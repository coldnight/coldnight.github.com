<!DOCTYPE html>
<html lang="zh-cn">
<title>Understanding Rust futures by going way too deep | Taking Smart Notes With Org-mode</title>
<meta charset="utf-8">
<meta name="generator" content="Hugo 0.83.1" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://www.linuxzen.com/notes/css/index.css">
<link rel="stylesheet" href="https://www.linuxzen.com/notes/css/classes.css">
<link rel="canonical" href="https://www.linuxzen.com/notes/articles/20210726105711-understanding_rust_futures_by_going_way_too_deep/">
<link rel="alternate" type="application/rss+xml" href="" title="Taking Smart Notes With Org-mode">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>


<body>

<header class="icons">
  
    <a href="https://www.linuxzen.com/notes/">Taking Smart Notes With Org-mode</a>
  
  
    <nav>
    
      <a href="/notes/articles/notes/" >
        
           Topics
        
      </a>
    
      <a href="/notes/articles/" >
        
          Articles
        
      </a>
    
      <a href="/notes/notes/" >
        
          Notes
        
      </a>
    
    </nav>
  
  
</header>

<article>
  <header>
    <h1>Understanding Rust futures by going way too deep</h1>
    <time datetime="2021-07-26T10:57:00&#43;08:00">July 26, 2021</time>
  </header>
  <p>åŸæ–‡é“¾æ¥ï¼š<a href="https://fasterthanli.me/articles/understanding-rust-futures-by-going-way-too-deep">Understanding Rust futures by going way too deep</a>ã€‚</p>
<p>è¯‘è€…æ³¨ï¼šåŸæ–‡å¤§é‡çš„å¼•å…¥äº†æœ‰è¶£çš„å¯¹è¯ï¼Œè¿«äºæ’ç‰ˆé—®é¢˜è¿™é‡Œä¸è¿›è¡Œç¿»è¯‘ï¼Œå¿…è¦çš„å¯¹è¯é€šè¿‡å¼•ç”¨å—æ¥è§£é‡Šã€‚</p>
<h2 id="æ·±å…¥ç†è§£-rust-future">æ·±å…¥ç†è§£ Rust future</h2>
<p>ç”¨ Rust futureï¼å°±æ˜¯è¿™ä¹ˆç®€å•ï¼ç›´åˆ°æˆ‘ä»¬å‘ç°å¹¶éå¦‚æ­¤ã€‚æ‰€ä»¥æˆ‘ä»¬å…ˆæ¢ç´¢ç®€å•çš„éƒ¨åˆ†ï¼Œç„¶åç»§ç»­æ¢ç´¢å›°éš¾éƒ¨åˆ†è€Œä¸æ˜¯ç­‰å®ƒæ…¢æ…¢é è¿‘æˆ‘ä»¬ã€‚</p>
<h2 id="èµ·æ­¥">èµ·æ­¥</h2>
<blockquote>
<p>Choo choo here comes the easy part ğŸš‚ğŸ’¨</p>
</blockquote>
<p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cargo new waytoodeep
     Created binary <span style="color:#f92672">(</span>application<span style="color:#f92672">)</span> <span style="color:#e6db74">`</span>waytoodeep<span style="color:#e6db74">`</span> package
</code></pre></div><p>æˆ‘ä»¬éœ€è¦å®‰è£… <code>cargo-edit</code> å¦‚æœä¹‹å‰æ²¡æœ‰å®‰è£…è¿‡çš„è¯ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥ç›´æ¥ <code>cargo add</code> ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cargo install cargo-edit
    Updating crates.io index
  Downloaded cargo-edit v0.7.0
  Downloaded <span style="color:#ae81ff">1</span> crate <span style="color:#f92672">(</span>57.6 KB<span style="color:#f92672">)</span> in 0.47s
     Ignored package <span style="color:#e6db74">`</span>cargo-edit v0.7.0<span style="color:#e6db74">`</span> is already installed, use --force to override
</code></pre></div><blockquote>
<p>å› ä¸º <code>cargo-edit</code> çœŸçš„å¾ˆæ–¹ä¾¿ï¼Œæ‰€ä»¥ä½ å¯èƒ½å·²ç»å®‰è£…è¿‡å®ƒã€‚éƒ¨åˆ†è¯»è€…ä¼šæ„Ÿåˆ°å›°æƒ‘æ˜¯å› ä¸ºåƒ
<code>cargo new</code>, <code>cargo build</code>, <code>cargo test</code>, <code>cargo run</code> ç­‰å­å‘½ä»¤éƒ½å†…ç½®åœ¨ cargo ä¸­ï¼Œ
ä½†æ˜¯ <code>cargo add</code> æ²¡æœ‰ã€‚</p>
<p>å®é™…ä¸Šï¼Œæœ‰ä¸€å¤§å †åƒè¿™æ ·çš„åŒ…ï¼Œå¦‚ <a href="https://lib.rs/crates/cargo-hack">cargo-hack</a>,<a href="https://lib.rs/crates/cargo-udeps">cargo-udeps</a>,<a href="https://lib.rs/crates/cargo-expand">cargo-expand</a>&hellip;<a href="https://lib.rs/keywords/cargo">ç­‰ç­‰</a>ã€‚</p>
</blockquote>
<p>ç„¶åæˆ‘ä»¬éœ€è¦é€‰æ‹©ä¸€ä¸ªã€Œå¼‚æ­¥è¿è¡Œæ—¶ã€ï¼ˆasync runtimeï¼‰ï¼Œå› ä¸ºè¿™äº› future å¯¹è±¡ä¸ä¼šè½®è¯¢ï¼ˆpollï¼‰è‡ªå·±ã€‚ã€‚ã€‚
æˆ‘ä»¬æ¯«æ— ç†ç”±çš„é€‰æ‹© tokioï¼Œå”¯ä¸€çš„åŸå› æ˜¯ï¼šè¿‡å»å‡ ä¸ªæœˆæˆ‘ä¸€ç›´åœ¨ç”¨å®ƒã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cargo add tokio@1.9.0 --features full
    Updating <span style="color:#e6db74">&#39;https://github.com/rust-lang/crates.io-index&#39;</span> index
      Adding tokio v1.9.0 to dependencies with features: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;full&#34;</span><span style="color:#f92672">]</span>
</code></pre></div><p>ç„¶åæˆ‘ä»¬ä¿®æ”¹ <code>main</code> å‡½æ•°ä½¿ç”¨ tokio é»˜è®¤æ‰§è¡Œå™¨ï¼ˆexecutorï¼‰ï¼ˆ <code>cargo new</code> ä¸ºæˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ª <code>main</code> å‡½æ•°ï¼Œä½†æ˜¯è¿™é‡Œå¹¶ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼‰ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#75715e">// in `src/main.rs`
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#[tokio::main]</span>
<span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
    println<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Hello from a (so far completely unnecessary) async runtime&#34;</span>);
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cargo run                                                                                                                                                                                          3s 209ms
   Compiling waytoodeep v0.1.0 <span style="color:#f92672">(</span>/Users/wh/codes/rust/waytoodeep<span style="color:#f92672">)</span>
    Finished dev <span style="color:#f92672">[</span>unoptimized + debuginfo<span style="color:#f92672">]</span> target<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> in 3.47s
     Running <span style="color:#e6db74">`</span>target/debug/waytoodeep<span style="color:#e6db74">`</span>
Hello from a <span style="color:#f92672">(</span>so far completely unnecessary<span style="color:#f92672">)</span> async runtime
</code></pre></div><p>é…·ï¼</p>
<p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬æ·»åŠ å…¶ä»–ä¸€äº›æˆ‘å–œæ¬¢åœ¨æˆ‘çš„é¡¹ç›®ä¸­ä½¿ç”¨çš„å¥½ä¸œè¥¿ã€‚</p>
<p>é¦–å…ˆï¼Œå¯¹äºé”™è¯¯å¤„ç† - æˆ‘ä»¬ç¼–å†™ç¨‹åºå°±éœ€è¦å¤„ç†ä¸€å †ä¸åŒåº“é‡Œä¸åŒçš„ç±»å‹ï¼Œå¦‚æœèƒ½é€šè¿‡ä¸€ä¸ªç±»å‹ç»Ÿä¸€å®ƒä»¬å°±ä¼šéå¸¸æ•´æ´ã€‚</p>
<p><a href="https://lib.rs/crates/eyre">eyre</a> å¯ä»¥èµ‹äºˆæˆ‘ä»¬è¿™äº›ï¼ˆå°±åƒ <code>anyhow</code> ï¼‰ï¼</p>
<p>å¹¶ä¸”å› ä¸ºæˆ‘å–œæ¬¢æ¼‚äº®çš„é¢œè‰²æˆ‘å°†ä½¿ç”¨ <a href="https://lib.rs/crates/color-eyre">color-eyre</a>ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cargo add color-eyre@0.5.11
    Updating <span style="color:#e6db74">&#39;https://github.com/rust-lang/crates.io-index&#39;</span> index
      Adding color-eyre v0.5.11 to dependencies
</code></pre></div><p>ç°åœ¨æˆ‘ä»¬éœ€è¦å®‰è£… <code>color-eyre</code> ä½œä¸ºé»˜è®¤çš„å´©æºƒï¼ˆpanicï¼‰å¤„ç†å™¨ï¼Œæˆ‘æ‚„æ‚„ä¿®æ”¹äº†ä¸€äº›ç¯å¢ƒå˜é‡æ¥é»˜è®¤è¾“å‡º bracktracesã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">use</span> color_eyre::Report;

<span style="color:#75715e">#[tokio::main]</span>
<span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
    setup()<span style="color:#f92672">?</span>;

    println<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Hello from a (so far completely unnecessary) async runtime&#34;</span>);

    Ok(())
}

<span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">setup</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
    <span style="color:#66d9ef">if</span> std::env::var(<span style="color:#e6db74">&#34;RUST_LIB_BACKTRACE&#34;</span>).is_err() {
        std::env::set_var(<span style="color:#e6db74">&#34;RUST_LIB_BACKTRACE&#34;</span>, <span style="color:#e6db74">&#34;1&#34;</span>)
    }
    color_eyre::install()<span style="color:#f92672">?</span>;

    Ok(())
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cargo run
    Finished dev <span style="color:#f92672">[</span>unoptimized + debuginfo<span style="color:#f92672">]</span> target<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> in 0.02s
     Running <span style="color:#e6db74">`</span>target/debug/waytoodeep<span style="color:#e6db74">`</span>
Hello from a <span style="color:#f92672">(</span>so far completely unnecessary<span style="color:#f92672">)</span> async runtime
</code></pre></div><p>å¾ˆå¥½ï¼ç°åœ¨å¦‚æœæˆ‘ä»¬æŸå¤„å‡ºç°äº†ä¸€ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å®Œæ•´çš„å †æ ˆè·Ÿè¸ªï¼Œå°±åƒä¸‹é¢è¿™æ ·ï¼š
<img src="/notes/ox-hugo/color-eyre.png" alt=""></p>
<p>æœ€åï¼Œå› ä¸ºæˆ‘å–œæ¬¢ç»“æ„åŒ–æ—¥å¿—ï¼Œè®©æˆ‘ä»¬æ·»åŠ  <a href="https://lib.rs/crates/tracing">tracing</a> ç„¶åé€šè¿‡æ¼‚äº®çš„é¢œè‰²æ‰“å°å®ƒä»¬ï¼Œè®©æˆ‘ä»¬æ·»åŠ  <a href="https://lib.rs/crates/tracing-subscriber">tracing-subscriber</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cargo add tracing@0.1.26 tracing-subscriber@0.2.19
    Updating <span style="color:#e6db74">&#39;https://github.com/rust-lang/crates.io-index&#39;</span> index
      Adding tracing v0.1.26 to dependencies
      Adding tracing-subscriber v0.2.19 to dependencies
</code></pre></div><p>æˆ‘ä»¬å·²ç»æœ‰ä¸€ä¸ª <code>setup</code> å‡½æ•°ï¼Œæ‰€ä»¥ç›´æ¥åœ¨é‚£é‡Œå®‰è£… <code>tracing-subscriber</code>.. ç„¶åæˆ‘ä»¬å°† <code>println!</code> æ”¹æˆ <code>info!</code> ï¼
ç„¶åï¼Œä¸ºäº†æ¼”ç¤ºå¦‚ä½•è®¾ç½®è®©æˆ‘ä»¬å†æ¬¡ä¿®æ”¹ä¸€äº›ç¯å¢ƒå˜é‡ï¼šå¯¹æ‰€æœ‰åŒ…ï¼ˆcratesï¼‰é»˜è®¤ <code>info</code> æ—¥å¿—çº§åˆ«ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">use</span> color_eyre::Report;
<span style="color:#66d9ef">use</span> tracing::info;
<span style="color:#66d9ef">use</span> tracing_subscriber::EnvFilter;

<span style="color:#75715e">#[tokio::main]</span>
<span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
    setup()<span style="color:#f92672">?</span>;

    info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Hello from a comfy nest we&#39;ve made for ourselves&#34;</span>);

    Ok(())
}

<span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">setup</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
    <span style="color:#66d9ef">if</span> std::env::var(<span style="color:#e6db74">&#34;RUST_LIB_BACKTRACE&#34;</span>).is_err() {
        std::env::set_var(<span style="color:#e6db74">&#34;RUST_LIB_BACKTRACE&#34;</span>, <span style="color:#e6db74">&#34;1&#34;</span>)
    }
    color_eyre::install()<span style="color:#f92672">?</span>;

    <span style="color:#66d9ef">if</span> std::env::var(<span style="color:#e6db74">&#34;RUST_LOG&#34;</span>).is_err() {
        std::env::set_var(<span style="color:#e6db74">&#34;RUST_LOG&#34;</span>, <span style="color:#e6db74">&#34;info&#34;</span>)
    }
    tracing_subscriber::fmt::fmt()
        .with_env_filter(EnvFilter::from_default_env())
        .init();

    Ok(())
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cargo run
    Finished dev <span style="color:#f92672">[</span>unoptimized + debuginfo<span style="color:#f92672">]</span> target<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> in 0.02s
     Running <span style="color:#e6db74">`</span>target/debug/waytoodeep<span style="color:#e6db74">`</span>
Jul <span style="color:#ae81ff">25</span> 17:03:46.993  INFO waytoodeep: Hello from a comfy nest we<span style="color:#960050;background-color:#1e0010">&#39;</span>ve made <span style="color:#66d9ef">for</span> ourselves
</code></pre></div><p>å¥½äº†ï¼Œæˆ‘ä»¬å‡†å¤‡å¥½åšä¸€äº›æœ‰ç”¨çš„äº‹æƒ…äº†ã€‚</p>
<h3 id="åšä¸€äº›æœ‰ç”¨çš„äº‹æƒ…">åšä¸€äº›æœ‰ç”¨çš„äº‹æƒ…</h3>
<p>å½“å†³å®šåœ¨å’–å•¡é—´éš™é˜…è¯»å“ªä¸€ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œäººä»¬é€šå¸¸åŒæ—¶æ‰“å¼€å‡ ä¸ªç½‘ç«™ï¼Œç„¶åè¯»æœ€å…ˆåŠ è½½å‡ºæ¥çš„é‚£ä¸€ç¯‡ã€‚</p>
<p>äº‹å®å¦‚æ­¤ã€‚ä½ å¯ä»¥å¼•ç”¨æˆ‘çš„è¯ï¼Œæ¯•ç«Ÿè°ä¼šå»éªŒè¯å‘¢ï¼Ÿæ¯•ç«Ÿè¿™å¬èµ·æ¥éœ€è¦å¾ˆå¤šå·¥ä½œã€‚</p>
<p>æ‰€ä»¥è®©æˆ‘ä»¬æ¥ç¼–å†™ä¸€ä¸ªç¨‹åºåšç›¸åŒçš„äº‹æƒ…ã€‚</p>
<p>è®©æˆ‘ä»¬å¼•å…¥ <a href="https://lib.rs/crates/reqwest">reqwest</a> &ndash; å°½ç®¡æˆ‘ä¸å–œæ¬¢å®ƒçš„ APIï¼Œä½†å®ƒä¼šå¾ˆå¥½çš„å®Œæˆæ¥ä¸‹æ¥çš„å·¥ä½œã€‚</p>
<p>åŒæ—¶ï¼Œå› ä¸º <a href="https://www.openssl.org/news/vulnerabilities.html">screw OpenSSL</a> æˆ‘ä»¬å°†æ ‡è®° reqwest ä½¿ç”¨ <a href="https://lib.rs/crates/rustls">rustls</a>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cargo add reqwest@0.11.4 --no-default-features --features rustls-tls
    Updating <span style="color:#e6db74">&#39;https://github.com/rust-lang/crates.io-index&#39;</span> index
      Adding reqwest v0.11.4 to dependencies with features: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;rustls-tls&#34;</span><span style="color:#f92672">]</span>
</code></pre></div><p>æˆ‘ä»¬å‡†å¤‡å¥½å‘é€ä¸€ä¸ªè¯·æ±‚ï¼</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">use</span> color_eyre::Report;
<span style="color:#66d9ef">use</span> tracing::info;
<span style="color:#66d9ef">use</span> tracing_subscriber::EnvFilter;
<span style="color:#66d9ef">use</span> reqwest::Client;

<span style="color:#75715e">#[tokio::main]</span>
<span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
    setup()<span style="color:#f92672">?</span>;

    info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Hello from a comfy nest we&#39;ve made for ourselves&#34;</span>);

    <span style="color:#66d9ef">let</span> client <span style="color:#f92672">=</span> Client::new();
    <span style="color:#66d9ef">let</span> url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://fasterthanli.me&#34;</span>;
    <span style="color:#75715e">// this will turn non-200 HTTP status codes into rust errors,
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// so the first `?` propagates &#34;we had a connection problem&#34; and
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// the second `?` propagates &#34;we had a chat with the server and they
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// were not pleased&#34;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> res <span style="color:#f92672">=</span> client.get(url).send().<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>.error_for_status()<span style="color:#f92672">?</span>;
    info<span style="color:#f92672">!</span>(<span style="color:#f92672">%</span>url, content_type <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>res.headers().get(<span style="color:#e6db74">&#34;content-type&#34;</span>), <span style="color:#e6db74">&#34;Got a response!&#34;</span>);


    Ok(())
}

<span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">setup</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
    <span style="color:#66d9ef">if</span> std::env::var(<span style="color:#e6db74">&#34;RUST_LIB_BACKTRACE&#34;</span>).is_err() {
        std::env::set_var(<span style="color:#e6db74">&#34;RUST_LIB_BACKTRACE&#34;</span>, <span style="color:#e6db74">&#34;1&#34;</span>)
    }
    color_eyre::install()<span style="color:#f92672">?</span>;

    <span style="color:#66d9ef">if</span> std::env::var(<span style="color:#e6db74">&#34;RUST_LOG&#34;</span>).is_err() {
        std::env::set_var(<span style="color:#e6db74">&#34;RUST_LOG&#34;</span>, <span style="color:#e6db74">&#34;info&#34;</span>)
    }
    tracing_subscriber::fmt::fmt()
        .with_env_filter(EnvFilter::from_default_env())
        .init();

    Ok(())
}
</code></pre></div><p>å‡ºå‘äº†ï¼</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cargo run                                                                                                                                                                                          3s 662ms
   Compiling waytoodeep v0.1.0 <span style="color:#f92672">(</span>/Users/wh/codes/rust/waytoodeep<span style="color:#f92672">)</span>
    Finished dev <span style="color:#f92672">[</span>unoptimized + debuginfo<span style="color:#f92672">]</span> target<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> in 7.16s
     Running <span style="color:#e6db74">`</span>target/debug/waytoodeep<span style="color:#e6db74">`</span>
Jul <span style="color:#ae81ff">26</span> 16:50:57.778  INFO waytoodeep: Hello from a comfy nest we<span style="color:#960050;background-color:#1e0010">&#39;</span>ve made <span style="color:#66d9ef">for</span> ourselves
Jul <span style="color:#ae81ff">26</span> 16:50:59.090  INFO waytoodeep: Got a response! url<span style="color:#f92672">=</span>https://fasterthanli.me content_type<span style="color:#f92672">=</span>Some<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;text/html; charset=utf-8&#34;</span><span style="color:#f92672">)</span>
</code></pre></div><p>è¿™å°±æ˜¯æˆ‘æ‰€è¯´çš„ã€Œç»“æ„åŒ–æ—¥å¿—ã€ã€‚å—¯ï¼Œå…¶ä¸­çš„ä¸€éƒ¨åˆ†ã€‚è®©æˆ‘ä»¬çœ‹ä¸‹è¿™è¡Œä»£ç ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">info<span style="color:#f92672">!</span>(<span style="color:#f92672">%</span>url, content_type <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>res.headers().get(<span style="color:#e6db74">&#34;content-type&#34;</span>), <span style="color:#e6db74">&#34;Got a response!&#34;</span>);
</code></pre></div><p>æˆ‘ä»¬è¾“å‡ºæ¥ä¸€ä¸ªæ¶ˆæ¯ï¼š <code>Got a response!</code> ï¼Œä¸€ä¸ªåä¸º <code>url</code> çš„æ ‡ç­¾ï¼šå€¼ä¸ºå˜é‡ <code>url</code> çš„ <a href="https://doc.rust-lang.org/stable/std/fmt/trait.Display.html">Display</a> æ ¼å¼ï¼Œ
ä¸€ä¸ªåä¸º <code>content_type</code> çš„æ ‡ç­¾ï¼šå€¼ä¸ºè¡¨è¾¾å¼çš„ <a href="https://doc.rust-lang.org/stable/std/fmt/trait.Debug.html">Debug</a> æ ¼å¼ã€‚</p>
<p>å°±æ˜¯è¿™ä¹ˆç®€å•ï¼ <code>name = %value</code> è¾“å‡º <code>Display</code> ï¼Œ <code>name = ?value</code> è¾“å‡º <code>Debug</code> ã€‚</p>
<p>å½“ç„¶ï¼Œè¿˜æœ‰éå¸¸æ£’çš„è·¨åº¦ï¼ˆspansï¼‰ï¼Œé‡ç‚¹æ˜¯ä½ å¯ä»¥å°†å®ƒä»¬å‘é€åˆ° APMï¼ˆAppliation Performance Monitoringï¼‰ï¼Œæ¯”å¦‚ Datadog æˆ–è€… Honeycomb ç­‰ï¼Œä½†æ˜¯è¿™ä¸æ˜¯ä¸€ç¯‡å…³äºè·Ÿè¸ªçš„æ–‡ç« ã€‚</p>
<p>ä¸ºäº†ä¸¾ä¾‹è¯´æ˜ï¼Œå¦‚æœæˆ‘ä»¬å®‰è£…ä¸€ä¸ª JSON çš„ tracing subscriberï¼Œæˆ‘ä»¬å°†è·å¾—å¦‚ä¸‹å†…å®¹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cargo run
   Compiling waytoodeep v0.1.0 <span style="color:#f92672">(</span>/home/amos/ftl/waytoodeep<span style="color:#f92672">)</span>
    Finished dev <span style="color:#f92672">[</span>unoptimized + debuginfo<span style="color:#f92672">]</span> target<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> in 3.09s
     Running <span style="color:#e6db74">`</span>target/debug/waytoodeep<span style="color:#e6db74">`</span>
<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;timestamp&#34;</span>:<span style="color:#e6db74">&#34;Jul 25 17:17:21.531&#34;</span>,<span style="color:#e6db74">&#34;level&#34;</span>:<span style="color:#e6db74">&#34;INFO&#34;</span>,<span style="color:#e6db74">&#34;fields&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;message&#34;</span>:<span style="color:#e6db74">&#34;Hello from a comfy nest we&#39;ve made for ourselves&#34;</span><span style="color:#f92672">}</span>,<span style="color:#e6db74">&#34;target&#34;</span>:<span style="color:#e6db74">&#34;waytoodeep&#34;</span><span style="color:#f92672">}</span>
<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;timestamp&#34;</span>:<span style="color:#e6db74">&#34;Jul 25 17:17:21.709&#34;</span>,<span style="color:#e6db74">&#34;level&#34;</span>:<span style="color:#e6db74">&#34;INFO&#34;</span>,<span style="color:#e6db74">&#34;fields&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;message&#34;</span>:<span style="color:#e6db74">&#34;Got a response!&#34;</span>,<span style="color:#e6db74">&#34;url&#34;</span>:<span style="color:#e6db74">&#34;https://fasterthanli.me&#34;</span>,<span style="color:#e6db74">&#34;content_type&#34;</span>:<span style="color:#e6db74">&#34;Some(\&#34;text/html; charset=utf-8\&#34;)&#34;</span><span style="color:#f92672">}</span>,<span style="color:#e6db74">&#34;target&#34;</span>:<span style="color:#e6db74">&#34;waytoodeep&#34;</span><span style="color:#f92672">}</span>
</code></pre></div><p>è¿™åº”è¯¥è¶³ä»¥æ¿€èµ·ä½ çš„å…´è¶£ã€‚</p>
<h3 id="åŒæ—¶è·å–ä¸¤ä¸ªåœ°å€">åŒæ—¶è·å–ä¸¤ä¸ªåœ°å€</h3>
<p>ç°åœ¨è®©æˆ‘ä»¬è·å–ä¸¤ä¸ªåœ°å€ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">const</span> URL_1: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://fasterthanli.me/articles/whats-in-the-box&#34;</span>;
<span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">const</span> URL_2: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://fasterthanli.me/series/advent-of-code-2020/part-13&#34;</span>;
</code></pre></div><p>&hellip;&hellip;æ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªå…¬å¹³çš„æ¯”è¾ƒã€‚ è¿™ä¸¤ç¯‡æ–‡ç« éƒ½æ‰˜ç®¡åœ¨æˆ‘è‡ªå·±çš„ç½‘ç«™ä¸Šï¼Œç»å¯¹ä¸æ˜¯ä¸ºäº†æ¨å¹¿ï¼Œè€Œæ˜¯ä¸ºäº†ä½¿è·å–æ—¶é—´å…·æœ‰å¯æ¯”æ€§ï¼Œå¹¶ä¸”ä»»ä¸€éƒ½æœ‰å¯èƒ½å…ˆåŠ è½½å®Œæˆï¼ˆå¹¶ä¸”ä¼šéšç€æ—¶é—´çš„æ¨ç§»éšæœºå˜åŒ–ï¼‰ã€‚</p>
<p>æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå‡½æ•°æ¥è·å–å†…å®¹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fetch_thing</span>(client: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Client</span>, url: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span>) -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
    <span style="color:#66d9ef">let</span> res <span style="color:#f92672">=</span> client.get(url).send().<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>.error_for_status()<span style="color:#f92672">?</span>;
    info<span style="color:#f92672">!</span>(<span style="color:#f92672">%</span>url, content_type <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>res.headers().get(<span style="color:#e6db74">&#34;content-type&#34;</span>), <span style="color:#e6db74">&#34;Got a response!&#34;</span>);
    Ok(())
}
</code></pre></div><p>å¹¶ä½¿ç”¨å®ƒï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#75715e">#[tokio::main]</span>
<span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
    setup()<span style="color:#f92672">?</span>;

    info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Hello from a comfy nest we&#39;ve made for ourselves&#34;</span>);

    <span style="color:#66d9ef">let</span> client <span style="color:#f92672">=</span> Client::new();
    fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_1);
    fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_2);

    Ok(())
}
</code></pre></div><p>ç„¶åè¿è¡Œå®ƒ:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#75715e">$</span> cargo run
   Compiling waytoodeep v0.<span style="color:#ae81ff">1.0</span> (<span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>amos<span style="color:#f92672">/</span>ftl<span style="color:#f92672">/</span>waytoodeep)
warning: <span style="color:#a6e22e">unused</span> implementer of <span style="color:#960050;background-color:#1e0010">`</span>Future<span style="color:#960050;background-color:#1e0010">`</span> that must be used
  <span style="color:#f92672">-</span>-&gt; <span style="color:#a6e22e">src</span><span style="color:#f92672">/</span>main.rs:<span style="color:#ae81ff">15</span>:<span style="color:#ae81ff">5</span>
   <span style="color:#f92672">|</span>
<span style="color:#ae81ff">15</span> <span style="color:#f92672">|</span>     fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_1);
   <span style="color:#f92672">|</span>     <span style="color:#f92672">^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
   <span style="color:#f92672">|</span>
   <span style="color:#f92672">=</span> note: <span style="color:#960050;background-color:#1e0010">`</span><span style="color:#75715e">#[warn(unused_must_use)]</span><span style="color:#960050;background-color:#1e0010">`</span> on by default
   <span style="color:#f92672">=</span> note: <span style="color:#a6e22e">futures</span> <span style="color:#66d9ef">do</span> nothing unless you <span style="color:#960050;background-color:#1e0010">`</span>.<span style="color:#66d9ef">await</span><span style="color:#960050;background-color:#1e0010">`</span> or poll them

warning: <span style="color:#a6e22e">unused</span> implementer of <span style="color:#960050;background-color:#1e0010">`</span>Future<span style="color:#960050;background-color:#1e0010">`</span> that must be used
  <span style="color:#f92672">-</span>-&gt; <span style="color:#a6e22e">src</span><span style="color:#f92672">/</span>main.rs:<span style="color:#ae81ff">16</span>:<span style="color:#ae81ff">5</span>
   <span style="color:#f92672">|</span>
<span style="color:#ae81ff">16</span> <span style="color:#f92672">|</span>     fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_2);
   <span style="color:#f92672">|</span>     <span style="color:#f92672">^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
   <span style="color:#f92672">|</span>
   <span style="color:#f92672">=</span> note: <span style="color:#a6e22e">futures</span> <span style="color:#66d9ef">do</span> nothing unless you <span style="color:#960050;background-color:#1e0010">`</span>.<span style="color:#66d9ef">await</span><span style="color:#960050;background-color:#1e0010">`</span> or poll them

warning: <span style="color:#ae81ff">2</span> warnings emitted

    Finished dev [unoptimized <span style="color:#f92672">+</span> debuginfo] target(s) <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">3.01</span>s
     Running <span style="color:#960050;background-color:#1e0010">`</span>target<span style="color:#f92672">/</span>debug<span style="color:#f92672">/</span>waytoodeep<span style="color:#960050;background-color:#1e0010">`</span>
Jul <span style="color:#ae81ff">25</span> <span style="color:#ae81ff">17</span>:<span style="color:#ae81ff">26</span>:<span style="color:#ae81ff">31.571</span>  INFO waytoodeep: <span style="color:#a6e22e">Hello</span> from a comfy nest we<span style="color:#a6e22e">&#39;ve</span> made <span style="color:#66d9ef">for</span> ourselves
</code></pre></div><p>å¥‡æ€ªçš„æ˜¯ï¼Œæ²¡æœ‰ä»»ä½•äº‹æƒ…å‘ç”Ÿã€‚</p>
<blockquote>
<p>é»„é»„çš„æ³¢æµªçº¿å’Œæ¼äººçš„ Rust è­¦å‘Šå·²ç»ç»™å‡ºäº†æç¤ºã€‚</p>
</blockquote>
<p>è®©æˆ‘ä»¬æ¥ä¿®å¤å®ƒï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_1).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_2).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</code></pre></div><pre><code class="language-nil" data-lang="nil">$ cargo run
   Compiling waytoodeep v0.1.0 (/home/amos/ftl/waytoodeep)
    Finished dev [unoptimized + debuginfo] target(s) in 3.17s
     Running `target/debug/waytoodeep`
Jul 25 17:27:29.768  INFO waytoodeep: Hello from a comfy nest we've made for ourselves
Jul 25 17:27:29.891  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&quot;text/html; charset=utf-8&quot;)
Jul 25 17:27:29.974  INFO waytoodeep: Got a response! url=https://fasterthanli.me/series/advent-of-code-2020/part-13 content_type=Some(&quot;text/html; charset=utf-8&quot;)
</code></pre><p>æ‰€ä»¥ï¼Œç¬¬é›¶è¯¾ï¼šfuture å¯¹è±¡ä¸åšä»»ä½•äº‹æƒ…ç›´åˆ°å®ƒä»¬è¢«è½®è¯¢ï¼ˆpolledï¼‰ã€‚</p>
<p>è¿™æ˜¯å› ä¸º future å¯¹è±¡å‡ ä¹å°±æ˜¯çŠ¶æ€ã€‚è®©æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#75715e">// in `src/main.rs`
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">mod</span> dumb;
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#75715e">// in `src/dumb.rs`
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">use</span> std::{
    future::Future,
    pin::Pin,
    task::{Context, Poll},
};

<span style="color:#66d9ef">use</span> tracing::info;

<span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">DumbFuture</span> {}

<span style="color:#66d9ef">impl</span> Future <span style="color:#66d9ef">for</span> DumbFuture {
    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Output</span> <span style="color:#f92672">=</span> ();

    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">poll</span>(self: <span style="color:#a6e22e">Pin</span><span style="color:#f92672">&lt;&amp;</span><span style="color:#66d9ef">mut</span> Self<span style="color:#f92672">&gt;</span>, _cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Context<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;_</span><span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>Self::Output<span style="color:#f92672">&gt;</span> {
        info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Hello from a dumb future!&#34;</span>);
        Poll::Ready(())
    }
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#75715e">// back in `src/main.rs`
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#[tokio::main]</span>
<span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
    setup()<span style="color:#f92672">?</span>;

    <span style="color:#66d9ef">let</span> fut <span style="color:#f92672">=</span> dumb::DumbFuture {};

    Ok(())
}
</code></pre></div><p>ä»¥ä¸Šï¼æˆ‘ä»¬å‡ ä¹å°±å®Œæˆæ¥é™¤äº†æˆ‘ä»¬æ²¡æœ‰ <code>.await</code> ã€‚</p>
<p>è¿è¡Œå®ƒé™¤äº†æ‰“å°æŠ¥è­¦ä¸ä¼šæœ‰ä»»ä½•æ•ˆæœï¼š</p>
<pre><code class="language-nil" data-lang="nil">$ cargo run
   Compiling waytoodeep v0.1.0 (/home/amos/ftl/waytoodeep)
warning: unused variable: `fut`
  --&gt; src/main.rs:14:9
   |
14 |     let fut = dumb::DumbFuture {};
   |         ^^^ help: if this is intentional, prefix it with an underscore: `_fut`
   |
   = note: `#[warn(unused_variables)]` on by default

warning: 1 warning emitted

    Finished dev [unoptimized + debuginfo] target(s) in 2.11s
     Running `target/debug/waytoodeep`
</code></pre><p>å› ä¸ºæ€ä¹ˆå¯èƒ½ï¼Ÿæˆ‘ä»¬å­—é¢ä¸Šä»…ä»…æ„å»ºäº†ä¸€ä¸ªç»“æ„ä½“ã€‚ä¸€ä¸ªé›¶å¤§å°çš„ç»“æ„ä½“ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬è°ƒç”¨å®ƒçš„ <code>.await</code> ã€‚ã€‚ ç„¶åå½“æˆ‘ä»¬è¦æ±‚è¿è¡Œæ—¶è¿è¡Œå®ƒçš„äº‹ä»¶å¾ªç¯ç›´åˆ° future å¯¹è±¡è¢«è½®è¯¢ï¼ˆpolledï¼‰å¹¶ä¸”æœ€ç»ˆè¿”å› <code>Poll::Ready</code> ï¼ˆæˆ‘ä»¬çš„ä»£ç ç«‹å³è¿”å›ï¼‰ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#75715e">#[tokio::main]</span>
<span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
    setup()<span style="color:#f92672">?</span>;

    info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Building that dumb future...&#34;</span>);
    <span style="color:#66d9ef">let</span> fut <span style="color:#f92672">=</span> dumb::DumbFuture {};
    info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Awaiting that dumb future...&#34;</span>);
    fut.<span style="color:#66d9ef">await</span>;
    info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Done awaiting that dumb future&#34;</span>);

    Ok(())
}

</code></pre></div><pre><code class="language-nil" data-lang="nil">$ cargo run
   Compiling waytoodeep v0.1.0 (/home/amos/ftl/waytoodeep)
    Finished dev [unoptimized + debuginfo] target(s) in 2.34s
     Running `target/debug/waytoodeep`
Jul 25 17:37:09.261  INFO waytoodeep: Building that dumb future...
Jul 25 17:37:09.261  INFO waytoodeep: Awaiting that dumb future...
Jul 25 17:37:09.261  INFO waytoodeep::dumb: Hello from a dumb future!
Jul 25 17:37:09.262  INFO waytoodeep: Done awaiting that dumb future
</code></pre><p>è¿™é‡Œæœ‰ä¸€äº›ç•¥å¾®çš„åŒºåˆ«ä¸ ECMAScript çš„ <code>promise</code> ï¼šå³ä½¿å®ƒä»¬å‹æ ¹æ²¡æœ‰è¢« await å…¶ä¸­åŒ…å«çš„å·¥ä½œä¾ç„¶ä¼šè¢«æ‰§è¡Œã€‚</p>
<p>ä½†æ˜¯ Rust çš„ future å¯¹è±¡ä»…ä»…æ˜¯æ— èŠçš„çŠ¶æ€æœºï¼Œå¦‚æœä½ æ•…æ„åˆ¶é€ éº»çƒ¦å°±å¯ä»¥ç†è§£è¿™ä¸ªæœºåˆ¶ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#75715e">// in `src/dumb.rs`
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">impl</span> Future <span style="color:#66d9ef">for</span> DumbFuture {
    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Output</span> <span style="color:#f92672">=</span> ();

    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">poll</span>(self: <span style="color:#a6e22e">Pin</span><span style="color:#f92672">&lt;&amp;</span><span style="color:#66d9ef">mut</span> Self<span style="color:#f92672">&gt;</span>, _cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Context<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;_</span><span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>Self::Output<span style="color:#f92672">&gt;</span> {
        panic<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Oh heck no&#34;</span>);
    }
}
</code></pre></div><pre><code class="language-nil" data-lang="nil">$ RUST_BACKTRACE=1 cargo run
   Compiling waytoodeep v0.1.0 (/home/amos/ftl/waytoodeep)
    Finished dev [unoptimized + debuginfo] target(s) in 2.28s
     Running `target/debug/waytoodeep`
Jul 25 17:41:18.956  INFO waytoodeep: Building that dumb future...
Jul 25 17:41:18.956  INFO waytoodeep: Awaiting that dumb future...
The application panicked (crashed).
Message:  Oh heck no
Location: src/dumb.rs:14

  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” BACKTRACE â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                                â‹® 6 frames hidden â‹®
   7: &lt;waytoodeep::dumb::DumbFuture as core::future::future::Future&gt;::poll::h4a44780628f4c5f0
      at /home/amos/ftl/waytoodeep/src/dumb.rs:14
   8: waytoodeep::main::{{closure}}::h36de5a1f1f2a5c5b
      at /home/amos/ftl/waytoodeep/src/main.rs:17
   9: &lt;core::future::from_generator::GenFuture&lt;T&gt; as core::future::future::Future&gt;::poll::h20a96e082c7a581e
      at /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/mod.rs:80
  10: tokio::park::thread::CachedParkThread::block_on::{{closure}}::hdf98cb3c7fdf3de4
      at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/park/thread.rs:263
  11: tokio::coop::with_budget::{{closure}}::h6a86a24a246e220f
      at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/coop.rs:106
  12: std::thread::local::LocalKey&lt;T&gt;::try_with::h2ce0ac27c85965b6
      at /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/local.rs:376
  13: std::thread::local::LocalKey&lt;T&gt;::with::hc449f38c9f65fb53
      at /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/local.rs:352
  14: tokio::coop::with_budget::h5db157bd1e95e0e8
      at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/coop.rs:99
  15: tokio::coop::budget::h7b57383f1255ac24
      at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/coop.rs:76
  16: tokio::park::thread::CachedParkThread::block_on::hece399485213b91c
      at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/park/thread.rs:263
  17: tokio::runtime::enter::Enter::block_on::h89e9882e539e82d3
      at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/runtime/enter.rs:151
  18: tokio::runtime::thread_pool::ThreadPool::block_on::h1a0186470c00ba70
      at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/runtime/thread_pool/mod.rs:71
  19: tokio::runtime::Runtime::block_on::h7c21d6989b86d606
      at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/runtime/mod.rs:452
  20: waytoodeep::main::hb4dd5ffd46a5c032
      at /home/amos/ftl/waytoodeep/src/main.rs:20
  21: core::ops::function::FnOnce::call_once::hc1fcc87431f77d25
      at /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/function.rs:227
                                â‹® 11 frames hidden â‹®

Run with COLORBT_SHOW_HIDDEN=1 environment variable to disable frame filtering.
Run with RUST_BACKTRACE=full to include source snippets.
</code></pre><p>ä¸Šé¢å †æ ˆè·Ÿè¸ªå¦‚æœåŠ ä¸Šé¢œè‰²æ•ˆæœä¼šæ›´å¥½ï¼Œæ‰€ä»¥æˆ‘å¸Œæœ›ä½ åœ¨æœ¬åœ°åšäº†ç›¸åŒçš„å°è¯•ï¼Œå³ä½¿å¦‚æ­¤æˆ‘ä»¬ä¾ç„¶å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çœŸæ­£çš„ main å‡½æ•°åœ¨ 20 å¸§ï¼Œç„¶åå¾€ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>Runtime::block_on</code>  ã€ä¸€ä¸ªçº¿ç¨‹æ± çš„ä¸œè¥¿ã€ä¸€äº›æŒ‚èµ·ï¼ˆparkedï¼‰çš„çº¿ç¨‹ã€thread-localï¼ˆå…¶ä»– TLSï¼‰ã€ä¸€ä¸ª <strong><strong>ç”Ÿæˆçš„</strong></strong> futureï¼ˆå¸§ 9 å’Œ 8ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ <code>async fn main</code> çš„æœ€ç»ˆç»“æœï¼‰ï¼Œæœ€åæ˜¯æˆ‘ä»¬çš„ <code>DumbFuture</code> poll æ–¹æ³•ï¼ˆå¸§ 7ï¼‰ã€‚</p>
<p>å¸§ 6 åˆ° 1 å°±æ˜¯ <a href="https://doc.rust-lang.org/stable/std/panic/index.html">panic</a> æœºåˆ¶ï¼Œå†æ¬¡å®Œå…¨è¶…å‡ºæœ¬æ–‡è®¨è®ºçš„èŒƒå›´ã€‚</p>
<p>ä½†æ˜¯è¯·ç«™èµ·æ¥ï¼Œäº²çˆ±çš„è§‚ä¼—ï¼Œç”¨ä½ çš„æ‰‹è‡‚ç»•è¿‡è¿™ä¸ªè£…ç½®ï¼Œä»¥ç¡®ä¿æ²¡æœ‰éšœçœ¼æ³•ï¼Œæ²¡æœ‰éšè—çš„çº¿ï¼Œæ²¡æœ‰ã€‚ã€‚ã€‚</p>
<p>ã€‚ã€‚ã€‚æˆ‘è¦è¯´çš„æ˜¯å¯¹äºå¼‚æ­¥å †æ ˆè·Ÿè¸ªæ²¡æœ‰â€œç‰¹æ®Šå¤„ç†â€ï¼ˆspecial handlingï¼‰ã€‚å½“ç„¶ï¼Œè¿™é‡Œæˆ‘ä»¬å´©æºƒäº†ï¼Œä½†æ˜¯ä»…ä»…æ˜¯ Rustï¼Œæ“ä½œç³»ç»Ÿç”šè‡³ä¸çŸ¥é“æˆ‘å‡ ä¹é¿å…äº†ä¸€åœºç¾éš¾ã€‚</p>
<p>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥åˆ¶é€ æ›´å¤§çš„æ··ä¹±ï¼Œå¦‚æœæˆ‘ä»¬æ„¿æ„ä½¿ç”¨ <code>unsafe</code> ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">impl</span> Future <span style="color:#66d9ef">for</span> DumbFuture {
    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Output</span> <span style="color:#f92672">=</span> ();

    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">poll</span>(self: <span style="color:#a6e22e">Pin</span><span style="color:#f92672">&lt;&amp;</span><span style="color:#66d9ef">mut</span> Self<span style="color:#f92672">&gt;</span>, _cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Context<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;_</span><span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>Self::Output<span style="color:#f92672">&gt;</span> {
        <span style="color:#66d9ef">unsafe</span> {
            <span style="color:#f92672">*</span>(<span style="color:#ae81ff">0xF00D</span> <span style="color:#66d9ef">as</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">mut</span> <span style="color:#66d9ef">u64</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>;
        }
        unreachable<span style="color:#f92672">!</span>(); <span style="color:#75715e">// pinky promise
</span><span style="color:#75715e"></span>    }
}
</code></pre></div><p>ç„¶åå°±ä¸ä¼šæœ‰ä¸€äº›åˆ—çš„å´©æºƒå¤„ç†æ¥æ‹¯æ•‘æˆ‘ä»¬ï¼š</p>
<pre><code class="language-nil" data-lang="nil">$ RUST_BACKTRACE=1 cargo run
   Compiling waytoodeep v0.1.0 (/home/amos/ftl/waytoodeep)
    Finished dev [unoptimized + debuginfo] target(s) in 2.18s
     Running `target/debug/waytoodeep`
Jul 25 17:46:53.926  INFO waytoodeep: Building that dumb future...
Jul 25 17:46:53.926  INFO waytoodeep: Awaiting that dumb future...
zsh: segmentation fault (core dumped)  RUST_BACKTRACE=1 cargo run
</code></pre><p>ä½†æ˜¯ GDB å¯ä»¥ï¼š</p>
<pre><code class="language-nil" data-lang="nil">$ cargo build &amp;&amp; gdb --quiet --args ./target/debug/waytoodeep
    Finished dev [unoptimized + debuginfo] target(s) in 0.04s
Reading symbols from ./target/debug/waytoodeep...
warning: Missing auto-load script at offset 0 in section .debug_gdb_scripts
of file /home/amos/ftl/waytoodeep/target/debug/waytoodeep.
Use `info auto-load python-scripts [REGEXP]' to list them.
(gdb) r
Starting program: /home/amos/ftl/waytoodeep/target/debug/waytoodeep
[Thread debugging using libthread_db enabled]
Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.
[New Thread 0x7ffff7c28700 (LWP 129418)]
[New Thread 0x7ffff7a27700 (LWP 129419)]
[New Thread 0x7ffff7826700 (LWP 129420)]
[New Thread 0x7ffff7625700 (LWP 129421)]
[New Thread 0x7ffff7424700 (LWP 129422)]
[New Thread 0x7ffff7223700 (LWP 129423)]
[New Thread 0x7ffff7022700 (LWP 129424)]
[New Thread 0x7ffff6e1e700 (LWP 129425)]
[New Thread 0x7ffff6c1a700 (LWP 129426)]
[New Thread 0x7ffff6a16700 (LWP 129427)]
[New Thread 0x7ffff6812700 (LWP 129428)]
[New Thread 0x7ffff660e700 (LWP 129429)]
[New Thread 0x7ffff640a700 (LWP 129430)]
[New Thread 0x7ffff6206700 (LWP 129431)]
[New Thread 0x7ffff6002700 (LWP 129432)]
Jul 25 17:47:13.278  INFO waytoodeep: Building that dumb future...
Jul 25 17:47:13.279  INFO waytoodeep: Awaiting that dumb future...

Thread 1 &quot;waytoodeep&quot; received signal SIGSEGV, Segmentation fault.
&lt;waytoodeep::dumb::DumbFuture as core::future::future::Future&gt;::poll (self=..., _cx=0x7fffffffd690) at src/dumb.rs:15
15                  *(0xF00D as *mut u64) = 0x0;
(gdb) bt
#0  &lt;waytoodeep::dumb::DumbFuture as core::future::future::Future&gt;::poll (self=..., _cx=0x7fffffffd690) at src/dumb.rs:15
#1  0x00005555555ab3a3 in waytoodeep::main::{{closure}} () at src/main.rs:17
#2  0x00005555555adb29 in &lt;core::future::from_generator::GenFuture&lt;T&gt; as core::future::future::Future&gt;::poll (self=..., cx=0x7fffffffd690)
    at /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/mod.rs:80
#3  0x00005555555adaa0 in tokio::park::thread::CachedParkThread::block_on::{{closure}} ()
    at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/park/thread.rs:263
#4  0x00005555555b1742 in tokio::coop::with_budget::{{closure}} (cell=0x7ffff7c2c412)
    at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/coop.rs:106
#5  0x00005555555a9f58 in std::thread::local::LocalKey&lt;T&gt;::try_with (self=0x555555925fc0, f=...)
    at /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/local.rs:376
#6  0x00005555555a9e3d in std::thread::local::LocalKey&lt;T&gt;::with (self=0x555555925fc0, f=...)
    at /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/local.rs:352
#7  0x00005555555ad7c8 in tokio::coop::with_budget (budget=..., f=...)
    at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/coop.rs:99
#8  tokio::coop::budget (f=...) at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/coop.rs:76
#9  tokio::park::thread::CachedParkThread::block_on (self=0x7fffffffd7a0, f=...)
    at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/park/thread.rs:263
#10 0x00005555555abcc9 in tokio::runtime::enter::Enter::block_on (self=0x7fffffffd7f0, f=...)
    at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/runtime/enter.rs:151
#11 0x00005555555acf2e in tokio::runtime::thread_pool::ThreadPool::block_on (self=0x7fffffffd908, future=...)
    at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/runtime/thread_pool/mod.rs:71
#12 0x00005555555b0dfd in tokio::runtime::Runtime::block_on (self=0x7fffffffd900, future=...)
    at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/runtime/mod.rs:452
#13 0x00005555555aa807 in waytoodeep::main () at src/main.rs:20
(gdb)
</code></pre><p>æˆ‘ä»¬å†æ¬¡ä¸¢å¤±äº†é«˜äº®é¢œè‰²ï¼Œè¿™é‡Œå¯ä»¥çœ‹ä¸€ä¸‹ï¼šTODO</p>
<p>æ˜¯ä¸æ˜¯å¾ˆæ¼‚äº®ï¼Ÿ</p>
<p>ç°åœ¨è®©æˆ‘ä»¬å›åˆ°æ­£å¸¸æœ‰ç”¨çš„ä»£ç ï¼Œç§»é™¤æ‰€æœ‰å…³äºè‡ªå·±å®ç°çš„ future ä»£ç ï¼š <code>src/dumb.rs</code> å’Œ <code>mod dumb</code> ã€‚å¹¶ä½¿ç”¨ä¸€ä¸ªè·å– future æ›¿ä»£ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#75715e">#[tokio::main]</span>
<span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
    setup()<span style="color:#f92672">?</span>;

    info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Building that fetch future...&#34;</span>);
    <span style="color:#66d9ef">let</span> client <span style="color:#f92672">=</span> Client::new();
    <span style="color:#66d9ef">let</span> fut <span style="color:#f92672">=</span> fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_1);
    info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Awaiting that fetch future...&#34;</span>);
    fut.<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
    info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Done awaiting that fetch future&#34;</span>);

    Ok(())
}
</code></pre></div><pre><code class="language-nil" data-lang="nil">$ RUST_BACKTRACE=1 cargo run
   Compiling waytoodeep v0.1.0 (/home/amos/ftl/waytoodeep)
    Finished dev [unoptimized + debuginfo] target(s) in 2.99s
     Running `target/debug/waytoodeep`
Jul 25 17:51:49.281  INFO waytoodeep: Building that fetch future...
Jul 25 17:51:49.282  INFO waytoodeep: Awaiting that fetch future...
Jul 25 17:51:49.437  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&quot;text/html; charset=utf-8&quot;)
Jul 25 17:51:49.438  INFO waytoodeep: Done awaiting that fetch future
</code></pre><p>æœ‰ä¸¤ç§æ–¹å¼è€ƒè™‘æˆ‘ä»¬çš„å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯è¯­æ³•ç³–å±‚ï¼šä¹Ÿå°±æ˜¯ <code>async fn</code> ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fetch_thing</span>(client: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Client</span>, url: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span>) -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
    <span style="color:#66d9ef">let</span> res <span style="color:#f92672">=</span> client.get(url).send().<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>.error_for_status()<span style="color:#f92672">?</span>;
    info<span style="color:#f92672">!</span>(<span style="color:#f92672">%</span>url, content_type <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>res.headers().get(<span style="color:#e6db74">&#34;content-type&#34;</span>), <span style="color:#e6db74">&#34;Got a response!&#34;</span>);
    Ok(())
}
</code></pre></div><p>ç„¶åæ˜¯æ ¸å¿ƒå®ç°å±‚ï¼šä¸€ä¸ªæ™®é€šçš„ <code>fn</code> ä»…ç”¨æ¥è¿”å›ä¸€ä¸ª future å¯¹è±¡ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">use</span> std::future::Future;

<span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fetch_thing</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;a</span><span style="color:#f92672">&gt;</span>(
    client: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> Client,
    url: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">&#39;a</span> <span style="color:#66d9ef">str</span>,
) -&gt; <span style="color:#a6e22e">impl</span> Future<span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;&gt;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">&#39;a</span> {
    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">move</span> {
        <span style="color:#66d9ef">let</span> res <span style="color:#f92672">=</span> client.get(url).send().<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>.error_for_status()<span style="color:#f92672">?</span>;
        info<span style="color:#f92672">!</span>(<span style="color:#f92672">%</span>url, content_type <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>res.headers().get(<span style="color:#e6db74">&#34;content-type&#34;</span>), <span style="color:#e6db74">&#34;Got a response!&#34;</span>);
        Ok(())
    }
}
</code></pre></div><p>ç”±äºå€Ÿç”¨ <code>client</code> å’Œ <code>url</code> ï¼Œæ‰€ä»¥ <code>Future</code> å¯¹è±¡çš„å­˜æ´»æ—¶é—´ä¸èƒ½è¶…è¿‡ä¸¤è€…ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä¼šå°†ä¸Šé¢ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸå‘½åä¸º <code>'a</code> ï¼Œ
å¹¶ä¸”è¿”å›çš„å€¼ä¹Ÿæ˜¯ä»»æ„å®ç°äº† <code>Future</code> ï¼ˆé€šè¿‡ <code>Output</code> ï¼‰åŒæ—¶ç”Ÿå‘½å‘¨æœŸä¹Ÿæ˜¯ <code>'a</code> ã€‚</p>
<p>æ•´ä¸ª <code>async move {}</code> å¿«ä¹Ÿä»…ä»…æ˜¯â€œæ„å»ºçŠ¶æ€â€ &ndash; ç­‰äºä¸€ä¸ªå®ç°äº† <code>Future</code> çš„ç±»å‹ã€‚</p>
<p>æˆ‘ä»¬åªæ˜¯æ— æ³•å‘½åå®ƒã€‚</p>
<p>æˆ‘ä»¬åªèƒ½å°½é‡è·å–å®ƒçš„æè¿°ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">type_name_of</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>(_: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">T</span>) -&gt; <span style="color:#66d9ef">&amp;</span>&#39;static <span style="color:#66d9ef">str</span> {
    std::any::type_name::<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>()
}

<span style="color:#75715e">// in main
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#[tokio::main]</span>
<span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
    setup()<span style="color:#f92672">?</span>;

    info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Building that fetch future...&#34;</span>);
    <span style="color:#66d9ef">let</span> client <span style="color:#f92672">=</span> Client::new();
    <span style="color:#66d9ef">let</span> fut <span style="color:#f92672">=</span> fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_1);
    info<span style="color:#f92672">!</span>(
        type_name <span style="color:#f92672">=</span> type_name_of(<span style="color:#f92672">&amp;</span>fut),
        <span style="color:#e6db74">&#34;That fetch future has a type..&#34;</span>
    );
    info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Awaiting that fetch future...&#34;</span>);
    fut.<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
    info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Done awaiting that fetch future&#34;</span>);

    Ok(())
}
</code></pre></div><pre><code class="language-nil" data-lang="nil">$ cargo run
    Finished dev [unoptimized + debuginfo] target(s) in 0.05s
     Running `target/debug/waytoodeep`
Jul 25 18:00:39.774  INFO waytoodeep: Building that fetch future...
Jul 25 18:00:39.775  INFO waytoodeep: That fetch future has a type.. type_name=&quot;core::future::from_generator::GenFuture&lt;waytoodeep::fetch_thing::{{closure}}&gt;&quot;
Jul 25 18:00:39.775  INFO waytoodeep: Awaiting that fetch future...
Jul 25 18:00:39.882  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&quot;text/html; charset=utf-8&quot;)
Jul 25 18:00:39.882  INFO waytoodeep: Done awaiting that fetch future
</code></pre><p>ã€‚ã€‚ã€‚ä½†æ˜¯ç­‰ç­‰ï¼Œç”±äºæˆ‘ä»¬ä½¿ç”¨äº† <code>async</code> è¯­æ³•æ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ªç¼–è¯‘å™¨ç”Ÿæˆçš„ç±»å‹ã€‚æŸç§æ„ä¹‰ä¸Šæˆ‘ä»¬æ— æ³•å‘½åå®ƒä¹Ÿå°±æ„å‘³è¿™æˆ‘ä»¬æ— æ³•ç»‘å®šè¿™ä¸ªå¯¹è±¡ï¼Œæˆ–è€…ç¼–å†™ä¸€ä¸ªå‡½æ•°ä»…ä»…æ¥å—è¯¥ç±»å‹ã€‚</p>
<p>ä¸ºäº†è®©æˆ‘ä»¬è‡ªå·±ç›¸ä¿¡ future å¯¹è±¡åœ¨æˆ‘ä»¬çœŸæ­£è½®è¯¢å®ƒä¹‹å‰å®ƒä¸ä¼šåšä»»ä½•å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥æ‰“å¼€ <code>reqwest</code> çš„è°ƒè¯•æ—¥å¿—ï¼š</p>
<pre><code class="language-nil" data-lang="nil">$ RUST_LOG=info,reqwest=debug cargo run
   Compiling waytoodeep v0.1.0 (/home/amos/ftl/waytoodeep)
    Finished dev [unoptimized + debuginfo] target(s) in 3.07s
     Running `target/debug/waytoodeep`
Jul 25 18:05:07.384  INFO waytoodeep: Building that fetch future...
Jul 25 18:05:07.385  INFO waytoodeep: That fetch future has a type.. type_name=&quot;core::future::from_generator::GenFuture&lt;waytoodeep::fetch_thing::{{closure}}&gt;&quot;
Jul 25 18:05:07.385  INFO waytoodeep: Awaiting that fetch future...
Jul 25 18:05:07.385 DEBUG reqwest::connect: starting new connection: https://fasterthanli.me/
Jul 25 18:05:07.503 DEBUG reqwest::async_impl::client: response '200 OK' for https://fasterthanli.me/articles/whats-in-the-box
Jul 25 18:05:07.503  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&quot;text/html; charset=utf-8&quot;)
Jul 25 18:05:07.503  INFO waytoodeep: Done awaiting that fetch future
</code></pre><p>ç”šè‡³å¯¹äºæ¯ä¸€ä¸ªåŒ…ï¼ˆcrateï¼‰ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥é€šè¿‡ç›‘å¬ <a href="https://lib.rs/crates/hyper">hyper</a> å’Œ <a href="https://lib.rs/crates/h2">h2</a> æ¥è§‚å¯Ÿï¼š</p>
<pre><code class="language-nil" data-lang="nil">$ RUST_LOG=debug cargo run
    Finished dev [unoptimized + debuginfo] target(s) in 0.04s
     Running `target/debug/waytoodeep`
Jul 25 18:05:59.973  INFO waytoodeep: Building that fetch future...
Jul 25 18:05:59.973  INFO waytoodeep: That fetch future has a type.. type_name=&quot;core::future::from_generator::GenFuture&lt;waytoodeep::fetch_thing::{{closure}}&gt;&quot;
Jul 25 18:05:59.973  INFO waytoodeep: Awaiting that fetch future...
Jul 25 18:05:59.974 DEBUG reqwest::connect: starting new connection: https://fasterthanli.me/
Jul 25 18:05:59.974 DEBUG hyper::client::connect::dns: resolving host=&quot;fasterthanli.me&quot;
Jul 25 18:05:59.989 DEBUG hyper::client::connect::http: connecting to 172.67.196.144:443
Jul 25 18:06:00.000 DEBUG hyper::client::connect::http: connected to 172.67.196.144:443
Jul 25 18:06:00.000 DEBUG rustls::client::hs: No cached session for DNSNameRef(&quot;fasterthanli.me&quot;)
Jul 25 18:06:00.000 DEBUG rustls::client::hs: Not resuming any session
Jul 25 18:06:00.016 DEBUG rustls::client::hs: Using ciphersuite TLS13_CHACHA20_POLY1305_SHA256
Jul 25 18:06:00.016 DEBUG rustls::client::tls13: Not resuming
Jul 25 18:06:00.017 DEBUG rustls::client::tls13: TLS1.3 encrypted extensions: [ServerNameAck, Protocols([PayloadU8([104, 50])])]
Jul 25 18:06:00.017 DEBUG rustls::client::hs: ALPN protocol is Some(b&quot;h2&quot;)
Jul 25 18:06:00.018 DEBUG h2::client: binding client connection
Jul 25 18:06:00.018 DEBUG h2::client: client connection bound
Jul 25 18:06:00.018 DEBUG h2::codec::framed_write: send frame=Settings { flags: (0x0), enable_push: 0, initial_window_size: 2097152, max_frame_size: 16384 }
Jul 25 18:06:00.019 DEBUG Connection{peer=Client}: h2::codec::framed_write: send frame=WindowUpdate { stream_id: StreamId(0), size_increment: 5177345 }
Jul 25 18:06:00.019 DEBUG hyper::client::pool: pooling idle connection for (&quot;https&quot;, fasterthanli.me)
Jul 25 18:06:00.020 DEBUG Connection{peer=Client}: h2::codec::framed_write: send frame=Headers { stream_id: StreamId(1), flags: (0x5: END_HEADERS | END_STREAM) }
Jul 25 18:06:00.029 DEBUG Connection{peer=Client}: rustls::client::tls13: Ticket saved
Jul 25 18:06:00.029 DEBUG Connection{peer=Client}: rustls::client::tls13: Ticket saved
Jul 25 18:06:00.029 DEBUG Connection{peer=Client}: h2::codec::framed_read: received frame=Settings { flags: (0x0), max_concurrent_streams: 256, initial_window_size: 65536, max_frame_size: 16777215 }
Jul 25 18:06:00.030 DEBUG Connection{peer=Client}: h2::codec::framed_write: send frame=Settings { flags: (0x1: ACK) }
Jul 25 18:06:00.030 DEBUG Connection{peer=Client}: h2::codec::framed_read: received frame=WindowUpdate { stream_id: StreamId(0), size_increment: 2147418112 }
Jul 25 18:06:00.041 DEBUG Connection{peer=Client}: h2::codec::framed_read: received frame=Settings { flags: (0x1: ACK) }
Jul 25 18:06:00.041 DEBUG Connection{peer=Client}: h2::proto::settings: received settings ACK; applying Settings { flags: (0x0), enable_push: 0, initial_window_size: 2097152, max_frame_size: 16384 }
Jul 25 18:06:00.120 DEBUG Connection{peer=Client}: h2::codec::framed_read: received frame=Headers { stream_id: StreamId(1), flags: (0x4: END_HEADERS) }
Jul 25 18:06:00.120 DEBUG Connection{peer=Client}: h2::codec::framed_read: received frame=Data { stream_id: StreamId(1) }
Jul 25 18:06:00.121 DEBUG reqwest::async_impl::client: response '200 OK' for https://fasterthanli.me/articles/whats-in-the-box
Jul 25 18:06:00.121  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&quot;text/html; charset=utf-8&quot;)
Jul 25 18:06:00.121  INFO waytoodeep: Done awaiting that fetch future
Jul 25 18:06:00.121 DEBUG Connection{peer=Client}: h2::codec::framed_read: received frame=Data { stream_id: StreamId(1) }
Jul 25 18:06:00.122 DEBUG Connection{peer=Client}: h2::codec::framed_write: send frame=Reset { stream_id: StreamId(1), error_code: CANCEL }
Jul 25 18:06:00.122 DEBUG Connection{peer=Client}: h2::codec::framed_write: send frame=GoAway { error_code: NO_ERROR, last_stream_id: StreamId(0) }
Jul 25 18:06:00.122 DEBUG Connection{peer=Client}: h2::proto::connection: Connection::poll; connection error error=NO_ERROR
Jul 25 18:06:00.122 DEBUG Connection{peer=Client}: rustls::session: Sending warning alert CloseNotify
</code></pre><blockquote>
<p>ä¸Šé¢å‡ºç°äº† rustlsï¼Œå¹¶ä¸”ä½¿ç”¨äº† TLS 1.3ï¼Œä½œè€…åšè¿‡<a href="https://www.youtube.com/watch?v=YHIiVsFybLA">ä¸€æœŸè§†é¢‘</a>ä»‹ç»è¿‡ TLS 1.3ã€‚</p>
</blockquote>
<p>è¿™äº›åº”è¯¥è¶³å¤Ÿè¯´æœä½ ï¼Œé™¤éä½ å€¼ç›¸ä¿¡å†…æ ¸æ‰€è¯´çš„ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬çœ‹çœ‹è°ƒç”¨å †æ ˆåªä¸ºäº†æ›´åŠ ç¡®å®šã€‚</p>
<p>æˆ‘ä»¬åœ¨ <code>await</code> future å¯¹è±¡ä¹‹å‰å¢åŠ ä¸€ç§’é’Ÿçš„ä¼‘çœ ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">use</span> tokio::time::sleep;
<span style="color:#66d9ef">use</span> std::time::Duration;

<span style="color:#75715e">#[tokio::main]</span>
<span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
    setup()<span style="color:#f92672">?</span>;

    info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Building that fetch future...&#34;</span>);
    <span style="color:#66d9ef">let</span> client <span style="color:#f92672">=</span> Client::new();
    <span style="color:#66d9ef">let</span> fut <span style="color:#f92672">=</span> fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_1);
    info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Sleeping for a bit...&#34;</span>);
    sleep(Duration::from_secs(<span style="color:#ae81ff">1</span>)).<span style="color:#66d9ef">await</span>;
    info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Awaiting that fetch future...&#34;</span>);
    fut.<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
    info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Done awaiting that fetch future&#34;</span>);

    Ok(())
}
</code></pre></div><blockquote>
<p>$ cargo build &amp;&amp; strace -e &lsquo;connect&rsquo; ./target/debug/waytoodeep
Compiling waytoodeep v0.1.0 (/home/amos/ftl/waytoodeep)
Finished dev [unoptimized + debuginfo] target(s) in 3.13s
Jul 25 18:09:36.595  INFO waytoodeep: Building that fetch future&hellip;
Jul 25 18:09:36.596  INFO waytoodeep: Sleeping for a bit&hellip;
Jul 25 18:09:37.599  INFO waytoodeep: Awaiting that fetch future&hellip;
connect(9, {sa_family=AF_INET, sin_port=htons(443), sin_addr=inet_addr(&ldquo;104.21.92.169&rdquo;)}, 16) = -1 EINPROGRESS (Operation now in progress)
Jul 25 18:09:37.720  INFO waytoodeep: Got a response! url=<a href="https://fasterthanli.me/articles/whats-in-the-box">https://fasterthanli.me/articles/whats-in-the-box</a> content_type=Some(&ldquo;text/html; charset=utf-8&rdquo;)
Jul 25 18:09:37.721  INFO waytoodeep: Done awaiting that fetch future
<del>+</del> exited with 0 <del>+</del></p>
</blockquote>

</article>



</body>

</html>
