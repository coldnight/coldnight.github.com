<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Understanding Rust futures by going way too deep :: Taking Smart Notes With Org-mode</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="tags: Translate,Rust,Tokio åŸæ–‡é“¾æ¥ï¼šUnderstanding Rust futures by going way too deepã€‚
è¯‘è€…æ³¨ï¼šåŸæ–‡å¤§é‡çš„å¼•å…¥äº†æœ‰è¶£çš„å¯¹è¯ï¼Œè¿«äºæ’ç‰ˆé—®é¢˜è¿™é‡Œä¸è¿›è¡Œç¿»è¯‘ï¼Œå¿…è¦çš„å¯¹è¯é€šè¿‡å¼•ç”¨å—æ¥è§£é‡Šã€‚
æ·±å…¥ç†è§£ Rust future ç”¨ Rust futureï¼å°±æ˜¯è¿™ä¹ˆç®€å•ï¼ç›´åˆ°æˆ‘ä»¬å‘ç°å¹¶éå¦‚æ­¤ã€‚æ‰€ä»¥æˆ‘ä»¬å…ˆæ¢ç´¢ç®€å•çš„éƒ¨åˆ†ï¼Œç„¶åç»§ç»­æ¢ç´¢å›°éš¾éƒ¨åˆ†è€Œä¸æ˜¯ç­‰å®ƒæ…¢æ…¢é è¿‘æˆ‘ä»¬ã€‚
èµ·æ­¥ Choo choo here comes the easy part ğŸš‚ğŸ’¨
æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®ï¼š
$ cargo new waytoodeep Created binary (application) `waytoodeep` package æˆ‘ä»¬éœ€è¦å®‰è£… cargo-edit å¦‚æœä¹‹å‰æ²¡æœ‰å®‰è£…è¿‡çš„è¯ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥ç›´æ¥ cargo add ï¼š
$ cargo install cargo-edit Updating crates.io index Downloaded cargo-edit v0.7.0 Downloaded 1 crate (57.6 KB) in 0.47s Ignored package `cargo-edit v0.7.0` is already installed, use --force to override å› ä¸º cargo-edit å¾ˆæ–¹ä¾¿ï¼Œæ‰€ä»¥ä½ å¯èƒ½å·²ç»å®‰è£…è¿‡å®ƒã€‚éƒ¨åˆ†è¯»è€…ä¼šæ„Ÿåˆ°å›°æƒ‘æ˜¯å› ä¸ºåƒ cargo new, cargo build, cargo test, cargo run ç­‰å­å‘½ä»¤éƒ½å†…ç½®åœ¨ cargo ä¸­ï¼Œ ä½†æ˜¯ cargo add æ²¡æœ‰ã€‚" />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://www.linuxzen.com/notes/articles/20210726105711-understanding_rust_futures_by_going_way_too_deep/" />




<link rel="stylesheet" href="https://www.linuxzen.com/notes/assets/style.css">






<link rel="apple-touch-icon" href="https://www.linuxzen.com/notes/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://www.linuxzen.com/notes/img/favicon/orange.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Understanding Rust futures by going way too deep">
<meta property="og:description" content="tags: Translate,Rust,Tokio åŸæ–‡é“¾æ¥ï¼šUnderstanding Rust futures by going way too deepã€‚
è¯‘è€…æ³¨ï¼šåŸæ–‡å¤§é‡çš„å¼•å…¥äº†æœ‰è¶£çš„å¯¹è¯ï¼Œè¿«äºæ’ç‰ˆé—®é¢˜è¿™é‡Œä¸è¿›è¡Œç¿»è¯‘ï¼Œå¿…è¦çš„å¯¹è¯é€šè¿‡å¼•ç”¨å—æ¥è§£é‡Šã€‚
æ·±å…¥ç†è§£ Rust future ç”¨ Rust futureï¼å°±æ˜¯è¿™ä¹ˆç®€å•ï¼ç›´åˆ°æˆ‘ä»¬å‘ç°å¹¶éå¦‚æ­¤ã€‚æ‰€ä»¥æˆ‘ä»¬å…ˆæ¢ç´¢ç®€å•çš„éƒ¨åˆ†ï¼Œç„¶åç»§ç»­æ¢ç´¢å›°éš¾éƒ¨åˆ†è€Œä¸æ˜¯ç­‰å®ƒæ…¢æ…¢é è¿‘æˆ‘ä»¬ã€‚
èµ·æ­¥ Choo choo here comes the easy part ğŸš‚ğŸ’¨
æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®ï¼š
$ cargo new waytoodeep Created binary (application) `waytoodeep` package æˆ‘ä»¬éœ€è¦å®‰è£… cargo-edit å¦‚æœä¹‹å‰æ²¡æœ‰å®‰è£…è¿‡çš„è¯ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥ç›´æ¥ cargo add ï¼š
$ cargo install cargo-edit Updating crates.io index Downloaded cargo-edit v0.7.0 Downloaded 1 crate (57.6 KB) in 0.47s Ignored package `cargo-edit v0.7.0` is already installed, use --force to override å› ä¸º cargo-edit å¾ˆæ–¹ä¾¿ï¼Œæ‰€ä»¥ä½ å¯èƒ½å·²ç»å®‰è£…è¿‡å®ƒã€‚éƒ¨åˆ†è¯»è€…ä¼šæ„Ÿåˆ°å›°æƒ‘æ˜¯å› ä¸ºåƒ cargo new, cargo build, cargo test, cargo run ç­‰å­å‘½ä»¤éƒ½å†…ç½®åœ¨ cargo ä¸­ï¼Œ ä½†æ˜¯ cargo add æ²¡æœ‰ã€‚" />
<meta property="og:url" content="https://www.linuxzen.com/notes/articles/20210726105711-understanding_rust_futures_by_going_way_too_deep/" />
<meta property="og:site_name" content="Taking Smart Notes With Org-mode" />

  
    <meta property="og:image" content="https://www.linuxzen.com/notes/img/favicon/orange.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2021-07-26 10:57:00 &#43;0800 &#43;0800" />












</head>
<body class="orange">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="https://www.linuxzen.com/notes/">
  <div class="logo">
    Terminal
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/notes/projects/"> Projects in Progress</a></li>
        
      
        
          <li><a href="/notes/articles/">Articles</a></li>
        
      
        
          <li><a href="/notes/flashcards/">Flashcards</a></li>
        
      
        
          <li><a href="/notes/notes/">Notes</a></li>
        
      
        
          <li><a href="/notes/topics/">Topics</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/notes/projects/"> Projects in Progress</a></li>
      
    
      
        <li><a href="/notes/articles/">Articles</a></li>
      
    
      
        <li><a href="/notes/flashcards/">Flashcards</a></li>
      
    
      
        <li><a href="/notes/notes/">Notes</a></li>
      
    
      
        <li><a href="/notes/topics/">Topics</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://www.linuxzen.com/notes/articles/20210726105711-understanding_rust_futures_by_going_way_too_deep/">Understanding Rust futures by going way too deep</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2021-07-26 
      </span>
    
    
    <span class="post-author">:: [Gray King]</span>
    
  </div>

  

  

  

  <div class="post-content"><div>
        <ul>
<li>tags: <a href="/notes/topics/20200309112105_translate/">Translate</a>,<a href="/notes/topics/20200307191429_rust/">Rust</a>,<a href="/notes/notes/20210808083146-tokio/">Tokio</a></li>
</ul>
<p>åŸæ–‡é“¾æ¥ï¼š<a href="https://fasterthanli.me/articles/understanding-rust-futures-by-going-way-too-deep">Understanding Rust futures by going way too deep</a>ã€‚</p>
<p>è¯‘è€…æ³¨ï¼šåŸæ–‡å¤§é‡çš„å¼•å…¥äº†æœ‰è¶£çš„å¯¹è¯ï¼Œè¿«äºæ’ç‰ˆé—®é¢˜è¿™é‡Œä¸è¿›è¡Œç¿»è¯‘ï¼Œå¿…è¦çš„å¯¹è¯é€šè¿‡å¼•ç”¨å—æ¥è§£é‡Šã€‚</p>
<h2 id="æ·±å…¥ç†è§£-rust-future">æ·±å…¥ç†è§£ Rust future<a href="#æ·±å…¥ç†è§£-rust-future" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>ç”¨ Rust futureï¼å°±æ˜¯è¿™ä¹ˆç®€å•ï¼ç›´åˆ°æˆ‘ä»¬å‘ç°å¹¶éå¦‚æ­¤ã€‚æ‰€ä»¥æˆ‘ä»¬å…ˆæ¢ç´¢ç®€å•çš„éƒ¨åˆ†ï¼Œç„¶åç»§ç»­æ¢ç´¢å›°éš¾éƒ¨åˆ†è€Œä¸æ˜¯ç­‰å®ƒæ…¢æ…¢é è¿‘æˆ‘ä»¬ã€‚</p>
<h2 id="èµ·æ­¥">èµ·æ­¥<a href="#èµ·æ­¥" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<blockquote>
<p>Choo choo here comes the easy part ğŸš‚ğŸ’¨</p>
</blockquote>
<p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®ï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo new waytoodeep
	 Created binary (application) `waytoodeep` package
</code></pre><p>æˆ‘ä»¬éœ€è¦å®‰è£… <code>cargo-edit</code> å¦‚æœä¹‹å‰æ²¡æœ‰å®‰è£…è¿‡çš„è¯ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥ç›´æ¥ <code>cargo add</code> ï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo install cargo-edit
	Updating crates.io index
  Downloaded cargo-edit v0.7.0
  Downloaded 1 crate (57.6 KB) in 0.47s
	 Ignored package `cargo-edit v0.7.0` is already installed, use --force to override
</code></pre><blockquote>
<p>å› ä¸º <code>cargo-edit</code> å¾ˆæ–¹ä¾¿ï¼Œæ‰€ä»¥ä½ å¯èƒ½å·²ç»å®‰è£…è¿‡å®ƒã€‚éƒ¨åˆ†è¯»è€…ä¼šæ„Ÿåˆ°å›°æƒ‘æ˜¯å› ä¸ºåƒ
<code>cargo new</code>, <code>cargo build</code>, <code>cargo test</code>, <code>cargo run</code> ç­‰å­å‘½ä»¤éƒ½å†…ç½®åœ¨ cargo ä¸­ï¼Œ
ä½†æ˜¯ <code>cargo add</code> æ²¡æœ‰ã€‚</p>
<p>å®é™…ä¸Šï¼Œæœ‰ä¸€å¤§å †åƒè¿™æ ·çš„åŒ…ï¼Œå¦‚ <a href="https://lib.rs/crates/cargo-hack">cargo-hack</a>,<a href="https://lib.rs/crates/cargo-udeps">cargo-udeps</a>,<a href="https://lib.rs/crates/cargo-expand">cargo-expand</a>&hellip;<a href="https://lib.rs/keywords/cargo">ç­‰ç­‰</a>ã€‚</p>
</blockquote>
<p>ç„¶åæˆ‘ä»¬éœ€è¦é€‰æ‹©ä¸€ä¸ªã€Œå¼‚æ­¥è¿è¡Œæ—¶ã€ï¼ˆasync runtimeï¼‰ï¼Œå› ä¸ºè¿™äº› future å¯¹è±¡ä¸ä¼šè½®è¯¢ï¼ˆpollï¼‰è‡ªå·±ã€‚ã€‚ã€‚
æˆ‘ä»¬æ¯«æ— ç†ç”±çš„é€‰æ‹© tokioï¼Œå”¯ä¸€çš„åŸå› æ˜¯ï¼šè¿‡å»å‡ ä¸ªæœˆæˆ‘ä¸€ç›´åœ¨ç”¨å®ƒã€‚</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo add tokio@1.9.0 --features full
	Updating &#39;https://github.com/rust-lang/crates.io-index&#39; index
	  Adding tokio v1.9.0 to dependencies with features: [&#34;full&#34;]
</code></pre><p>ç„¶åæˆ‘ä»¬ä¿®æ”¹ <code>main</code> å‡½æ•°ä½¿ç”¨ tokio é»˜è®¤æ‰§è¡Œå™¨ï¼ˆexecutorï¼‰ï¼ˆ <code>cargo new</code> ä¸ºæˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ª <code>main</code> å‡½æ•°ï¼Œä½†æ˜¯è¿™é‡Œå¹¶ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼‰ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// in `src/main.rs`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	println!(<span style="color:#e6db74">&#34;Hello from a (so far completely unnecessary) async runtime&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo run                                                                                                                                                                                          3s 209ms
   Compiling waytoodeep v0.1.0 (/Users/wh/codes/rust/waytoodeep)
	Finished dev [unoptimized + debuginfo] target(s) in 3.47s
	 Running `target/debug/waytoodeep`
Hello from a (so far completely unnecessary) async runtime
</code></pre><p>é…·ï¼</p>
<p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬æ·»åŠ å…¶ä»–ä¸€äº›æˆ‘å–œæ¬¢åœ¨æˆ‘çš„é¡¹ç›®ä¸­ä½¿ç”¨çš„å¥½ä¸œè¥¿ã€‚</p>
<p>é¦–å…ˆï¼Œå¯¹äºé”™è¯¯å¤„ç† - æˆ‘ä»¬ç¼–å†™ç¨‹åºå°±éœ€è¦å¤„ç†ä¸€å †ä¸åŒåº“é‡Œä¸åŒçš„é”™è¯¯ç±»å‹ï¼Œå¦‚æœèƒ½é€šè¿‡ä¸€ä¸ªç±»å‹ç»Ÿä¸€å®ƒä»¬å°±ä¼šéå¸¸æ•´æ´ã€‚</p>
<p><a href="https://lib.rs/crates/eyre">eyre</a> å¯ä»¥èµ‹äºˆæˆ‘ä»¬è¿™äº›ï¼ˆå°±åƒ <code>anyhow</code> ï¼‰ï¼</p>
<p>å¹¶ä¸”å› ä¸ºæˆ‘å–œæ¬¢æ¼‚äº®çš„é¢œè‰²æˆ‘å°†ä½¿ç”¨ <a href="https://lib.rs/crates/color-eyre">color-eyre</a>ã€‚</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo add color-eyre@0.5.11
	Updating &#39;https://github.com/rust-lang/crates.io-index&#39; index
	  Adding color-eyre v0.5.11 to dependencies
</code></pre><p>ç°åœ¨æˆ‘ä»¬éœ€è¦å®‰è£… <code>color-eyre</code> ä½œä¸ºé»˜è®¤çš„å´©æºƒï¼ˆpanicï¼‰å¤„ç†å™¨ï¼Œæˆ‘æ‚„æ‚„ä¿®æ”¹äº†ä¸€äº›ç¯å¢ƒå˜é‡æ¥é»˜è®¤è¾“å‡ºè°ƒç”¨å †æ ˆï¼ˆbacktracksï¼‰ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> color_eyre::Report;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	setup()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	println!(<span style="color:#e6db74">&#34;Hello from a (so far completely unnecessary) async runtime&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">setup</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> std::env::var(<span style="color:#e6db74">&#34;RUST_LIB_BACKTRACE&#34;</span>).is_err() {
</span></span><span style="display:flex;"><span>		std::env::set_var(<span style="color:#e6db74">&#34;RUST_LIB_BACKTRACE&#34;</span>, <span style="color:#e6db74">&#34;1&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	color_eyre::install()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo run
	Finished dev [unoptimized + debuginfo] target(s) in 0.02s
	 Running `target/debug/waytoodeep`
Hello from a (so far completely unnecessary) async runtime
</code></pre><p>å¾ˆå¥½ï¼ç°åœ¨å¦‚æœæˆ‘ä»¬æŸå¤„å‡ºç°äº†ä¸€ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å®Œæ•´çš„å †æ ˆè·Ÿè¸ªï¼Œå°±åƒä¸‹é¢è¿™æ ·ï¼š
<img src="https://fasterthanli.me/content/articles/understanding-rust-futures-by-going-way-too-deep/assets/color-eyre.78931d5fc80841f6.webp" alt=""></p>
<p>æœ€åï¼Œå› ä¸ºæˆ‘å–œæ¬¢ç»“æ„åŒ–æ—¥å¿—ï¼Œè®©æˆ‘ä»¬æ·»åŠ  <a href="https://lib.rs/crates/tracing">tracing</a> ç„¶åé€šè¿‡æ¼‚äº®çš„é¢œè‰²æ‰“å°å®ƒä»¬ï¼Œè®©æˆ‘ä»¬æ·»åŠ  <a href="https://lib.rs/crates/tracing-subscriber">tracing-subscriber</a>.</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo add tracing@0.1.26 tracing-subscriber@0.2.19
	Updating &#39;https://github.com/rust-lang/crates.io-index&#39; index
	  Adding tracing v0.1.26 to dependencies
	  Adding tracing-subscriber v0.2.19 to dependencies
</code></pre><p>æˆ‘ä»¬å·²ç»æœ‰ä¸€ä¸ª <code>setup</code> å‡½æ•°ï¼Œæ‰€ä»¥ç›´æ¥åœ¨é‚£é‡Œå®‰è£… <code>tracing-subscriber</code>.. ç„¶åæˆ‘ä»¬å°† <code>println!</code> æ”¹æˆ <code>info!</code> ï¼
ç„¶åï¼Œä¸ºäº†æ¼”ç¤ºå¦‚ä½•è®¾ç½®è®©æˆ‘ä»¬å†æ¬¡ä¿®æ”¹ä¸€äº›ç¯å¢ƒå˜é‡ï¼šå¯¹æ‰€æœ‰åŒ…ï¼ˆcratesï¼‰é»˜è®¤ <code>info</code> æ—¥å¿—çº§åˆ«ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> color_eyre::Report;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> tracing::info;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> tracing_subscriber::EnvFilter;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	setup()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Hello from a comfy nest we&#39;ve made for ourselves&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">setup</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> std::env::var(<span style="color:#e6db74">&#34;RUST_LIB_BACKTRACE&#34;</span>).is_err() {
</span></span><span style="display:flex;"><span>		std::env::set_var(<span style="color:#e6db74">&#34;RUST_LIB_BACKTRACE&#34;</span>, <span style="color:#e6db74">&#34;1&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	color_eyre::install()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> std::env::var(<span style="color:#e6db74">&#34;RUST_LOG&#34;</span>).is_err() {
</span></span><span style="display:flex;"><span>		std::env::set_var(<span style="color:#e6db74">&#34;RUST_LOG&#34;</span>, <span style="color:#e6db74">&#34;info&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	tracing_subscriber::fmt::fmt()
</span></span><span style="display:flex;"><span>		.with_env_filter(EnvFilter::from_default_env())
</span></span><span style="display:flex;"><span>		.init();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo run
	Finished dev [unoptimized + debuginfo] target(s) in 0.02s
	 Running `target/debug/waytoodeep`
Jul 25 17:03:46.993  INFO waytoodeep: Hello from a comfy nest we&#39;ve made for ourselves
</code></pre><p>å¥½äº†ï¼Œæˆ‘ä»¬å‡†å¤‡å¥½åšä¸€äº›æœ‰ç”¨çš„äº‹æƒ…äº†ã€‚</p>
<h3 id="åšä¸€äº›æœ‰ç”¨çš„äº‹æƒ…">åšä¸€äº›æœ‰ç”¨çš„äº‹æƒ…<a href="#åšä¸€äº›æœ‰ç”¨çš„äº‹æƒ…" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>å½“å†³å®šåœ¨å’–å•¡é—´éš™é˜…è¯»å“ªä¸€ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œäººä»¬é€šå¸¸åŒæ—¶æ‰“å¼€å‡ ä¸ªç½‘ç«™ï¼Œç„¶åè¯»æœ€å…ˆåŠ è½½å‡ºæ¥çš„é‚£ä¸€ç¯‡ã€‚</p>
<p>äº‹å®å¦‚æ­¤ã€‚ä½ å¯ä»¥å¼•ç”¨æˆ‘çš„è¯ï¼Œè°ä¼šå»éªŒè¯å‘¢ï¼Ÿæ¯•ç«Ÿè¿™å¬èµ·æ¥éœ€è¦å¾ˆå¤šå·¥ä½œã€‚</p>
<p>æ‰€ä»¥è®©æˆ‘ä»¬æ¥ç¼–å†™ä¸€ä¸ªç¨‹åºåšç›¸åŒçš„äº‹æƒ…ã€‚</p>
<p>è®©æˆ‘ä»¬å¼•å…¥ <a href="https://lib.rs/crates/reqwest">reqwest</a> &ndash; å°½ç®¡æˆ‘ä¸å–œæ¬¢å®ƒçš„ APIï¼Œä½†å®ƒä¼šå¾ˆå¥½çš„å®Œæˆæ¥ä¸‹æ¥çš„å·¥ä½œã€‚</p>
<p>åŒæ—¶ï¼Œå› ä¸º <a href="https://www.openssl.org/news/vulnerabilities.html">screw OpenSSL</a> æˆ‘ä»¬å°†æ ‡è®° reqwest ä½¿ç”¨ <a href="https://lib.rs/crates/rustls">rustls</a>ï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo add reqwest@0.11.4 --no-default-features --features rustls-tls
	Updating &#39;https://github.com/rust-lang/crates.io-index&#39; index
	  Adding reqwest v0.11.4 to dependencies with features: [&#34;rustls-tls&#34;]
</code></pre><p>æˆ‘ä»¬å‡†å¤‡å¥½å‘é€ä¸€ä¸ªè¯·æ±‚äº†ï¼</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> color_eyre::Report;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> tracing::info;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> tracing_subscriber::EnvFilter;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> reqwest::Client;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	setup()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Hello from a comfy nest we&#39;ve made for ourselves&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> client <span style="color:#f92672">=</span> Client::new();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://fasterthanli.me&#34;</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// this will turn non-200 HTTP status codes into rust errors,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// so the first `?` propagates &#34;we had a connection problem&#34; and
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// the second `?` propagates &#34;we had a chat with the server and they
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// were not pleased&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> res <span style="color:#f92672">=</span> client.get(url).send().<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>.error_for_status()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#f92672">%</span>url, content_type <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>res.headers().get(<span style="color:#e6db74">&#34;content-type&#34;</span>), <span style="color:#e6db74">&#34;Got a response!&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">setup</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> std::env::var(<span style="color:#e6db74">&#34;RUST_LIB_BACKTRACE&#34;</span>).is_err() {
</span></span><span style="display:flex;"><span>		std::env::set_var(<span style="color:#e6db74">&#34;RUST_LIB_BACKTRACE&#34;</span>, <span style="color:#e6db74">&#34;1&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	color_eyre::install()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> std::env::var(<span style="color:#e6db74">&#34;RUST_LOG&#34;</span>).is_err() {
</span></span><span style="display:flex;"><span>		std::env::set_var(<span style="color:#e6db74">&#34;RUST_LOG&#34;</span>, <span style="color:#e6db74">&#34;info&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	tracing_subscriber::fmt::fmt()
</span></span><span style="display:flex;"><span>		.with_env_filter(EnvFilter::from_default_env())
</span></span><span style="display:flex;"><span>		.init();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å‡ºå‘äº†ï¼</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">cargo run
   Compiling waytoodeep v0.1.0 (/Users/wh/codes/rust/waytoodeep)
	Finished dev [unoptimized + debuginfo] target(s) in 7.16s
	 Running `target/debug/waytoodeep`
Jul 26 16:50:57.778  INFO waytoodeep: Hello from a comfy nest we&#39;ve made for ourselves
Jul 26 16:50:59.090  INFO waytoodeep: Got a response! url=https://fasterthanli.me content_type=Some(&#34;text/html; charset=utf-8&#34;)
</code></pre><p>è¿™å°±æ˜¯æˆ‘æ‰€è¯´çš„ã€Œç»“æ„åŒ–æ—¥å¿—ã€ã€‚å—¯ï¼Œå…¶ä¸­çš„ä¸€éƒ¨åˆ†ã€‚è®©æˆ‘ä»¬çœ‹ä¸‹è¿™è¡Œä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>info<span style="color:#f92672">!</span>(<span style="color:#f92672">%</span>url, content_type <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>res.headers().get(<span style="color:#e6db74">&#34;content-type&#34;</span>), <span style="color:#e6db74">&#34;Got a response!&#34;</span>);
</span></span></code></pre></div><p>æˆ‘ä»¬è¾“å‡ºæ¥ä¸€ä¸ªæ¶ˆæ¯ï¼š <code>Got a response!</code> ï¼Œä¸€ä¸ªåä¸º <code>url</code> çš„æ ‡ç­¾ï¼šå€¼ä¸ºå˜é‡ <code>url</code> çš„ <a href="https://doc.rust-lang.org/stable/std/fmt/trait.Display.html">Display</a> æ ¼å¼ï¼Œ
ä¸€ä¸ªåä¸º <code>content_type</code> çš„æ ‡ç­¾ï¼šå€¼ä¸ºè¡¨è¾¾å¼çš„ <a href="https://doc.rust-lang.org/stable/std/fmt/trait.Debug.html">Debug</a> æ ¼å¼ã€‚</p>
<p>å°±æ˜¯è¿™ä¹ˆç®€å•ï¼ <code>name = %value</code> è¾“å‡º <code>Display</code> ï¼Œ <code>name = ?value</code> è¾“å‡º <code>Debug</code> ã€‚</p>
<p>å½“ç„¶ï¼Œè¿˜æœ‰éå¸¸æ£’çš„è·¨åº¦ï¼ˆspansï¼‰ï¼Œé‡ç‚¹æ˜¯ä½ å¯ä»¥å°†å®ƒä»¬å‘é€åˆ° APMï¼ˆAppliation Performance Monitoringï¼‰ï¼Œæ¯”å¦‚ Datadog æˆ–è€… Honeycomb ç­‰ï¼Œä½†æ˜¯è¿™ä¸æ˜¯ä¸€ç¯‡å…³äºè·Ÿè¸ªçš„æ–‡ç« ã€‚</p>
<p>ä¸ºäº†ä¸¾ä¾‹è¯´æ˜ï¼Œå¦‚æœæˆ‘ä»¬å®‰è£…ä¸€ä¸ª JSON çš„ tracing subscriberï¼Œæˆ‘ä»¬å°†è·å¾—å¦‚ä¸‹å†…å®¹ï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo run
   Compiling waytoodeep v0.1.0 (/home/amos/ftl/waytoodeep)
	Finished dev [unoptimized + debuginfo] target(s) in 3.09s
	 Running `target/debug/waytoodeep`
{&#34;timestamp&#34;:&#34;Jul 25 17:17:21.531&#34;,&#34;level&#34;:&#34;INFO&#34;,&#34;fields&#34;:{&#34;message&#34;:&#34;Hello from a comfy nest we&#39;ve made for ourselves&#34;},&#34;target&#34;:&#34;waytoodeep&#34;}
{&#34;timestamp&#34;:&#34;Jul 25 17:17:21.709&#34;,&#34;level&#34;:&#34;INFO&#34;,&#34;fields&#34;:{&#34;message&#34;:&#34;Got a response!&#34;,&#34;url&#34;:&#34;https://fasterthanli.me&#34;,&#34;content_type&#34;:&#34;Some(\&#34;text/html; charset=utf-8\&#34;)&#34;},&#34;target&#34;:&#34;waytoodeep&#34;}
</code></pre><p>è¿™åº”è¯¥è¶³ä»¥æ¿€èµ·ä½ çš„å…´è¶£ã€‚</p>
<h3 id="åŒæ—¶è·å–ä¸¤ä¸ªåœ°å€">åŒæ—¶è·å–ä¸¤ä¸ªåœ°å€<a href="#åŒæ—¶è·å–ä¸¤ä¸ªåœ°å€" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>ç°åœ¨è®©æˆ‘ä»¬è·å–ä¸¤ä¸ªåœ°å€ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">const</span> URL_1: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://fasterthanli.me/articles/whats-in-the-box&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">const</span> URL_2: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://fasterthanli.me/series/advent-of-code-2020/part-13&#34;</span>;
</span></span></code></pre></div><p>ã€‚ã€‚ã€‚è¿™æ˜¯ä¸€ä¸ªå…¬å¹³çš„æ¯”è¾ƒã€‚ è¿™ä¸¤ç¯‡æ–‡ç« éƒ½æ‰˜ç®¡åœ¨æˆ‘è‡ªå·±çš„ç½‘ç«™ä¸Šï¼Œç»å¯¹ä¸æ˜¯ä¸ºäº†æ¨å¹¿ï¼Œè€Œæ˜¯ä¸ºäº†ä½¿è·å–æ—¶é—´å…·æœ‰å¯æ¯”æ€§ï¼Œå¹¶ä¸”ä»»ä¸€éƒ½æœ‰å¯èƒ½å…ˆåŠ è½½å®Œæˆï¼ˆå¹¶ä¸”ä¼šéšç€æ—¶é—´çš„æ¨ç§»éšæœºå˜åŒ–ï¼‰ã€‚</p>
<p>æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå‡½æ•°æ¥è·å–å†…å®¹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fetch_thing</span>(client: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Client</span>, url: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span>) -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> res <span style="color:#f92672">=</span> client.get(url).send().<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>.error_for_status()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#f92672">%</span>url, content_type <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>res.headers().get(<span style="color:#e6db74">&#34;content-type&#34;</span>), <span style="color:#e6db74">&#34;Got a response!&#34;</span>);
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¹¶ä½¿ç”¨å®ƒï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	setup()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Hello from a comfy nest we&#39;ve made for ourselves&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> client <span style="color:#f92672">=</span> Client::new();
</span></span><span style="display:flex;"><span>	fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_1);
</span></span><span style="display:flex;"><span>	fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç„¶åè¿è¡Œå®ƒ:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">$</span> cargo run
</span></span><span style="display:flex;"><span>   Compiling waytoodeep v0.<span style="color:#ae81ff">1.0</span> (<span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>amos<span style="color:#f92672">/</span>ftl<span style="color:#f92672">/</span>waytoodeep)
</span></span><span style="display:flex;"><span>warning: <span style="color:#a6e22e">unused</span> implementer of <span style="color:#960050;background-color:#1e0010">`</span>Future<span style="color:#960050;background-color:#1e0010">`</span> that must be used
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">-</span>-&gt; <span style="color:#a6e22e">src</span><span style="color:#f92672">/</span>main.rs:<span style="color:#ae81ff">15</span>:<span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">15</span> <span style="color:#f92672">|</span>     fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_1);
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">|</span>     <span style="color:#f92672">^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">=</span> note: <span style="color:#960050;background-color:#1e0010">`</span><span style="color:#75715e">#[warn(unused_must_use)]</span><span style="color:#960050;background-color:#1e0010">`</span> on by default
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">=</span> note: <span style="color:#a6e22e">futures</span> <span style="color:#66d9ef">do</span> nothing unless you <span style="color:#960050;background-color:#1e0010">`</span>.<span style="color:#66d9ef">await</span><span style="color:#960050;background-color:#1e0010">`</span> or poll them
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>warning: <span style="color:#a6e22e">unused</span> implementer of <span style="color:#960050;background-color:#1e0010">`</span>Future<span style="color:#960050;background-color:#1e0010">`</span> that must be used
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">-</span>-&gt; <span style="color:#a6e22e">src</span><span style="color:#f92672">/</span>main.rs:<span style="color:#ae81ff">16</span>:<span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">16</span> <span style="color:#f92672">|</span>     fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_2);
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">|</span>     <span style="color:#f92672">^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">=</span> note: <span style="color:#a6e22e">futures</span> <span style="color:#66d9ef">do</span> nothing unless you <span style="color:#960050;background-color:#1e0010">`</span>.<span style="color:#66d9ef">await</span><span style="color:#960050;background-color:#1e0010">`</span> or poll them
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>warning: <span style="color:#ae81ff">2</span> warnings emitted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Finished dev [unoptimized <span style="color:#f92672">+</span> debuginfo] target(s) <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">3.01</span>s
</span></span><span style="display:flex;"><span>	 Running <span style="color:#960050;background-color:#1e0010">`</span>target<span style="color:#f92672">/</span>debug<span style="color:#f92672">/</span>waytoodeep<span style="color:#960050;background-color:#1e0010">`</span>
</span></span><span style="display:flex;"><span>Jul <span style="color:#ae81ff">25</span> <span style="color:#ae81ff">17</span>:<span style="color:#ae81ff">26</span>:<span style="color:#ae81ff">31.571</span>  INFO waytoodeep: <span style="color:#a6e22e">Hello</span> from a comfy nest we<span style="color:#f92672">&#39;</span><span style="color:#a6e22e">ve</span> made <span style="color:#66d9ef">for</span> ourselves
</span></span></code></pre></div><p>å¥‡æ€ªçš„æ˜¯ï¼Œæ²¡æœ‰ä»»ä½•äº‹æƒ…å‘ç”Ÿã€‚</p>
<blockquote>
<p>é»„è‰²çš„æ³¢æµªçº¿å’Œæ¼äººçš„ Rust è­¦å‘Šå·²ç»ç»™å‡ºäº†æç¤ºã€‚</p>
</blockquote>
<p>è®©æˆ‘ä»¬æ¥ä¿®å¤å®ƒï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_1).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_2).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span></code></pre></div><pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo run
   Compiling waytoodeep v0.1.0 (/home/amos/ftl/waytoodeep)
	Finished dev [unoptimized + debuginfo] target(s) in 3.17s
	 Running `target/debug/waytoodeep`
Jul 25 17:27:29.768  INFO waytoodeep: Hello from a comfy nest we&#39;ve made for ourselves
Jul 25 17:27:29.891  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&#34;text/html; charset=utf-8&#34;)
Jul 25 17:27:29.974  INFO waytoodeep: Got a response! url=https://fasterthanli.me/series/advent-of-code-2020/part-13 content_type=Some(&#34;text/html; charset=utf-8&#34;)
</code></pre><p>æ‰€ä»¥ï¼Œç¬¬é›¶è¯¾ï¼šfuture å¯¹è±¡ä¸åšä»»ä½•äº‹æƒ…ç›´åˆ°å®ƒä»¬è¢«è½®è¯¢ï¼ˆpolledï¼‰ã€‚</p>
<p>è¿™æ˜¯å› ä¸º future å¯¹è±¡å‡ ä¹å°±æ˜¯çŠ¶æ€ã€‚è®©æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// in `src/main.rs`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">mod</span> dumb;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// in `src/dumb.rs`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::{
</span></span><span style="display:flex;"><span>	future::Future,
</span></span><span style="display:flex;"><span>	pin::Pin,
</span></span><span style="display:flex;"><span>	task::{Context, Poll},
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> tracing::info;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">DumbFuture</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> Future <span style="color:#66d9ef">for</span> DumbFuture {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Output</span> <span style="color:#f92672">=</span> ();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">poll</span>(self: <span style="color:#a6e22e">Pin</span><span style="color:#f92672">&lt;&amp;</span><span style="color:#66d9ef">mut</span> Self<span style="color:#f92672">&gt;</span>, _cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Context<span style="color:#f92672">&lt;&#39;</span>_<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>Self::Output<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>		info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Hello from a dumb future!&#34;</span>);
</span></span><span style="display:flex;"><span>		Poll::Ready(())
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// back in `src/main.rs`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	setup()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> fut <span style="color:#f92672">=</span> dumb::DumbFuture {};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä»¥ä¸Šï¼æˆ‘ä»¬å‡ ä¹å°±å®Œæˆäº†ï¼Œé™¤äº†æˆ‘ä»¬æ²¡æœ‰è¿›è¡Œ <code>.await</code> ã€‚</p>
<p>è¿è¡Œå®ƒé™¤äº†æ‰“å°è­¦å‘Šä¸ä¼šæœ‰ä»»ä½•æ•ˆæœï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo run
   Compiling waytoodeep v0.1.0 (/home/amos/ftl/waytoodeep)
warning: unused variable: `fut`
  --&gt; src/main.rs:14:9
   |
14 |     let fut = dumb::DumbFuture {};
   |         ^^^ help: if this is intentional, prefix it with an underscore: `_fut`
   |
   = note: `#[warn(unused_variables)]` on by default

warning: 1 warning emitted

	Finished dev [unoptimized + debuginfo] target(s) in 2.11s
	 Running `target/debug/waytoodeep`
</code></pre><p>å› ä¸ºæ€ä¹ˆå¯èƒ½ï¼Ÿæˆ‘ä»¬å­—é¢ä¸Šä»…ä»…æ„å»ºäº†ä¸€ä¸ªç»“æ„ä½“ã€‚ä¸€ä¸ªé›¶å¤§å°çš„ç»“æ„ä½“ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬è°ƒç”¨å®ƒçš„ <code>.await</code> ã€‚ã€‚ ç„¶åå½“æˆ‘ä»¬è¦æ±‚è¿è¡Œæ—¶è¿è¡Œå®ƒçš„äº‹ä»¶å¾ªç¯ç›´åˆ° future å¯¹è±¡è¢«è½®è¯¢ï¼ˆpolledï¼‰å¹¶ä¸”æœ€ç»ˆè¿”å› <code>Poll::Ready</code> ï¼ˆæˆ‘ä»¬çš„ä»£ç ç«‹å³è¿”å›ï¼‰ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	setup()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Building that dumb future...&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> fut <span style="color:#f92672">=</span> dumb::DumbFuture {};
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Awaiting that dumb future...&#34;</span>);
</span></span><span style="display:flex;"><span>	fut.<span style="color:#66d9ef">await</span>;
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Done awaiting that dumb future&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo run
   Compiling waytoodeep v0.1.0 (/home/amos/ftl/waytoodeep)
	Finished dev [unoptimized + debuginfo] target(s) in 2.34s
	 Running `target/debug/waytoodeep`
Jul 25 17:37:09.261  INFO waytoodeep: Building that dumb future...
Jul 25 17:37:09.261  INFO waytoodeep: Awaiting that dumb future...
Jul 25 17:37:09.261  INFO waytoodeep::dumb: Hello from a dumb future!
Jul 25 17:37:09.262  INFO waytoodeep: Done awaiting that dumb future
</code></pre><p>è¿™é‡Œä¸ ECMAScript çš„ <code>promise</code> æœ‰ä¸€äº›ç•¥å¾®çš„åŒºåˆ«ï¼šå³ä½¿å®ƒä»¬å‹æ ¹æ²¡æœ‰è¢« await å…¶ä¸­åŒ…å«çš„å·¥ä½œä¾ç„¶ä¼šè¢«æ‰§è¡Œã€‚</p>
<p>ä½†æ˜¯ Rust çš„ future å¯¹è±¡ä»…ä»…æ˜¯æ— èŠçš„çŠ¶æ€æœºï¼Œå¦‚æœä½ æ•…æ„åˆ¶é€ éº»çƒ¦å°±å¯ä»¥ç†è§£è¿™ä¸ªæœºåˆ¶ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// in `src/dumb.rs`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> Future <span style="color:#66d9ef">for</span> DumbFuture {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Output</span> <span style="color:#f92672">=</span> ();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">poll</span>(self: <span style="color:#a6e22e">Pin</span><span style="color:#f92672">&lt;&amp;</span><span style="color:#66d9ef">mut</span> Self<span style="color:#f92672">&gt;</span>, _cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Context<span style="color:#f92672">&lt;&#39;</span>_<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>Self::Output<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>		panic!(<span style="color:#e6db74">&#34;Oh heck no&#34;</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_BACKTRACE=1 cargo run
   Compiling waytoodeep v0.1.0 (/home/amos/ftl/waytoodeep)
	Finished dev [unoptimized + debuginfo] target(s) in 2.28s
	 Running `target/debug/waytoodeep`
Jul 25 17:41:18.956  INFO waytoodeep: Building that dumb future...
Jul 25 17:41:18.956  INFO waytoodeep: Awaiting that dumb future...
The application panicked (crashed).
Message:  Oh heck no
Location: src/dumb.rs:14

  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” BACKTRACE â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
								â‹® 6 frames hidden â‹®
   7: &lt;waytoodeep::dumb::DumbFuture as core::future::future::Future&gt;::poll::h4a44780628f4c5f0
	  at /home/amos/ftl/waytoodeep/src/dumb.rs:14
   8: waytoodeep::main::{{closure}}::h36de5a1f1f2a5c5b
	  at /home/amos/ftl/waytoodeep/src/main.rs:17
   9: &lt;core::future::from_generator::GenFuture&lt;T&gt; as core::future::future::Future&gt;::poll::h20a96e082c7a581e
	  at /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/mod.rs:80
  10: tokio::park::thread::CachedParkThread::block_on::{{closure}}::hdf98cb3c7fdf3de4
	  at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/park/thread.rs:263
  11: tokio::coop::with_budget::{{closure}}::h6a86a24a246e220f
	  at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/coop.rs:106
  12: std::thread::local::LocalKey&lt;T&gt;::try_with::h2ce0ac27c85965b6
	  at /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/local.rs:376
  13: std::thread::local::LocalKey&lt;T&gt;::with::hc449f38c9f65fb53
	  at /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/local.rs:352
  14: tokio::coop::with_budget::h5db157bd1e95e0e8
	  at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/coop.rs:99
  15: tokio::coop::budget::h7b57383f1255ac24
	  at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/coop.rs:76
  16: tokio::park::thread::CachedParkThread::block_on::hece399485213b91c
	  at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/park/thread.rs:263
  17: tokio::runtime::enter::Enter::block_on::h89e9882e539e82d3
	  at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/runtime/enter.rs:151
  18: tokio::runtime::thread_pool::ThreadPool::block_on::h1a0186470c00ba70
	  at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/runtime/thread_pool/mod.rs:71
  19: tokio::runtime::Runtime::block_on::h7c21d6989b86d606
	  at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/runtime/mod.rs:452
  20: waytoodeep::main::hb4dd5ffd46a5c032
	  at /home/amos/ftl/waytoodeep/src/main.rs:20
  21: core::ops::function::FnOnce::call_once::hc1fcc87431f77d25
	  at /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/function.rs:227
								â‹® 11 frames hidden â‹®

Run with COLORBT_SHOW_HIDDEN=1 environment variable to disable frame filtering.
Run with RUST_BACKTRACE=full to include source snippets.
</code></pre><p>ä¸Šé¢å †æ ˆè·Ÿè¸ªå¦‚æœåŠ ä¸Šé¢œè‰²æ•ˆæœä¼šæ›´å¥½ï¼Œæ‰€ä»¥æˆ‘å¸Œæœ›ä½ åœ¨æœ¬åœ°åšäº†ç›¸åŒçš„å°è¯•ï¼Œå³ä½¿å¦‚æ­¤æˆ‘ä»¬ä¾ç„¶å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çœŸæ­£çš„ main å‡½æ•°åœ¨ 20 å¸§ï¼Œç„¶åå¾€ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>Runtime::block_on</code>  ã€ä¸€ä¸ªçº¿ç¨‹æ± çš„ä¸œè¥¿ã€ä¸€äº›æŒ‚èµ·ï¼ˆparkedï¼‰çš„çº¿ç¨‹ã€thread-localï¼ˆå…¶ä»– TLSï¼‰ã€ä¸€ä¸ª <strong><strong>ç”Ÿæˆçš„</strong></strong> futureï¼ˆå¸§ 9 å’Œ 8ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ <code>async fn main</code> çš„æœ€ç»ˆç»“æœï¼‰ï¼Œæœ€åæ˜¯æˆ‘ä»¬çš„ <code>DumbFuture</code> poll æ–¹æ³•ï¼ˆå¸§ 7ï¼‰ã€‚</p>
<p>å¸§ 6 åˆ° 1 å°±æ˜¯ <a href="https://doc.rust-lang.org/stable/std/panic/index.html">panic</a> æœºåˆ¶ï¼Œå†æ¬¡å®Œå…¨è¶…å‡ºæœ¬æ–‡è®¨è®ºçš„èŒƒå›´ã€‚</p>
<p>ä½†æ˜¯è¯·ç«™èµ·æ¥ï¼Œäº²çˆ±çš„è§‚ä¼—ï¼Œç”¨ä½ çš„æ‰‹è‡‚ç»•è¿‡è¿™ä¸ªè£…ç½®ï¼Œä»¥ç¡®ä¿æ²¡æœ‰éšœçœ¼æ³•ï¼Œæ²¡æœ‰éšè—çš„çº¿ï¼Œæ²¡æœ‰ã€‚ã€‚ã€‚</p>
<p>ã€‚ã€‚ã€‚æˆ‘è¦è¯´çš„æ˜¯å¯¹äºå¼‚æ­¥å †æ ˆè·Ÿè¸ªæ²¡æœ‰â€œç‰¹æ®Šå¤„ç†â€ï¼ˆspecial handlingï¼‰ã€‚å½“ç„¶ï¼Œè¿™é‡Œæˆ‘ä»¬å´©æºƒäº†ï¼Œä½†æ˜¯ä»…ä»…æ˜¯ Rustï¼Œæ“ä½œç³»ç»Ÿç”šè‡³ä¸çŸ¥é“æˆ‘å‡ ä¹é¿å…äº†ä¸€åœºç¾éš¾ã€‚</p>
<p>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥åˆ¶é€ æ›´å¤§çš„æ··ä¹±ï¼Œå¦‚æœæˆ‘ä»¬æ„¿æ„ä½¿ç”¨ <code>unsafe</code> ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> Future <span style="color:#66d9ef">for</span> DumbFuture {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Output</span> <span style="color:#f92672">=</span> ();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">poll</span>(self: <span style="color:#a6e22e">Pin</span><span style="color:#f92672">&lt;&amp;</span><span style="color:#66d9ef">mut</span> Self<span style="color:#f92672">&gt;</span>, _cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Context<span style="color:#f92672">&lt;&#39;</span>_<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>Self::Output<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">unsafe</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">*</span>(<span style="color:#ae81ff">0xF00D</span> <span style="color:#66d9ef">as</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">mut</span> <span style="color:#66d9ef">u64</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		unreachable!(); <span style="color:#75715e">// pinky promise
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç„¶åå°±ä¸ä¼šæœ‰ä¸€äº›åˆ—çš„å´©æºƒå¤„ç†æ¥æ‹¯æ•‘æˆ‘ä»¬ï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_BACKTRACE=1 cargo run
   Compiling waytoodeep v0.1.0 (/home/amos/ftl/waytoodeep)
	Finished dev [unoptimized + debuginfo] target(s) in 2.18s
	 Running `target/debug/waytoodeep`
Jul 25 17:46:53.926  INFO waytoodeep: Building that dumb future...
Jul 25 17:46:53.926  INFO waytoodeep: Awaiting that dumb future...
zsh: segmentation fault (core dumped)  RUST_BACKTRACE=1 cargo run
</code></pre><p>ä½†æ˜¯ GDB å¯ä»¥ï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo build &amp;&amp; gdb --quiet --args ./target/debug/waytoodeep
	Finished dev [unoptimized + debuginfo] target(s) in 0.04s
Reading symbols from ./target/debug/waytoodeep...
warning: Missing auto-load script at offset 0 in section .debug_gdb_scripts
of file /home/amos/ftl/waytoodeep/target/debug/waytoodeep.
Use `info auto-load python-scripts [REGEXP]&#39; to list them.
(gdb) r
Starting program: /home/amos/ftl/waytoodeep/target/debug/waytoodeep
[Thread debugging using libthread_db enabled]
Using host libthread_db library &#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;.
[New Thread 0x7ffff7c28700 (LWP 129418)]
[New Thread 0x7ffff7a27700 (LWP 129419)]
[New Thread 0x7ffff7826700 (LWP 129420)]
[New Thread 0x7ffff7625700 (LWP 129421)]
[New Thread 0x7ffff7424700 (LWP 129422)]
[New Thread 0x7ffff7223700 (LWP 129423)]
[New Thread 0x7ffff7022700 (LWP 129424)]
[New Thread 0x7ffff6e1e700 (LWP 129425)]
[New Thread 0x7ffff6c1a700 (LWP 129426)]
[New Thread 0x7ffff6a16700 (LWP 129427)]
[New Thread 0x7ffff6812700 (LWP 129428)]
[New Thread 0x7ffff660e700 (LWP 129429)]
[New Thread 0x7ffff640a700 (LWP 129430)]
[New Thread 0x7ffff6206700 (LWP 129431)]
[New Thread 0x7ffff6002700 (LWP 129432)]
Jul 25 17:47:13.278  INFO waytoodeep: Building that dumb future...
Jul 25 17:47:13.279  INFO waytoodeep: Awaiting that dumb future...

Thread 1 &#34;waytoodeep&#34; received signal SIGSEGV, Segmentation fault.
&lt;waytoodeep::dumb::DumbFuture as core::future::future::Future&gt;::poll (self=..., _cx=0x7fffffffd690) at src/dumb.rs:15
15                  *(0xF00D as *mut u64) = 0x0;
(gdb) bt
#0  &lt;waytoodeep::dumb::DumbFuture as core::future::future::Future&gt;::poll (self=..., _cx=0x7fffffffd690) at src/dumb.rs:15
#1  0x00005555555ab3a3 in waytoodeep::main::{{closure}} () at src/main.rs:17
#2  0x00005555555adb29 in &lt;core::future::from_generator::GenFuture&lt;T&gt; as core::future::future::Future&gt;::poll (self=..., cx=0x7fffffffd690)
	at /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/mod.rs:80
#3  0x00005555555adaa0 in tokio::park::thread::CachedParkThread::block_on::{{closure}} ()
	at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/park/thread.rs:263
#4  0x00005555555b1742 in tokio::coop::with_budget::{{closure}} (cell=0x7ffff7c2c412)
	at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/coop.rs:106
#5  0x00005555555a9f58 in std::thread::local::LocalKey&lt;T&gt;::try_with (self=0x555555925fc0, f=...)
	at /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/local.rs:376
#6  0x00005555555a9e3d in std::thread::local::LocalKey&lt;T&gt;::with (self=0x555555925fc0, f=...)
	at /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/local.rs:352
#7  0x00005555555ad7c8 in tokio::coop::with_budget (budget=..., f=...)
	at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/coop.rs:99
#8  tokio::coop::budget (f=...) at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/coop.rs:76
#9  tokio::park::thread::CachedParkThread::block_on (self=0x7fffffffd7a0, f=...)
	at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/park/thread.rs:263
#10 0x00005555555abcc9 in tokio::runtime::enter::Enter::block_on (self=0x7fffffffd7f0, f=...)
	at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/runtime/enter.rs:151
#11 0x00005555555acf2e in tokio::runtime::thread_pool::ThreadPool::block_on (self=0x7fffffffd908, future=...)
	at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/runtime/thread_pool/mod.rs:71
#12 0x00005555555b0dfd in tokio::runtime::Runtime::block_on (self=0x7fffffffd900, future=...)
	at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/runtime/mod.rs:452
#13 0x00005555555aa807 in waytoodeep::main () at src/main.rs:20
(gdb)
</code></pre><p>æˆ‘ä»¬å†æ¬¡ä¸¢å¤±äº†é«˜äº®é¢œè‰²ï¼Œè¿™é‡Œå¯ä»¥çœ‹ä¸€ä¸‹ï¼š
<img src="https://fasterthanli.me/content/articles/understanding-rust-futures-by-going-way-too-deep/assets/gdb-colors.b45af429c46a37d9.webp" alt=""></p>
<blockquote>
<p>è¯‘æ³¨ï¼šæˆ‘åœ¨æœ¬åœ°ç¯å¢ƒå¹¶æ²¡æœ‰é€šè¿‡ GDB å¤ç°å¸¦é«˜äº®çš„å †æ ˆè·Ÿè¸ªï¼Œåè€Œæ˜¯é€šè¿‡ LLDB å¯ä»¥çœ‹åˆ°é«˜äº®çš„å †æ ˆè·Ÿè¸ªã€‚</p>
</blockquote>
<p>æ˜¯ä¸æ˜¯å¾ˆæ¼‚äº®ï¼Ÿ</p>
<p>ç°åœ¨è®©æˆ‘ä»¬å›åˆ°æ­£å¸¸æœ‰ç”¨çš„ä»£ç ï¼Œç§»é™¤æ‰€æœ‰å…³äºè‡ªå·±å®ç°çš„ future ä»£ç ï¼š <code>src/dumb.rs</code> å’Œ <code>mod dumb</code> ã€‚å¹¶ä½¿ç”¨ä¸€ä¸ªè·å– future æ›¿ä»£ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	setup()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Building that fetch future...&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> client <span style="color:#f92672">=</span> Client::new();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> fut <span style="color:#f92672">=</span> fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_1);
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Awaiting that fetch future...&#34;</span>);
</span></span><span style="display:flex;"><span>	fut.<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Done awaiting that fetch future&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_BACKTRACE=1 cargo run
   Compiling waytoodeep v0.1.0 (/home/amos/ftl/waytoodeep)
	Finished dev [unoptimized + debuginfo] target(s) in 2.99s
	 Running `target/debug/waytoodeep`
Jul 25 17:51:49.281  INFO waytoodeep: Building that fetch future...
Jul 25 17:51:49.282  INFO waytoodeep: Awaiting that fetch future...
Jul 25 17:51:49.437  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&#34;text/html; charset=utf-8&#34;)
Jul 25 17:51:49.438  INFO waytoodeep: Done awaiting that fetch future
</code></pre><p>æœ‰ä¸¤ç§æ–¹å¼è€ƒè™‘æˆ‘ä»¬çš„å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯è¯­æ³•ç³–å±‚ï¼šä¹Ÿå°±æ˜¯ <code>async fn</code> ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fetch_thing</span>(client: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Client</span>, url: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span>) -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> res <span style="color:#f92672">=</span> client.get(url).send().<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>.error_for_status()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#f92672">%</span>url, content_type <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>res.headers().get(<span style="color:#e6db74">&#34;content-type&#34;</span>), <span style="color:#e6db74">&#34;Got a response!&#34;</span>);
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç„¶åæ˜¯æ ¸å¿ƒå®ç°å±‚ï¼šä¸€ä¸ªæ™®é€šçš„ <code>fn</code> ä»…ç”¨æ¥è¿”å›ä¸€ä¸ª future å¯¹è±¡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::future::Future;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fetch_thing</span><span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span><span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>	client: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&#39;</span><span style="color:#a6e22e">a</span> <span style="color:#a6e22e">Client</span>,
</span></span><span style="display:flex;"><span>	url: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&#39;</span><span style="color:#a6e22e">a</span> <span style="color:#66d9ef">str</span>,
</span></span><span style="display:flex;"><span>) -&gt; <span style="color:#a6e22e">impl</span> Future<span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;&gt;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">&#39;</span><span style="color:#a6e22e">a</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">async</span> <span style="color:#66d9ef">move</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> res <span style="color:#f92672">=</span> client.get(url).send().<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>.error_for_status()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>		info<span style="color:#f92672">!</span>(<span style="color:#f92672">%</span>url, content_type <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>res.headers().get(<span style="color:#e6db74">&#34;content-type&#34;</span>), <span style="color:#e6db74">&#34;Got a response!&#34;</span>);
</span></span><span style="display:flex;"><span>		Ok(())
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç”±äºå€Ÿç”¨ <code>client</code> å’Œ <code>url</code> ï¼Œæ‰€ä»¥ <code>Future</code> å¯¹è±¡çš„å­˜æ´»æ—¶é—´ä¸èƒ½è¶…è¿‡ä¸¤è€…ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä¼šå°†ä¸Šé¢ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸå‘½åä¸º <code>'a</code> ï¼Œ
å¹¶ä¸”è¿”å›çš„å€¼ä¹Ÿæ˜¯ä»»æ„å®ç°äº† <code>Future</code> ï¼ˆé€šè¿‡ <code>Output</code> ï¼‰åŒæ—¶ç”Ÿå‘½å‘¨æœŸä¹Ÿæ˜¯ <code>'a</code> ã€‚</p>
<p>æ•´ä¸ª <code>async move {}</code> å¿«ä¹Ÿä»…ä»…æ˜¯â€œæ„å»ºçŠ¶æ€â€ &ndash; ç­‰äºä¸€ä¸ªå®ç°äº† <code>Future</code> çš„ç±»å‹ã€‚</p>
<p>æˆ‘ä»¬åªæ˜¯æ— æ³•å‘½åå®ƒã€‚</p>
<p>æˆ‘ä»¬åªèƒ½å°½é‡è·å–å®ƒçš„æè¿°ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">type_name_of</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>(_: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">T</span>) -&gt; <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&#39;</span>static <span style="color:#66d9ef">str</span> {
</span></span><span style="display:flex;"><span>	std::any::type_name::<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// in main
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	setup()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Building that fetch future...&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> client <span style="color:#f92672">=</span> Client::new();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> fut <span style="color:#f92672">=</span> fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_1);
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(
</span></span><span style="display:flex;"><span>		type_name <span style="color:#f92672">=</span> type_name_of(<span style="color:#f92672">&amp;</span>fut),
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;That fetch future has a type..&#34;</span>
</span></span><span style="display:flex;"><span>	);
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Awaiting that fetch future...&#34;</span>);
</span></span><span style="display:flex;"><span>	fut.<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Done awaiting that fetch future&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo run
	Finished dev [unoptimized + debuginfo] target(s) in 0.05s
	 Running `target/debug/waytoodeep`
Jul 25 18:00:39.774  INFO waytoodeep: Building that fetch future...
Jul 25 18:00:39.775  INFO waytoodeep: That fetch future has a type.. type_name=&#34;core::future::from_generator::GenFuture&lt;waytoodeep::fetch_thing::{{closure}}&gt;&#34;
Jul 25 18:00:39.775  INFO waytoodeep: Awaiting that fetch future...
Jul 25 18:00:39.882  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&#34;text/html; charset=utf-8&#34;)
Jul 25 18:00:39.882  INFO waytoodeep: Done awaiting that fetch future
</code></pre><p>ã€‚ã€‚ã€‚ä½†æ˜¯ç­‰ç­‰ï¼Œç”±äºæˆ‘ä»¬ä½¿ç”¨äº† <code>async</code> è¯­æ³•æ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ªç¼–è¯‘å™¨ç”Ÿæˆçš„ç±»å‹ã€‚æŸç§æ„ä¹‰ä¸Šæˆ‘ä»¬æ— æ³•å‘½åå®ƒä¹Ÿå°±æ„å‘³è¿™æˆ‘ä»¬æ— æ³•ç»‘å®šè¿™ä¸ªå¯¹è±¡ï¼Œæˆ–è€…ç¼–å†™ä¸€ä¸ªå‡½æ•°ä»…ä»…æ¥å—è¯¥ç±»å‹ã€‚</p>
<p>ä¸ºäº†è®©æˆ‘ä»¬è‡ªå·±ç›¸ä¿¡ future å¯¹è±¡åœ¨æˆ‘ä»¬çœŸæ­£è½®è¯¢å®ƒä¹‹å‰å®ƒä¸ä¼šåšä»»ä½•å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥æ‰“å¼€ <code>reqwest</code> çš„è°ƒè¯•æ—¥å¿—ï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info,reqwest=debug cargo run
   Compiling waytoodeep v0.1.0 (/home/amos/ftl/waytoodeep)
	Finished dev [unoptimized + debuginfo] target(s) in 3.07s
	 Running `target/debug/waytoodeep`
Jul 25 18:05:07.384  INFO waytoodeep: Building that fetch future...
Jul 25 18:05:07.385  INFO waytoodeep: That fetch future has a type.. type_name=&#34;core::future::from_generator::GenFuture&lt;waytoodeep::fetch_thing::{{closure}}&gt;&#34;
Jul 25 18:05:07.385  INFO waytoodeep: Awaiting that fetch future...
Jul 25 18:05:07.385 DEBUG reqwest::connect: starting new connection: https://fasterthanli.me/
Jul 25 18:05:07.503 DEBUG reqwest::async_impl::client: response &#39;200 OK&#39; for https://fasterthanli.me/articles/whats-in-the-box
Jul 25 18:05:07.503  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&#34;text/html; charset=utf-8&#34;)
Jul 25 18:05:07.503  INFO waytoodeep: Done awaiting that fetch future
</code></pre><p>ç”šè‡³å¯¹äºæ¯ä¸€ä¸ªåŒ…ï¼ˆcrateï¼‰ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥é€šè¿‡ç›‘å¬ <a href="https://lib.rs/crates/hyper">hyper</a> å’Œ <a href="https://lib.rs/crates/h2">h2</a> æ¥è§‚å¯Ÿï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=debug cargo run
	Finished dev [unoptimized + debuginfo] target(s) in 0.04s
	 Running `target/debug/waytoodeep`
Jul 25 18:05:59.973  INFO waytoodeep: Building that fetch future...
Jul 25 18:05:59.973  INFO waytoodeep: That fetch future has a type.. type_name=&#34;core::future::from_generator::GenFuture&lt;waytoodeep::fetch_thing::{{closure}}&gt;&#34;
Jul 25 18:05:59.973  INFO waytoodeep: Awaiting that fetch future...
Jul 25 18:05:59.974 DEBUG reqwest::connect: starting new connection: https://fasterthanli.me/
Jul 25 18:05:59.974 DEBUG hyper::client::connect::dns: resolving host=&#34;fasterthanli.me&#34;
Jul 25 18:05:59.989 DEBUG hyper::client::connect::http: connecting to 172.67.196.144:443
Jul 25 18:06:00.000 DEBUG hyper::client::connect::http: connected to 172.67.196.144:443
Jul 25 18:06:00.000 DEBUG rustls::client::hs: No cached session for DNSNameRef(&#34;fasterthanli.me&#34;)
Jul 25 18:06:00.000 DEBUG rustls::client::hs: Not resuming any session
Jul 25 18:06:00.016 DEBUG rustls::client::hs: Using ciphersuite TLS13_CHACHA20_POLY1305_SHA256
Jul 25 18:06:00.016 DEBUG rustls::client::tls13: Not resuming
Jul 25 18:06:00.017 DEBUG rustls::client::tls13: TLS1.3 encrypted extensions: [ServerNameAck, Protocols([PayloadU8([104, 50])])]
Jul 25 18:06:00.017 DEBUG rustls::client::hs: ALPN protocol is Some(b&#34;h2&#34;)
Jul 25 18:06:00.018 DEBUG h2::client: binding client connection
Jul 25 18:06:00.018 DEBUG h2::client: client connection bound
Jul 25 18:06:00.018 DEBUG h2::codec::framed_write: send frame=Settings { flags: (0x0), enable_push: 0, initial_window_size: 2097152, max_frame_size: 16384 }
Jul 25 18:06:00.019 DEBUG Connection{peer=Client}: h2::codec::framed_write: send frame=WindowUpdate { stream_id: StreamId(0), size_increment: 5177345 }
Jul 25 18:06:00.019 DEBUG hyper::client::pool: pooling idle connection for (&#34;https&#34;, fasterthanli.me)
Jul 25 18:06:00.020 DEBUG Connection{peer=Client}: h2::codec::framed_write: send frame=Headers { stream_id: StreamId(1), flags: (0x5: END_HEADERS | END_STREAM) }
Jul 25 18:06:00.029 DEBUG Connection{peer=Client}: rustls::client::tls13: Ticket saved
Jul 25 18:06:00.029 DEBUG Connection{peer=Client}: rustls::client::tls13: Ticket saved
Jul 25 18:06:00.029 DEBUG Connection{peer=Client}: h2::codec::framed_read: received frame=Settings { flags: (0x0), max_concurrent_streams: 256, initial_window_size: 65536, max_frame_size: 16777215 }
Jul 25 18:06:00.030 DEBUG Connection{peer=Client}: h2::codec::framed_write: send frame=Settings { flags: (0x1: ACK) }
Jul 25 18:06:00.030 DEBUG Connection{peer=Client}: h2::codec::framed_read: received frame=WindowUpdate { stream_id: StreamId(0), size_increment: 2147418112 }
Jul 25 18:06:00.041 DEBUG Connection{peer=Client}: h2::codec::framed_read: received frame=Settings { flags: (0x1: ACK) }
Jul 25 18:06:00.041 DEBUG Connection{peer=Client}: h2::proto::settings: received settings ACK; applying Settings { flags: (0x0), enable_push: 0, initial_window_size: 2097152, max_frame_size: 16384 }
Jul 25 18:06:00.120 DEBUG Connection{peer=Client}: h2::codec::framed_read: received frame=Headers { stream_id: StreamId(1), flags: (0x4: END_HEADERS) }
Jul 25 18:06:00.120 DEBUG Connection{peer=Client}: h2::codec::framed_read: received frame=Data { stream_id: StreamId(1) }
Jul 25 18:06:00.121 DEBUG reqwest::async_impl::client: response &#39;200 OK&#39; for https://fasterthanli.me/articles/whats-in-the-box
Jul 25 18:06:00.121  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&#34;text/html; charset=utf-8&#34;)
Jul 25 18:06:00.121  INFO waytoodeep: Done awaiting that fetch future
Jul 25 18:06:00.121 DEBUG Connection{peer=Client}: h2::codec::framed_read: received frame=Data { stream_id: StreamId(1) }
Jul 25 18:06:00.122 DEBUG Connection{peer=Client}: h2::codec::framed_write: send frame=Reset { stream_id: StreamId(1), error_code: CANCEL }
Jul 25 18:06:00.122 DEBUG Connection{peer=Client}: h2::codec::framed_write: send frame=GoAway { error_code: NO_ERROR, last_stream_id: StreamId(0) }
Jul 25 18:06:00.122 DEBUG Connection{peer=Client}: h2::proto::connection: Connection::poll; connection error error=NO_ERROR
Jul 25 18:06:00.122 DEBUG Connection{peer=Client}: rustls::session: Sending warning alert CloseNotify
</code></pre><blockquote>
<p>ä¸Šé¢å‡ºç°äº† rustlsï¼Œå¹¶ä¸”ä½¿ç”¨äº† TLS 1.3ï¼Œä½œè€…åšè¿‡<a href="https://www.youtube.com/watch?v=YHIiVsFybLA">ä¸€æœŸè§†é¢‘</a>ä»‹ç»è¿‡ TLS 1.3ã€‚</p>
</blockquote>
<p>è¿™äº›åº”è¯¥è¶³å¤Ÿè¯´æœä½ ï¼Œé™¤éä½ åªç›¸ä¿¡å†…æ ¸æ‰€è¯´çš„ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬çœ‹çœ‹è°ƒç”¨å †æ ˆåªä¸ºäº†æ›´åŠ ç¡®å®šã€‚</p>
<p>æˆ‘ä»¬åœ¨ <code>await</code> future å¯¹è±¡ä¹‹å‰å¢åŠ ä¸€ç§’é’Ÿçš„ä¼‘çœ ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> tokio::time::sleep;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::time::Duration;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	setup()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Building that fetch future...&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> client <span style="color:#f92672">=</span> Client::new();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> fut <span style="color:#f92672">=</span> fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_1);
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Sleeping for a bit...&#34;</span>);
</span></span><span style="display:flex;"><span>	sleep(Duration::from_secs(<span style="color:#ae81ff">1</span>)).<span style="color:#66d9ef">await</span>;
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Awaiting that fetch future...&#34;</span>);
</span></span><span style="display:flex;"><span>	fut.<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Done awaiting that fetch future&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo build &amp;&amp; strace -e &#39;connect&#39; ./target/debug/waytoodeep
   Compiling waytoodeep v0.1.0 (/home/amos/ftl/waytoodeep)
	Finished dev [unoptimized + debuginfo] target(s) in 3.13s
Jul 25 18:09:36.595  INFO waytoodeep: Building that fetch future...
Jul 25 18:09:36.596  INFO waytoodeep: Sleeping for a bit...
Jul 25 18:09:37.599  INFO waytoodeep: Awaiting that fetch future...
connect(9, {sa_family=AF_INET, sin_port=htons(443), sin_addr=inet_addr(&#34;104.21.92.169&#34;)}, 16) = -1 EINPROGRESS (Operation now in progress)
Jul 25 18:09:37.720  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&#34;text/html; charset=utf-8&#34;)
Jul 25 18:09:37.721  INFO waytoodeep: Done awaiting that fetch future
+++ exited with 0 +++
</code></pre><p>å†æ¬¡å¼ºè°ƒï¼Œé™„ä¸Šä¼šè®©æ˜¾è‘—æé«˜ä¸Šé¢ä¿¡æ¯çš„å¯è¯»æ€§ï¼Œå¦‚æœä¸è®©æˆ‘é€‰æ‹©å®ƒä»¬çš„è¯æˆ‘æ˜¯éå¸¸å–œæ¬¢é«˜äº®çš„ã€‚æˆ‘æœ¬åœ°çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š
<img src="https://fasterthanli.me/content/articles/understanding-rust-futures-by-going-way-too-deep/assets/strace-colors.a4163f4bda179c2b.webp" alt="">
ç”±äº <code>tracing-subscriber</code> é»˜è®¤æ ¼å¼ä¼šè¾“å‡ºæ—¶é—´æˆ³ï¼Œå¯ä»¥çœ‹åˆ°ç¨‹åºä¼‘çœ äº†1åˆ†é’Ÿï¼ˆå¤–åŠ 3æ¯«ç§’ï¼‰ï¼Œè€Œä¸”åªæœ‰æˆ‘ä»¬çœŸæ­£è°ƒç”¨ <code>await</code> æ—¶æˆ‘ä»¬çš„ç¨‹åºæ‰ä¼šå¼€å§‹è¿æ¥åˆ°æ‰˜ç®¡æ–‡ç« çš„ CDN èŠ‚ç‚¹ã€‚</p>
<p>å¥½äº†ï¼è®©æˆ‘ä»¬å†æ¬¡å°è¯•æ‹‰å–ä¸¤ç¯‡æ–‡ç« ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	setup()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> client <span style="color:#f92672">=</span> Client::new();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> fut1 <span style="color:#f92672">=</span> fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_1);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> fut2 <span style="color:#f92672">=</span> fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	fut1.<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	fut2.<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å†æ¬¡æ£€æŸ¥æ—¥å¿—ï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info,reqwest=debug cargo run --quiet
Jul 25 18:31:47.396 DEBUG reqwest::connect: starting new connection: https://fasterthanli.me/
Jul 25 18:31:47.536 DEBUG reqwest::async_impl::client: response &#39;200 OK&#39; for https://fasterthanli.me/articles/whats-in-the-box
Jul 25 18:31:47.537  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&#34;text/html; charset=utf-8&#34;)
Jul 25 18:31:47.627 DEBUG reqwest::async_impl::client: response &#39;200 OK&#39; for https://fasterthanli.me/series/advent-of-code-2020/part-13
Jul 25 18:31:47.627  INFO waytoodeep: Got a response! url=https://fasterthanli.me/series/advent-of-code-2020/part-13 content_type=Some(&#34;text/html; charset=utf-8&#34;)
</code></pre><p>éå¸¸æœ‰è¶£ã€‚ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œ <code>reqwest</code> ä¸ºä¸¤ä¸ªè¯·æ±‚å¤ç”¨äº†ç›¸åŒçš„è¿æ¥ã€‚æˆ‘ä¼šè¿™ä¹ˆè¯´æ˜¯å› æˆ‘åªçœ‹åˆ°äº†ä¸€è¡Œ <code>reqwest::connect</code> æ—¥å¿—ã€‚</p>
<p>è®©æˆ‘ä»¬å¿«é€Ÿé€šè¿‡ <code>strace</code> æ£€æŸ¥ä¸€ä¸‹ï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo build --quiet &amp;&amp; strace -e &#39;connect&#39; ./target/debug/waytoodeep &gt; /dev/null
connect(9, {sa_family=AF_INET, sin_port=htons(443), sin_addr=inet_addr(&#34;172.67.196.144&#34;)}, 16) = -1 EINPROGRESS (Operation now in progress)
+++ exited with 0 +++
</code></pre><p>ç°åœ¨å¯ä»¥ç¡®è®¤äº†ï¼Œåªæœ‰ä¸€æ¬¡è¿æ¥ã€‚</p>
<p>ä½†æ˜¯ï¼Œç¬¬ä¸€ä¸ªè¯·æ±‚å®Œæˆåæ‰å¼€å§‹äº†ç¬¬äºŒä¸ªè¯·æ±‚ã€‚ç¬¬ä¸€ä¸ªè€—è´¹äº† <code>536-396 = 140</code> æ¯«ç§’ï¼Œä½†æ˜¯ç¬¬äºŒä¸ªè€—è´¹äº† <code>627-537 = 90</code> æ¯«ç§’ï¼</p>
<blockquote>
<p>Emmmï¼Œç°åœ¨æˆ‘ä»¬è¿è¡Œæ„å»ºçš„æ˜¯ debug ç‰ˆæœ¬ä¸æ˜¯å—ï¼Ÿ</p>
</blockquote>
<p>è¿™æ˜¯çœŸçš„ã€‚æˆ‘ç¡®ä¿¡æˆ‘ä»¬é¢ä¸´çš„æ˜¯ IO å¯†é›†å‹ï¼Œè€Œä¸æ˜¯ CPU å¯†é›†å‹ã€‚</p>
<p>debug ç‰ˆæœ¬çš„æ„å»ºç»å¯¹æœ‰ä¸€äº›é¢å¤–çš„å¼€é”€ï¼Œä½†æ˜¯æˆ‘æ€€ç–‘è¿™é‡Œå®ƒä¸ä¼šå¤ªå½±å“å»¶è¿Ÿã€‚æ— è®ºå¦‚ä½•ï¼Œè®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹ï¼š
ï¼ˆæ³¨æ„ &ndash;releaseï¼‰</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info,reqwest=debug cargo run --quiet --release
Jul 25 18:34:59.211 DEBUG reqwest::connect: starting new connection: https://fasterthanli.me/
Jul 25 18:34:59.343 DEBUG reqwest::async_impl::client: response &#39;200 OK&#39; for https://fasterthanli.me/articles/whats-in-the-box
Jul 25 18:34:59.343  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&#34;text/html; charset=utf-8&#34;)
Jul 25 18:34:59.427 DEBUG reqwest::async_impl::client: response &#39;200 OK&#39; for https://fasterthanli.me/series/advent-of-code-2020/part-13
Jul 25 18:34:59.427  INFO waytoodeep: Got a response! url=https://fasterthanli.me/series/advent-of-code-2020/part-13 content_type=Some(&#34;text/html; charset=utf-8&#34;)
</code></pre><p>æˆ‘ä»¬è®¡ç®—ä¸€ä¸‹å»¶è¿Ÿ <code>343-211 = 132ms</code> ï¼Œ <code>427-343 = 84ms</code> ã€‚</p>
<p>å‡ æ¯«ç§’çš„å·®å¼‚å¯èƒ½çš„è§£é‡Šæ˜¯é‚»å±…æ‰“å¼€äº†ä¸€ä¸ª YouTube è§†é¢‘å¯¼è‡´æ— çº¿ç”µæ³¢çˆ†å‘ï¼Œä»è€Œå¯¼è‡´å†²çªï¼ˆ802.11 æ²¡æœ‰ç©ºä¸­æµé‡æ§åˆ¶ï¼Œå…¨æ°‘è‡ªç”±ï¼ˆfree-for-allï¼‰ï¼‰å’Œé‡ä¼ ã€‚</p>
<p>æˆ–è€…å¦å¤–ä¸€ç™¾ä¸‡ä¸ªåŸå› ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸ç»§ç»­åˆ†æçš„åŸå› ã€‚</p>
<p>è®©æˆ‘ä»¬å›åˆ°æ–‡ç« çš„ä¸»é¢˜ã€‚</p>
<h3 id="ç­‰å¾…ç¬¬ä¸€ä¸ªå®Œæˆ">ç­‰å¾…ç¬¬ä¸€ä¸ªå®Œæˆ<a href="#ç­‰å¾…ç¬¬ä¸€ä¸ªå®Œæˆ" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>æ˜¯çš„ï¼ç­‰å¾…ç¬¬ä¸€ä¸ªå®Œæˆã€‚æ‰€ä»¥æˆ‘ä»¬å¦‚ä½•è®©ç¨‹åºåŒæ—¶è¯·æ±‚ä¸¤ä¸ªï¼Ÿ</p>
<p>å…¶å®æœ‰ä¸€å¤§å †æ–¹å¼ï¼</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªæ‰§è¡Œå™¨ä¸Šæ‰§è¡Œï¼ˆ <code>spawn</code> ï¼‰è¿™äº› future å¯¹è±¡ï¼Œç„¶åä¼‘çœ ä¸€ç§’é’Ÿã€‚1 ç§’é’Ÿè¶³å¤Ÿäº†å§ï¼Ÿ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	setup()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> client <span style="color:#f92672">=</span> Client::new();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> fut1 <span style="color:#f92672">=</span> fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_1);
</span></span><span style="display:flex;"><span>	tokio::spawn(fut1);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> fut2 <span style="color:#f92672">=</span> fetch_thing(<span style="color:#f92672">&amp;</span>client, URL_2);
</span></span><span style="display:flex;"><span>	tokio::spawn(fut2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	tokio::time::sleep(Duration::from_secs(<span style="color:#ae81ff">1</span>)).<span style="color:#66d9ef">await</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info,reqwest=debug cargo run --quiet --release
error[E0597]: `client` does not live long enough
  --&gt; src/main.rs:17:28
   |
17 |     let fut1 = fetch_thing(&amp;client, URL_1);
   |                ------------^^^^^^^--------
   |                |           |
   |                |           borrowed value does not live long enough
   |                argument requires that `client` is borrowed for `&#39;static`
...
25 | }
   | - `client` dropped here while still borrowed

error: aborting due to previous error

For more information about this error, try `rustc --explain E0597`.
error: could not compile `waytoodeep`

To learn more, run the command again with --verbose.
</code></pre><p>é¢ï¼Œé™¤éæˆ‘ä»¬ä¸å¯ä»¥ã€‚ä¸å¯ä»¥æ˜¯å› ä¸ºã€‚ã€‚ã€‚</p>
<blockquote>
<p>æˆ‘ä»¬å°†ã€Œfuture å¯¹è±¡äº¤ç»™æ‰§è¡Œå™¨æ‰§è¡Œã€å¹¶å°† future å¯¹è±¡è½¬äº¤ç»™æ‰§è¡Œå™¨ï¼Œå¯¹å§ï¼Ÿæˆ‘ä»¬è½¬ç§»äº†å®ƒå’Œå®ƒçš„å†…å®¹çš„æ‰€æœ‰æƒã€‚</p>
<p>ç„¶åå³ä½¿æˆ‘ä»¬ä¸å¯¹å…¶è¿›è¡Œ <code>await</code> ï¼Œfuture å¯¹è±¡å› ä¸ºæ˜¯ã€Œæ‰§è¡Œå™¨éœ€è¦åšã€çš„ä¸€éƒ¨åˆ†ä¾ç„¶ä¼šè¢«æ‰§è¡Œï¼Œæ‰€ä»¥å³ä½¿æˆ‘ä»¬ä» <code>main</code> è¿”å› future å¯¹è±¡ä¹Ÿä¼šè¢«è½®è¯¢ï¼ˆpolledï¼‰ã€‚</p>
<p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬ä» <code>main</code> è¿”å›ï¼Œåˆ™æ•´ä¸ªç¨‹åºéƒ½ä¼šé€€å‡ºã€‚</p>
<p>è¿™é‡Œä¹Ÿå¯ä»¥æ˜¯ä»»ä½•å‡½æ•°ï¼ˆè¿™é‡Œæ˜¯ <code>main</code> ï¼‰ã€‚é‡è¦çš„æ˜¯å¦‚æœå‡½æ•°è¿”å›äº†ä½†æ˜¯ future å¯¹è±¡å€Ÿç”¨äº†éƒ¨åˆ†æ•°æ®å°†æ— æ³•é€šè¿‡å€Ÿç”¨æ£€æŸ¥å™¨ã€‚</p>
</blockquote>
<p>è¿™è®©æˆ‘å¾ˆé«˜å…´ï¼Œå› ä¸ºè¿™æ„å‘³ç€æˆ‘ä»¬ä¸ä¼šæ„å¤–è®¿é—®åˆ°ä¸€äº›è¢«é‡Šæ”¾çš„èµ„æºï¼š<a href="https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=use+after+free">UAF</a>ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬çš„ä¾‹å­æ²¡æœ‰å®Œæˆã€‚</p>
<p>æ‰€ä»¥ã€‚ã€‚ã€‚æˆ‘ä»¬éœ€è¦è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å¦‚æœ <code>fetch_thing</code> è¿”å›çš„ future å¯¹è±¡æ˜¯ <code>'static</code> çš„å‘¢ï¼Ÿæˆ–è€…å®ƒä¸å€Ÿç”¨ä»»ä½•ä¸œè¥¿ï¼Ÿ</p>
<p>ç¨‹åºç°åœ¨çœ‹èµ·æ¥å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::future::Future;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fetch_thing</span><span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span><span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>	client: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&#39;</span><span style="color:#a6e22e">a</span> <span style="color:#a6e22e">Client</span>,
</span></span><span style="display:flex;"><span>	url: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&#39;</span><span style="color:#a6e22e">a</span> <span style="color:#66d9ef">str</span>,
</span></span><span style="display:flex;"><span>) -&gt; <span style="color:#a6e22e">impl</span> Future<span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;&gt;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">&#39;</span><span style="color:#a6e22e">a</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">async</span> <span style="color:#66d9ef">move</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> res <span style="color:#f92672">=</span> client.get(url).send().<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>.error_for_status()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>		info<span style="color:#f92672">!</span>(<span style="color:#f92672">%</span>url, content_type <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>res.headers().get(<span style="color:#e6db74">&#34;content-type&#34;</span>), <span style="color:#e6db74">&#34;Got a response!&#34;</span>);
</span></span><span style="display:flex;"><span>		Ok(())
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¥½å§ï¼Œä¹‹å‰æˆ‘ä»¬ç”¨äº† <code>async fn</code> ï¼Œä½†æ˜¯ä¸ºäº†æ›´åŠ æ·±å…¥çš„ç†è§£ï¼Œæˆ‘ä»¬ä¸å¾—ä¸æ”¾å¼ƒæ¼‚äº®çš„è¯­æ³•ã€‚</p>
<p>ä½†æ˜¯å¹¸è¿çš„æ˜¯ï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fetch_thing</span><span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span><span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>	client: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&#39;</span><span style="color:#a6e22e">a</span> <span style="color:#a6e22e">Client</span>,
</span></span><span style="display:flex;"><span>	url: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&#39;</span><span style="color:#a6e22e">a</span> <span style="color:#66d9ef">str</span>,
</span></span><span style="display:flex;"><span><span style="color:#75715e">//                                                 ğŸ‘‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>) -&gt; <span style="color:#a6e22e">impl</span> Future<span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;&gt;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">&#39;</span>static {}
</span></span></code></pre></div><p>ä½†æ˜¯æˆ‘ä»¬å€Ÿç”¨äº† <code>client</code> å’Œ <code>url</code> æˆ‘ä»¬å¿…é¡»é¿å…è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>å› ä¸º <code>url</code> æœ¬èº«å°±æ˜¯å¸¸é‡ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“è§£å†³ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">const</span> URL_1: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://fasterthanli.me/articles/whats-in-the-box&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">const</span> URL_2: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://fasterthanli.me/series/advent-of-code-2020/part-13&#34;</span>;
</span></span></code></pre></div><p>å®ƒä»¬æœ¬èº«å°±æ˜¯ <code>'static</code> ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è°ƒæ•´éœ€è¦ <code>'static</code> å°±è¡Œ:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fetch_thing</span><span style="color:#f92672">&lt;&#39;</span><span style="color:#a6e22e">a</span><span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>	client: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&#39;</span><span style="color:#a6e22e">a</span> <span style="color:#a6e22e">Client</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//       ğŸ‘‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	url: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&#39;</span>static <span style="color:#66d9ef">str</span>,
</span></span><span style="display:flex;"><span>) -&gt; <span style="color:#a6e22e">impl</span> Future<span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;&gt;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">&#39;</span>static {}
</span></span></code></pre></div><p>éå¸¸å¥½ï¼è§£å†³äº†ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œè¿˜å‰©ä¸‹ä¸€ä¸ªã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥è¦æ±‚ <code>client</code> çš„ç”Ÿå‘½å‘¨æœŸä¸º <code>'static</code> ã€‚ç”±äºå®ƒæ˜¯ä¸€ä¸ª  <code>Client</code> çš„å¼•ç”¨ï¼Œæ„å‘³ç€ <code>Cleint</code> æœ¬èº«ä¹Ÿéœ€è¦æ˜¯ <code>'static</code> ç”Ÿå‘½å‘¨æœŸã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fetch_thing</span>(
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//         ğŸ‘‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	client: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&#39;</span>static <span style="color:#a6e22e">Client</span>,
</span></span><span style="display:flex;"><span>	url: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&#39;</span>static <span style="color:#66d9ef">str</span>,
</span></span><span style="display:flex;"><span>) -&gt; <span style="color:#a6e22e">impl</span> Future<span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;&gt;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">&#39;</span>static {}
</span></span></code></pre></div><p>ç”±äºå®ƒè¢« <code>main</code> æ‰€æœ‰ï¼Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥ï¼Œå¯ä»¥ã€‚ã€‚ã€‚å¯ä»¥æ³„æ¼å®ƒï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	setup()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> client <span style="color:#f92672">=</span> Client::new();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> leaked_client <span style="color:#f92672">=</span> Box::leak(Box::new(client));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> fut1 <span style="color:#f92672">=</span> fetch_thing(leaked_client, URL_1);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> fut2 <span style="color:#f92672">=</span> fetch_thing(leaked_client, URL_2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	tokio::spawn(fut1);
</span></span><span style="display:flex;"><span>	tokio::spawn(fut2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	tokio::time::sleep(Duration::from_secs(<span style="color:#ae81ff">1</span>)).<span style="color:#66d9ef">await</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å®Œç¾ï¼æ²¡æœ‰ç”Ÿå‘½å‘¨æœŸçš„é—®é¢˜äº†ã€‚</p>
<p>ä»…ä»…å°†æ‰€æœ‰ä¸œè¥¿æ³„æ¼å°±è¡Œã€‚çœ‹åˆ°æ²¡ï¼Ÿä½ ä¸éœ€è¦ Cï¼</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info,reqwest=debug cargo run --quiet --release
Jul 25 18:54:53.614 DEBUG reqwest::connect: starting new connection: https://fasterthanli.me/
Jul 25 18:54:53.614 DEBUG reqwest::connect: starting new connection: https://fasterthanli.me/
Jul 25 18:54:53.708 DEBUG reqwest::async_impl::client: response &#39;200 OK&#39; for https://fasterthanli.me/articles/whats-in-the-box
Jul 25 18:54:53.708  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&#34;text/html; charset=utf-8&#34;)
Jul 25 18:54:53.733 DEBUG reqwest::async_impl::client: response &#39;200 OK&#39; for https://fasterthanli.me/series/advent-of-code-2020/part-13
Jul 25 18:54:53.733  INFO waytoodeep: Got a response! url=https://fasterthanli.me/series/advent-of-code-2020/part-13 content_type=Some(&#34;text/html; charset=utf-8&#34;)
</code></pre><p>éï½ï½å¸¸æœ‰è¶£ï¼</p>
<p>æˆ‘ä»¬çš„ä¸¤ä¸ªè¯·æ±‚è‚¯å®šæ˜¯å¹¶å‘çš„å‘å‡ºå»äº†ï¼Œæˆ‘ä»¬ä¹‹æ‰€ä»¥çŸ¥é“æ˜¯å› ä¸ºä»æˆ‘çš„ç¬”è®°æœ¬ä¸Šè¯·æ±‚æˆ‘çš„ç½‘ç«™å¤§æ¦‚è€—æ—¶ 80ms åˆ° 140ms ä¹‹é—´ï¼Œä½†æ˜¯åœ¨æ—¥å¿—ä¸­æˆ‘ä»¬çœ‹åˆ°ä¸¤ä¸ªå“åº”ä¹‹é—´åªæœ‰ ~25ms çš„é—´éš”ã€‚</p>
<p>æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ° <code>reqwest</code> æœ‰è¿æ¥æ± æœºåˆ¶ï¼šåŒæ—¶åˆ›å»ºäº†ä¸¤ä¸ªè¿æ¥ã€‚å¯èƒ½æ˜¯å› ä¸ºæˆ‘ä»¬å¼€å§‹ç¬¬äºŒä¸ªè¿æ¥çš„æ—¶å€™ç¬¬ä¸€ä¸ªè¯·æ±‚çš„è¿æ¥è¿˜æ²¡æœ‰å»ºç«‹å®Œæˆã€‚</p>
<p>ä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬é€šè¿‡ <code>strace</code> å¯ä»¥çœ‹åˆ°ï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo build --quiet --release &amp;&amp; strace -e &#39;connect&#39; ./target/release/waytoodeep
Jul 25 18:58:16.425  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&#34;text/html; charset=utf-8&#34;)
Jul 25 18:58:16.443  INFO waytoodeep: Got a response! url=https://fasterthanli.me/series/advent-of-code-2020/part-13 content_type=Some(&#34;text/html; charset=utf-8&#34;)
+++ exited with 0 +++
</code></pre><p>ã€‚ã€‚ã€‚ä¸¤ä¸ª <code>connect</code> è°ƒç”¨ï¼å¦‚æˆ‘æ‰€æ–™ï¼</p>
<blockquote>
<p>è°¬è®ºï¼šä¸€ä¸ª <code>connect</code> è°ƒç”¨éƒ½æ²¡çœ‹åˆ°ï¼Ÿå› ä¸º Rust æ„å»º HTTP/2 è¯·æ±‚çš„æ—¶å€™ç”šè‡³éƒ½éœ€è¦å»ºç«‹ TCP è¿æ¥ã€‚çœŸæ˜¯é©å‘½æ€§çš„ï¼</p>
</blockquote>
<p>è¿™å½“ç„¶ä¸æ˜¯çœŸçš„ã€‚å¯èƒ½åœ¨å…¶ä»–çº¿ç¨‹æ‰§è¡Œäº†ï¼Ÿä¹Ÿè®¸ <code>strace</code> é»˜è®¤ä»…è·Ÿè¸ªäº†ä¸»çº¿ç¨‹ï¼Ÿ</p>
<p>å•Šï¼Œå¯¹äº†ï¼Œ <code>-f</code> å¯ä»¥è·Ÿè¸ªæ‰€æœ‰ã€Œå­è¿›ç¨‹ã€ï¼Œå°±åƒå¤§å®¶çŸ¥é“çš„é‚£æ · Linux çº¿ç¨‹ä»…ä»…æ˜¯æŠ«äº†ä»¶é£è¡£çš„è¿›ç¨‹ï¼ˆæˆ–è€…å…¶ä»–æ–¹å¼ï¼‰ã€‚æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo build --quiet --release &amp;&amp; strace -f -e &#39;connect&#39; ./target/release/waytoodeep
strace: Process 154612 attached
strace: Process 154613 attached
strace: Process 154614 attached
strace: Process 154615 attached
strace: Process 154616 attached
strace: Process 154617 attached
strace: Process 154618 attached
strace: Process 154619 attached
strace: Process 154620 attached
strace: Process 154621 attached
strace: Process 154622 attached
strace: Process 154623 attached
strace: Process 154624 attached
strace: Process 154625 attached
strace: Process 154626 attached
strace: Process 154627 attached
strace: Process 154628 attached
[pid 154627] connect(9, {sa_family=AF_UNIX, sun_path=&#34;/var/run/nscd/socket&#34;}, 110) = -1 ENOENT (No such file or directory)
[pid 154628] connect(10, {sa_family=AF_UNIX, sun_path=&#34;/var/run/nscd/socket&#34;}, 110) = -1 ENOENT (No such file or directory)
[pid 154627] connect(9, {sa_family=AF_UNIX, sun_path=&#34;/var/run/nscd/socket&#34;}, 110) = -1 ENOENT (No such file or directory)
[pid 154628] connect(9, {sa_family=AF_INET, sin_port=htons(53), sin_addr=inet_addr(&#34;127.0.0.53&#34;)}, 16) = 0
[pid 154627] connect(10, {sa_family=AF_INET, sin_port=htons(53), sin_addr=inet_addr(&#34;127.0.0.53&#34;)}, 16) = 0
[pid 154627] connect(9, {sa_family=AF_INET6, sin6_port=htons(0), sin6_flowinfo=htonl(0), inet_pton(AF_INET6, &#34;2606:4700:3034::6815:5ca9&#34;, &amp;sin6_addr), sin6_scope_id=0}, 28) = -1 ENETUNREACH (Network is unreachable)
[pid 154627] connect(9, {sa_family=AF_UNSPEC, sa_data=&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;}, 16) = 0
[pid 154627] connect(9, {sa_family=AF_INET6, sin6_port=htons(0), sin6_flowinfo=htonl(0), inet_pton(AF_INET6, &#34;2606:4700:3031::ac43:c490&#34;, &amp;sin6_addr), sin6_scope_id=0}, 28) = -1 ENETUNREACH (Network is unreachable)
[pid 154627] connect(9, {sa_family=AF_UNSPEC, sa_data=&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;}, 16) = 0
[pid 154627] connect(9, {sa_family=AF_INET, sin_port=htons(0), sin_addr=inet_addr(&#34;104.21.92.169&#34;)}, 16) = 0
[pid 154627] connect(9, {sa_family=AF_UNSPEC, sa_data=&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;}, 16) = 0
[pid 154627] connect(9, {sa_family=AF_INET, sin_port=htons(0), sin_addr=inet_addr(&#34;172.67.196.144&#34;)}, 16) = 0
[pid 154628] connect(10, {sa_family=AF_INET6, sin6_port=htons(0), sin6_flowinfo=htonl(0), inet_pton(AF_INET6, &#34;2606:4700:3034::6815:5ca9&#34;, &amp;sin6_addr), sin6_scope_id=0}, 28) = -1 ENETUNREACH (Network is unreachable)
[pid 154628] connect(10, {sa_family=AF_UNSPEC, sa_data=&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;}, 16) = 0
[pid 154628] connect(10, {sa_family=AF_INET6, sin6_port=htons(0), sin6_flowinfo=htonl(0), inet_pton(AF_INET6, &#34;2606:4700:3031::ac43:c490&#34;, &amp;sin6_addr), sin6_scope_id=0}, 28) = -1 ENETUNREACH (Network is unreachable)
[pid 154628] connect(10, {sa_family=AF_UNSPEC, sa_data=&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;}, 16) = 0
[pid 154628] connect(10, {sa_family=AF_INET, sin_port=htons(0), sin_addr=inet_addr(&#34;104.21.92.169&#34;)}, 16) = 0
[pid 154628] connect(10, {sa_family=AF_UNSPEC, sa_data=&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;}, 16) = 0
[pid 154628] connect(10, {sa_family=AF_INET, sin_port=htons(0), sin_addr=inet_addr(&#34;172.67.196.144&#34;)}, 16) = 0
[pid 154625] connect(9, {sa_family=AF_INET, sin_port=htons(443), sin_addr=inet_addr(&#34;104.21.92.169&#34;)}, 16) = -1 EINPROGRESS (Operation now in progress)
[pid 154626] connect(10, {sa_family=AF_INET, sin_port=htons(443), sin_addr=inet_addr(&#34;104.21.92.169&#34;)}, 16) = -1 EINPROGRESS (Operation now in progress)
Jul 25 19:00:53.862  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&#34;text/html; charset=utf-8&#34;)
Jul 25 19:00:53.880  INFO waytoodeep: Got a response! url=https://fasterthanli.me/series/advent-of-code-2020/part-13 content_type=Some(&#34;text/html; charset=utf-8&#34;)
[pid 154628] +++ exited with 0 +++
[pid 154627] +++ exited with 0 +++
[pid 154618] +++ exited with 0 +++
[pid 154614] +++ exited with 0 +++
[pid 154612] +++ exited with 0 +++
[pid 154619] +++ exited with 0 +++
[pid 154617] +++ exited with 0 +++
[pid 154613] +++ exited with 0 +++
[pid 154615] +++ exited with 0 +++
[pid 154623] +++ exited with 0 +++
[pid 154616] +++ exited with 0 +++
[pid 154624] +++ exited with 0 +++
[pid 154621] +++ exited with 0 +++
[pid 154622] +++ exited with 0 +++
[pid 154626] +++ exited with 0 +++
[pid 154620] +++ exited with 0 +++
[pid 154625] +++ exited with 0 +++
+++ exited with 0 +++shell
</code></pre><p>å“‡å“¦ï¼Œä¸€å¤§å † <code>connect</code> ã€‚</p>
<p>æ‰€ä»¥ç¨‹åºé¦–å…ˆå°è¯•è¿æ¥ <a href="https://jameshfisher.com/2018/02/05/dont-use-nscd/">nscd</a> å› ä¸ºæ˜¾ç„¶æˆ‘ä»¬ä¾ç„¶ç”Ÿæ´»åœ¨ 90 å¹´ä»£ï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">[pid 154627] connect(9, {sa_family=AF_UNIX, sun_path=&#34;/var/run/nscd/socket&#34;}, 110) = -1 ENOENT (No such file or directory)
</code></pre><p>ã€‚ã€‚ã€‚å¹¸å¥½æˆ‘çš„ç³»ç»Ÿæ²¡æœ‰å®ƒï¼Œæ‰€ä»¥å®ƒç»§ç»­é€šè¿‡ <code>/etc/resolv.conf</code> æŸ¥è¯¢ DNSï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">[pid 154628] connect(9, {sa_family=AF_INET, sin_port=htons(53), sin_addr=inet_addr(&#34;127.0.0.53&#34;)}, 16) = 0
</code></pre><p>ç„¶åæœ€ç»ˆè·å¾—ä¸€äº› <a href="https://www.cloudflare.com/ips/">Cloudflare çš„ IP åœ°å€</a>ï¼Œå¦‚ <code>172.67.196.144</code> å’Œ <code>104.21.92.169</code> ã€‚è¿˜æœ‰ä¸€äº› IPv6 ç›¸å…³çš„ï¼Œç”±äºæˆ‘ç¦ç”¨äº† IPv6 æ‰€ä»¥å¹¶æ²¡æœ‰å·¥ä½œï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">[pid 154627] connect(9, {sa_family=AF_INET6, sin6_port=htons(0), sin6_flowinfo=htonl(0), inet_pton(AF_INET6, &#34;2606:4700:3034::6815:5ca9&#34;, &amp;sin6_addr), sin6_scope_id=0}, 28) = -1 ENETUNREACH (Network is unreachable)
</code></pre><p>ç„¶åç»ˆäºç¨‹åºå†³å®šä½¿ç”¨ IPv4 çš„åœ°å€ <code>104.21.92.169</code> å»æ„å»ºè¯·æ±‚ï¼ŒåŒæ—¶æˆ‘ä»¬èƒ½çœ‹åˆ°è¿™äº›éƒ½æ˜¯éé˜»å¡çš„ï¼ˆnon-blockingï¼‰è¿æ¥ï¼Œå› ä¸º <code>connect</code> è¿”å› <code>-1</code> è€Œä¸æ˜¯ <code>0</code> è¡¨ç¤ºã€Œæ­£åœ¨è¿æ¥ã€æ­£åœ¨è¿æ¥ã€ç¨åå›æ¥æ£€æŸ¥ã€ã€‚</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">[pid 154625] connect(9, {sa_family=AF_INET, sin_port=htons(443), sin_addr=inet_addr(&#34;104.21.92.169&#34;)}, 16) = -1 EINPROGRESS (Operation now in progress)
[pid 154626] connect(10, {sa_family=AF_INET, sin_port=htons(443), sin_addr=inet_addr(&#34;104.21.92.169&#34;)}, 16) = -1 EINPROGRESS (Operation now in progress)
</code></pre><p>å¥½äº†ï¼æ‰€ä»¥å¿½ç•¥ <a href="https://isitdns.com/">DNS</a> çš„è¯æˆ‘ä»¬çœ‹åˆ°äº†ä¸¤ä¸ªè¿æ¥ã€‚</p>
<p>åŒæ—¶æˆ‘ä»¬çœ‹åˆ°äº†ä¸€äº›çº¿ç¨‹ã€‚</p>
<p>è¿™å°±æ˜¯ Rust å¼‚æ­¥çš„å·¥ä½œæ–¹å¼ï¼Ÿæˆ‘ä»¬åªæ˜¯ç”¨äº†ä¸€äº›çº¿ç¨‹ï¼Ÿè¿™ä¹Ÿå°±æ˜¯å®ƒèƒ½åœ¨ã€Œåå°è¿è¡Œã€çš„åŸå› ï¼Ÿ</p>
<p>åœ¨æˆ‘ä»¬å›ç­”è¿™äº›é—®é¢˜å‰ï¼Œè®©æˆ‘ä»¬å…ˆè°ƒæ•´æˆ‘ä»¬çš„ä»£ç çœŸæ­£çš„å»ç­‰å¾… future å®Œæˆï¼Œè€Œä¸æ˜¯éšæ„çš„ä¼‘çœ  1 ç§’é’Ÿã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	setup()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> client <span style="color:#f92672">=</span> Client::new();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> leaked_client <span style="color:#f92672">=</span> Box::leak(Box::new(client));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> fut1 <span style="color:#f92672">=</span> fetch_thing(leaked_client, URL_1);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> fut2 <span style="color:#f92672">=</span> fetch_thing(leaked_client, URL_2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> handle1 <span style="color:#f92672">=</span> tokio::spawn(fut1);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> handle2 <span style="color:#f92672">=</span> tokio::spawn(fut2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	handle1.<span style="color:#66d9ef">await</span>.unwrap()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	handle2.<span style="color:#66d9ef">await</span>.unwrap()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç­‰ç­‰ï¼Œæˆ‘ä»¬è¿™ä¸åˆå›åˆ°åŸç‚¹å—ï¼Ÿç­‰å¾…ç¬¬ä¸€ä¸ªè¯·æ±‚å®Œæˆï¼Œç„¶åæ‰å¼€å§‹ç¬¬äºŒä¸ªè¯·æ±‚ã€‚</p>
<p>å½“ç„¶ä¸æ˜¯ï¼æˆ‘ä»¬è¿è¡Œå‡ æ¬¡å°±å¯ä»¥çœ‹åˆ°ï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info cargo run --quiet --release
Jul 25 19:11:07.934  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&#34;text/html; charset=utf-8&#34;)
Jul 25 19:11:07.958  INFO waytoodeep: Got a response! url=https://fasterthanli.me/series/advent-of-code-2020/part-13 content_type=Some(&#34;text/html; charset=utf-8&#34;)
$ RUST_LOG=info cargo run --quiet --release
Jul 25 19:11:08.676  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&#34;text/html; charset=utf-8&#34;)
Jul 25 19:11:08.680  INFO waytoodeep: Got a response! url=https://fasterthanli.me/series/advent-of-code-2020/part-13 content_type=Some(&#34;text/html; charset=utf-8&#34;)
$ RUST_LOG=info cargo run --quiet --release
Jul 25 19:11:09.325  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&#34;text/html; charset=utf-8&#34;)
Jul 25 19:11:09.338  INFO waytoodeep: Got a response! url=https://fasterthanli.me/series/advent-of-code-2020/part-13 content_type=Some(&#34;text/html; charset=utf-8&#34;)
$ RUST_LOG=info cargo run --quiet --release
Jul 25 19:11:10.134  INFO waytoodeep: Got a response! url=https://fasterthanli.me/series/advent-of-code-2020/part-13 content_type=Some(&#34;text/html; charset=utf-8&#34;)
Jul 25 19:11:10.144  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&#34;text/html; charset=utf-8&#34;)
</code></pre><p>ã€‚ã€‚ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹â€œwhats-in-the-boxâ€èƒœå‡ºäº†ï¼ˆå®ƒç¡®å®å…ˆå¼€å§‹ï¼‰ï¼Œä½†æ˜¯â€œadvent-of-code-2020â€ä¹Ÿé¦–å…ˆå®Œæˆäº†å‡ æ¬¡ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¬å¸Œæœ›çœ‹åˆ°çš„ã€‚</p>
<blockquote>
<p>è°¬è®ºï¼šä¹Ÿå°±æ˜¯è¯´å› ä¸ºæœ‰çº¿ç¨‹è¯·æ±‚è¢«å¹¶è¡Œï¼ˆparallelï¼‰çš„æ‰§è¡Œäº†ã€‚</p>
</blockquote>
<p>ä¸æ˜¯çš„ã€‚ä½†æ˜¯ä¸è¦ç›¸ä¿¡æˆ‘ï¼Œè®©æˆ‘ä»¬ç»§ç»­æ·±å…¥ã€‚</p>
<h3 id="ä¸æ˜¯å› ä¸ºçº¿ç¨‹">ä¸æ˜¯å› ä¸ºçº¿ç¨‹<a href="#ä¸æ˜¯å› ä¸ºçº¿ç¨‹" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>è®©æˆ‘ä»¬é€šè¿‡ GDB è¿è¡Œæˆ‘ä»¬çš„å°ç¨‹åºï¼Œå¤§éƒ¨åˆ†åŸå› æ˜¯æˆ‘è¿˜æ²¡æœ‰å¯¹ LLDB å½¢æˆè‚Œè‚‰è®°å¿†ï¼Œæˆ‘ç›¸ä¿¡è¿™æ˜¯æ°´åˆ°æ¸ æˆçš„äº‹ã€‚</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo build --quiet &amp;&amp; gdb --quiet --args ./target/debug/waytoodeep
Reading symbols from ./target/debug/waytoodeep...
warning: Missing auto-load script at offset 0 in section .debug_gdb_scripts
of file /home/amos/ftl/waytoodeep/target/debug/waytoodeep.
Use `info auto-load python-scripts [REGEXP]&#39; to list them.
(gdb)
</code></pre><p>ä¸€åˆ‡å°±ç»ªï¼</p>
<p>åœ¨æˆ‘ä»¬å¼€å§‹ä¹‹å‰å…ˆè®¾ç½®ä¸€ä¸‹æ–­ç‚¹ã€‚æˆ‘è¯´äº†æ–­ç‚¹ï¼Ÿåº”è¯¥æ˜¯æ•æ‰ç‚¹ï¼ˆcatchpointï¼‰ã€‚æˆ‘ä¸çŸ¥é“å‚ä¸æ„é€  HTTP/2 è¯·æ±‚çš„æ‰€æœ‰å‡½æ•°åï¼Œä½†æ˜¯æˆ‘çŸ¥é“ <code>connect</code> å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆsyscallï¼‰ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦æ‰“æ–­ç‚¹çš„åœ°æ–¹ï¼Œæˆ–è€…æ•æ‰ï¼ˆcatchï¼‰ã€‚</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">(gdb) catch syscall connect
Catchpoint 1 (syscall &#39;connect&#39; [42])
</code></pre><p>ç°åœ¨æˆ‘ä»¬å¼€å§‹ï¼</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ Starting program: /home/amos/ftl/waytoodeep/target/debug/waytoodeep
[Thread debugging using libthread_db enabled]
Using host libthread_db library &#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;.
[New Thread 0x7ffff7c28700 (LWP 158945)]
[New Thread 0x7ffff7a27700 (LWP 158946)]
[New Thread 0x7fffef826700 (LWP 158947)]
[New Thread 0x7ffff7826700 (LWP 158948)]
[New Thread 0x7ffff7625700 (LWP 158949)]
[New Thread 0x7ffff7424700 (LWP 158950)]
[New Thread 0x7ffff7223700 (LWP 158951)]
[New Thread 0x7ffff701f700 (LWP 158952)]
[New Thread 0x7ffff6e1e700 (LWP 158953)]
[New Thread 0x7ffff6c1a700 (LWP 158954)]
[New Thread 0x7ffff6a16700 (LWP 158955)]
[New Thread 0x7ffff680f700 (LWP 158956)]
[New Thread 0x7ffff660e700 (LWP 158957)]
[New Thread 0x7ffff640a700 (LWP 158958)]
[New Thread 0x7ffff6206700 (LWP 158959)]
[New Thread 0x7ffff5f4b700 (LWP 158960)]
[New Thread 0x7ffff5d4a700 (LWP 158961)]
[Switching to Thread 0x7ffff5f4b700 (LWP 158960)]

Thread 17 &#34;tokio-runtime-w&#34; hit Catchpoint 1 (call to syscall connect), 0x00007ffff7d5033b in __libc_connect (fd=fd@entry=9, addr=..., addr@entry=...,
	len=len@entry=110) at ../sysdeps/unix/sysv/linux/connect.c:26
26      ../sysdeps/unix/sysv/linux/connect.c: No such file or directory.
(gdb)
</code></pre><p>ä¸é”™ä¸é”™ï¼ŒçœŸå¿«ï¼æˆ‘ä»¬åœåœ¨äº†åä¸º <code>tokio-runtime-w</code> çš„ <code>Thread 17</code> ä¸­ï¼Œå› ä¸ºæˆ‘çŒœå…¶ä»–æ‰€æœ‰å­—æ¯éƒ½è¢«ä½¿ç”¨äº†ã€‚</p>
<blockquote>
<p><code>w</code> æ„å‘³è¿™ <code>worker</code> ï¼Œå¦‚æœä½ ä¸æ˜¯ç¬¬ä¸€å¤©ç”¨ Unix å°±ä¼šçŸ¥é“ä»€ä¹ˆè¿™ä¹ˆç®€å†™ã€‚</p>
</blockquote>
<p>å¥½çš„ï¼Œ <code>Thread 17</code> ï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹åœ¨åšä»€ä¹ˆå‘¢ï¼Ÿ</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">(gdb) info threads
  Id   Target Id                                            Frame
  1    Thread 0x7ffff7c2c6c0 (LWP 158941) &#34;waytoodeep&#34;      syscall () at ../sysdeps/unix/sysv/linux/x86_64/syscall.S:38
  2    Thread 0x7ffff7c28700 (LWP 158945) &#34;tokio-runtime-w&#34; syscall () at ../sysdeps/unix/sysv/linux/x86_64/syscall.S:38
  3    Thread 0x7ffff7a27700 (LWP 158946) &#34;tokio-runtime-w&#34; 0x00007ffff7d4f5ce in epoll_wait (epfd=3, events=0x555556338b60, maxevents=1024, timeout=-1)
	at ../sysdeps/unix/sysv/linux/epoll_wait.c:30
  4    Thread 0x7fffef826700 (LWP 158947) &#34;tokio-runtime-w&#34; syscall () at ../sysdeps/unix/sysv/linux/x86_64/syscall.S:38
  5    Thread 0x7ffff7826700 (LWP 158948) &#34;tokio-runtime-w&#34; syscall () at ../sysdeps/unix/sysv/linux/x86_64/syscall.S:38
  6    Thread 0x7ffff7625700 (LWP 158949) &#34;tokio-runtime-w&#34; syscall () at ../sysdeps/unix/sysv/linux/x86_64/syscall.S:38
  7    Thread 0x7ffff7424700 (LWP 158950) &#34;tokio-runtime-w&#34; syscall () at ../sysdeps/unix/sysv/linux/x86_64/syscall.S:38
  8    Thread 0x7ffff7223700 (LWP 158951) &#34;tokio-runtime-w&#34; syscall () at ../sysdeps/unix/sysv/linux/x86_64/syscall.S:38
  9    Thread 0x7ffff701f700 (LWP 158952) &#34;tokio-runtime-w&#34; syscall () at ../sysdeps/unix/sysv/linux/x86_64/syscall.S:38
  10   Thread 0x7ffff6e1e700 (LWP 158953) &#34;tokio-runtime-w&#34; syscall () at ../sysdeps/unix/sysv/linux/x86_64/syscall.S:38
  11   Thread 0x7ffff6c1a700 (LWP 158954) &#34;tokio-runtime-w&#34; syscall () at ../sysdeps/unix/sysv/linux/x86_64/syscall.S:38
  12   Thread 0x7ffff6a16700 (LWP 158955) &#34;tokio-runtime-w&#34; syscall () at ../sysdeps/unix/sysv/linux/x86_64/syscall.S:38
  13   Thread 0x7ffff680f700 (LWP 158956) &#34;tokio-runtime-w&#34; syscall () at ../sysdeps/unix/sysv/linux/x86_64/syscall.S:38
  14   Thread 0x7ffff660e700 (LWP 158957) &#34;tokio-runtime-w&#34; syscall () at ../sysdeps/unix/sysv/linux/x86_64/syscall.S:38
  15   Thread 0x7ffff640a700 (LWP 158958) &#34;tokio-runtime-w&#34; syscall () at ../sysdeps/unix/sysv/linux/x86_64/syscall.S:38
  16   Thread 0x7ffff6206700 (LWP 158959) &#34;tokio-runtime-w&#34; syscall () at ../sysdeps/unix/sysv/linux/x86_64/syscall.S:38
 *17   Thread 0x7ffff5f4b700 (LWP 158960) &#34;tokio-runtime-w&#34; 0x00007ffff7d5033b in __libc_connect (fd=fd@entry=9, addr=..., addr@entry=..., len=len@entry=110)
	at ../sysdeps/unix/sysv/linux/connect.c:26
  18   Thread 0x7ffff5d4a700 (LWP 158961) &#34;tokio-runtime-w&#34; 0x00007ffff7d48a46 in __GI___mmap64 (offset=0, fd=-1, flags=16418, prot=0, len=134217728, addr=0x0)
	at ../sysdeps/unix/sysv/linux/mmap64.c:59
</code></pre><p>é¢ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥è·å¾—æ›´å¤šçš„æ ˆå¸§ï¼Ÿ</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">(gdb) thread apply all backtrace 2

Thread 18 (Thread 0x7ffff5d4a700 (LWP 158961)):
#0  0x00007ffff7d48a46 in __GI___mmap64 (offset=0, fd=-1, flags=16418, prot=0, len=134217728, addr=0x0) at ../sysdeps/unix/sysv/linux/mmap64.c:59
#1  __GI___mmap64 (addr=addr@entry=0x0, len=len@entry=134217728, prot=prot@entry=0, flags=flags@entry=16418, fd=fd@entry=-1, offset=offset@entry=0) at ../sysdeps/unix/sysv/linux/mmap64.c:47
(More stack frames follow...)

Thread 17 (Thread 0x7ffff5f4b700 (LWP 158960)):
#0  0x00007ffff7d5033b in __libc_connect (fd=fd@entry=9, addr=..., addr@entry=..., len=len@entry=110) at ../sysdeps/unix/sysv/linux/connect.c:26
#1  0x00007ffff7d8b713 in open_socket (type=type@entry=GETFDHST, key=key@entry=0x7ffff7de5ccb &#34;hosts&#34;, keylen=keylen@entry=6) at nscd_helper.c:185
(More stack frames follow...)

Thread 16 (Thread 0x7ffff6206700 (LWP 158959)):
#0  syscall () at ../sysdeps/unix/sysv/linux/x86_64/syscall.S:38
#1  0x0000555555b9f1d1 in parking_lot_core::thread_parker::imp::ThreadParker::futex_wait (self=0x7ffff6206498, ts=...) at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/parking_lot_core-0.8.3/src/thread_parker/linux.rs:112
(More stack frames follow...)

Thread 15 (Thread 0x7ffff640a700 (LWP 158958)):
#0  syscall () at ../sysdeps/unix/sysv/linux/x86_64/syscall.S:38
#1  0x0000555555b9f1d1 in parking_lot_core::thread_parker::imp::ThreadParker::futex_wait (self=0x7ffff640a498, ts=...) at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/parking_lot_core-0.8.3/src/thread_parker/linux.rs:112
(More stack frames follow...)

Thread 14 (Thread 0x7ffff660e700 (LWP 158957)):
#0  syscall () at ../sysdeps/unix/sysv/linux/x86_64/syscall.S:38
#1  0x0000555555b9f1d1 in parking_lot_core::thread_parker::imp::ThreadParker::futex_wait (self=0x7ffff660e498, ts=...) at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/parking_lot_core-0.8.3/src/thread_parker/linux.rs:112
(More stack frames follow...)

Thread 13 (Thread 0x7ffff680f700 (LWP 158956)):
#0  syscall () at ../sysdeps/unix/sysv/linux/x86_64/syscall.S:38
#1  0x0000555555b9f1d1 in parking_lot_core::thread_parker::imp::ThreadParker::futex_wait (self=0x7ffff680f498, ts=...) at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/parking_lot_core-0.8.3/src/thread_parker/linux.rs:112
(More stack frames follow...)
</code></pre><p>é¢ã€‚å¤§éƒ¨åˆ†éƒ½æ˜¯æŒ‚èµ·çš„ã€‚ä¹Ÿå°±æ˜¯ç©ºé—²çš„ã€‚æ›´å‡†ç¡®çš„æ˜¯å®ƒä»¬åœ¨ç­‰å¾…å·¥ä½œã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ htop æŸ¥çœ‹è¿™äº›æ‰€æœ‰çº¿ç¨‹ï¼Œæˆ‘çŸ¥é“æˆ‘ä»¬å·²ç»çœ‹åˆ°äº†ï¼Œä½†æ˜¯æˆ‘ä»…ä»…æ˜¯è§‰å¾— htop å¾ˆæ£’ã€‚æ„Ÿè°¢ <a href="https://twitter.com/hisham%5Fhm">Hisham</a>ï¼
<img src="https://fasterthanli.me/content/articles/understanding-rust-futures-by-going-way-too-deep/assets/htop-colors.571c5effbff8a0b3.webp" alt="">
æ‰€ä»¥ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°ä¸€äº›çº¿ç¨‹ï¼ŒåŒæ—¶ä¹Ÿæœ‰ä¸€äº› CPU æ ¸å¿ƒã€‚å¯èƒ½æ˜¯ä¸€ä¸ª CPU æ ¸å¿ƒä¸€ä¸ªçº¿ç¨‹ï¼Ÿ
<img src="https://fasterthanli.me/content/articles/understanding-rust-futures-by-going-way-too-deep/assets/worker-threads.64dbe39e33ccfc4f.webp" alt="">
æ˜¯çš„ã€‚ç„¶åè¿˜æœ‰ä¸€äº›é˜»å¡çš„çº¿ç¨‹ï¼Œæ­£å¦‚æˆ‘ä»¬ä»ä¸Šé¢ <code>strace</code> è¾“å‡ºçœ‹åˆ°çš„é‚£æ ·ï¼Œ å®ƒä¼šè¿›è¡Œä¸€äº›é˜»å¡çš„ <code>connect</code> è°ƒç”¨å»æŸ¥è¯¢ DNSï¼ˆå®é™…æ˜¯ glibc åœ¨æ‰§è¡Œï¼‰ï¼Œ
æ‰€ä»¥å®ƒé€šè¿‡è¿è¡Œåœ¨å·¥ä½œçº¿ç¨‹ä¹‹å¤–é¿å…é˜»å¡å…¶ä»–ä»»åŠ¡ã€‚</p>
<blockquote>
<p>æ‰€ä»¥å¤šä¸ªçº¿ç¨‹ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸€æ¬¡å¯ä»¥è¿è¡Œå¤šä¸ªè¯·æ±‚çš„åŸå› ï¼Ÿ</p>
</blockquote>
<p>å®é™…ä¸Šæ–‡æ¡£ä¸Šè¡¨æ˜è¿™æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„æ‰§è¡Œå™¨ï¼Œæˆ‘ä¹Ÿä¸èƒ½ç¡®å®šï¼Œæ‰€ä»¥è®©æˆ‘ä»¬è¯•ä¸€ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">//                           ğŸ‘‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#[tokio::main(flavor = </span><span style="color:#e6db74">&#34;current_thread&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// (same as before)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info cargo run --quiet --release
Jul 25 19:50:15.977  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&#34;text/html; charset=utf-8&#34;)
Jul 25 19:50:15.994  INFO waytoodeep: Got a response! url=https://fasterthanli.me/series/advent-of-code-2020/part-13 content_type=Some(&#34;text/html; charset=utf-8&#34;)
</code></pre><p>ä¸¤ä¸ªå“åº”é—´éš” <code>17ms</code> ï¼Œè¿™ä¸ªæ—¶é—´ä¸å¤Ÿæ„é€ ä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚ï¼Œæ‰€ä»¥è¯·æ±‚å¹¶è¡Œï¼ˆparallelï¼‰çš„æ‰§è¡Œäº†ã€‚å¦‚æœä½ ä¾ç„¶åšæŒå®ƒå†…éƒ¨ä½¿ç”¨äº†çº¿ç¨‹ï¼Œè®©æˆ‘ä»¬è¿›ä¸€æ­¥ç¡®è®¤æˆ‘ä»¬åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼š
<img src="https://fasterthanli.me/content/articles/understanding-rust-futures-by-going-way-too-deep/assets/current-thread.cd7b619ed644899b.webp" alt="">
ç¡®å®æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯è¿™äº›éƒ½æ˜¯é˜»å¡çº¿ç¨‹ã€‚ä»…ä»…æ˜¯ DNS æŸ¥è¯¢ã€‚å¯ä»¥é€šè¿‡ htop çœ‹åˆ°å·²ç»æ²¡æœ‰æ— æ•°ï¼ˆ15ï¼‰çš„å·¥ä½œçº¿ç¨‹äº†ï¼š
<img src="https://fasterthanli.me/content/articles/understanding-rust-futures-by-going-way-too-deep/assets/htop-current-thread.fe28174abc5d15fa.webp" alt="">
ï¼ˆé¡ºä¾¿è¯´ä¸€ä¸‹ 15 ä¸ªå·¥ä½œçº¿ç¨‹çš„åŸå› ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘é¢„ç•™äº†ä¸€ä¸ª CPU æ ¸å¿ƒæ²¡æœ‰åˆ†é…ç»™è™šæ‹Ÿæœºï¼Œè¿™æ ·å³ä½¿è™šæ‹Ÿæœºå…¨é€Ÿè¿è¡Œä¹Ÿä¸ä¼šå¯¼è‡´å®¿ä¸»æœºåœæ­¢å“åº”ï¼‰ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬å°† DNS æŸ¥è¯¢æ’é™¤åœ¨å¤–ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°å®é™…ä¸Šä»…ä»…ä½¿ç”¨äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œæˆ‘ä»¬å°†ç»§ç»­ä¸‹å»ï¼Œä»¥é˜²ä½ ä¾ç„¶å­˜ç–‘ï¼</p>
<h3 id="æ’æ›²-è®©æˆ‘ä»¬é¿å…æ³„æ¼å†…å­˜">æ’æ›²ï¼šè®©æˆ‘ä»¬é¿å…æ³„æ¼å†…å­˜<a href="#æ’æ›²-è®©æˆ‘ä»¬é¿å…æ³„æ¼å†…å­˜" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>ä½†æ˜¯åœ¨é‚£ä¹‹å‰ï¼šæ­£åœ¨æ³„æ¼ reqwest çš„ <code>Client</code> è®©æˆ‘å¾ˆä¸çˆ½ã€‚</p>
<p>ä¸ºäº†é¿å…ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªåŸå­å¼•ç”¨è®¡æ•°ï¼ˆatomically-reference-countedï¼‰ï¼Œè¿™æ ·å®ƒå°±å¯ä»¥éšç€ä»»åŠ¡è¿è¡Œè€Œå­˜æ´»ã€‚</p>
<p>ä¿®æ”¹èµ·æ¥éå¸¸ç®€å•ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">//             ğŸ‘‡ Atomically Reference Counted = Arc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">use</span> std::sync::Arc;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main(flavor = </span><span style="color:#e6db74">&#34;current_thread&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	setup()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//           ğŸ‘‡ there we go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> client <span style="color:#f92672">=</span> Arc::new(Client::new());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//                              ğŸ‘‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> fut1 <span style="color:#f92672">=</span> fetch_thing(client.clone(), URL_1);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// (cloning it only increases the reference count)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> fut2 <span style="color:#f92672">=</span> fetch_thing(client.clone(), URL_2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> handle1 <span style="color:#f92672">=</span> tokio::spawn(fut1);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> handle2 <span style="color:#f92672">=</span> tokio::spawn(fut2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	handle1.<span style="color:#66d9ef">await</span>.unwrap()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	handle2.<span style="color:#66d9ef">await</span>.unwrap()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[allow(clippy::manual_async_fn)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fetch_thing</span>(
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//       ğŸ‘‡ now taking this, we have shared ownership of it
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	client: <span style="color:#a6e22e">Arc</span><span style="color:#f92672">&lt;</span>Client<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>	url: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&#39;</span>static <span style="color:#66d9ef">str</span>,
</span></span><span style="display:flex;"><span>) -&gt; <span style="color:#a6e22e">impl</span> Future<span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;&gt;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">&#39;</span>static {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">async</span> <span style="color:#66d9ef">move</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// luckily this  ğŸ‘‡ only requires `&amp;self`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">let</span> res <span style="color:#f92672">=</span> client.get(url).send().<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>.error_for_status()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>		info<span style="color:#f92672">!</span>(<span style="color:#f92672">%</span>url, content_type <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>res.headers().get(<span style="color:#e6db74">&#34;content-type&#34;</span>), <span style="color:#e6db74">&#34;Got a response!&#34;</span>);
</span></span><span style="display:flex;"><span>		Ok(())
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¥½äº†ï¼Œç°åœ¨æˆ‘æ„Ÿè§‰å¥½å¤šäº†ã€‚æˆ‘ä»¬çš„ç¨‹åºä¸å†æ³„æ¼ä¸€äº›å­—èŠ‚å³ä½¿å®ƒæ°¸è¿œä¸ä¼šè¿è¡Œè¶…è¿‡å‡ ç§’é’Ÿã€‚ä¸€åˆ‡éƒ½è¿˜å¥½ã€‚</p>
<p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ <code>reqwest</code> çš„ <code>Client</code> å®šä¹‰:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[derive(Clone)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Client</span> {
</span></span><span style="display:flex;"><span>	inner: <span style="color:#a6e22e">Arc</span><span style="color:#f92672">&lt;</span>ClientRef<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å®ƒå·²ç»æ˜¯å¼•ç”¨è®¡æ•°çš„äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥æ¥å—ä¸€ä¸ª <code>Client</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main(flavor = </span><span style="color:#e6db74">&#34;current_thread&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	setup()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//             ğŸ‘‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> client <span style="color:#f92672">=</span> Client::new();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//                              ğŸ‘‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> fut1 <span style="color:#f92672">=</span> fetch_thing(client.clone(), URL_1);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// no need to clone a second time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> fut2 <span style="color:#f92672">=</span> fetch_thing(client, URL_2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> handle1 <span style="color:#f92672">=</span> tokio::spawn(fut1);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> handle2 <span style="color:#f92672">=</span> tokio::spawn(fut2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	handle1.<span style="color:#66d9ef">await</span>.unwrap()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	handle2.<span style="color:#66d9ef">await</span>.unwrap()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[allow(clippy::manual_async_fn)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fetch_thing</span>(
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//        ğŸ‘‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	client: <span style="color:#a6e22e">Client</span>,
</span></span><span style="display:flex;"><span>	url: <span style="color:#66d9ef">&amp;</span><span style="color:#f92672">&#39;</span>static <span style="color:#66d9ef">str</span>,
</span></span><span style="display:flex;"><span>) -&gt; <span style="color:#a6e22e">impl</span> Future<span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;&gt;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">&#39;</span>static {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">async</span> <span style="color:#66d9ef">move</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> res <span style="color:#f92672">=</span> client.get(url).send().<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>.error_for_status()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>		info<span style="color:#f92672">!</span>(<span style="color:#f92672">%</span>url, content_type <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>res.headers().get(<span style="color:#e6db74">&#34;content-type&#34;</span>), <span style="color:#e6db74">&#34;Got a response!&#34;</span>);
</span></span><span style="display:flex;"><span>		Ok(())
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¥½äº†ã€‚</p>
<p>å¯¹äº†ï¼Œä»…ä¾›å‚è€ƒï¼Œæ›´ç®€å•çš„ <code>async fn</code> ä¹Ÿå¯ä»¥å·¥ä½œäº†ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fetch_thing</span>(client: <span style="color:#a6e22e">Client</span>, url: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span>) -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> res <span style="color:#f92672">=</span> client.get(url).send().<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>.error_for_status()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#f92672">%</span>url, content_type <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>res.headers().get(<span style="color:#e6db74">&#34;content-type&#34;</span>), <span style="color:#e6db74">&#34;Got a response!&#34;</span>);
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬ç”šè‡³ä¸éœ€è¦è¦æ±‚ <code>url</code> çš„å€Ÿç”¨ç”Ÿå‘½å‘¨æœŸæ˜¯ <code>'static</code> ã€‚å¦‚æœ <code>url</code> æ˜¯ <code>'static</code> çš„åˆ™è¿”å›çš„ Future ä¹Ÿæ˜¯ï¼Œåä¹‹äº¦ç„¶ã€‚</p>
<p>ä½œä¸ºä¾‹å­ï¼Œä¸‹é¢ä»£ç æ— æ³•é€šè¿‡ç¼–è¯‘ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main(flavor = </span><span style="color:#e6db74">&#34;current_thread&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	setup()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> client <span style="color:#f92672">=</span> Client::new();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// this is a `String`, owned by main
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> url1 <span style="color:#f92672">=</span> String::from(URL_1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// we&#39;re borrowing from main           ğŸ‘‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> fut1 <span style="color:#f92672">=</span> fetch_thing(client.clone(), <span style="color:#f92672">&amp;</span>url1);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> fut2 <span style="color:#f92672">=</span> fetch_thing(client, URL_2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> handle1 <span style="color:#f92672">=</span> tokio::spawn(fut1);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> handle2 <span style="color:#f92672">=</span> tokio::spawn(fut2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	handle1.<span style="color:#66d9ef">await</span>.unwrap()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	handle2.<span style="color:#66d9ef">await</span>.unwrap()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo check
	Checking waytoodeep v0.1.0 (/home/amos/ftl/waytoodeep)

error[E0597]: `url1` does not live long enough
  --&gt; src/main.rs:18:44
   |
18 |     let fut1 = fetch_thing(client.clone(), &amp;url1);
   |                ----------------------------^^^^^-
   |                |                           |
   |                |                           borrowed value does not live long enough
   |                argument requires that `url1` is borrowed for `&#39;static`
...
28 | }
   | - `url1` dropped here while still borrowed
</code></pre><blockquote>
<p>ä½ é¢å¯¹çš„è€ƒéªŒå°±æ˜¯ï¼šä¿®æ”¹äº†ä¸€äº›ä»£ç ï¼Œç„¶åçªç„¶é—´æ•´ä¸ª <code>Future</code> ä¸å†å®ç° <code>Send</code> ï¼Œä½†æ˜¯ä½ éœ€è¦å®ƒå®ç° <code>Send</code> ã€‚å‚è€ƒ<a href="https://fasterthanli.me/articles/getting-in-and-out-of-trouble-with-rust-futures">Getting in and out of trouble with Rust futures</a>ã€‚</p>
</blockquote>
<p>åœ¨æˆ‘ä»¬è¿›ä¸€æ­¥æ·±å…¥ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æƒ³æä¸€ä¸‹ï¼Œé™¤äº†é€šè¿‡ <code>tokio::spawn</code> å¯ä»¥åŒæ—¶è¿è¡Œä¸¤ä¸ª future å¹¶ä¸”ç«‹å³ç­‰å¾…ä¸¤ä¸ª future å®Œæˆï¼Œè¿˜æ˜¯ä½¿ç”¨ <code>FuturesUnordered</code> å®ç°ç›¸åŒç›®çš„ã€‚</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo add futures@0.3.16
	Updating &#39;https://github.com/rust-lang/crates.io-index&#39; index
	  Adding futures v0.3.16 to dependencies
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> futures::{stream::FuturesUnordered, StreamExt};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main(flavor = </span><span style="color:#e6db74">&#34;current_thread&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	setup()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> client <span style="color:#f92672">=</span> Client::new();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> group <span style="color:#f92672">=</span> vec![
</span></span><span style="display:flex;"><span>		fetch_thing(client.clone(), URL_1),
</span></span><span style="display:flex;"><span>		fetch_thing(client, URL_2),
</span></span><span style="display:flex;"><span>	]
</span></span><span style="display:flex;"><span>	.into_iter()
</span></span><span style="display:flex;"><span>	.collect::<span style="color:#f92672">&lt;</span>FuturesUnordered<span style="color:#f92672">&lt;</span>_<span style="color:#f92672">&gt;&gt;</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">while</span> <span style="color:#66d9ef">let</span> Some(item) <span style="color:#f92672">=</span> group.next().<span style="color:#66d9ef">await</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// propagate errors
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		item<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>é€šè¿‡è¿™ä¸ªè§£å†³åŠå•ƒå•Šï¼Œæˆ‘ä»¬å¯ä»¥ await ä»»æ„æ•°é‡çš„ future å¯¹è±¡ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å¹¶å‘çš„è¢«è½®è¯¢ï¼ˆpolledï¼‰ã€‚</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info cargo run --quiet --release
Jul 25 20:12:37.208  INFO waytoodeep: Got a response! url=https://fasterthanli.me/articles/whats-in-the-box content_type=Some(&#34;text/html; charset=utf-8&#34;)
Jul 25 20:12:37.227  INFO waytoodeep: Got a response! url=https://fasterthanli.me/series/advent-of-code-2020/part-13 content_type=Some(&#34;text/html; charset=utf-8&#34;)
</code></pre><p>ä»…ä»…ã€‚ã€‚ã€‚19 æ¯«ç§’çš„é—´éš” &ndash; å¯ä»¥ç¡®å®šæ˜¯å¹¶å‘çš„ã€‚</p>
<h3 id="å½»åº•æ‘†è„±-dns">å½»åº•æ‘†è„± DNS<a href="#å½»åº•æ‘†è„±-dns" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>ç°åœ¨è®©æˆ‘ä»¬æš‚æ—¶å¿˜æ‰ <code>reqwest</code> ã€‚</p>
<p>HTTP <a href="https://fasterthanli.me/articles/aiming-for-correctness-with-types">å¹¶ä¸éš¾</a> ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±æ„å»ºã€‚åªè¦ TCP å°±è¡Œï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::net::SocketAddr;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> tokio::{
</span></span><span style="display:flex;"><span>	io::{AsyncReadExt, AsyncWriteExt},
</span></span><span style="display:flex;"><span>	net::TcpStream,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fetch_thing</span>(name: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span>) -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// look mom, no DNS!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> addr: <span style="color:#a6e22e">SocketAddr</span> <span style="color:#f92672">=</span> ([<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">80</span>).into();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> socket <span style="color:#f92672">=</span> TcpStream::connect(addr).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// we&#39;re writing straight to the socket, there&#39;s no buffering
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// so no need to flush
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	socket.write_all(<span style="color:#e6db74">b&#34;GET / HTTP/1.1</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	socket.write_all(<span style="color:#e6db74">b&#34;Host: 1.1.1.1</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	socket.write_all(<span style="color:#e6db74">b&#34;User-Agent: cool-bear</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	socket.write_all(<span style="color:#e6db74">b&#34;Connection: close</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	socket.write_all(<span style="color:#e6db74">b&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> response <span style="color:#f92672">=</span> String::with_capacity(<span style="color:#ae81ff">256</span>);
</span></span><span style="display:flex;"><span>	socket.read_to_string(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> response).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> status <span style="color:#f92672">=</span> response.lines().next().unwrap_or_default();
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#f92672">%</span>status, , <span style="color:#e6db74">&#34;Got response!&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// dropping the socket will close the connection
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯ä»¥æ­£å¸¸è¿è¡Œï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info cargo run --quiet --release
Jul 25 20:24:05.158  INFO waytoodeep: Got response! status=HTTP/1.1 301 Moved Permanently name=second
Jul 25 20:24:05.159  INFO waytoodeep: Got response! status=HTTP/1.1 301 Moved Permanently name=first
</code></pre><p>ï¼ˆçœ‹ï¼Œç¬¬äºŒä¸ªèµ¢å¾—äº†èƒœåˆ©ï¼‰ã€‚</p>
<p>åŒæ—¶å†ä¹Ÿæ²¡æœ‰ DNS æŸ¥è¯¢äº†ã€‚</p>
<p>å½“ç„¶ <code>http://1.1.1.1</code> å°†æˆ‘ä»¬é‡å®šå‘åˆ° HTTPS çš„é¡µé¢ï¼ŒæŠ€æœ¯ä¸Šå®ç° TLS å¹¶ä¸å›°éš¾ï¼Œä½†æ˜¯æˆ‘ä»¬çš„ç¯‡å¹…å·²ç»å¾ˆé•¿äº†ï¼Œæ‰€ä»¥ã€‚ã€‚ã€‚</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo add tokio-rustls@0.22.0
	Updating &#39;https://github.com/rust-lang/crates.io-index&#39; index
	  Adding tokio-rustls v0.22.0 to dependencies
$ cargo add webpki@0.21.4
	Updating &#39;https://github.com/rust-lang/crates.io-index&#39; index
	  Adding webpki v0.21.4 to dependencies
$ cargo add webpki-roots@0.21.1
	Updating &#39;https://github.com/rust-lang/crates.io-index&#39; index
	  Adding webpki-roots v0.21.1 to dependencies
</code></pre><p>ç„¶åã€‚ã€‚ã€‚</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo rm reqwest
	Removing reqwest from dependencies
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::sync::Arc;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> webpki::DNSNameRef;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> tokio_rustls::{rustls::ClientConfig, TlsConnector};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fetch_thing</span>(name: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span>) -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// look out it&#39;s port 443 now
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> addr: <span style="color:#a6e22e">SocketAddr</span> <span style="color:#f92672">=</span> ([<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">443</span>).into();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> socket <span style="color:#f92672">=</span> TcpStream::connect(addr).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// establish a TLS session...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> connector: <span style="color:#a6e22e">TlsConnector</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> config <span style="color:#f92672">=</span> ClientConfig::new();
</span></span><span style="display:flex;"><span>		config
</span></span><span style="display:flex;"><span>			.root_store
</span></span><span style="display:flex;"><span>			.add_server_trust_anchors(<span style="color:#f92672">&amp;</span>webpki_roots::TLS_SERVER_ROOTS);
</span></span><span style="display:flex;"><span>		Arc::new(config).into()
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// we have to use the proper DNS name now      ğŸ‘‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> dnsname <span style="color:#f92672">=</span> DNSNameRef::try_from_ascii_str(<span style="color:#e6db74">&#34;one.one.one.one&#34;</span>)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> socket <span style="color:#f92672">=</span> connector.connect(dnsname, socket).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// we&#39;re writing straight to the socket, there&#39;s no buffering
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// so no need to flush
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	socket.write_all(<span style="color:#e6db74">b&#34;GET / HTTP/1.1</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//                        ğŸ‘‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	socket.write_all(<span style="color:#e6db74">b&#34;Host: one.one.one.one</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	socket.write_all(<span style="color:#e6db74">b&#34;User-Agent: cool-bear</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	socket.write_all(<span style="color:#e6db74">b&#34;Connection: close</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	socket.write_all(<span style="color:#e6db74">b&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> response <span style="color:#f92672">=</span> String::with_capacity(<span style="color:#ae81ff">256</span>);
</span></span><span style="display:flex;"><span>	socket.read_to_string(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> response).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> status <span style="color:#f92672">=</span> response.lines().next().unwrap_or_default();
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#f92672">%</span>status, , <span style="color:#e6db74">&#34;Got response!&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// dropping the socket will close the connection
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info cargo run --quiet --release
Jul 25 20:31:32.627  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=second
Jul 25 20:31:32.658  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=first
</code></pre><p>å¥½äº†ï¼Œç°åœ¨è¿”å›çŠ¶æ€ç  200ï¼</p>
<p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯äº†è§£ Rust çš„ futureï¼Œæˆ‘ä»¬å·²ç»è·å¾—äº†ä¸é”™çš„è¿›å±•ã€‚</p>
<p>ä½†æ˜¯è®©æˆ‘ä»¬è€ƒè™‘ä»¥ä¸‹åœºæ™¯ï¼šæˆ‘ä»¬æƒ³å¹¶å‘çš„æ‰§è¡Œä¸¤ä¸ªè¯·æ±‚ï¼Œä¸€æ—¦å…¶ä¸­ä¸€ä¸ªå¤±è´¥ï¼Œå¦å¤–ä¸€ä¸ªä¹Ÿåº”è¯¥ç«‹å³è¯·æ±‚å¤±è´¥ï¼Œæˆ–è€…ä¸¤ä¸ªä¸€èµ·æˆåŠŸã€‚</p>
<h3 id="tokio-çš„-try-join-å®">tokio çš„ try_join å®<a href="#tokio-çš„-try-join-å®" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>å®é™…ä¸Šï¼Œåˆä¸€ä¸ªå®å¯ä»¥åšè¿™ä¸ªï¼</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main(flavor = </span><span style="color:#e6db74">&#34;current_thread&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	setup()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> res <span style="color:#f92672">=</span> tokio::try_join<span style="color:#f92672">!</span>(fetch_thing(<span style="color:#e6db74">&#34;first&#34;</span>), fetch_thing(<span style="color:#e6db74">&#34;second&#34;</span>),)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#f92672">?</span>res, <span style="color:#e6db74">&#34;All done!&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¿™å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info cargo run --quiet --release
Jul 25 20:44:52.150  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=first
Jul 25 20:44:52.165  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=second
Jul 25 20:44:52.165  INFO waytoodeep: All done! res=((), ())
</code></pre><p>å†æ¬¡å¿«é€Ÿæ£€æŸ¥ä»¥ä¸‹ï¼šå“åº”é—´éš”åœ¨ 15ms &ndash; ä¹Ÿå°±æ˜¯ç¡®å®šæ˜¯å¹¶å‘çš„å‘é€ã€‚</p>
<p><code>try_join!</code> å¸®æˆ‘ä»¬è¿›è¡Œäº† <code>await</code> ï¼ŒåŒæ—¶å¸®æˆ‘ä»¬å¤„ç†äº†ç»“æœã€‚å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œæˆ‘ä»¬å¾—åˆ°æ‰€æœ‰ future å¯¹è±¡çš„ç»“æœï¼šå†…å®¹ä¸º <code>Ok</code> çš„ç©ºå…ƒç»„ï¼ˆæœ‰åºçš„ï¼‰ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å–åˆ°æˆ‘ä»¬ future è¿”å›çš„å¯¹è±¡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">//                                          ğŸ‘‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fetch_thing</span>(name: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span>) -&gt; Result<span style="color:#f92672">&lt;&amp;</span><span style="color:#66d9ef">str</span>, Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// (omitted)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  ğŸ‘‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	Ok(name)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬è‡ªå·±ï¼Œå®ƒä»¬æŒ‰ç…§é¡ºåºè¿”å›ï¼Œæ— è®ºå“ªä¸ªå…ˆè¢«æ‰§è¡Œï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info cargo run --quiet --release
Jul 25 20:47:56.967  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=second
Jul 25 20:47:56.967  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=first
Jul 25 20:47:56.967  INFO waytoodeep: All done! res=(&#34;first&#34;, &#34;second&#34;)
$ RUST_LOG=info cargo run --quiet --release
Jul 25 20:47:57.933  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=first
Jul 25 20:47:57.935  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=second
Jul 25 20:47:57.935  INFO waytoodeep: All done! res=(&#34;first&#34;, &#34;second&#34;)
$ RUST_LOG=info cargo run --quiet --release
Jul 25 20:47:58.942  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=second
Jul 25 20:47:58.946  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=first
Jul 25 20:47:58.946  INFO waytoodeep: All done! res=(&#34;first&#34;, &#34;second&#34;)
</code></pre><p>å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬æ²¡æœ‰ DNS æŸ¥è¯¢ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¶ˆé™¤â€œåŒæ—¶â€è¯·æ±‚æ˜¯ç”±äºå¤šçº¿ç¨‹å®ç°çš„ã€‚</p>
<p>å› ä¸ºï¼Œå¦‚æœæˆ‘ä»¬åœ¨ <code>strace</code> ä¸‹è¿è¡Œç¨‹åºï¼Œå¹¶é€šè¿‡ <code>-f</code> è¯·æ±‚è·Ÿè¸ªå­çº¿ç¨‹ï¼ˆ BTW <code>f</code> æ„æ€æ˜¯è·Ÿè¸ªï¼ˆ <code>follow</code> ï¼‰å­çº¿ç¨‹ï¼‰ï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ cargo build --quiet --release &amp;&amp; strace -f -e &#39;connect&#39; ./target/release/waytoodeep
connect(9, {sa_family=AF_INET, sin_port=htons(443), sin_addr=inet_addr(&#34;1.1.1.1&#34;)}, 16) = -1 EINPROGRESS (Operation now in progress)
connect(10, {sa_family=AF_INET, sin_port=htons(443), sin_addr=inet_addr(&#34;1.1.1.1&#34;)}, 16) = -1 EINPROGRESS (Operation now in progress)
Jul 25 20:51:54.004  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=first
Jul 25 20:51:54.013  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=second
Jul 25 20:51:54.015  INFO waytoodeep: All done! res=(&#34;first&#34;, &#34;second&#34;)
+++ exited with 0 +++
</code></pre><p>ã€‚ã€‚ã€‚ç°åœ¨æˆ‘ä»¬çœ‹åˆ°äº†é¢„æœŸçš„ä¸¤æ¬¡ <code>connect</code> è°ƒç”¨ï¼Œä½†æ˜¯æ²¡æœ‰ä»»ä½•å­çº¿ç¨‹ã€‚è€Œä¸”åœ¨è¿™ä¸ªè¿è¡Œä¸­ï¼Œå“åº”ä¹‹é—´çš„é—´éš”æ—¶é—´æ˜¯ 9 æ¯«ç§’ï¼å°‘äºæˆ‘ç›´æ¥ ping 1.1.1.1:</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ ping -c 1 1.1.1.1
PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data.
64 bytes from 1.1.1.1: icmp_seq=1 ttl=57 time=13.7 ms

--- 1.1.1.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 13.748/13.748/13.748/0.000 ms
</code></pre><p>è¿™æ˜¯å› ä¸ºæ‰§è¡Œå™¨é€šè¿‡ Event Loop æ„å»ºéé˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ï¼Œç„¶åè®¢é˜… Event Loop ç®¡ç†çš„èµ„æºç›¸å…³çš„äº‹ä»¶ï¼Œ
ç„¶åå°±å¯ä»¥çŸ¥é“ä¸€ä¸ª socket ä»€ä¹ˆæ—¶é—´å¯ä»¥è¿›è¡Œè¯»å†™ã€‚</p>
<p>æ‰€ä»¥ï¼Œfuture å¯¹è±¡åªæ˜¯ä¸€äº›çŠ¶æ€ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥è¿›è¡Œ awaitï¼Œé‚£ä¹ˆåœ¨å“ªè®¢é˜…çš„äº‹ä»¶å‘¢ï¼Ÿ</p>
<p>è®©æˆ‘ä»¬å°è¯•åˆ›å»ºä¸€ä¸ªæˆ‘ä»¬è‡ªå·±çš„ <code>try_join</code> &ndash; ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”åªæ¥å—ä¸¤ä¸ª futureã€‚ç„¶åæˆ‘ä»¬å°±èƒ½çœ‹åˆ°å‘ç”Ÿäº†ä»€ä¹ˆã€‚</p>
<p>æˆ‘ä»¬å·²ç»å®ç°äº†è‡ªå·±çš„ futureï¼Œå®ç°ä¸€ä¸ª <code>try_join</code> å‡½æ•°ä¼šæœ‰å¤šéº»çƒ¦ï¼Ÿ</p>
<h3 id="äº‹å®è¯æ˜å¾ˆéº»çƒ¦">äº‹å®è¯æ˜å¾ˆéº»çƒ¦<a href="#äº‹å®è¯æ˜å¾ˆéº»çƒ¦" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>æˆ‘ä»¬å…ˆä»ç®€å•çš„å¼€å§‹ï¼æˆ‘ä»¬æƒ³å®ç°ä¸€ä¸ªå‡½æ•°æ¥å—ä¸¤ä¸ª future å¯¹è±¡ç„¶åè¿”å›ä¸€ä¸ª future å¯¹è±¡ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// in `src/main.rs`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">mod</span> tj;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// in `src/tj.rs`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::future::Future;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">try_join</span><span style="color:#f92672">&lt;</span>A, B<span style="color:#f92672">&gt;</span>(a: <span style="color:#a6e22e">A</span>, b: <span style="color:#a6e22e">B</span>) -&gt; <span style="color:#a6e22e">impl</span> Future<span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> ()<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>	A: <span style="color:#a6e22e">Future</span>,
</span></span><span style="display:flex;"><span>	B: <span style="color:#a6e22e">Future</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	todo!(<span style="color:#e6db74">&#34;implement me!&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>é¢ã€‚å‡½æ•°ä¸åº”è¯¥åªè¿”å›ä¸€ä¸ªç©ºå…ƒç»„ï¼Œå®ƒéœ€è¦è¿”å›ä¸€ä¸ªåŒ…å«æˆåŠŸç»“æœçš„å…ƒç»„ã€‚æˆ–è€…é‡åˆ°çš„ç¬¬ä¸€ä¸ªé”™è¯¯ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€äº›æ›´å¤šçš„èŒƒå‹å‚æ•°ï¼šä¸€ä¸ªé”™è¯¯ç±»å‹ï¼ˆæˆ‘ä»¬å‡è®¾ä¸¤ä¸ª future å¯¹è±¡è¿”å›åŒæ ·çš„é”™è¯¯ç±»å‹ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯ future å¯¹è±¡è¿”å›çš„ <code>Ok</code> çš„ç±»å‹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">try_join</span><span style="color:#f92672">&lt;</span>A, B, AR, BR, E<span style="color:#f92672">&gt;</span>(a: <span style="color:#a6e22e">A</span>, b: <span style="color:#a6e22e">B</span>) -&gt; <span style="color:#a6e22e">impl</span> Future<span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>(AR, BR), E<span style="color:#f92672">&gt;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>	A: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>AR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>	B: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>BR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	todo!(<span style="color:#e6db74">&#34;implement me!&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¥½äº†ï¼è¿™éå¸¸ç»•å£ï¼Œä½†æ˜¯æˆ‘ç›¸ä¿¡æˆ‘ä»¬å·²ç»å®ç°äº†éœ€æ±‚ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬ä½¿ç”¨äº† <code>impl Trait</code> è¯­æ³•ï¼Œè®©æˆ‘ä»¬ä¸ç”¨æš´éœ²æˆ‘ä»¬è‡ªå·±çš„ <code>try join future</code> ã€‚è¿™ä¸é‡è¦ï¼Œä½†æ˜¯å¯ä»¥è®©æˆ‘ä»¬ç”¨æ›´å°‘çš„ <code>pub</code> å…³é”®å­—ï¼ŒåŒæ—¶æˆ‘ä»¬çš„æ‰‹æŒ‡å·²ç»ç ç´¯äº†ã€‚éå¸¸ç´¯ã€‚</p>
<p>æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬æ¥åˆ›å»ºè¿™ä¸ªç±»å‹ï¼</p>
<p>ç±»å‹éœ€è¦æŒç»­ <code>A</code> å’Œ <code>B</code> ï¼Œå¹¶æ³¨æ„ <code>AR</code> ã€ <code>BR</code> å’Œ <code>E</code> ç±»å‹ã€‚æ‰€ä»¥ï¼Œå¸Œæœ›æ‚¨å¯¹è¿™äº›èŒƒå‹å‚æ•°æ²™æ‹‰æœ‰ä¸ªå¥½èƒƒå£ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">TryJoin</span><span style="color:#f92672">&lt;</span>A, B, AR, BR, E<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>	A: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>AR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>	B: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>BR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	a: <span style="color:#a6e22e">A</span>,
</span></span><span style="display:flex;"><span>	b: <span style="color:#a6e22e">B</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç„¶åå¯ä»¥åœ¨æˆ‘ä»¬çš„ <code>try_join</code> å‡½æ•°ä¸­è¿”å›å®ƒï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">try_join</span><span style="color:#f92672">&lt;</span>A, B, AR, BR, E<span style="color:#f92672">&gt;</span>(a: <span style="color:#a6e22e">A</span>, b: <span style="color:#a6e22e">B</span>) -&gt; <span style="color:#a6e22e">impl</span> Future<span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>(AR, BR), E<span style="color:#f92672">&gt;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>	A: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>AR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>	B: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>BR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// so simple!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	TryJoin { a, b }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æˆ‘è®¤ä¸ºè¿™å¾ˆå¥½çš„è¯´æ˜ä¸€ä¸ªäº‹å®ï¼šåˆ›å»º future å¯¹è±¡ä»…ä»…æ˜¯æ„å»ºçŠ¶æ€ã€‚ä¸éœ€è¦ä»»ä½•é¢å¤–çš„å·¥ä½œã€‚</p>
<p>å½“ç„¶ï¼Œè¿™ä¸ªä¸ä¼šé€šè¿‡ç¼–è¯‘ï¼Œå› ä¸º <code>TryJoin</code> è¿˜æ²¡æœ‰å®ç° <code>Future</code> ã€‚</p>
<p>ä½†æ˜¯ä¸è¦æ‹…å¿ƒï¼ <code>rust-analyzer</code> å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç”Ÿæˆç¼ºå¤±çš„éƒ¨åˆ†ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::{
</span></span><span style="display:flex;"><span>	future::Future,
</span></span><span style="display:flex;"><span>	pin::Pin,
</span></span><span style="display:flex;"><span>	task::{Context, Poll},
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span>A, B, AR, BR, E<span style="color:#f92672">&gt;</span> Future <span style="color:#66d9ef">for</span> TryJoin<span style="color:#f92672">&lt;</span>A, B, AR, BR, E<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>	A: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>AR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>	B: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>BR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Output</span> <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>(AR, BR), E<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">poll</span>(self: <span style="color:#a6e22e">Pin</span><span style="color:#f92672">&lt;&amp;</span><span style="color:#66d9ef">mut</span> Self<span style="color:#f92672">&gt;</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Context<span style="color:#f92672">&lt;&#39;</span>_<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>Self::Output<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>		todo!()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¦‚æœæˆ‘ä»¬çœŸæ­£çš„å®ç°äº†ï¼Œæˆ‘ä»¬å°†æŒ‰ç…§ä¸‹é¢æ–¹å¼ä½¿ç”¨ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main(flavor = </span><span style="color:#e6db74">&#34;current_thread&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	setup()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> res <span style="color:#f92672">=</span> tj::try_join(fetch_thing(<span style="color:#e6db74">&#34;first&#34;</span>), fetch_thing(<span style="color:#e6db74">&#34;second&#34;</span>)).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#f92672">?</span>res, <span style="color:#e6db74">&#34;All done!&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å½“ç„¶ï¼Œç°åœ¨åªæ˜¯ä¼šå´©æºƒï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info cargo run --quiet --release

The application panicked (crashed).
Message:  not yet implemented
Location: src/tj.rs:32

Backtrace omitted.
Run with RUST_BACKTRACE=1 environment variable to display it.
Run with RUST_BACKTRACE=full to include source snippets.
</code></pre><p>æ‰€ä»¥ï¼Œæˆ‘çŒœæˆ‘ä»¬éœ€è¦å®ç°å®ƒï¼</p>
<p>å¥½å§ï¼Œè®©æˆ‘ä»¬å…ˆå°è¯•è‡³å°‘è½®è¯¢ï¼ˆpollingï¼‰ä¸€ä¸ª future å¯¹è±¡ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">poll</span>(self: <span style="color:#a6e22e">Pin</span><span style="color:#f92672">&lt;&amp;</span><span style="color:#66d9ef">mut</span> Self<span style="color:#f92672">&gt;</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Context<span style="color:#f92672">&lt;&#39;</span>_<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>Self::Output<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> a <span style="color:#f92672">=</span> self.a.poll(cx);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	todo!()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info cargo run --quiet --release
error[E0599]: no method named `poll` found for type parameter `A` in the current scope
   --&gt; src/tj.rs:32:24
	|
32  |         let a = self.a.poll(cx);
	|                        ^^^^ method not found in `A`
	|
   ::: /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/future.rs:100:8
	|
100 |     fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;&#39;_&gt;) -&gt; Poll&lt;Self::Output&gt;;
	|        ---- the method is available for `Pin&lt;&amp;mut A&gt;` here
	|
help: consider wrapping the receiver expression with the appropriate type
	|
32  |         let a = Pin::new(&amp;mut self.a).poll(cx);
	|                 ^^^^^^^^^^^^^       ^
</code></pre><p>é¢ï¼ä¸€ä¸ªå¥½çš„å¼€å§‹ï¼Œå¥½çš„å¼€å§‹ã€‚</p>
<p>æˆ‘å·²ç»åœ¨è¿™é‡Œ<a href="https://fasterthanli.me/articles/pin-and-suffering">è¯¦ç»†çš„è§£é‡Šäº†</a> Pinï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±ç®€å•çš„ä»‹ç»ä¸€ä¸‹ã€‚</p>
<p>æ–¹æ³•é€šå¸¸é€šè¿‡å¦‚ä¸‹æ–¹å¼å®šä¹‰æ¥æ”¶è€…ï¼ˆreceiverï¼‰ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">MyType</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">do_thing</span>(<span style="color:#f92672">&amp;</span>self) {
</span></span><span style="display:flex;"><span>		println!(<span style="color:#e6db74">&#34;my value is {}&#34;</span>, self.value)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¹Ÿå°±æ˜¯ä¸‹é¢çš„ç®€å†™ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">MyType</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">do_thing</span>(self: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Self</span>) {
</span></span><span style="display:flex;"><span>		println!(<span style="color:#e6db74">&#34;my value is {}&#34;</span>, self.value)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å› ä¸ºæˆ‘ä»¬åœ¨ <code>impl MyType</code> ä»£ç å—ä¸­ <code>Self</code> å°±æ˜¯ <code>MyType</code> ã€‚</p>
<p>å¾ˆæ¸…æ™°å§ï¼Ÿå¥½äº†ï¼Œè¿˜å¯ä»¥å®šä¹‰å…¶ä»–å¾ˆå¤šç±»å‹ä½œä¸ºæ¥æ”¶è€…ï¼Œ <code>Pin&lt;&amp;mut Self&gt;</code> å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">MyType</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">do_thing</span>(self: <span style="color:#a6e22e">Pin</span><span style="color:#f92672">&lt;&amp;</span><span style="color:#66d9ef">mut</span> Self<span style="color:#f92672">&gt;</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// good luck!1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>é‚£ä¹ˆ <code>MyType</code> å¿…é¡»æ˜¯å›ºå®šçš„ï¼ˆpinnedï¼‰æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæ¯”å¦‚ï¼Œå®ƒä¿è¯ä¸è¿›è¡Œè½¬ç§»ï¼ˆmoveï¼‰ã€‚é™¤éå®ƒå®ç°äº† <code>Unpin</code> ï¼Œ
ç„¶åå®ƒå°±å¯ä»¥æ˜¯éå›ºå®šçš„ï¼ˆunpinnedï¼‰ï¼Œå¯ç§»åŠ¨ï¼Œç„¶åè¢«å†ä¸€æ¬¡å›ºå®šã€‚</p>
<p>å¯¹äºå‰©ä¸‹çš„æ–‡ç« ï¼Œæˆ‘ä»¬ä¸ä¼šå‡è®¾æˆ‘ä»¬çš„ future <code>A</code> å’Œ <code>B</code> éƒ½æ˜¯ <code>Unpin</code> ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è‡ªå·±ä¸ä¼šç§»åŠ¨ï¼ˆmoveï¼‰å®ƒä»¬ï¼ˆåªé”€æ¯ï¼ˆdropï¼‰å®ƒä»¬ï¼‰ã€‚</p>
<p>ä½ å¯ä»¥è¯´æˆ‘ä»¬ä¸éœ€è¦ <code>A</code> å’Œ <code>B</code> æ˜¯ <code>Unpin</code> çš„ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰æ·»åŠ æŒ‡å®šçš„ where clause æ¥æ ‡è®°éœ€è¦å®ƒä»¬æ˜¯ <code>Unpin</code> ã€‚
å› ä¸ºå¦‚æœæˆ‘ä»¬éœ€è¦ï¼Œæˆ‘ä»¬å°±è¦åƒä¸‹é¢è¿™æ ·æ·»åŠ é¢å¤–çš„ <code>trait bound</code> ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">TryJoin</span><span style="color:#f92672">&lt;</span>A, B, AR, BR, E<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//                                    ğŸ‘‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	A: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>AR, E<span style="color:#f92672">&gt;&gt;</span> <span style="color:#f92672">+</span> Unpin,
</span></span><span style="display:flex;"><span>	B: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>BR, E<span style="color:#f92672">&gt;&gt;</span> <span style="color:#f92672">+</span> Unpin,
</span></span><span style="display:flex;"><span>{}
</span></span></code></pre></div><p>ä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½å‡è®¾ <code>A</code> æˆ– <code>B</code> æ˜¯ <code>Unpin</code> çš„ã€‚</p>
<p>æ‰€ä»¥ï¼æˆ‘ä»¬ç°åœ¨çœŸçš„åªæ˜¯é¢ä¸´å›ºå®šï¼ˆpinï¼‰ä¿æŠ¤çš„é—®é¢˜ã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨åªæŒæœ‰ä¸€ä¸ª <code>Pin&lt;&amp;mut TryJoin&lt;A, B, ...&gt;&gt;</code> ä½†æ˜¯æˆ‘å¸Œæœ›æŒç»­ä¸€ä¸ª <code>Pin&lt;&amp;mut A&gt;</code> ï¼ˆå› ä¸ºè¿™å°±æ˜¯æˆ‘ä»¬å› ä¸ºéœ€è¦è½®è¯¢ <code>A</code> ï¼‰ã€‚</p>
<p>å¦å¤–ä¸€ä¸ªè§£å†³æ–¹æ³•ï¼Œæˆ‘å€¾å‘äºé€šè¿‡ä¸€äº›ç±»ä¼¼ <a href="https://lib.rs/crates/pin-project">pin-project</a> åŒ…ï¼Œæˆ–è€…ç±»ä¼¼ <a href="https://lib.rs/crates/pin-project-lite">pin-project-lite</a>ï¼Œä½†æ˜¯åœ¨æˆ‘ä»¬å‰è¿›çš„æ–¹å‘ç›´æ¥ä½¿ç”¨ <code>pin-project</code> çœŸçš„å¾ˆå°´å°¬ï¼Œ
æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä½¿ç”¨ <code>unsafe</code> ä½œä¸ºæ›¿ä»£ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">poll</span>(self: <span style="color:#a6e22e">Pin</span><span style="color:#f92672">&lt;&amp;</span><span style="color:#66d9ef">mut</span> Self<span style="color:#f92672">&gt;</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Context<span style="color:#f92672">&lt;&#39;</span>_<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>Self::Output<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> a <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { self.map_unchecked_mut(<span style="color:#f92672">|</span>this<span style="color:#f92672">|</span> <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> this.a) };
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> a <span style="color:#f92672">=</span> a.poll(cx);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	todo!()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯ä»¥é€šè¿‡ç¼–è¯‘ã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨ <code>unsafe</code> ï¼Œä¹Ÿå°±æ„å‘³ç€ç¼–è¯‘å™¨æ­£å¼åœæ­¢ <del>ç…§é¡¾</del> æ£€æŸ¥æˆ‘ä»¬çš„ä»£ç ã€‚
æˆ‘ä»¬è‡ªå·±å¿…é¡»å¼ºåˆ¶æ‰§è¡Œä¸€äº›ä¸å˜é‡ï¼ˆinvariantsï¼‰ï¼Œå¹¶ä¸”éå¸¸éå¸¸å°å¿ƒï¼ŒåŒæ—¶è®©å…¶ä»–äººå®¡æŸ¥ï¼ˆreviewï¼‰æˆ‘ä»¬çš„å·¥ä½œï¼Œ
ä½†æ˜¯ä¾ç„¶å¯èƒ½ä¼šå‡ºé”™ï¼Œå› ä¸ºä»–ä»¬ä¹Ÿä¼šä¼‘æ¯ã€‚</p>
<p>ç°åœ¨ï¼Œéå¸¸æ£’çš„æ˜¯æˆ‘ä»¬å¯ä»¥è½®è¯¢ <code>a</code> ã€‚å®ƒå¦‚æœå®Œæˆä¼šè¿”å› <code>Poll::Ready(Result&lt;AR, E&gt;)</code> ï¼Œ
å¦åˆ™å°±æ˜¯ç­‰ä¼šä¼šå®Œæˆåˆ™è¿”å› <code>Poll::Pending</code> ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">poll</span>(self: <span style="color:#a6e22e">Pin</span><span style="color:#f92672">&lt;&amp;</span><span style="color:#66d9ef">mut</span> Self<span style="color:#f92672">&gt;</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Context<span style="color:#f92672">&lt;&#39;</span>_<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>Self::Output<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> a <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { self.map_unchecked_mut(<span style="color:#f92672">|</span>this<span style="color:#f92672">|</span> <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> this.a) };
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">match</span> a.poll(cx) {
</span></span><span style="display:flex;"><span>		Poll::Pending <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>			info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;A is pending...&#34;</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> Poll::Pending;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		Poll::Ready(res) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">match</span> res {
</span></span><span style="display:flex;"><span>			Ok(_) <span style="color:#f92672">=&gt;</span> info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;A is ready!&#34;</span>),
</span></span><span style="display:flex;"><span>			Err(e) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> Poll::Ready(Err(e)),
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	todo!()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬é€šè¿‡æ‰“å°æ—¥å¿—â€œA is pendingâ€çŸ¥é“å‡†å¤‡å®Œæˆã€‚è¿™å¯èƒ½éœ€è¦å‡ ä¸ªå›åˆï¼šæ¯•ç«Ÿï¼Œæˆ‘ä»¬æ­£åœ¨åšä¸€äº›é‡è¦çš„äº‹æƒ…ã€‚
æˆ‘ä»¬å»ºç«‹ä¸€ä¸ª TCP è¿æ¥ï¼Œæ¥ç€åœ¨ä¸Šé¢è¿›è¡Œ TLS ä¼šè¯ï¼Œæ¥ç€æ˜¯ä¸€äº›åˆ†å¼€çš„å†™ï¼Œæœ€åè¯»åˆ° EOFï¼ˆend of fileï¼‰ã€‚</p>
<p>å½“ç„¶ï¼Œå¦‚æœæˆ‘ä»¬è¿è¡Œå®ƒçš„è¯ï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">aytoodeep::tj: A is pending...
Jul 25 22:54:14.495  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.495  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.495  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.495  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.495  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.495  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.495  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.513  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.513  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.513  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.513  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.513  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.514  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.522  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.522  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.522  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.522  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.522  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.523  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.523  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.530  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.530  INFO waytoodeep::tj: A is pending...
Jul 25 22:54:14.530  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=first
Jul 25 22:54:14.530  INFO waytoodeep::tj: A is ready!
The application panicked (crashed).
Message:  not yet implemented
Location: src/tj.rs:46

Backtrace omitted.
Run with RUST_BACKTRACE=1 environment variable to display it.
Run with RUST_BACKTRACE=full to include source snippets.
</code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒç¡®å®èŠ±è´¹äº†å‡ ä¸ªå›åˆã€‚</p>
<p>æ³¨æ„å¦‚æœ <code>A</code> è¿”å›é”™è¯¯æˆ‘ä»¬çš„ä»£ç ä¹Ÿä¼šè¿”å› <code>Poll:Ready</code> ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³æ”¶é›† A å’Œ B çš„ç»“æœã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯¹ B åšç›¸åŒçš„äº‹æƒ…ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">poll</span>(self: <span style="color:#a6e22e">Pin</span><span style="color:#f92672">&lt;&amp;</span><span style="color:#66d9ef">mut</span> Self<span style="color:#f92672">&gt;</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Context<span style="color:#f92672">&lt;&#39;</span>_<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>Self::Output<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> a <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { self.map_unchecked_mut(<span style="color:#f92672">|</span>this<span style="color:#f92672">|</span> <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> this.a) };
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">match</span> a.poll(cx) {
</span></span><span style="display:flex;"><span>		Poll::Pending <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>			info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;A is pending...&#34;</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> Poll::Pending;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		Poll::Ready(res) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">match</span> res {
</span></span><span style="display:flex;"><span>			Ok(_) <span style="color:#f92672">=&gt;</span> info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;A is ready!&#34;</span>),
</span></span><span style="display:flex;"><span>			Err(e) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> Poll::Ready(Err(e)),
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> b <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { self.map_unchecked_mut(<span style="color:#f92672">|</span>this<span style="color:#f92672">|</span> <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> this.a) };
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">match</span> b.poll(cx) {
</span></span><span style="display:flex;"><span>		Poll::Pending <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>			info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;B is pending...&#34;</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> Poll::Pending;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		Poll::Ready(res) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">match</span> res {
</span></span><span style="display:flex;"><span>			Ok(_) <span style="color:#f92672">=&gt;</span> info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;B is ready!&#34;</span>),
</span></span><span style="display:flex;"><span>			Err(e) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> Poll::Ready(Err(e)),
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	todo!()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç„¶åã€‚ã€‚whoopsï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">RUST_LOG=info cargo run --quiet --release
error[E0382]: use of moved value: `self`
   --&gt; src/tj.rs:46:26
	|
33  |     fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;&#39;_&gt;) -&gt; Poll&lt;Self::Output&gt; {
	|             ---- move occurs because `self` has type `Pin&lt;&amp;mut TryJoin&lt;A, B, AR, BR, E&gt;&gt;`, which does not implement the `Copy` trait
34  |         let a = unsafe { self.map_unchecked_mut(|this| &amp;mut this.a) };
	|                               ------------------------------------- `self` moved due to this method call
...
46  |         let b = unsafe { self.map_unchecked_mut(|this| &amp;mut this.a) };
	|                          ^^^^ value used here after move
	|
note: this function takes ownership of the receiver `self`, which moves `self`
   --&gt; /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/pin.rs:776:43
	|
776 |     pub unsafe fn map_unchecked_mut&lt;U, F&gt;(self, func: F) -&gt; Pin&lt;&amp;&#39;a mut U&gt;
	|                                           ^^^^
</code></pre><p>æ˜¯çš„ã€‚ <code>map_unchecked_mut</code> å æœ‰äº† <code>self</code> ã€‚</p>
<p>ä¸ç”¨æ‹…å¿ƒï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>.as_mut()</code> ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">//       ğŸ‘‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">poll</span>(<span style="color:#66d9ef">mut</span> self: <span style="color:#a6e22e">Pin</span><span style="color:#f92672">&lt;&amp;</span><span style="color:#66d9ef">mut</span> Self<span style="color:#f92672">&gt;</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Context<span style="color:#f92672">&lt;&#39;</span>_<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>Self::Output<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//                      ğŸ‘‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> a <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { self.as_mut().map_unchecked_mut(<span style="color:#f92672">|</span>this<span style="color:#f92672">|</span> <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> this.a) };
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">match</span> a.poll(cx) {
</span></span><span style="display:flex;"><span>		Poll::Pending <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>			info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;A is pending...&#34;</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> Poll::Pending;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		Poll::Ready(res) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">match</span> res {
</span></span><span style="display:flex;"><span>			Ok(_) <span style="color:#f92672">=&gt;</span> info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;A is ready!&#34;</span>),
</span></span><span style="display:flex;"><span>			Err(e) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> Poll::Ready(Err(e)),
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//                      ğŸ‘‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> b <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { self.as_mut().map_unchecked_mut(<span style="color:#f92672">|</span>this<span style="color:#f92672">|</span> <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> this.a) };
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">match</span> b.poll(cx) {
</span></span><span style="display:flex;"><span>		Poll::Pending <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>			info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;B is pending...&#34;</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> Poll::Pending;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		Poll::Ready(res) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">match</span> res {
</span></span><span style="display:flex;"><span>			Ok(_) <span style="color:#f92672">=&gt;</span> info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;B is ready!&#34;</span>),
</span></span><span style="display:flex;"><span>			Err(e) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> Poll::Ready(Err(e)),
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	todo!()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä½†æ˜¯ä¾ç„¶æ— æ³•é€šè¿‡ç¼–è¯‘ï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info cargo run --quiet --release
(cut)
Jul 25 22:57:07.913  INFO waytoodeep::tj: A is pending...
Jul 25 22:57:07.913  INFO waytoodeep::tj: A is pending...
Jul 25 22:57:07.913  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=first
Jul 25 22:57:07.913  INFO waytoodeep::tj: A is ready!
The application panicked (crashed).
Message:  `async fn` resumed after completion
Location: src/main.rs:24

Backtrace omitted.
Run with RUST_BACKTRACE=1 environment variable to display it.
Run with RUST_BACKTRACE=full to include source snippets.
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸€æ—¦ <code>Future</code> è¿”å› <code>Poll::Ready</code> æˆ‘ä»¬å°±ä¸èƒ½å†æ¬¡è½®è¯¢å®ƒäº†ã€‚æˆ‘ä»¬ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿå› ä¸º <code>Future</code> å·²ç»è¿”å›äº†ç»“æœã€‚å¦‚æœç»“æœæ˜¯é <code>Copy</code> çš„ï¼Œå®ƒå¯èƒ½åªèƒ½è¿”å›ä¸€æ¬¡ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦ 1ï¼‰è·Ÿè¸ª <code>A</code> æ˜¯å¦å®Œæˆï¼Œç„¶å 2ï¼‰åœ¨æŸä¸ªåœ°æ–¹å­˜å‚¨å®ƒçš„è¿”å›ç»“æœã€‚</p>
<p>æˆ‘ä»¬åªéœ€è¦åœ¨æˆ‘ä»¬çš„ç»“æ„ä½“ä¸­æ·»åŠ ä¸€äº›å­—æ®µï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">TryJoin</span><span style="color:#f92672">&lt;</span>A, B, AR, BR, E<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>	A: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>AR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>	B: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>BR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	a: <span style="color:#a6e22e">A</span>,
</span></span><span style="display:flex;"><span>	b: <span style="color:#a6e22e">B</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ğŸ‘‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	a_res: Option<span style="color:#f92672">&lt;</span>AR<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>	b_res: Option<span style="color:#f92672">&lt;</span>BR<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¸è¦å¿˜è®°åˆå§‹åŒ–å®ƒä»¬ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">try_join</span><span style="color:#f92672">&lt;</span>A, B, AR, BR, E<span style="color:#f92672">&gt;</span>(a: <span style="color:#a6e22e">A</span>, b: <span style="color:#a6e22e">B</span>) -&gt; <span style="color:#a6e22e">impl</span> Future<span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>(AR, BR), E<span style="color:#f92672">&gt;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>	A: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>AR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>	B: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>BR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	TryJoin {
</span></span><span style="display:flex;"><span>		a,
</span></span><span style="display:flex;"><span>		b,
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ğŸ‘‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		a_res: None,
</span></span><span style="display:flex;"><span>		b_res: None,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç°åœ¨è®¡åˆ’æ˜¯ï¼š</p>
<ul>
<li>å¦‚æœ <code>a_res</code> æ˜¯ <code>Some</code> ï¼Œç„¶åæˆ‘ä»¬å°±ä¸éœ€è¦è½®è¯¢ <code>a</code> ,å› ä¸ºå®ƒå·²ç»å®Œæˆäº†</li>
<li>åŒæ ·çš„é€»è¾‘å¤„ç† <code>b_res</code> å’Œ <code>b</code></li>
</ul>
<p>è®©æˆ‘ä»¬å®ç°å®ƒã€‚åŒæ—¶ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»åœ¨ä½¿ç”¨äº† <code>unsafe</code> ï¼Œæ‰€ä»¥æˆ‘ä»¬å·²ç»è´Ÿè´£ç»´æŠ¤ä¸å˜é‡ï¼ˆinvariantsï¼‰ï¼Œ
æ‰€ä»¥æˆ‘å†³å®šåŒæ—¶å›ºå®š <code>a</code> å’Œ <code>b</code> ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">poll</span>(self: <span style="color:#a6e22e">Pin</span><span style="color:#f92672">&lt;&amp;</span><span style="color:#66d9ef">mut</span> Self<span style="color:#f92672">&gt;</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Context<span style="color:#f92672">&lt;&#39;</span>_<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>Self::Output<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> this <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { self.get_unchecked_mut() };
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> (a, b) <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> {
</span></span><span style="display:flex;"><span>		(
</span></span><span style="display:flex;"><span>			Pin::new_unchecked(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> this.a),
</span></span><span style="display:flex;"><span>			Pin::new_unchecked(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> this.b),
</span></span><span style="display:flex;"><span>		)
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> this.a_res.is_none() {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">match</span> a.poll(cx) {
</span></span><span style="display:flex;"><span>			Poll::Pending <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> Poll::Pending,
</span></span><span style="display:flex;"><span>			Poll::Ready(res) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">match</span> res {
</span></span><span style="display:flex;"><span>				Ok(x) <span style="color:#f92672">=&gt;</span> this.a_res <span style="color:#f92672">=</span> Some(x),
</span></span><span style="display:flex;"><span>				Err(e) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> Poll::Ready(Err(e)),
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> this.b_res.is_none() {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">match</span> b.poll(cx) {
</span></span><span style="display:flex;"><span>			Poll::Pending <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> Poll::Pending,
</span></span><span style="display:flex;"><span>			Poll::Ready(res) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">match</span> res {
</span></span><span style="display:flex;"><span>				Ok(x) <span style="color:#f92672">=&gt;</span> this.b_res <span style="color:#f92672">=</span> Some(x),
</span></span><span style="display:flex;"><span>				Err(e) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> Poll::Ready(Err(e)),
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	todo!()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¥½äº†ï¼Œè¿™ä¸ªåº”è¯¥èƒ½è®© <code>a</code> å’Œ <code>b</code> æœ‰æœºä¼šåœ¨æˆ‘ä»¬å´©æºƒä¹‹å‰å®Œæˆï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info cargo run --quiet --release
Jul 25 23:11:03.851  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=first
Jul 25 23:11:04.380  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=second
The application panicked (crashed).
Message:  not yet implemented
Location: src/tj.rs:69

Backtrace omitted.
Run with RUST_BACKTRACE=1 environment variable to display it.
Run with RUST_BACKTRACE=full to include source snippets.
</code></pre><p>å¾ˆå¥½ï¼ç°åœ¨æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯è§£å‡ºä¸¤ä¸ªç»“æœå¹¶è¿”å›å®ƒä»¬ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// instead of the `todo!()`:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> (Some(_), Some(_)) <span style="color:#f92672">=</span> (<span style="color:#f92672">&amp;</span>this.a_res, <span style="color:#f92672">&amp;</span>this.b_res) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> a <span style="color:#f92672">=</span> this.a_res.take().unwrap();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> b <span style="color:#f92672">=</span> this.b_res.take().unwrap();
</span></span><span style="display:flex;"><span>	Poll::Ready(Ok((a, b)))
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>	Poll::Pending
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯ä»¥å·¥ä½œï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info cargo run --quiet --release
Jul 25 23:13:32.497  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=first
Jul 25 23:13:32.829  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=second
Jul 25 23:13:32.829  INFO waytoodeep: All done! res=(&#34;first&#34;, &#34;second&#34;)
</code></pre><p>ã€‚ã€‚ã€‚ä½†æ˜¯è¿™ä¸æ˜¯ <code>try_join</code> çš„å®ç°ã€‚æˆ‘ä»¬æ­£åœ¨åšçš„å’Œè¿™ä¸ªå®Œå…¨ä¸€æ ·ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// (pseudo-code, buncha things are missing)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">try_join</span>(a: <span style="color:#a6e22e">A</span>, b: <span style="color:#a6e22e">B</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> a <span style="color:#f92672">=</span> self.a.<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> b <span style="color:#f92672">=</span> self.b.<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	Ok((a, b))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æ˜¯é¡ºåºçš„æ‰§è¡Œçš„ã€‚è¯·è®°ä½ï¼Œä»…ä»…æ˜¯å› ä¸º tokio çš„æ‰§è¡Œå™¨å¯èƒ½ç”¨äº†ä¸€å †çº¿ç¨‹å¹¶æ„å‘³ç€åŒæ—¶è¿è¡Œæ˜¯è‡ªåŠ¨çš„ã€‚
å‰é¢æˆ‘ä»¬ä¸å¾—ä¸ä½¿ç”¨ <code>tokio::spwan</code> æˆ– <code>UnorderedFutures</code> æˆ– <code>try_join!</code> è®©å…¶åŒæ—¶è¿è¡Œã€‚</p>
<p>æ‰€ä»¥è®©æˆ‘ä»¬é‡æ–°çœ‹ä¸€ä¸‹ã€‚ã€‚ã€‚å½“æˆ‘ä»¬è½®è¯¢ <code>a</code> çš„æ˜¯åå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> this.a_res.is_none() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">match</span> a.poll(cx) {
</span></span><span style="display:flex;"><span>		Poll::Pending <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> Poll::Pending,
</span></span><span style="display:flex;"><span>		Poll::Ready(res) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">match</span> res {
</span></span><span style="display:flex;"><span>			Ok(x) <span style="color:#f92672">=&gt;</span> this.a_res <span style="color:#f92672">=</span> Some(x),
</span></span><span style="display:flex;"><span>			Err(e) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> Poll::Ready(Err(e)),
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>é¢ï¼Œå½“è½®è¯¢ <code>a</code> çš„æ—¶å€™è¿”å› <code>Poll::Pending</code> æ—¶æˆ‘ä»¬ä¹Ÿä¼šè¿”å› <code>Poll::Pending</code>  ã€‚æ‰€ä»¥è¿™å°±æ˜¯é—®é¢˜ã€‚
å¦‚æœ <code>a</code> æ­£åœ¨ç­‰å¾…ï¼ˆpendingï¼‰æˆ‘ä»¬ä¸åº”è¯¥è¿”å›ã€‚å› ä¸ºå¦‚æœè¿™æ—¶å€™ <code>b</code> å·²ç»å‡†å¤‡å¥½æˆ–è€…æœ‰é”™è¯¯å‘¢ï¼Ÿ</p>
<p>æˆ–è€…å¦‚æœï¼Œæˆ‘ä»¬åƒè¿™æ ·è°ƒç”¨ <code>try_join</code> å‘¢ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Joining...&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> res <span style="color:#f92672">=</span> tj::try_join(
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">async</span> <span style="color:#66d9ef">move</span> {
</span></span><span style="display:flex;"><span>		sleep(Duration::from_millis(<span style="color:#ae81ff">2000</span>)).<span style="color:#66d9ef">await</span>;
</span></span><span style="display:flex;"><span>		Ok(())
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">async</span> <span style="color:#66d9ef">move</span> {
</span></span><span style="display:flex;"><span>		sleep(Duration::from_millis(<span style="color:#ae81ff">10</span>)).<span style="color:#66d9ef">await</span>;
</span></span><span style="display:flex;"><span>		Err::<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span>(color_eyre::eyre::eyre<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;uh oh&#34;</span>))
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>.<span style="color:#66d9ef">await</span>;
</span></span></code></pre></div><p>ã€‚ã€‚ã€‚ç„¶å <code>a</code> èŠ±è´¹äº† 2 ç§’é’Ÿæ‰å‡†å¤‡å¥½ï¼ŒåŒæ—¶ <code>b</code> ä¼šåœ¨ 10æ¯«ç§’ä¹‹åè¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œå¦‚æœæˆ‘ä»¬è½®è¯¢å®ƒï¼</p>
<p>å—ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info cargo run --quiet --release
Jul 25 23:19:26.972  INFO waytoodeep: Joining...
Jul 25 23:19:28.990  INFO waytoodeep: All done! res=Err(
   0: uh oh

Location:
   src/main.rs:28
(cut)
</code></pre><p>ï¼ˆæ³¨æ„æ—¶é—´æˆ³ï¼‰</p>
<p>é‡ç‚¹æ˜¯ <code>try_join</code> ä¼šæå‰å¤±è´¥ï¼šä¸€æ—¦ Future è¿”å› <code>Result::Err~</code> ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¿…é¡»åŒæ—¶è½®è¯¢ <code>a</code> å’Œ <code>b</code> ã€‚å¥½å§ã€‚ã€‚ã€‚ä¸æ˜¯ä¸¥æ ¼æ„ä¹‰çš„åŒæ—¶ã€‚æˆ‘ä»¬å¿…é¡»æ¯æ¬¡æˆ‘ä»¬çš„ <code>TryJoin</code> future å¯¹è±¡è¢«è½®è¯¢æ—¶å¹¶å‘ï¼ˆconcurrentlyï¼‰çš„è½®è¯¢å®ƒä»¬ï¼Œ
ç›´åˆ°å®ƒä»¬è¿”å›ç»“æœã€‚</p>
<p>æœ‰ä¸€ä¸ªç®€å•è§£å†³åŠæ³• &ndash; åœ¨ä»»ä¸€ future å¯¹è±¡è¿”å› <code>Poll::Pending</code> æ—¶ä¸è¿”å› <code>Poll::Pending</code> ã€‚</p>
<p>åŒæ—¶ï¼Œæˆ‘åŒå€¦äº†è¾“å…¥ <code>Poll::Ready</code> å¹¶ä¸” <code>Poll&lt;T&gt;</code> å®ç°äº† <code>From&lt;T&gt;</code> ,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>.into()</code> äº†ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">poll</span>(self: <span style="color:#a6e22e">Pin</span><span style="color:#f92672">&lt;&amp;</span><span style="color:#66d9ef">mut</span> Self<span style="color:#f92672">&gt;</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Context<span style="color:#f92672">&lt;&#39;</span>_<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>Self::Output<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> this <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { self.get_unchecked_mut() };
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> (a, b) <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> {
</span></span><span style="display:flex;"><span>		(
</span></span><span style="display:flex;"><span>			Pin::new_unchecked(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> this.a),
</span></span><span style="display:flex;"><span>			Pin::new_unchecked(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> this.b),
</span></span><span style="display:flex;"><span>		)
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> this.a_res.is_none() {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Poll::Ready(res) <span style="color:#f92672">=</span> a.poll(cx) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">match</span> res {
</span></span><span style="display:flex;"><span>				Ok(x) <span style="color:#f92672">=&gt;</span> this.a_res <span style="color:#f92672">=</span> Some(x),
</span></span><span style="display:flex;"><span>				Err(e) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> Err(e).into(),
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> this.b_res.is_none() {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Poll::Ready(res) <span style="color:#f92672">=</span> b.poll(cx) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">match</span> res {
</span></span><span style="display:flex;"><span>				Ok(x) <span style="color:#f92672">=&gt;</span> this.b_res <span style="color:#f92672">=</span> Some(x),
</span></span><span style="display:flex;"><span>				Err(e) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> Err(e).into(),
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> (Some(_), Some(_)) <span style="color:#f92672">=</span> (<span style="color:#f92672">&amp;</span>this.a_res, <span style="color:#f92672">&amp;</span>this.b_res) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> a <span style="color:#f92672">=</span> this.a_res.take().unwrap();
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> b <span style="color:#f92672">=</span> this.b_res.take().unwrap();
</span></span><span style="display:flex;"><span>		Ok((a, b)).into()
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		Poll::Pending
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è®©æˆ‘ä»¬å†æ¬¡è¿è¡Œ</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info cargo run --quiet --release
Jul 25 23:22:40.238  INFO waytoodeep: Joining...
Jul 25 23:22:40.253  INFO waytoodeep: All done! res=Err(
   0: uh oh

Location:
   src/main.rs:28

(cut)
</code></pre><p>ã€‚ã€‚ã€‚å¯ä»¥äº†ï¼æˆ‘æ˜¯è¯´å®ƒæŒ‰ç…§é¢„æœŸçš„å¤±è´¥äº†ã€‚é¢„æœŸçš„å¤±è´¥å°±æ˜¯æˆåŠŸã€‚</p>
<p>ç„¶åæˆ‘ä»¬å°†è¿™ä¸ªæ–¹æ³•åº”ç”¨åˆ°è°ƒç”¨ <code>try_join</code> :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main(flavor = </span><span style="color:#e6db74">&#34;current_thread&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	setup()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Joining...&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> res <span style="color:#f92672">=</span> tj::try_join(fetch_thing(<span style="color:#e6db74">&#34;first&#34;</span>), fetch_thing(<span style="color:#e6db74">&#34;second&#34;</span>)).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#f92672">?</span>res, <span style="color:#e6db74">&#34;All done!&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç«äº‰åˆå›æ¥äº†ï¼šæœ‰æ—¶ <code>first</code> å…ˆå®Œæˆï¼Œæœ‰æ—¶åˆ™ä¸æ˜¯ï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info cargo run --quiet --release
Jul 25 23:25:25.925  INFO waytoodeep: Joining...
Jul 25 23:25:26.224  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=first
Jul 25 23:25:26.236  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=second
Jul 25 23:25:26.236  INFO waytoodeep: All done! res=(&#34;first&#34;, &#34;second&#34;)
$ RUST_LOG=info cargo run --quiet --release
Jul 25 23:25:26.937  INFO waytoodeep: Joining...
Jul 25 23:25:27.237  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=first
Jul 25 23:25:27.242  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=second
Jul 25 23:25:27.242  INFO waytoodeep: All done! res=(&#34;first&#34;, &#34;second&#34;)
$ RUST_LOG=info cargo run --quiet --release
Jul 25 23:25:27.865  INFO waytoodeep: Joining...
Jul 25 23:25:28.164  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=second
Jul 25 23:25:28.818  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=first
Jul 25 23:25:28.818  INFO waytoodeep: All done! res=(&#34;first&#34;, &#34;second&#34;)
$ RUST_LOG=info cargo run --quiet --release
Jul 25 23:25:30.153  INFO waytoodeep: Joining...
Jul 25 23:25:31.477  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=second
Jul 25 23:25:31.496  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=first
Jul 25 23:25:31.496  INFO waytoodeep: All done! res=(&#34;first&#34;, &#34;second&#34;)
</code></pre><p>ã€‚ã€‚ã€‚åŒæ—¶ç»“æœçš„é¡ºåºæ˜¯æ­£ç¡®çš„ã€‚</p>
<p>éå¸¸å¥½ï¼Œæˆ‘ä»¬å®ç°äº†å®ƒï¼</p>
<p>ä½†æ˜¯ï¼</p>
<h3 id="æˆ‘ä»¬å¯ä»¥åšçš„æ›´å¥½">æˆ‘ä»¬å¯ä»¥åšçš„æ›´å¥½<a href="#æˆ‘ä»¬å¯ä»¥åšçš„æ›´å¥½" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>å¹¸è¿çš„æ˜¯ï¼Œåå°±æ˜¯å¥½ã€‚</p>
<p>ä¸‹é¢è¿™ä¸ªç±»å‹å›°æ‰°ç€æˆ‘ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">TryJoin</span><span style="color:#f92672">&lt;</span>A, B, AR, BR, E<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>	A: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>AR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>	B: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>BR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	a: <span style="color:#a6e22e">A</span>,
</span></span><span style="display:flex;"><span>	b: <span style="color:#a6e22e">B</span>,
</span></span><span style="display:flex;"><span>	a_res: Option<span style="color:#f92672">&lt;</span>AR<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>	b_res: Option<span style="color:#f92672">&lt;</span>BR<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æˆ‘å…¶å®åªæœ‰åœ¨ <code>a</code> å®Œæˆåæ‰éœ€è¦ <code>a_res</code> ã€‚ä¸€æ—¦ <code>a</code> å®Œæˆç„¶åå°†ç»“æœå­˜å‚¨åˆ° <code>a_res</code> ï¼Œæˆ‘ä»¬å°±ä¸å†éœ€è¦ <code>a</code> äº†ã€‚</p>
<p>å®é™…ä¸Šï¼Œç”šè‡³æˆ‘ä»¬ä¸åº”è¯¥å†ç¢° <code>a</code>  ã€‚</p>
<p>è¿™å¬èµ·æ¥æ›´åƒæˆ‘ä»¬è¦ä¹ˆæŒæœ‰ <code>A</code> è¦ä¹ˆæŒæœ‰ <code>AR</code> ï¼Œä½†æ˜¯æ°¸è¿œä¸ä¼šåŒæ—¶æŒæœ‰ã€‚</p>
<blockquote>
<p><code>SUM TYPES</code> : Rust çš„æšä¸¾å°±æ˜¯ä¸€ä¸ªæ±‡æ€»ç±»å‹ã€‚</p>
</blockquote>
<p>æ‰€ä»¥ï¼æ±‡æ€»ç±»å‹ã€‚Rust æšä¸¾ã€‚è¿™å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå«åš <code>State</code> çš„ç±»å‹ï¼Œç„¶åå®ƒæœ‰ä¸¤ä¸ªå˜ä½“ï¼š
ä¸€ä¸ªç”¨äºå®ƒè¿˜æ˜¯ future å¯¹è±¡ï¼Œä¸€ä¸ªç”¨äºå®ƒæ˜¯ä¸€ä¸ªç»“æœã€‚éå¸¸ç®€å•ï¼</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">State</span><span style="color:#f92672">&lt;</span>F, T, E<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>	F: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>T, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	Future(F),
</span></span><span style="display:flex;"><span>	Ok(T),
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¿™å°†ä¼šéå¸¸æ£’ï¼</p>
<p>è®©æˆ‘ä»¬èµ‹ç»™æˆ‘ä»¬çš„ <code>TryJoin</code> ç»“æ„ä½“ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">TryJoin</span><span style="color:#f92672">&lt;</span>A, B, AR, BR, E<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>	A: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>AR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>	B: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>BR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	a: <span style="color:#a6e22e">State</span><span style="color:#f92672">&lt;</span>A, AR, E<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>	b: <span style="color:#a6e22e">State</span><span style="color:#f92672">&lt;</span>B, BR, E<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ï¼ˆæ˜¯ä¸æ˜¯éå¸¸æ¼‚äº®ï¼‰</p>
<p>ç„¶ååˆå§‹åŒ–å®ƒä»¬ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">try_join</span><span style="color:#f92672">&lt;</span>A, B, AR, BR, E<span style="color:#f92672">&gt;</span>(a: <span style="color:#a6e22e">A</span>, b: <span style="color:#a6e22e">B</span>) -&gt; <span style="color:#a6e22e">impl</span> Future<span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>(AR, BR), E<span style="color:#f92672">&gt;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>	A: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>AR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>	B: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>BR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	TryJoin {
</span></span><span style="display:flex;"><span>		a: <span style="color:#a6e22e">State</span>::Future(a),
</span></span><span style="display:flex;"><span>		b: <span style="color:#a6e22e">State</span>::Future(b),
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>éå¸¸é…·ã€‚ç„¶åæˆ‘ä»¬åªéœ€è¦ç¨å¾®è°ƒæ•´ä¸€ä¸‹æˆ‘ä»¬çš„ <code>poll</code> æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦å°† <code>Pin&lt;&amp;mut Self&gt;</code> è½¬æ¢ä¸º <code>&amp;mut Self</code> ã€‚ã€‚ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">poll</span>(self: <span style="color:#a6e22e">Pin</span><span style="color:#f92672">&lt;&amp;</span><span style="color:#66d9ef">mut</span> Self<span style="color:#f92672">&gt;</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Context<span style="color:#f92672">&lt;&#39;</span>_<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>Self::Output<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> this <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { self.get_unchecked_mut() };
</span></span></code></pre></div><p>è¿™æ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºæˆ‘ä»¬æ‰¿è¯ºç»´æŠ¤ä¸å˜é‡ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¸ä¼šè½¬ç§»ï¼ˆmoveï¼‰ <code>State::Future</code> å†…éƒ¨ã€‚</p>
<p>ç„¶åå¦‚æœ <code>a</code> æ˜¯ <code>State::Future</code> æˆ‘ä»¬å°±è½®è¯¢å®ƒï¼Œç„¶åæˆ‘ä»¬å†ä¼ æ’­é”™è¯¯æˆ–è€…ä¿å­˜å®ƒçš„ç»“æœï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> State::Future(a) <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> this.a {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> a <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { Pin::new_unchecked(a) };
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Poll::Ready(res) <span style="color:#f92672">=</span> a.poll(cx) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">match</span> res {
</span></span><span style="display:flex;"><span>			Ok(t) <span style="color:#f92672">=&gt;</span> this.a <span style="color:#f92672">=</span> State::Ok(t),
</span></span><span style="display:flex;"><span>			Err(e) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> Err(e).into(),
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç„¶ååŒæ ·çš„ä¿®æ”¹ <code>b</code> ã€‚ã€‚ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// you can figure that one out, I believe in you
</span></span></span></code></pre></div><p>ç„¶åæˆ‘ä»¬å°±å®Œæˆäº†å¦‚æœå®ƒä»¬éƒ½æ˜¯ <code>State::Ok</code> ï¼å¦åˆ™æˆ‘ä»¬å°±è¿”å› <code>Poll::Pending</code> :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">match</span> (this.a, this.b) {
</span></span><span style="display:flex;"><span>	(State::Ok(a), State::Ok(b)) <span style="color:#f92672">=&gt;</span> Ok((a, b)).into(),
</span></span><span style="display:flex;"><span>	_ <span style="color:#f92672">=&gt;</span> Poll::Pending,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>éå¸¸å¥½ã€‚</p>
<p>é™¤äº†å®ƒæ— æ³•é€šè¿‡ç¼–è¯‘ï¼š</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info cargo run --quiet --release
error[E0507]: cannot move out of `this.a` which is behind a mutable reference
  --&gt; src/tj.rs:65:16
   |
65 |         match (this.a, this.b) {
   |                ^^^^^^ move occurs because `this.a` has type `State&lt;A, AR, E&gt;`, which does not implement the `Copy` trait

error[E0507]: cannot move out of `this.b` which is behind a mutable reference
  --&gt; src/tj.rs:65:24
   |
65 |         match (this.a, this.b) {
   |                        ^^^^^^ move occurs because `this.b` has type `State&lt;B, BR, E&gt;`, which does not implement the `Copy` trait

error: aborting due to 2 previous errors

For more information about this error, try `rustc --explain E0507`.
error: could not compile `waytoodeep`

To learn more, run the command again with --verbose.
</code></pre><p>å› ä¸ºã€‚ã€‚ã€‚æˆ‘ä»¬åªæœ‰ <code>&amp;mut Self</code> è€Œä¸æ˜¯ <code>Self</code> ã€‚</p>
<p>æˆ‘ä»¬æ²¡æœ‰è‡ªå·±çš„æ‰€æœ‰æƒï¼Œä»…ä»…æ˜¯å€Ÿç”¨æˆ‘ä»¬è‡ªå·±ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¸èƒ½å°†å°†æˆ‘ä»¬çš„æˆå‘˜è½¬ç§»ï¼ˆmoveï¼‰å‡ºå»ï¼Œå› ä¸ºæˆ‘ä»¬ä¸èƒ½é˜»æ­¢å…¶ä»–äººå†æ¬¡è½®è¯¢ <code>TryJoin</code> ã€‚
æ‰€ä»¥è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦å´©æºƒï¼ˆpanicï¼‰ã€‚</p>
<p>å½“ç„¶ï¼Œå¦‚æœæˆ‘ä»¬åƒ <code>Option&lt;T&gt;</code> é‚£æ ·æœ‰ä¸€ä¸ª <code>.take()</code> æ–¹æ³•äº‹æƒ…å°±ä¼šå¤§å¤§ç®€åŒ–ã€‚
å®ƒè¿”å› Option æ‹¥æœ‰çš„ä»»ä½•å†…å®¹ï¼Œæˆ–è€… <code>None</code> ã€‚</p>
<p>ä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰ <code>None</code> ã€‚æˆ‘ä»¬åªæœ‰ <code>State::Future</code> å’Œ <code>State::OK</code> ï¼Œæ²¡æœ‰â€œä¸­ç«‹â€ï¼ˆneutralï¼‰çŠ¶æ€ã€‚</p>
<p>è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">State</span><span style="color:#f92672">&lt;</span>F, T, E<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>	F: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>T, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	Future(F),
</span></span><span style="display:flex;"><span>	Ok(T),
</span></span><span style="display:flex;"><span>	Gone,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å°† <code>this.a</code> å’Œ <code>this.b</code> æ›¿æ¢ä¸º <code>State::Gone</code> ã€‚ã€‚ã€‚æˆ–è€…å®ƒçš„è¿”å›ç»“æœï¼ˆæˆ‘ä»¬æ‹¥æœ‰æ‰€æœ‰æƒï¼‰ã€‚
ç„¶åæˆ‘ä»¬å°±å¯ä»¥å°†å®ƒä»¬è½¬ç§»ï¼ˆmoveï¼‰å‡ºå»ã€‚</p>
<p>ä½†æ˜¯åŒæ—¶ã€‚ã€‚ã€‚æˆ‘ä»¬éœ€è¦å†æ¬¡å¯¹å…¶è¿›è¡Œæ¨¡å¼åŒ¹é…ï¼ˆpattern matchï¼‰ã€‚</p>
<p>å°±åƒï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">match</span> (<span style="color:#f92672">&amp;</span>this.a, <span style="color:#f92672">&amp;</span>this.b) {
</span></span><span style="display:flex;"><span>	(State::Ok(_), State::Ok(_)) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> a <span style="color:#f92672">=</span> <span style="color:#66d9ef">match</span> std::mem::replace(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> this.a, State::Gone) {
</span></span><span style="display:flex;"><span>			State::Ok(t) <span style="color:#f92672">=&gt;</span> t,
</span></span><span style="display:flex;"><span>			_ <span style="color:#f92672">=&gt;</span> unreachable!(),
</span></span><span style="display:flex;"><span>		};
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> b <span style="color:#f92672">=</span> <span style="color:#66d9ef">match</span> std::mem::replace(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> this.b, State::Gone) {
</span></span><span style="display:flex;"><span>			State::Ok(t) <span style="color:#f92672">=&gt;</span> t,
</span></span><span style="display:flex;"><span>			_ <span style="color:#f92672">=&gt;</span> unreachable!(),
</span></span><span style="display:flex;"><span>		};
</span></span><span style="display:flex;"><span>		Ok((a, b)).into()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	_ <span style="color:#f92672">=&gt;</span> Poll::Pending,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å®è¯è¯´ã€‚ã€‚ã€‚æˆ‘çœ‹è¿‡æ›´ç³Ÿçš„ä»£ç ã€‚å®ƒåªæ˜¯æ²¡é‚£ä¹ˆ<a href="https://en.wikipedia.org/wiki/Don%27t%5Frepeat%5Fyourself">DRY</a>ã€‚</p>
<p>éå¸¸å¥½çš„å®ç°ï¼</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info cargo run --quiet --release
Jul 25 23:52:24.097  INFO waytoodeep: Joining...
Jul 25 23:52:25.050  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=second
Jul 25 23:52:25.061  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=first
Jul 25 23:52:25.061  INFO waytoodeep: All done! res=(&#34;first&#34;, &#34;second&#34;)
</code></pre><p>çœ‹ï¼Œåªæœ‰ 11ms çš„é—´éš”ã€‚</p>
<h3 id="æ›´è¿›ä¸€æ­¥">æ›´è¿›ä¸€æ­¥ï¼Ÿ<a href="#æ›´è¿›ä¸€æ­¥" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>è¿™æ®µä»£ç å†æ¬¡å›°æ‰°äº†æˆ‘ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">TryJoin</span><span style="color:#f92672">&lt;</span>A, B, AR, BR, E<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>	A: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>AR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>	B: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>BR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	a: <span style="color:#a6e22e">State</span><span style="color:#f92672">&lt;</span>A, AR, E<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>	b: <span style="color:#a6e22e">State</span><span style="color:#f92672">&lt;</span>B, BR, E<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å› ä¸ºç°åœ¨ <code>a</code> å’Œ <code>b</code> æ˜¯ä¸‰æ€çš„ï¼ˆtri-stateï¼‰ï¼š <code>Future</code> ã€ <code>Ok</code> æˆ–è€… <code>Gone</code> ã€‚</p>
<p>å¦‚æœ <code>a</code> å’Œ <code>b</code> éƒ½æ˜¯ <code>Gone</code> å‘¢ï¼Ÿè¿™ä¸ªçŠ¶æ€ä¸åˆç†ï¼</p>
<p>å¦‚æœå‘ç”Ÿäº†è¿™ä¸ªçŠ¶æ€ï¼Œæˆ‘ä»¬ç°åœ¨å°†ä¼šæ°¸è¿œè¿”å› <code>Poll::Pending</code> &ndash; è¿™ä¸å¤ªå¥½ &ndash; ä¸€ä¸ªæ­»é”ã€‚</p>
<p>æˆ‘ä»¬çœŸæ­£æƒ³è¦çš„æ˜¯ã€‚ã€‚ã€‚ä¸¤ä¸ªæšä¸¾ã€‚å®é™…ä¸Šæˆ‘ä»¬æƒ³è¦æ•´ä¸ª <code>TryJoin</code> ç±»å‹æ˜¯ä¸€ä¸ª <code>enum</code> ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">TryJoin</span><span style="color:#f92672">&lt;</span>A, B, AR, BR, E<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>	A: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>AR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>	B: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>BR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	Polling {
</span></span><span style="display:flex;"><span>		a: <span style="color:#a6e22e">State</span><span style="color:#f92672">&lt;</span>A, AR, E<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>		b: <span style="color:#a6e22e">State</span><span style="color:#f92672">&lt;</span>B, BR, E<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	Done,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>åƒè¿™æ ·åˆå§‹åŒ–ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">try_join</span><span style="color:#f92672">&lt;</span>A, B, AR, BR, E<span style="color:#f92672">&gt;</span>(a: <span style="color:#a6e22e">A</span>, b: <span style="color:#a6e22e">B</span>) -&gt; <span style="color:#a6e22e">impl</span> Future<span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>(AR, BR), E<span style="color:#f92672">&gt;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>	A: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>AR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>	B: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>BR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	TryJoin::Polling {
</span></span><span style="display:flex;"><span>		a: <span style="color:#a6e22e">State</span>::Future(a),
</span></span><span style="display:flex;"><span>		b: <span style="color:#a6e22e">State</span>::Future(b),
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç„¶åï¼Œsurpriceï¼ <code>Poll&lt;T&gt;</code> å®ç°äº† <a href="https://doc.rust-lang.org/stable/std/ops/trait.Try.html">Try</a> traitã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>?</code> ã€‚
æ‰€ä»¥æœ€ç»ˆæˆ‘ä»¬çš„ä»£ç å®é™…ä¸Šéå¸¸çŸ­å°ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span>A, B, AR, BR, E<span style="color:#f92672">&gt;</span> Future <span style="color:#66d9ef">for</span> TryJoin<span style="color:#f92672">&lt;</span>A, B, AR, BR, E<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>	A: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>AR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>	B: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>BR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Output</span> <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>(AR, BR), E<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">poll</span>(self: <span style="color:#a6e22e">Pin</span><span style="color:#f92672">&lt;&amp;</span><span style="color:#66d9ef">mut</span> Self<span style="color:#f92672">&gt;</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Context<span style="color:#f92672">&lt;&#39;</span>_<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>Self::Output<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> this <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { self.get_unchecked_mut() };
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> (a, b) <span style="color:#f92672">=</span> <span style="color:#66d9ef">match</span> this {
</span></span><span style="display:flex;"><span>			Self::Polling { a, b } <span style="color:#f92672">=&gt;</span> (a, b),
</span></span><span style="display:flex;"><span>			Self::Done <span style="color:#f92672">=&gt;</span> panic!(<span style="color:#e6db74">&#34;TryJoin future polled after completion&#34;</span>),
</span></span><span style="display:flex;"><span>		};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> State::Future(fut) <span style="color:#f92672">=</span> a {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Poll::Ready(res) <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { Pin::new_unchecked(fut) }.poll(cx) {
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">*</span>a <span style="color:#f92672">=</span> State::Ok(res<span style="color:#f92672">?</span>);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> State::Future(fut) <span style="color:#f92672">=</span> b {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Poll::Ready(res) <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { Pin::new_unchecked(fut) }.poll(cx) {
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">*</span>b <span style="color:#f92672">=</span> State::Ok(res<span style="color:#f92672">?</span>);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">match</span> (a, b) {
</span></span><span style="display:flex;"><span>			(State::Ok(_), State::Ok(_)) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">match</span> std::mem::replace(this, Self::Done) {
</span></span><span style="display:flex;"><span>				Self::Polling {
</span></span><span style="display:flex;"><span>					a: <span style="color:#a6e22e">State</span>::Ok(a),
</span></span><span style="display:flex;"><span>					b: <span style="color:#a6e22e">State</span>::Ok(b),
</span></span><span style="display:flex;"><span>				} <span style="color:#f92672">=&gt;</span> Ok((a, b)).into(),
</span></span><span style="display:flex;"><span>				_ <span style="color:#f92672">=&gt;</span> unreachable!(),
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>			_ <span style="color:#f92672">=&gt;</span> Poll::Pending,
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç°åœ¨ï¼Œæˆ‘çŸ¥é“ä½ åœ¨æƒ³ä»€ä¹ˆã€‚ <code>Pin&lt;&amp;mut T&gt;</code> ä¸æ˜¯æ°æ°ç”¨æ¥é¿å…åƒ <code>std::mem::swap</code> å’Œ <code>std::mem::replace</code> å—ï¼Ÿ
è¿™äº›æ‰€æœ‰çš„è½¬ç§»ï¼ˆmoveï¼‰éƒ½æ˜¯å›´ç»•ç€å†…å­˜ï¼è¿™æ˜¯è¢«ç¦æ­¢çš„ï¼æ˜¯çš„ï¼Œæˆ‘ä»¬æ‰¿è¯ºäº†ä¸å»è½¬ç§»ï¼ˆmoveï¼‰å®ƒã€‚
ä½†æ˜¯åœ¨è¿™ä¸ªæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªæ˜¯åœ¨å®Œæˆè½®è¯¢ä¸¤ä¸ª future å¯¹è±¡åè½¬ç§»äº† <code>self</code> / <code>this</code> ã€‚</p>
<p>ç„¶åæˆ‘ä»¬å°±å†ä¹Ÿæ²¡æœ‰ä½¿ç”¨è¿‡ä¸¤ä¸ª future å¯¹è±¡ï¼Œæ— è®ºå›ºå®šè¿˜æ˜¯éå›ºå®šã€‚åŒæ—¶æˆ‘ä»¬ä»æ¥ä¹Ÿæ²¡ä¿è¯è¿‡ç»“æœè‡ªèº«æ˜¯å¦å°†è¦è¢«å›ºå®šï¼ˆpinnedï¼‰ï¼</p>
<p>æˆ‘ä»¬åªéœ€è¦å†³å®šæŸäº›ä¸œè¥¿æ˜¯â€œæ°¸è¿œå›ºå®šâ€è¿˜æ˜¯â€œæ°¸ä¸å›ºå®šâ€ï¼Œç„¶åæˆ‘ä»¬å¯èƒ½ä¼šç¼–å†™ç»“æœæ­£ç¡®çš„ä»£ç ã€‚</p>
<p>åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸‹ï¼Œåªæœ‰ <code>TryJoin::Polling(State::Future(_))</code> å°±æ˜¯â€œæ°¸è¿œå›ºå®šâ€ çš„ï¼Œå…¶ä»–éƒ½ä¸æ˜¯ã€‚</p>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬å¿«é€Ÿçš„ä» <code>Pin&lt;&amp;mut Self&gt;</code> åˆ‡æ¢åˆ° <code>&amp;mut Self</code> ï¼Œç„¶ååˆå›åˆ° <code>Pin&lt;&amp;mut A&gt;</code> ï¼Œ
ä½†åªè¦æˆ‘ä»¬ä¸è¦åœ¨ä¸­é—´ç§»åŠ¨å°±æ²¡æœ‰é—®é¢˜ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬åœ¨æŒæœ‰ future å¯¹è±¡çš„æƒ…å†µä¸‹ä½¿ç”¨ <code>std::mem:replace</code> æˆ– <code>std::mem::swap</code> å°±ä¼šä¸å¦™ã€‚
æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜å¥½ï¼Œæˆ‘æƒ³ï¼Œæˆ‘ä¸å¤ªç¡®å®šã€‚å¦‚æœä¸æ˜¯ï¼Œæœ‰äººåº”è¯¥ä¼šç•™è¨€ã€‚</p>
<h3 id="å°±è¿™æ ·">å°±è¿™æ ·<a href="#å°±è¿™æ ·" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>è®©æˆ‘ä»¬å›é¡¾æˆ‘ä»¬çš„å·¥ä½œï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// in `src/tj.rs`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::{
</span></span><span style="display:flex;"><span>	future::Future,
</span></span><span style="display:flex;"><span>	pin::Pin,
</span></span><span style="display:flex;"><span>	task::{Context, Poll},
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">try_join</span><span style="color:#f92672">&lt;</span>A, B, AR, BR, E<span style="color:#f92672">&gt;</span>(a: <span style="color:#a6e22e">A</span>, b: <span style="color:#a6e22e">B</span>) -&gt; <span style="color:#a6e22e">impl</span> Future<span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>(AR, BR), E<span style="color:#f92672">&gt;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>	A: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>AR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>	B: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>BR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	TryJoin::Polling {
</span></span><span style="display:flex;"><span>		a: <span style="color:#a6e22e">State</span>::Future(a),
</span></span><span style="display:flex;"><span>		b: <span style="color:#a6e22e">State</span>::Future(b),
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">State</span><span style="color:#f92672">&lt;</span>F, T, E<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>	F: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>T, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	Future(F),
</span></span><span style="display:flex;"><span>	Ok(T),
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">TryJoin</span><span style="color:#f92672">&lt;</span>A, B, AR, BR, E<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>	A: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>AR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>	B: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>BR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	Polling {
</span></span><span style="display:flex;"><span>		a: <span style="color:#a6e22e">State</span><span style="color:#f92672">&lt;</span>A, AR, E<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>		b: <span style="color:#a6e22e">State</span><span style="color:#f92672">&lt;</span>B, BR, E<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	Done,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span>A, B, AR, BR, E<span style="color:#f92672">&gt;</span> Future <span style="color:#66d9ef">for</span> TryJoin<span style="color:#f92672">&lt;</span>A, B, AR, BR, E<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>	A: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>AR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>	B: <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Output <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>BR, E<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Output</span> <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>(AR, BR), E<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">poll</span>(self: <span style="color:#a6e22e">Pin</span><span style="color:#f92672">&lt;&amp;</span><span style="color:#66d9ef">mut</span> Self<span style="color:#f92672">&gt;</span>, cx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Context<span style="color:#f92672">&lt;&#39;</span>_<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>Self::Output<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> this <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { self.get_unchecked_mut() };
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> (a, b) <span style="color:#f92672">=</span> <span style="color:#66d9ef">match</span> this {
</span></span><span style="display:flex;"><span>			Self::Polling { a, b } <span style="color:#f92672">=&gt;</span> (a, b),
</span></span><span style="display:flex;"><span>			Self::Done <span style="color:#f92672">=&gt;</span> panic!(<span style="color:#e6db74">&#34;TryJoin future polled after completion&#34;</span>),
</span></span><span style="display:flex;"><span>		};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> State::Future(fut) <span style="color:#f92672">=</span> a {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Poll::Ready(res) <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { Pin::new_unchecked(fut) }.poll(cx) {
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">*</span>a <span style="color:#f92672">=</span> State::Ok(res<span style="color:#f92672">?</span>);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> State::Future(fut) <span style="color:#f92672">=</span> b {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Poll::Ready(res) <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { Pin::new_unchecked(fut) }.poll(cx) {
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">*</span>b <span style="color:#f92672">=</span> State::Ok(res<span style="color:#f92672">?</span>);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">match</span> (a, b) {
</span></span><span style="display:flex;"><span>			(State::Ok(_), State::Ok(_)) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">match</span> std::mem::replace(this, Self::Done) {
</span></span><span style="display:flex;"><span>				Self::Polling {
</span></span><span style="display:flex;"><span>					a: <span style="color:#a6e22e">State</span>::Ok(a),
</span></span><span style="display:flex;"><span>					b: <span style="color:#a6e22e">State</span>::Ok(b),
</span></span><span style="display:flex;"><span>				} <span style="color:#f92672">=&gt;</span> Ok((a, b)).into(),
</span></span><span style="display:flex;"><span>				_ <span style="color:#f92672">=&gt;</span> unreachable!(),
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>			_ <span style="color:#f92672">=&gt;</span> Poll::Pending,
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¿˜æœ‰æˆ‘ä»¬å°å°çš„ HTTPS å®¢æˆ·ç«¯ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// in `src/main.rs`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> color_eyre::Report;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::{net::SocketAddr, sync::Arc};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> tokio::{
</span></span><span style="display:flex;"><span>	io::{AsyncReadExt, AsyncWriteExt},
</span></span><span style="display:flex;"><span>	net::TcpStream,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> tokio_rustls::{rustls::ClientConfig, TlsConnector};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> tracing::info;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> tracing_subscriber::EnvFilter;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> webpki::DNSNameRef;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">mod</span> tj;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main(flavor = </span><span style="color:#e6db74">&#34;current_thread&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	setup()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Joining...&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> res <span style="color:#f92672">=</span> tj::try_join(fetch_thing(<span style="color:#e6db74">&#34;first&#34;</span>), fetch_thing(<span style="color:#e6db74">&#34;second&#34;</span>)).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#f92672">?</span>res, <span style="color:#e6db74">&#34;All done!&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[allow(dead_code)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fetch_thing</span>(name: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span>) -&gt; Result<span style="color:#f92672">&lt;&amp;</span><span style="color:#66d9ef">str</span>, Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// look out it&#39;s port 443 now
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> addr: <span style="color:#a6e22e">SocketAddr</span> <span style="color:#f92672">=</span> ([<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">443</span>).into();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> socket <span style="color:#f92672">=</span> TcpStream::connect(addr).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// establish a TLS session...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> connector: <span style="color:#a6e22e">TlsConnector</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> config <span style="color:#f92672">=</span> ClientConfig::new();
</span></span><span style="display:flex;"><span>		config
</span></span><span style="display:flex;"><span>			.root_store
</span></span><span style="display:flex;"><span>			.add_server_trust_anchors(<span style="color:#f92672">&amp;</span>webpki_roots::TLS_SERVER_ROOTS);
</span></span><span style="display:flex;"><span>		Arc::new(config).into()
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> dnsname <span style="color:#f92672">=</span> DNSNameRef::try_from_ascii_str(<span style="color:#e6db74">&#34;one.one.one.one&#34;</span>)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> socket <span style="color:#f92672">=</span> connector.connect(dnsname, socket).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// we&#39;re writing straight to the socket, there&#39;s no buffering
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// so no need to flush
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	socket.write_all(<span style="color:#e6db74">b&#34;GET / HTTP/1.1</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	socket.write_all(<span style="color:#e6db74">b&#34;Host: one.one.one.one</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	socket.write_all(<span style="color:#e6db74">b&#34;User-Agent: cool-bear</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	socket.write_all(<span style="color:#e6db74">b&#34;Connection: close</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	socket.write_all(<span style="color:#e6db74">b&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> response <span style="color:#f92672">=</span> String::with_capacity(<span style="color:#ae81ff">256</span>);
</span></span><span style="display:flex;"><span>	socket.read_to_string(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> response).<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> status <span style="color:#f92672">=</span> response.lines().next().unwrap_or_default();
</span></span><span style="display:flex;"><span>	info<span style="color:#f92672">!</span>(<span style="color:#f92672">%</span>status, , <span style="color:#e6db74">&#34;Got response!&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// dropping the socket will close the connection
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	Ok(name)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">setup</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Report<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> std::env::var(<span style="color:#e6db74">&#34;RUST_LIB_BACKTRACE&#34;</span>).is_err() {
</span></span><span style="display:flex;"><span>		std::env::set_var(<span style="color:#e6db74">&#34;RUST_LIB_BACKTRACE&#34;</span>, <span style="color:#e6db74">&#34;1&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	color_eyre::install()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> std::env::var(<span style="color:#e6db74">&#34;RUST_LOG&#34;</span>).is_err() {
</span></span><span style="display:flex;"><span>		std::env::set_var(<span style="color:#e6db74">&#34;RUST_LOG&#34;</span>, <span style="color:#e6db74">&#34;info&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	tracing_subscriber::fmt::fmt()
</span></span><span style="display:flex;"><span>		.with_env_filter(EnvFilter::from_default_env())
</span></span><span style="display:flex;"><span>		.init();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And it works.</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">$ RUST_LOG=info cargo run --quiet --release
Jul 26 00:08:13.399  INFO waytoodeep: Joining...
Jul 26 00:08:13.707  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=first
Jul 26 00:08:13.709  INFO waytoodeep: Got response! status=HTTP/1.1 200 OK name=second
Jul 26 00:08:13.710  INFO waytoodeep: All done! res=(&#34;first&#34;, &#34;second&#34;)
</code></pre><p>2ms é—´éš”ï¼è¿™æ˜¯ä¸€ä¸ªæ–°çš„è®°å½•ã€‚</p>

      </div></div>

  

  


   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   


<hr>

  <div class="bl-section">
    <h4>No notes link to this note</h4>
  </div>


</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>Â© 2022 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://www.linuxzen.com/notes/assets/main.js"></script>
<script src="https://www.linuxzen.com/notes/assets/prism.js"></script>




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>


  
</div>

</body>
</html>
