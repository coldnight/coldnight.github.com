<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />


  <title>ã€è¯‘ã€‘æ·±å…¥ç†è§£ Rust future</title>

  <meta name="description" content="åšä¸»ä¸€ä¸ªçˆ±å¥½å¼€æºæŠ€æœ¯çš„äººï¼Œå¯¹ Python æ¯”è¾ƒç†Ÿæ‚‰ï¼Œä¹Ÿå–œæ¬¢ç”¨ Python æ£è…¾ä¸€äº›ä¸œè¥¿ï¼Œæœ¬åšä¸»è¦åˆ†äº«ä¸€äº›å¼€æºæŠ€æœ¯ï¼Œå…¶ä¸­åŒ…æ‹¬ä½†ä¸é™äº Linux/Python/Vimã€‚" />

  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="origin" />
  <meta name="generator" content="Pelican" />

  <link rel="shortcut icon" href="/favicon.ico" type="image/vnd.microsoft.icon" />
  <link rel="icon" href="/favicon.ico" type="image/vnd.microsoft.icon" />

<link href="https://www.linuxzen.com/understanding-rust-futures-by-going-way-too-deep.html" rel="canonical" />
  <!-- Feed -->
      <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="cold's world Full Atom Feed" />

  <link href="https://www.linuxzen.com/theme/css/style.css" type="text/css" rel="stylesheet" />

  <!-- Code highlight color scheme -->
      <link href="https://www.linuxzen.com/theme/css/code_blocks/tomorrow.css" rel="stylesheet">

    <!-- CSS specified by the user -->


    <link href="https://www.linuxzen.com/static/css/wide.css" type="text/css" rel="stylesheet" />

  <!-- Custom fonts -->
  <link href='https://fonts.googleapis.cnpmjs.org/css?family=Montserrat:400,300' rel='stylesheet' type='text/css' />
  <link href="https://fonts.googleapis.cnpmjs.org/css?family=Lato" rel="stylesheet" type="text/css" />

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->



    <meta name="description" content="åŸæ–‡é“¾æ¥ï¼šUnderstanding Rust futures by going way too deepã€‚ è¯‘è€…æ³¨ï¼šåŸæ–‡å¤§é‡çš„å¼•å…¥äº†æœ‰è¶£çš„å¯¹è¯ï¼Œè¿«äºæ’ç‰ˆé—®é¢˜è¿™é‡Œä¸è¿›è¡Œç¿»è¯‘ï¼Œå¿…è¦çš„å¯¹è¯é€šè¿‡å¼•ç”¨ â€¦">

    <meta name="author" content="cold">

    <meta name="tags" content="Rust">
    <meta name="tags" content="future">
    <meta name="tags" content="tokio">




<!-- Open Graph -->
<meta property="og:site_name" content="cold's world"/>
<meta property="og:title" content="ã€è¯‘ã€‘æ·±å…¥ç†è§£ Rust future"/>
<meta property="og:description" content="åŸæ–‡é“¾æ¥ï¼šUnderstanding Rust futures by going way too deepã€‚ è¯‘è€…æ³¨ï¼šåŸæ–‡å¤§é‡çš„å¼•å…¥äº†æœ‰è¶£çš„å¯¹è¯ï¼Œè¿«äºæ’ç‰ˆé—®é¢˜è¿™é‡Œä¸è¿›è¡Œç¿»è¯‘ï¼Œå¿…è¦çš„å¯¹è¯é€šè¿‡å¼•ç”¨ â€¦"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://www.linuxzen.com/understanding-rust-futures-by-going-way-too-deep.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2021-07-29 00:00:00+08:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://www.linuxzen.com/author/cold.html">
<meta property="article:section" content="Rust"/>
<meta property="article:tag" content="Rust"/>
<meta property="article:tag" content="future"/>
<meta property="article:tag" content="tokio"/>
<meta property="og:image" content="https://www.linuxzen.com/theme/images/post-bg.jpg">

<!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@grayking_w">
    <meta name="twitter:title" content="ã€è¯‘ã€‘æ·±å…¥ç†è§£ Rust future">
    <meta name="twitter:url" content="https://www.linuxzen.com/understanding-rust-futures-by-going-way-too-deep.html">

        <meta name="twitter:image:src" content="https://www.linuxzen.com/theme/images/post-bg.jpg">

      <meta name="twitter:description" content="åŸæ–‡é“¾æ¥ï¼šUnderstanding Rust futures by going way too deepã€‚ è¯‘è€…æ³¨ï¼šåŸæ–‡å¤§é‡çš„å¼•å…¥äº†æœ‰è¶£çš„å¯¹è¯ï¼Œè¿«äºæ’ç‰ˆé—®é¢˜è¿™é‡Œä¸è¿›è¡Œç¿»è¯‘ï¼Œå¿…è¦çš„å¯¹è¯é€šè¿‡å¼•ç”¨ â€¦">

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "ã€è¯‘ã€‘æ·±å…¥ç†è§£ Rust future",
  "headline": "ã€è¯‘ã€‘æ·±å…¥ç†è§£ Rust future",
  "datePublished": "2021-07-29 00:00:00+08:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "cold",
    "url": "https://www.linuxzen.com/author/cold.html"
  },
  "image": "https://www.linuxzen.com/theme/images/post-bg.jpg",
  "url": "https://www.linuxzen.com/understanding-rust-futures-by-going-way-too-deep.html",
  "description": "åŸæ–‡é“¾æ¥ï¼šUnderstanding Rust futures by going way too deepã€‚ è¯‘è€…æ³¨ï¼šåŸæ–‡å¤§é‡çš„å¼•å…¥äº†æœ‰è¶£çš„å¯¹è¯ï¼Œè¿«äºæ’ç‰ˆé—®é¢˜è¿™é‡Œä¸è¿›è¡Œç¿»è¯‘ï¼Œå¿…è¦çš„å¯¹è¯é€šè¿‡å¼•ç”¨ â€¦"
}
</script>
</head>
<!-- TODO : Body class -->
<body class="home-template">

<nav id="menu">
  <a class="close-button">Close</a>
  <div class="nav-wrapper">
    <p class="nav-label">Menu</p>
    <ul>
          <li><a href="/notes/" role="presentation">Zettelkasten</a></li>

                  <li role="presentation"><a href="https://www.linuxzen.com/category/git.html">Git</a></li>
                  <li role="presentation"><a href="https://www.linuxzen.com/category/go.html">Go</a></li>
                  <li role="presentation"><a href="https://www.linuxzen.com/category/linux.html">Linux</a></li>
                  <li role="presentation"><a href="https://www.linuxzen.com/category/other.html">Other</a></li>
                  <li role="presentation"><a href="https://www.linuxzen.com/category/pyqt.html">PyQt</a></li>
                  <li role="presentation"><a href="https://www.linuxzen.com/category/python.html">Python</a></li>
                  <li class="nav-rust active" role="presentation"><a href="https://www.linuxzen.com/category/rust.html">Rust</a></li>
                  <li role="presentation"><a href="https://www.linuxzen.com/category/tech.html">Tech</a></li>
                  <li role="presentation"><a href="https://www.linuxzen.com/category/vim.html">Vim</a></li>

        <li class="nav-rss"><a href="/feeds/all.atom.xml"><i class="ic ic-rss"></i> Subscribe</a></li>
    </ul>
  </div>
</nav>
    <!-- Progressbar -->
    <div class="progress-container">
        <span class="progress-bar"></span>
    </div>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header id="post-header" >
      <div class="inner">
        <nav id="navigation">
            <span id="home-button" class="nav-button">
                <a class="home-button" href="https://www.linuxzen.com/" title="Home"><i class="ic ic-arrow-left"></i> Home</a>
            </span>
          <span id="menu-button" class="nav-button">
            <a class="menu-button"><i class="ic ic-menu"></i> Menu</a>
          </span>
        </nav>
        <h1 class="post-title">ã€è¯‘ã€‘æ·±å…¥ç†è§£ Rust future</h1>
        <!-- TODO : Proper class for headline -->
        <span class="post-meta">
                <a href="https://www.linuxzen.com/author/cold.html">Gray King</a>
            | <time datetime="Thu 29 July 2021">Thu 29 July 2021</time>
        </span>
        <!-- TODO : Modified check -->
      </div>
    </header>

  <section id="wrapper">
    <a class="hidden-close"></a>

    <!-- Post content -->
    <main class="content" role="main">
        <article class="post">
        <div class="inner">
            <section class="post-content">
                <p>åŸæ–‡é“¾æ¥ï¼š<a href="https://fasterthanli.me/articles/understanding-rust-futures-by-going-way-too-deep">Understanding Rust futures by going way too deep</a>ã€‚</p>
<p>è¯‘è€…æ³¨ï¼šåŸæ–‡å¤§é‡çš„å¼•å…¥äº†æœ‰è¶£çš„å¯¹è¯ï¼Œè¿«äºæ’ç‰ˆé—®é¢˜è¿™é‡Œä¸è¿›è¡Œç¿»è¯‘ï¼Œå¿…è¦çš„å¯¹è¯é€šè¿‡å¼•ç”¨å—æ¥è§£é‡Šã€‚</p>
<h2 id="æ·±å…¥ç†è§£-rust-future">æ·±å…¥ç†è§£ Rust future</h2>
<p>ç”¨ Rust futureï¼å°±æ˜¯è¿™ä¹ˆç®€å•ï¼ç›´åˆ°æˆ‘ä»¬å‘ç°å¹¶éå¦‚æ­¤ã€‚æ‰€ä»¥æˆ‘ä»¬å…ˆæ¢ç´¢ç®€å•çš„éƒ¨åˆ†ï¼Œç„¶åç»§ç»­æ¢ç´¢å›°éš¾éƒ¨åˆ†è€Œä¸æ˜¯ç­‰å®ƒæ…¢æ…¢é è¿‘æˆ‘ä»¬ã€‚</p>
<h2 id="èµ·æ­¥">èµ·æ­¥</h2>
<blockquote>
<p>Choo choo here comes the easy part ğŸš‚ğŸ’¨</p>
</blockquote>
<p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">waytoodeep</span>
<span class="w">     </span><span class="n">Created</span><span class="w"> </span><span class="kt">binary</span><span class="w"> </span><span class="p">(</span><span class="n">application</span><span class="p">)</span><span class="w"> </span><span class="n n-Quoted">`waytoodeep`</span><span class="w"> </span><span class="n">package</span>
</code></pre></div>

<p>æˆ‘ä»¬éœ€è¦å®‰è£… <code>cargo-edit</code> å¦‚æœä¹‹å‰æ²¡æœ‰å®‰è£…è¿‡çš„è¯ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥ç›´æ¥ <code>cargo add</code> ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="o">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">cargo</span><span class="o">-</span><span class="n">edit</span>
<span class="w">    </span><span class="n">Updating</span><span class="w"> </span><span class="n">crates</span><span class="o">.</span><span class="n">io</span><span class="w"> </span><span class="n">index</span>
<span class="w">  </span><span class="n">Downloaded</span><span class="w"> </span><span class="n">cargo</span><span class="o">-</span><span class="n">edit</span><span class="w"> </span><span class="n">v0</span><span class="o">.</span><span class="mf">7.0</span>
<span class="w">  </span><span class="n">Downloaded</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">crate</span><span class="w"> </span><span class="p">(</span><span class="mf">57.6</span><span class="w"> </span><span class="n">KB</span><span class="p">)</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.47</span><span class="n">s</span>
<span class="w">     </span><span class="n">Ignored</span><span class="w"> </span><span class="n">package</span><span class="w"> </span><span class="err">`</span><span class="n">cargo</span><span class="o">-</span><span class="n">edit</span><span class="w"> </span><span class="n">v0</span><span class="o">.</span><span class="mf">7.0</span><span class="err">`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">already</span><span class="w"> </span><span class="n">installed</span><span class="p">,</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="o">--</span><span class="n">force</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">override</span>
</code></pre></div>

<blockquote>
<p>å› ä¸º <code>cargo-edit</code> å¾ˆæ–¹ä¾¿ï¼Œæ‰€ä»¥ä½ å¯èƒ½å·²ç»å®‰è£…è¿‡å®ƒã€‚éƒ¨åˆ†è¯»è€…ä¼šæ„Ÿåˆ°å›°æƒ‘æ˜¯å› ä¸ºåƒ
<code>cargo new</code>, <code>cargo build</code>, <code>cargo test</code>, <code>cargo run</code> ç­‰å­å‘½ä»¤éƒ½å†…ç½®åœ¨ cargo ä¸­ï¼Œ
ä½†æ˜¯ <code>cargo add</code> æ²¡æœ‰ã€‚</p>
<p>å®é™…ä¸Šï¼Œæœ‰ä¸€å¤§å †åƒè¿™æ ·çš„åŒ…ï¼Œå¦‚ <a href="https://lib.rs/crates/cargo-hack">cargo-hack</a>,<a href="https://lib.rs/crates/cargo-udeps">cargo-udeps</a>,<a href="https://lib.rs/crates/cargo-expand">cargo-expand</a>...<a href="https://lib.rs/keywords/cargo">ç­‰ç­‰</a>ã€‚</p>
</blockquote>
<p>ç„¶åæˆ‘ä»¬éœ€è¦é€‰æ‹©ä¸€ä¸ªã€Œå¼‚æ­¥è¿è¡Œæ—¶ã€ï¼ˆasync runtimeï¼‰ï¼Œå› ä¸ºè¿™äº› future å¯¹è±¡ä¸ä¼šè½®è¯¢ï¼ˆpollï¼‰è‡ªå·±ã€‚ã€‚ã€‚
æˆ‘ä»¬æ¯«æ— ç†ç”±çš„é€‰æ‹© tokioï¼Œå”¯ä¸€çš„åŸå› æ˜¯ï¼šè¿‡å»å‡ ä¸ªæœˆæˆ‘ä¸€ç›´åœ¨ç”¨å®ƒã€‚</p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">tokio</span><span class="mf">@1.9.0</span><span class="w"> </span><span class="o">--</span><span class="n">features</span><span class="w"> </span><span class="n">full</span>
<span class="w">    </span><span class="n">Updating</span><span class="w"> </span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//github.com/rust-lang/crates.io-index&#39; index</span>
<span class="w">      </span><span class="n">Adding</span><span class="w"> </span><span class="n">tokio</span><span class="w"> </span><span class="n">v1</span><span class="mf">.9.0</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dependencies</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">features</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;full&quot;</span><span class="p">]</span>
</code></pre></div>

<p>ç„¶åæˆ‘ä»¬ä¿®æ”¹ <code>main</code> å‡½æ•°ä½¿ç”¨ tokio é»˜è®¤æ‰§è¡Œå™¨ï¼ˆexecutorï¼‰ï¼ˆ <code>cargo new</code> ä¸ºæˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ª <code>main</code> å‡½æ•°ï¼Œä½†æ˜¯è¿™é‡Œå¹¶ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼‰ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in `src/main.rs`</span>

<span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello from a (so far completely unnecessary) async runtime&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>run<span class="w">                                                                                                                                                                                          </span>3s<span class="w"> </span>209ms
<span class="w">   </span>Compiling<span class="w"> </span>waytoodeep<span class="w"> </span>v0.1.0<span class="w"> </span><span class="o">(</span>/Users/wh/codes/rust/waytoodeep<span class="o">)</span>
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.47s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
Hello<span class="w"> </span>from<span class="w"> </span>a<span class="w"> </span><span class="o">(</span>so<span class="w"> </span>far<span class="w"> </span>completely<span class="w"> </span>unnecessary<span class="o">)</span><span class="w"> </span>async<span class="w"> </span>runtime
</code></pre></div>

<p>é…·ï¼</p>
<p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬æ·»åŠ å…¶ä»–ä¸€äº›æˆ‘å–œæ¬¢åœ¨æˆ‘çš„é¡¹ç›®ä¸­ä½¿ç”¨çš„å¥½ä¸œè¥¿ã€‚</p>
<p>é¦–å…ˆï¼Œå¯¹äºé”™è¯¯å¤„ç† - æˆ‘ä»¬ç¼–å†™ç¨‹åºå°±éœ€è¦å¤„ç†ä¸€å †ä¸åŒåº“é‡Œä¸åŒçš„é”™è¯¯ç±»å‹ï¼Œå¦‚æœèƒ½é€šè¿‡ä¸€ä¸ªç±»å‹ç»Ÿä¸€å®ƒä»¬å°±ä¼šéå¸¸æ•´æ´ã€‚</p>
<p><a href="https://lib.rs/crates/eyre">eyre</a> å¯ä»¥èµ‹äºˆæˆ‘ä»¬è¿™äº›ï¼ˆå°±åƒ <code>anyhow</code> ï¼‰ï¼</p>
<p>å¹¶ä¸”å› ä¸ºæˆ‘å–œæ¬¢æ¼‚äº®çš„é¢œè‰²æˆ‘å°†ä½¿ç”¨ <a href="https://lib.rs/crates/color-eyre">color-eyre</a>ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">color</span><span class="o">-</span><span class="n">eyre</span><span class="mf">@0.5.11</span>
<span class="w">    </span><span class="n">Updating</span><span class="w"> </span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//github.com/rust-lang/crates.io-index&#39; index</span>
<span class="w">      </span><span class="n">Adding</span><span class="w"> </span><span class="n">color</span><span class="o">-</span><span class="n">eyre</span><span class="w"> </span><span class="n">v0</span><span class="mf">.5.11</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dependencies</span>
</code></pre></div>

<p>ç°åœ¨æˆ‘ä»¬éœ€è¦å®‰è£… <code>color-eyre</code> ä½œä¸ºé»˜è®¤çš„å´©æºƒï¼ˆpanicï¼‰å¤„ç†å™¨ï¼Œæˆ‘æ‚„æ‚„ä¿®æ”¹äº†ä¸€äº›ç¯å¢ƒå˜é‡æ¥é»˜è®¤è¾“å‡ºè°ƒç”¨å †æ ˆï¼ˆbacktracksï¼‰ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">color_eyre</span>::<span class="n">Report</span><span class="p">;</span>

<span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello from a (so far completely unnecessary) async runtime&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">setup</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">var</span><span class="p">(</span><span class="s">&quot;RUST_LIB_BACKTRACE&quot;</span><span class="p">).</span><span class="n">is_err</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="s">&quot;RUST_LIB_BACKTRACE&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">color_eyre</span>::<span class="n">install</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>run
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.02s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
Hello<span class="w"> </span>from<span class="w"> </span>a<span class="w"> </span><span class="o">(</span>so<span class="w"> </span>far<span class="w"> </span>completely<span class="w"> </span>unnecessary<span class="o">)</span><span class="w"> </span>async<span class="w"> </span>runtime
</code></pre></div>

<p>å¾ˆå¥½ï¼ç°åœ¨å¦‚æœæˆ‘ä»¬æŸå¤„å‡ºç°äº†ä¸€ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å®Œæ•´çš„å †æ ˆè·Ÿè¸ªï¼Œå°±åƒä¸‹é¢è¿™æ ·ï¼š
<img alt="" src="https://fasterthanli.me/content/articles/understanding-rust-futures-by-going-way-too-deep/assets/color-eyre.78931d5fc80841f6.webp"></p>
<p>æœ€åï¼Œå› ä¸ºæˆ‘å–œæ¬¢ç»“æ„åŒ–æ—¥å¿—ï¼Œè®©æˆ‘ä»¬æ·»åŠ  <a href="https://lib.rs/crates/tracing">tracing</a> ç„¶åé€šè¿‡æ¼‚äº®çš„é¢œè‰²æ‰“å°å®ƒä»¬ï¼Œè®©æˆ‘ä»¬æ·»åŠ  <a href="https://lib.rs/crates/tracing-subscriber">tracing-subscriber</a>.</p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">tracing</span><span class="mf">@0.1.26</span><span class="w"> </span><span class="n">tracing</span><span class="o">-</span><span class="n">subscriber</span><span class="mf">@0.2.19</span>
<span class="w">    </span><span class="n">Updating</span><span class="w"> </span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//github.com/rust-lang/crates.io-index&#39; index</span>
<span class="w">      </span><span class="n">Adding</span><span class="w"> </span><span class="n">tracing</span><span class="w"> </span><span class="n">v0</span><span class="mf">.1.26</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dependencies</span>
<span class="w">      </span><span class="n">Adding</span><span class="w"> </span><span class="n">tracing</span><span class="o">-</span><span class="n">subscriber</span><span class="w"> </span><span class="n">v0</span><span class="mf">.2.19</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dependencies</span>
</code></pre></div>

<p>æˆ‘ä»¬å·²ç»æœ‰ä¸€ä¸ª <code>setup</code> å‡½æ•°ï¼Œæ‰€ä»¥ç›´æ¥åœ¨é‚£é‡Œå®‰è£… <code>tracing-subscriber</code>.. ç„¶åæˆ‘ä»¬å°† <code>println!</code> æ”¹æˆ <code>info!</code> ï¼
ç„¶åï¼Œä¸ºäº†æ¼”ç¤ºå¦‚ä½•è®¾ç½®è®©æˆ‘ä»¬å†æ¬¡ä¿®æ”¹ä¸€äº›ç¯å¢ƒå˜é‡ï¼šå¯¹æ‰€æœ‰åŒ…ï¼ˆcratesï¼‰é»˜è®¤ <code>info</code> æ—¥å¿—çº§åˆ«ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">color_eyre</span>::<span class="n">Report</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">tracing</span>::<span class="n">info</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">tracing_subscriber</span>::<span class="n">EnvFilter</span><span class="p">;</span>

<span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Hello from a comfy nest we&#39;ve made for ourselves&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">setup</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">var</span><span class="p">(</span><span class="s">&quot;RUST_LIB_BACKTRACE&quot;</span><span class="p">).</span><span class="n">is_err</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="s">&quot;RUST_LIB_BACKTRACE&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">color_eyre</span>::<span class="n">install</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">var</span><span class="p">(</span><span class="s">&quot;RUST_LOG&quot;</span><span class="p">).</span><span class="n">is_err</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="s">&quot;RUST_LOG&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;info&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">tracing_subscriber</span>::<span class="n">fmt</span>::<span class="n">fmt</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">with_env_filter</span><span class="p">(</span><span class="n">EnvFilter</span>::<span class="n">from_default_env</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">init</span><span class="p">();</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>run
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.02s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:03:46.993<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Hello<span class="w"> </span>from<span class="w"> </span>a<span class="w"> </span>comfy<span class="w"> </span>nest<span class="w"> </span>we<span class="err">&#39;</span>ve<span class="w"> </span>made<span class="w"> </span><span class="k">for</span><span class="w"> </span>ourselves
</code></pre></div>

<p>å¥½äº†ï¼Œæˆ‘ä»¬å‡†å¤‡å¥½åšä¸€äº›æœ‰ç”¨çš„äº‹æƒ…äº†ã€‚</p>
<h3 id="åšä¸€äº›æœ‰ç”¨çš„äº‹æƒ…">åšä¸€äº›æœ‰ç”¨çš„äº‹æƒ…</h3>
<p>å½“å†³å®šåœ¨å’–å•¡é—´éš™é˜…è¯»å“ªä¸€ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œäººä»¬é€šå¸¸åŒæ—¶æ‰“å¼€å‡ ä¸ªç½‘ç«™ï¼Œç„¶åè¯»æœ€å…ˆåŠ è½½å‡ºæ¥çš„é‚£ä¸€ç¯‡ã€‚</p>
<p>äº‹å®å¦‚æ­¤ã€‚ä½ å¯ä»¥å¼•ç”¨æˆ‘çš„è¯ï¼Œè°ä¼šå»éªŒè¯å‘¢ï¼Ÿæ¯•ç«Ÿè¿™å¬èµ·æ¥éœ€è¦å¾ˆå¤šå·¥ä½œã€‚</p>
<p>æ‰€ä»¥è®©æˆ‘ä»¬æ¥ç¼–å†™ä¸€ä¸ªç¨‹åºåšç›¸åŒçš„äº‹æƒ…ã€‚</p>
<p>è®©æˆ‘ä»¬å¼•å…¥ <a href="https://lib.rs/crates/reqwest">reqwest</a> -- å°½ç®¡æˆ‘ä¸å–œæ¬¢å®ƒçš„ APIï¼Œä½†å®ƒä¼šå¾ˆå¥½çš„å®Œæˆæ¥ä¸‹æ¥çš„å·¥ä½œã€‚</p>
<p>åŒæ—¶ï¼Œå› ä¸º <a href="https://www.openssl.org/news/vulnerabilities.html">screw OpenSSL</a> æˆ‘ä»¬å°†æ ‡è®° reqwest ä½¿ç”¨ <a href="https://lib.rs/crates/rustls">rustls</a>ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">reqwest</span><span class="mf">@0.11.4</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="k">default</span><span class="o">-</span><span class="n">features</span><span class="w"> </span><span class="o">--</span><span class="n">features</span><span class="w"> </span><span class="n">rustls</span><span class="o">-</span><span class="n">tls</span>
<span class="w">    </span><span class="n">Updating</span><span class="w"> </span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//github.com/rust-lang/crates.io-index&#39; index</span>
<span class="w">      </span><span class="n">Adding</span><span class="w"> </span><span class="n">reqwest</span><span class="w"> </span><span class="n">v0</span><span class="mf">.11.4</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dependencies</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">features</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;rustls-tls&quot;</span><span class="p">]</span>
</code></pre></div>

<p>æˆ‘ä»¬å‡†å¤‡å¥½å‘é€ä¸€ä¸ªè¯·æ±‚äº†ï¼</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">color_eyre</span>::<span class="n">Report</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">tracing</span>::<span class="n">info</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">tracing_subscriber</span>::<span class="n">EnvFilter</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">reqwest</span>::<span class="n">Client</span><span class="p">;</span>

<span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Hello from a comfy nest we&#39;ve made for ourselves&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;https://fasterthanli.me&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// this will turn non-200 HTTP status codes into rust errors,</span>
<span class="w">    </span><span class="c1">// so the first `?` propagates &quot;we had a connection problem&quot; and</span>
<span class="w">    </span><span class="c1">// the second `?` propagates &quot;we had a chat with the server and they</span>
<span class="w">    </span><span class="c1">// were not pleased&quot;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">send</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">.</span><span class="n">error_for_status</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">content_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="n">res</span><span class="p">.</span><span class="n">headers</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;content-type&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Got a response!&quot;</span><span class="p">);</span>


<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">setup</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">var</span><span class="p">(</span><span class="s">&quot;RUST_LIB_BACKTRACE&quot;</span><span class="p">).</span><span class="n">is_err</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="s">&quot;RUST_LIB_BACKTRACE&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">color_eyre</span>::<span class="n">install</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">var</span><span class="p">(</span><span class="s">&quot;RUST_LOG&quot;</span><span class="p">).</span><span class="n">is_err</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="s">&quot;RUST_LOG&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;info&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">tracing_subscriber</span>::<span class="n">fmt</span>::<span class="n">fmt</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">with_env_filter</span><span class="p">(</span><span class="n">EnvFilter</span>::<span class="n">from_default_env</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">init</span><span class="p">();</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>å‡ºå‘äº†ï¼</p>
<div class="highlight"><pre><span></span><code><span class="nt">cargo</span><span class="w"> </span><span class="nt">run</span>
<span class="w">   </span><span class="nt">Compiling</span><span class="w"> </span><span class="nt">waytoodeep</span><span class="w"> </span><span class="nt">v0</span><span class="p">.</span><span class="nc">1</span><span class="p">.</span><span class="nc">0</span><span class="w"> </span><span class="o">(/</span><span class="nt">Users</span><span class="o">/</span><span class="nt">wh</span><span class="o">/</span><span class="nt">codes</span><span class="o">/</span><span class="nt">rust</span><span class="o">/</span><span class="nt">waytoodeep</span><span class="o">)</span>
<span class="w">    </span><span class="nt">Finished</span><span class="w"> </span><span class="nt">dev</span><span class="w"> </span><span class="cp">[</span><span class="nx">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">debuginfo</span><span class="cp">]</span><span class="w"> </span><span class="nt">target</span><span class="o">(</span><span class="nt">s</span><span class="o">)</span><span class="w"> </span><span class="nt">in</span><span class="w"> </span><span class="nt">7</span><span class="p">.</span><span class="nc">16s</span>
<span class="w">     </span><span class="nt">Running</span><span class="w"> </span><span class="err">`</span><span class="nt">target</span><span class="o">/</span><span class="nt">debug</span><span class="o">/</span><span class="nt">waytoodeep</span><span class="err">`</span>
<span class="nt">Jul</span><span class="w"> </span><span class="nt">26</span><span class="w"> </span><span class="nt">16</span><span class="p">:</span><span class="nd">50</span><span class="p">:</span><span class="nd">57</span><span class="p">.</span><span class="nc">778</span><span class="w">  </span><span class="nt">INFO</span><span class="w"> </span><span class="nt">waytoodeep</span><span class="o">:</span><span class="w"> </span><span class="nt">Hello</span><span class="w"> </span><span class="nt">from</span><span class="w"> </span><span class="nt">a</span><span class="w"> </span><span class="nt">comfy</span><span class="w"> </span><span class="nt">nest</span><span class="w"> </span><span class="nt">we</span><span class="err">&#39;</span><span class="nt">ve</span><span class="w"> </span><span class="nt">made</span><span class="w"> </span><span class="nt">for</span><span class="w"> </span><span class="nt">ourselves</span>
<span class="nt">Jul</span><span class="w"> </span><span class="nt">26</span><span class="w"> </span><span class="nt">16</span><span class="p">:</span><span class="nd">50</span><span class="p">:</span><span class="nd">59</span><span class="p">.</span><span class="nc">090</span><span class="w">  </span><span class="nt">INFO</span><span class="w"> </span><span class="nt">waytoodeep</span><span class="o">:</span><span class="w"> </span><span class="nt">Got</span><span class="w"> </span><span class="nt">a</span><span class="w"> </span><span class="nt">response</span><span class="o">!</span><span class="w"> </span><span class="nt">url</span><span class="o">=</span><span class="nt">https</span><span class="o">://</span><span class="nt">fasterthanli</span><span class="p">.</span><span class="nc">me</span><span class="w"> </span><span class="nt">content_type</span><span class="o">=</span><span class="nt">Some</span><span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
</code></pre></div>

<p>è¿™å°±æ˜¯æˆ‘æ‰€è¯´çš„ã€Œç»“æ„åŒ–æ—¥å¿—ã€ã€‚å—¯ï¼Œå…¶ä¸­çš„ä¸€éƒ¨åˆ†ã€‚è®©æˆ‘ä»¬çœ‹ä¸‹è¿™è¡Œä»£ç ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">content_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="n">res</span><span class="p">.</span><span class="n">headers</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;content-type&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Got a response!&quot;</span><span class="p">);</span>
</code></pre></div>

<p>æˆ‘ä»¬è¾“å‡ºæ¥ä¸€ä¸ªæ¶ˆæ¯ï¼š <code>Got a response!</code> ï¼Œä¸€ä¸ªåä¸º <code>url</code> çš„æ ‡ç­¾ï¼šå€¼ä¸ºå˜é‡ <code>url</code> çš„ <a href="https://doc.rust-lang.org/stable/std/fmt/trait.Display.html">Display</a> æ ¼å¼ï¼Œ
ä¸€ä¸ªåä¸º <code>content_type</code> çš„æ ‡ç­¾ï¼šå€¼ä¸ºè¡¨è¾¾å¼çš„ <a href="https://doc.rust-lang.org/stable/std/fmt/trait.Debug.html">Debug</a> æ ¼å¼ã€‚</p>
<p>å°±æ˜¯è¿™ä¹ˆç®€å•ï¼ <code>name = %value</code> è¾“å‡º <code>Display</code> ï¼Œ <code>name = ?value</code> è¾“å‡º <code>Debug</code> ã€‚</p>
<p>å½“ç„¶ï¼Œè¿˜æœ‰éå¸¸æ£’çš„è·¨åº¦ï¼ˆspansï¼‰ï¼Œé‡ç‚¹æ˜¯ä½ å¯ä»¥å°†å®ƒä»¬å‘é€åˆ° APMï¼ˆAppliation Performance Monitoringï¼‰ï¼Œæ¯”å¦‚ Datadog æˆ–è€… Honeycomb ç­‰ï¼Œä½†æ˜¯è¿™ä¸æ˜¯ä¸€ç¯‡å…³äºè·Ÿè¸ªçš„æ–‡ç« ã€‚</p>
<p>ä¸ºäº†ä¸¾ä¾‹è¯´æ˜ï¼Œå¦‚æœæˆ‘ä»¬å®‰è£…ä¸€ä¸ª JSON çš„ tracing subscriberï¼Œæˆ‘ä»¬å°†è·å¾—å¦‚ä¸‹å†…å®¹ï¼š</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>run
<span class="w">   </span>Compiling<span class="w"> </span>waytoodeep<span class="w"> </span>v0.1.0<span class="w"> </span><span class="o">(</span>/home/amos/ftl/waytoodeep<span class="o">)</span>
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.09s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
<span class="o">{</span><span class="s2">&quot;timestamp&quot;</span>:<span class="s2">&quot;Jul 25 17:17:21.531&quot;</span>,<span class="s2">&quot;level&quot;</span>:<span class="s2">&quot;INFO&quot;</span>,<span class="s2">&quot;fields&quot;</span>:<span class="o">{</span><span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;Hello from a comfy nest we&#39;ve made for ourselves&quot;</span><span class="o">}</span>,<span class="s2">&quot;target&quot;</span>:<span class="s2">&quot;waytoodeep&quot;</span><span class="o">}</span>
<span class="o">{</span><span class="s2">&quot;timestamp&quot;</span>:<span class="s2">&quot;Jul 25 17:17:21.709&quot;</span>,<span class="s2">&quot;level&quot;</span>:<span class="s2">&quot;INFO&quot;</span>,<span class="s2">&quot;fields&quot;</span>:<span class="o">{</span><span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;Got a response!&quot;</span>,<span class="s2">&quot;url&quot;</span>:<span class="s2">&quot;https://fasterthanli.me&quot;</span>,<span class="s2">&quot;content_type&quot;</span>:<span class="s2">&quot;Some(\&quot;text/html; charset=utf-8\&quot;)&quot;</span><span class="o">}</span>,<span class="s2">&quot;target&quot;</span>:<span class="s2">&quot;waytoodeep&quot;</span><span class="o">}</span>
</code></pre></div>

<p>è¿™åº”è¯¥è¶³ä»¥æ¿€èµ·ä½ çš„å…´è¶£ã€‚</p>
<h3 id="åŒæ—¶è·å–ä¸¤ä¸ªåœ°å€">åŒæ—¶è·å–ä¸¤ä¸ªåœ°å€</h3>
<p>ç°åœ¨è®©æˆ‘ä»¬è·å–ä¸¤ä¸ªåœ°å€ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">URL_1</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&quot;https://fasterthanli.me/articles/whats-in-the-box&quot;</span><span class="p">;</span>
<span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">URL_2</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&quot;https://fasterthanli.me/series/advent-of-code-2020/part-13&quot;</span><span class="p">;</span>
</code></pre></div>

<p>ã€‚ã€‚ã€‚è¿™æ˜¯ä¸€ä¸ªå…¬å¹³çš„æ¯”è¾ƒã€‚ è¿™ä¸¤ç¯‡æ–‡ç« éƒ½æ‰˜ç®¡åœ¨æˆ‘è‡ªå·±çš„ç½‘ç«™ä¸Šï¼Œç»å¯¹ä¸æ˜¯ä¸ºäº†æ¨å¹¿ï¼Œè€Œæ˜¯ä¸ºäº†ä½¿è·å–æ—¶é—´å…·æœ‰å¯æ¯”æ€§ï¼Œå¹¶ä¸”ä»»ä¸€éƒ½æœ‰å¯èƒ½å…ˆåŠ è½½å®Œæˆï¼ˆå¹¶ä¸”ä¼šéšç€æ—¶é—´çš„æ¨ç§»éšæœºå˜åŒ–ï¼‰ã€‚</p>
<p>æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå‡½æ•°æ¥è·å–å†…å®¹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">fetch_thing</span><span class="p">(</span><span class="n">client</span>: <span class="kp">&amp;</span><span class="nc">Client</span><span class="p">,</span><span class="w"> </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">send</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">.</span><span class="n">error_for_status</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">content_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="n">res</span><span class="p">.</span><span class="n">headers</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;content-type&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Got a response!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>å¹¶ä½¿ç”¨å®ƒï¼š</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Hello from a comfy nest we&#39;ve made for ourselves&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">    </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_2</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>ç„¶åè¿è¡Œå®ƒ:</p>
<div class="highlight"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">waytoodeep</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">1.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="n">ftl</span><span class="o">/</span><span class="n">waytoodeep</span><span class="p">)</span>
<span class="n">warning</span>: <span class="nc">unused</span><span class="w"> </span><span class="n">implementer</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="err">`</span><span class="n">Future</span><span class="err">`</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">used</span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">15</span>:<span class="mi">5</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">15</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="w">   </span><span class="o">|</span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="err">`</span><span class="cp">#[warn(unused_must_use)]</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">default</span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">futures</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">nothing</span><span class="w"> </span><span class="n">unless</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="err">`</span><span class="p">.</span><span class="k">await</span><span class="err">`</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">poll</span><span class="w"> </span><span class="n">them</span>

<span class="n">warning</span>: <span class="nc">unused</span><span class="w"> </span><span class="n">implementer</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="err">`</span><span class="n">Future</span><span class="err">`</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">used</span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">16</span>:<span class="mi">5</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">16</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_2</span><span class="p">);</span>
<span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="w">   </span><span class="o">|</span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">futures</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">nothing</span><span class="w"> </span><span class="n">unless</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="err">`</span><span class="p">.</span><span class="k">await</span><span class="err">`</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">poll</span><span class="w"> </span><span class="n">them</span>

<span class="n">warning</span>: <span class="mi">2</span><span class="w"> </span><span class="n">warnings</span><span class="w"> </span><span class="n">emitted</span>

<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">3.01</span><span class="n">s</span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">waytoodeep</span><span class="err">`</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">17</span>:<span class="mi">26</span>:<span class="mf">31.571</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span>: <span class="nc">Hello</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">comfy</span><span class="w"> </span><span class="n">nest</span><span class="w"> </span><span class="n">we</span><span class="o">&#39;</span><span class="na">ve</span><span class="w"> </span><span class="n">made</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">ourselves</span>
</code></pre></div>

<p>å¥‡æ€ªçš„æ˜¯ï¼Œæ²¡æœ‰ä»»ä½•äº‹æƒ…å‘ç”Ÿã€‚</p>
<blockquote>
<p>é»„è‰²çš„æ³¢æµªçº¿å’Œæ¼äººçš„ Rust è­¦å‘Šå·²ç»ç»™å‡ºäº†æç¤ºã€‚</p>
</blockquote>
<p>è®©æˆ‘ä»¬æ¥ä¿®å¤å®ƒï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_2</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>run
<span class="w">   </span>Compiling<span class="w"> </span>waytoodeep<span class="w"> </span>v0.1.0<span class="w"> </span><span class="o">(</span>/home/amos/ftl/waytoodeep<span class="o">)</span>
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.17s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:27:29.768<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Hello<span class="w"> </span>from<span class="w"> </span>a<span class="w"> </span>comfy<span class="w"> </span>nest<span class="w"> </span>we<span class="err">&#39;</span>ve<span class="w"> </span>made<span class="w"> </span><span class="k">for</span><span class="w"> </span>ourselves
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:27:29.891<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:27:29.974<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
</code></pre></div>

<p>æ‰€ä»¥ï¼Œç¬¬é›¶è¯¾ï¼šfuture å¯¹è±¡ä¸åšä»»ä½•äº‹æƒ…ç›´åˆ°å®ƒä»¬è¢«è½®è¯¢ï¼ˆpolledï¼‰ã€‚</p>
<p>è¿™æ˜¯å› ä¸º future å¯¹è±¡å‡ ä¹å°±æ˜¯çŠ¶æ€ã€‚è®©æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in `src/main.rs`</span>

<span class="k">mod</span> <span class="nn">dumb</span><span class="p">;</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1">// in `src/dumb.rs`</span>

<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">future</span>::<span class="n">Future</span><span class="p">,</span>
<span class="w">    </span><span class="n">pin</span>::<span class="n">Pin</span><span class="p">,</span>
<span class="w">    </span><span class="n">task</span>::<span class="p">{</span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">Poll</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">use</span><span class="w"> </span><span class="n">tracing</span>::<span class="n">info</span><span class="p">;</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">DumbFuture</span><span class="w"> </span><span class="p">{}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">DumbFuture</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">();</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">_cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Hello from a dumb future!&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1">// back in `src/main.rs`</span>

<span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dumb</span>::<span class="n">DumbFuture</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>ä»¥ä¸Šï¼æˆ‘ä»¬å‡ ä¹å°±å®Œæˆäº†ï¼Œé™¤äº†æˆ‘ä»¬æ²¡æœ‰è¿›è¡Œ <code>.await</code> ã€‚</p>
<p>è¿è¡Œå®ƒé™¤äº†æ‰“å°è­¦å‘Šä¸ä¼šæœ‰ä»»ä½•æ•ˆæœï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">waytoodeep</span><span class="w"> </span><span class="n">v0</span><span class="mf">.1.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="n">ftl</span><span class="o">/</span><span class="n">waytoodeep</span><span class="p">)</span>
<span class="n">warning</span><span class="o">:</span><span class="w"> </span><span class="n">unused</span><span class="w"> </span><span class="n">variable</span><span class="o">:</span><span class="w"> </span><span class="n n-Quoted">`fut`</span>
<span class="w">  </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mi">9</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">14</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">let</span><span class="w"> </span><span class="n">fut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dumb</span><span class="o">::</span><span class="n">DumbFuture</span><span class="w"> </span><span class="err">{}</span><span class="p">;</span>
<span class="w">   </span><span class="o">|</span><span class="w">         </span><span class="o">^^^</span><span class="w"> </span><span class="k">help</span><span class="o">:</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">intentional</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">underscore</span><span class="o">:</span><span class="w"> </span><span class="n n-Quoted">`_fut`</span>
<span class="w">   </span><span class="o">|</span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span><span class="o">:</span><span class="w"> </span><span class="n n-Quoted">`#[warn(unused_variables)]`</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">default</span>

<span class="n">warning</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">warning</span><span class="w"> </span><span class="n">emitted</span>

<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="err">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="err">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">2.11</span><span class="n">s</span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="n n-Quoted">`target/debug/waytoodeep`</span>
</code></pre></div>

<p>å› ä¸ºæ€ä¹ˆå¯èƒ½ï¼Ÿæˆ‘ä»¬å­—é¢ä¸Šä»…ä»…æ„å»ºäº†ä¸€ä¸ªç»“æ„ä½“ã€‚ä¸€ä¸ªé›¶å¤§å°çš„ç»“æ„ä½“ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬è°ƒç”¨å®ƒçš„ <code>.await</code> ã€‚ã€‚ ç„¶åå½“æˆ‘ä»¬è¦æ±‚è¿è¡Œæ—¶è¿è¡Œå®ƒçš„äº‹ä»¶å¾ªç¯ç›´åˆ° future å¯¹è±¡è¢«è½®è¯¢ï¼ˆpolledï¼‰å¹¶ä¸”æœ€ç»ˆè¿”å› <code>Poll::Ready</code> ï¼ˆæˆ‘ä»¬çš„ä»£ç ç«‹å³è¿”å›ï¼‰ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Building that dumb future...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dumb</span>::<span class="n">DumbFuture</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Awaiting that dumb future...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">fut</span><span class="p">.</span><span class="k">await</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Done awaiting that dumb future&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>run
<span class="w">   </span>Compiling<span class="w"> </span>waytoodeep<span class="w"> </span>v0.1.0<span class="w"> </span><span class="o">(</span>/home/amos/ftl/waytoodeep<span class="o">)</span>
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span>.34s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:37:09.261<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Building<span class="w"> </span>that<span class="w"> </span>dumb<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:37:09.261<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Awaiting<span class="w"> </span>that<span class="w"> </span>dumb<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:37:09.261<span class="w">  </span>INFO<span class="w"> </span>waytoodeep::dumb:<span class="w"> </span>Hello<span class="w"> </span>from<span class="w"> </span>a<span class="w"> </span>dumb<span class="w"> </span>future!
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:37:09.262<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Done<span class="w"> </span>awaiting<span class="w"> </span>that<span class="w"> </span>dumb<span class="w"> </span>future
</code></pre></div>

<p>è¿™é‡Œä¸ ECMAScript çš„ <code>promise</code> æœ‰ä¸€äº›ç•¥å¾®çš„åŒºåˆ«ï¼šå³ä½¿å®ƒä»¬å‹æ ¹æ²¡æœ‰è¢« await å…¶ä¸­åŒ…å«çš„å·¥ä½œä¾ç„¶ä¼šè¢«æ‰§è¡Œã€‚</p>
<p>ä½†æ˜¯ Rust çš„ future å¯¹è±¡ä»…ä»…æ˜¯æ— èŠçš„çŠ¶æ€æœºï¼Œå¦‚æœä½ æ•…æ„åˆ¶é€ éº»çƒ¦å°±å¯ä»¥ç†è§£è¿™ä¸ªæœºåˆ¶ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in `src/dumb.rs`</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">DumbFuture</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">();</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">_cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">panic!</span><span class="p">(</span><span class="s">&quot;Oh heck no&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>cargo<span class="w"> </span>run
<span class="w">   </span>Compiling<span class="w"> </span>waytoodeep<span class="w"> </span>v0.1.0<span class="w"> </span><span class="o">(</span>/home/amos/ftl/waytoodeep<span class="o">)</span>
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span>.28s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:41:18.956<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Building<span class="w"> </span>that<span class="w"> </span>dumb<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:41:18.956<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Awaiting<span class="w"> </span>that<span class="w"> </span>dumb<span class="w"> </span>future...
The<span class="w"> </span>application<span class="w"> </span>panicked<span class="w"> </span><span class="o">(</span>crashed<span class="o">)</span>.
Message:<span class="w">  </span>Oh<span class="w"> </span>heck<span class="w"> </span>no
Location:<span class="w"> </span>src/dumb.rs:14

<span class="w">  </span>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<span class="w"> </span>BACKTRACE<span class="w"> </span>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
<span class="w">                                </span>â‹®<span class="w"> </span><span class="m">6</span><span class="w"> </span>frames<span class="w"> </span>hidden<span class="w"> </span>â‹®
<span class="w">   </span><span class="m">7</span>:<span class="w"> </span>&lt;waytoodeep::dumb::DumbFuture<span class="w"> </span>as<span class="w"> </span>core::future::future::Future&gt;::poll::h4a44780628f4c5f0
<span class="w">      </span>at<span class="w"> </span>/home/amos/ftl/waytoodeep/src/dumb.rs:14
<span class="w">   </span><span class="m">8</span>:<span class="w"> </span>waytoodeep::main::<span class="o">{{</span>closure<span class="o">}}</span>::h36de5a1f1f2a5c5b
<span class="w">      </span>at<span class="w"> </span>/home/amos/ftl/waytoodeep/src/main.rs:17
<span class="w">   </span><span class="m">9</span>:<span class="w"> </span>&lt;core::future::from_generator::GenFuture&lt;T&gt;<span class="w"> </span>as<span class="w"> </span>core::future::future::Future&gt;::poll::h20a96e082c7a581e
<span class="w">      </span>at<span class="w"> </span>/home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/mod.rs:80
<span class="w">  </span><span class="m">10</span>:<span class="w"> </span>tokio::park::thread::CachedParkThread::block_on::<span class="o">{{</span>closure<span class="o">}}</span>::hdf98cb3c7fdf3de4
<span class="w">      </span>at<span class="w"> </span>/home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/park/thread.rs:263
<span class="w">  </span><span class="m">11</span>:<span class="w"> </span>tokio::coop::with_budget::<span class="o">{{</span>closure<span class="o">}}</span>::h6a86a24a246e220f
<span class="w">      </span>at<span class="w"> </span>/home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/coop.rs:106
<span class="w">  </span><span class="m">12</span>:<span class="w"> </span>std::thread::local::LocalKey&lt;T&gt;::try_with::h2ce0ac27c85965b6
<span class="w">      </span>at<span class="w"> </span>/home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/local.rs:376
<span class="w">  </span><span class="m">13</span>:<span class="w"> </span>std::thread::local::LocalKey&lt;T&gt;::with::hc449f38c9f65fb53
<span class="w">      </span>at<span class="w"> </span>/home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/local.rs:352
<span class="w">  </span><span class="m">14</span>:<span class="w"> </span>tokio::coop::with_budget::h5db157bd1e95e0e8
<span class="w">      </span>at<span class="w"> </span>/home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/coop.rs:99
<span class="w">  </span><span class="m">15</span>:<span class="w"> </span>tokio::coop::budget::h7b57383f1255ac24
<span class="w">      </span>at<span class="w"> </span>/home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/coop.rs:76
<span class="w">  </span><span class="m">16</span>:<span class="w"> </span>tokio::park::thread::CachedParkThread::block_on::hece399485213b91c
<span class="w">      </span>at<span class="w"> </span>/home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/park/thread.rs:263
<span class="w">  </span><span class="m">17</span>:<span class="w"> </span>tokio::runtime::enter::Enter::block_on::h89e9882e539e82d3
<span class="w">      </span>at<span class="w"> </span>/home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/runtime/enter.rs:151
<span class="w">  </span><span class="m">18</span>:<span class="w"> </span>tokio::runtime::thread_pool::ThreadPool::block_on::h1a0186470c00ba70
<span class="w">      </span>at<span class="w"> </span>/home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/runtime/thread_pool/mod.rs:71
<span class="w">  </span><span class="m">19</span>:<span class="w"> </span>tokio::runtime::Runtime::block_on::h7c21d6989b86d606
<span class="w">      </span>at<span class="w"> </span>/home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/runtime/mod.rs:452
<span class="w">  </span><span class="m">20</span>:<span class="w"> </span>waytoodeep::main::hb4dd5ffd46a5c032
<span class="w">      </span>at<span class="w"> </span>/home/amos/ftl/waytoodeep/src/main.rs:20
<span class="w">  </span><span class="m">21</span>:<span class="w"> </span>core::ops::function::FnOnce::call_once::hc1fcc87431f77d25
<span class="w">      </span>at<span class="w"> </span>/home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/function.rs:227
<span class="w">                                </span>â‹®<span class="w"> </span><span class="m">11</span><span class="w"> </span>frames<span class="w"> </span>hidden<span class="w"> </span>â‹®

Run<span class="w"> </span>with<span class="w"> </span><span class="nv">COLORBT_SHOW_HIDDEN</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>environment<span class="w"> </span>variable<span class="w"> </span>to<span class="w"> </span>disable<span class="w"> </span>frame<span class="w"> </span>filtering.
Run<span class="w"> </span>with<span class="w"> </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span>full<span class="w"> </span>to<span class="w"> </span>include<span class="w"> </span><span class="nb">source</span><span class="w"> </span>snippets.
</code></pre></div>

<p>ä¸Šé¢å †æ ˆè·Ÿè¸ªå¦‚æœåŠ ä¸Šé¢œè‰²æ•ˆæœä¼šæ›´å¥½ï¼Œæ‰€ä»¥æˆ‘å¸Œæœ›ä½ åœ¨æœ¬åœ°åšäº†ç›¸åŒçš„å°è¯•ï¼Œå³ä½¿å¦‚æ­¤æˆ‘ä»¬ä¾ç„¶å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çœŸæ­£çš„ main å‡½æ•°åœ¨ 20 å¸§ï¼Œç„¶åå¾€ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>Runtime::block_on</code>  ã€ä¸€ä¸ªçº¿ç¨‹æ± çš„ä¸œè¥¿ã€ä¸€äº›æŒ‚èµ·ï¼ˆparkedï¼‰çš„çº¿ç¨‹ã€thread-localï¼ˆå…¶ä»– TLSï¼‰ã€ä¸€ä¸ª <strong><em>*ç”Ÿæˆçš„</em></strong>* futureï¼ˆå¸§ 9 å’Œ 8ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ <code>async fn main</code> çš„æœ€ç»ˆç»“æœï¼‰ï¼Œæœ€åæ˜¯æˆ‘ä»¬çš„ <code>DumbFuture</code> poll æ–¹æ³•ï¼ˆå¸§ 7ï¼‰ã€‚</p>
<p>å¸§ 6 åˆ° 1 å°±æ˜¯ <a href="https://doc.rust-lang.org/stable/std/panic/index.html">panic</a> æœºåˆ¶ï¼Œå†æ¬¡å®Œå…¨è¶…å‡ºæœ¬æ–‡è®¨è®ºçš„èŒƒå›´ã€‚</p>
<p>ä½†æ˜¯è¯·ç«™èµ·æ¥ï¼Œäº²çˆ±çš„è§‚ä¼—ï¼Œç”¨ä½ çš„æ‰‹è‡‚ç»•è¿‡è¿™ä¸ªè£…ç½®ï¼Œä»¥ç¡®ä¿æ²¡æœ‰éšœçœ¼æ³•ï¼Œæ²¡æœ‰éšè—çš„çº¿ï¼Œæ²¡æœ‰ã€‚ã€‚ã€‚</p>
<p>ã€‚ã€‚ã€‚æˆ‘è¦è¯´çš„æ˜¯å¯¹äºå¼‚æ­¥å †æ ˆè·Ÿè¸ªæ²¡æœ‰â€œç‰¹æ®Šå¤„ç†â€ï¼ˆspecial handlingï¼‰ã€‚å½“ç„¶ï¼Œè¿™é‡Œæˆ‘ä»¬å´©æºƒäº†ï¼Œä½†æ˜¯ä»…ä»…æ˜¯ Rustï¼Œæ“ä½œç³»ç»Ÿç”šè‡³ä¸çŸ¥é“æˆ‘å‡ ä¹é¿å…äº†ä¸€åœºç¾éš¾ã€‚</p>
<p>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥åˆ¶é€ æ›´å¤§çš„æ··ä¹±ï¼Œå¦‚æœæˆ‘ä»¬æ„¿æ„ä½¿ç”¨ <code>unsafe</code> ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">DumbFuture</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">();</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">_cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">*</span><span class="p">(</span><span class="mh">0xF00D</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u64</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="fm">unreachable!</span><span class="p">();</span><span class="w"> </span><span class="c1">// pinky promise</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>ç„¶åå°±ä¸ä¼šæœ‰ä¸€äº›åˆ—çš„å´©æºƒå¤„ç†æ¥æ‹¯æ•‘æˆ‘ä»¬ï¼š</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>cargo<span class="w"> </span>run
<span class="w">   </span>Compiling<span class="w"> </span>waytoodeep<span class="w"> </span>v0.1.0<span class="w"> </span><span class="o">(</span>/home/amos/ftl/waytoodeep<span class="o">)</span>
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span>.18s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:46:53.926<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Building<span class="w"> </span>that<span class="w"> </span>dumb<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:46:53.926<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Awaiting<span class="w"> </span>that<span class="w"> </span>dumb<span class="w"> </span>future...
zsh:<span class="w"> </span>segmentation<span class="w"> </span>fault<span class="w"> </span><span class="o">(</span>core<span class="w"> </span>dumped<span class="o">)</span><span class="w">  </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>cargo<span class="w"> </span>run
</code></pre></div>

<p>ä½†æ˜¯ GDB å¯ä»¥ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="o">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">gdb</span><span class="w"> </span><span class="o">--</span><span class="n">quiet</span><span class="w"> </span><span class="o">--</span><span class="n">args</span><span class="w"> </span><span class="o">./</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">waytoodeep</span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.04</span><span class="n">s</span>
<span class="n">Reading</span><span class="w"> </span><span class="n">symbols</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="o">./</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">waytoodeep</span><span class="o">...</span>
<span class="n">warning</span><span class="p">:</span><span class="w"> </span><span class="n">Missing</span><span class="w"> </span><span class="n">auto</span><span class="o">-</span><span class="nb">load</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="o">.</span><span class="n">debug_gdb_scripts</span>
<span class="n">of</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="n">ftl</span><span class="o">/</span><span class="n">waytoodeep</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">waytoodeep</span><span class="o">.</span>
<span class="n">Use</span><span class="w"> </span><span class="err">`</span><span class="n">info</span><span class="w"> </span><span class="n">auto</span><span class="o">-</span><span class="nb">load</span><span class="w"> </span><span class="n">python</span><span class="o">-</span><span class="n">scripts</span><span class="w"> </span><span class="p">[</span><span class="n">REGEXP</span><span class="p">]</span><span class="s1">&#39; to list them.</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">r</span>
<span class="n">Starting</span><span class="w"> </span><span class="n">program</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="n">ftl</span><span class="o">/</span><span class="n">waytoodeep</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">waytoodeep</span>
<span class="p">[</span><span class="n">Thread</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">libthread_db</span><span class="w"> </span><span class="n">enabled</span><span class="p">]</span>
<span class="n">Using</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="n">libthread_db</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="s2">&quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;</span><span class="o">.</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7c28700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129418</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7a27700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129419</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7826700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129420</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7625700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129421</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7424700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129422</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7223700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129423</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7022700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129424</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6e1e700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129425</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6c1a700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129426</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6a16700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129427</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6812700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129428</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff660e700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129429</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff640a700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129430</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6206700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129431</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6002700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129432</span><span class="p">)]</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">17</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mf">13.278</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">:</span><span class="w"> </span><span class="n">Building</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">dumb</span><span class="w"> </span><span class="n">future</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">17</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mf">13.279</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">:</span><span class="w"> </span><span class="n">Awaiting</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">dumb</span><span class="w"> </span><span class="n">future</span><span class="o">...</span>

<span class="n">Thread</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="s2">&quot;waytoodeep&quot;</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="k">signal</span><span class="w"> </span><span class="n">SIGSEGV</span><span class="p">,</span><span class="w"> </span><span class="n">Segmentation</span><span class="w"> </span><span class="n">fault</span><span class="o">.</span>
<span class="o">&lt;</span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">dumb</span><span class="p">::</span><span class="n">DumbFuture</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">future</span><span class="p">::</span><span class="n">future</span><span class="p">::</span><span class="n">Future</span><span class="o">&gt;</span><span class="p">::</span><span class="n">poll</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">=...</span><span class="p">,</span><span class="w"> </span><span class="n">_cx</span><span class="o">=</span><span class="mh">0x7fffffffd690</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">dumb</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">15</span>
<span class="mi">15</span><span class="w">                  </span><span class="o">*</span><span class="p">(</span><span class="mh">0xF00D</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="n">mut</span><span class="w"> </span><span class="n">u64</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0</span><span class="p">;</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">bt</span>
<span class="c1">#0  &lt;waytoodeep::dumb::DumbFuture as core::future::future::Future&gt;::poll (self=..., _cx=0x7fffffffd690) at src/dumb.rs:15</span>
<span class="c1">#1  0x00005555555ab3a3 in waytoodeep::main::{{closure}} () at src/main.rs:17</span>
<span class="c1">#2  0x00005555555adb29 in &lt;core::future::from_generator::GenFuture&lt;T&gt; as core::future::future::Future&gt;::poll (self=..., cx=0x7fffffffd690)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">stable</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">future</span><span class="o">/</span><span class="n">mod</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">80</span>
<span class="c1">#3  0x00005555555adaa0 in tokio::park::thread::CachedParkThread::block_on::{{closure}} ()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">park</span><span class="o">/</span><span class="n">thread</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">263</span>
<span class="c1">#4  0x00005555555b1742 in tokio::coop::with_budget::{{closure}} (cell=0x7ffff7c2c412)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">coop</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">106</span>
<span class="c1">#5  0x00005555555a9f58 in std::thread::local::LocalKey&lt;T&gt;::try_with (self=0x555555925fc0, f=...)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">stable</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">thread</span><span class="o">/</span><span class="n">local</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">376</span>
<span class="c1">#6  0x00005555555a9e3d in std::thread::local::LocalKey&lt;T&gt;::with (self=0x555555925fc0, f=...)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">stable</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">thread</span><span class="o">/</span><span class="n">local</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">352</span>
<span class="c1">#7  0x00005555555ad7c8 in tokio::coop::with_budget (budget=..., f=...)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">coop</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">99</span>
<span class="c1">#8  tokio::coop::budget (f=...) at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/coop.rs:76</span>
<span class="c1">#9  tokio::park::thread::CachedParkThread::block_on (self=0x7fffffffd7a0, f=...)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">park</span><span class="o">/</span><span class="n">thread</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">263</span>
<span class="c1">#10 0x00005555555abcc9 in tokio::runtime::enter::Enter::block_on (self=0x7fffffffd7f0, f=...)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">enter</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">151</span>
<span class="c1">#11 0x00005555555acf2e in tokio::runtime::thread_pool::ThreadPool::block_on (self=0x7fffffffd908, future=...)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">thread_pool</span><span class="o">/</span><span class="n">mod</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">71</span>
<span class="c1">#12 0x00005555555b0dfd in tokio::runtime::Runtime::block_on (self=0x7fffffffd900, future=...)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">mod</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">452</span>
<span class="c1">#13 0x00005555555aa807 in waytoodeep::main () at src/main.rs:20</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span>
</code></pre></div>

<p>æˆ‘ä»¬å†æ¬¡ä¸¢å¤±äº†é«˜äº®é¢œè‰²ï¼Œè¿™é‡Œå¯ä»¥çœ‹ä¸€ä¸‹ï¼š
<img alt="" src="https://fasterthanli.me/content/articles/understanding-rust-futures-by-going-way-too-deep/assets/gdb-colors.b45af429c46a37d9.webp"></p>
<blockquote>
<p>è¯‘æ³¨ï¼šæˆ‘åœ¨æœ¬åœ°ç¯å¢ƒå¹¶æ²¡æœ‰é€šè¿‡ GDB å¤ç°å¸¦é«˜äº®çš„å †æ ˆè·Ÿè¸ªï¼Œåè€Œæ˜¯é€šè¿‡ LLDB å¯ä»¥çœ‹åˆ°é«˜äº®çš„å †æ ˆè·Ÿè¸ªã€‚</p>
</blockquote>
<p>æ˜¯ä¸æ˜¯å¾ˆæ¼‚äº®ï¼Ÿ</p>
<p>ç°åœ¨è®©æˆ‘ä»¬å›åˆ°æ­£å¸¸æœ‰ç”¨çš„ä»£ç ï¼Œç§»é™¤æ‰€æœ‰å…³äºè‡ªå·±å®ç°çš„ future ä»£ç ï¼š <code>src/dumb.rs</code> å’Œ <code>mod dumb</code> ã€‚å¹¶ä½¿ç”¨ä¸€ä¸ªè·å– future æ›¿ä»£ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Building that fetch future...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Awaiting that fetch future...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">fut</span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Done awaiting that fetch future&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>cargo<span class="w"> </span>run
<span class="w">   </span>Compiling<span class="w"> </span>waytoodeep<span class="w"> </span>v0.1.0<span class="w"> </span><span class="o">(</span>/home/amos/ftl/waytoodeep<span class="o">)</span>
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span>.99s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:51:49.281<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Building<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:51:49.282<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Awaiting<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:51:49.437<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:51:49.438<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Done<span class="w"> </span>awaiting<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future
</code></pre></div>

<p>æœ‰ä¸¤ç§æ–¹å¼è€ƒè™‘æˆ‘ä»¬çš„å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯è¯­æ³•ç³–å±‚ï¼šä¹Ÿå°±æ˜¯ <code>async fn</code> ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">fetch_thing</span><span class="p">(</span><span class="n">client</span>: <span class="kp">&amp;</span><span class="nc">Client</span><span class="p">,</span><span class="w"> </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">send</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">.</span><span class="n">error_for_status</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">content_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="n">res</span><span class="p">.</span><span class="n">headers</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;content-type&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Got a response!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>ç„¶åæ˜¯æ ¸å¿ƒå®ç°å±‚ï¼šä¸€ä¸ªæ™®é€šçš„ <code>fn</code> ä»…ç”¨æ¥è¿”å›ä¸€ä¸ª future å¯¹è±¡ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">future</span>::<span class="n">Future</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">fetch_thing</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">client</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="nc">Client</span><span class="p">,</span>
<span class="w">    </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="kt">str</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="na">a</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">send</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">.</span><span class="n">error_for_status</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">content_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="n">res</span><span class="p">.</span><span class="n">headers</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;content-type&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Got a response!&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>ç”±äºå€Ÿç”¨ <code>client</code> å’Œ <code>url</code> ï¼Œæ‰€ä»¥ <code>Future</code> å¯¹è±¡çš„å­˜æ´»æ—¶é—´ä¸èƒ½è¶…è¿‡ä¸¤è€…ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä¼šå°†ä¸Šé¢ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸå‘½åä¸º <code>'a</code> ï¼Œ
å¹¶ä¸”è¿”å›çš„å€¼ä¹Ÿæ˜¯ä»»æ„å®ç°äº† <code>Future</code> ï¼ˆé€šè¿‡ <code>Output</code> ï¼‰åŒæ—¶ç”Ÿå‘½å‘¨æœŸä¹Ÿæ˜¯ <code>'a</code> ã€‚</p>
<p>æ•´ä¸ª <code>async move {}</code> å¿«ä¹Ÿä»…ä»…æ˜¯â€œæ„å»ºçŠ¶æ€â€ -- ç­‰äºä¸€ä¸ªå®ç°äº† <code>Future</code> çš„ç±»å‹ã€‚</p>
<p>æˆ‘ä»¬åªæ˜¯æ— æ³•å‘½åå®ƒã€‚</p>
<p>æˆ‘ä»¬åªèƒ½å°½é‡è·å–å®ƒçš„æè¿°ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">type_name_of</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span>: <span class="kp">&amp;</span><span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span> <span class="kt">str</span> <span class="p">{</span>
<span class="w">    </span><span class="n">std</span>::<span class="n">any</span>::<span class="n">type_name</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// in main</span>

<span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Building that fetch future...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span>
<span class="w">        </span><span class="n">type_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type_name_of</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fut</span><span class="p">),</span>
<span class="w">        </span><span class="s">&quot;That fetch future has a type..&quot;</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Awaiting that fetch future...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">fut</span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Done awaiting that fetch future&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>run
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.05s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:00:39.774<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Building<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:00:39.775<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>That<span class="w"> </span>fetch<span class="w"> </span>future<span class="w"> </span>has<span class="w"> </span>a<span class="w"> </span>type..<span class="w"> </span><span class="nv">type_name</span><span class="o">=</span><span class="s2">&quot;core::future::from_generator::GenFuture&lt;waytoodeep::fetch_thing::{{closure}}&gt;&quot;</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:00:39.775<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Awaiting<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:00:39.882<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:00:39.882<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Done<span class="w"> </span>awaiting<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future
</code></pre></div>

<p>ã€‚ã€‚ã€‚ä½†æ˜¯ç­‰ç­‰ï¼Œç”±äºæˆ‘ä»¬ä½¿ç”¨äº† <code>async</code> è¯­æ³•æ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ªç¼–è¯‘å™¨ç”Ÿæˆçš„ç±»å‹ã€‚æŸç§æ„ä¹‰ä¸Šæˆ‘ä»¬æ— æ³•å‘½åå®ƒä¹Ÿå°±æ„å‘³è¿™æˆ‘ä»¬æ— æ³•ç»‘å®šè¿™ä¸ªå¯¹è±¡ï¼Œæˆ–è€…ç¼–å†™ä¸€ä¸ªå‡½æ•°ä»…ä»…æ¥å—è¯¥ç±»å‹ã€‚</p>
<p>ä¸ºäº†è®©æˆ‘ä»¬è‡ªå·±ç›¸ä¿¡ future å¯¹è±¡åœ¨æˆ‘ä»¬çœŸæ­£è½®è¯¢å®ƒä¹‹å‰å®ƒä¸ä¼šåšä»»ä½•å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥æ‰“å¼€ <code>reqwest</code> çš„è°ƒè¯•æ—¥å¿—ï¼š</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info,reqwest<span class="o">=</span>debug<span class="w"> </span>cargo<span class="w"> </span>run
<span class="w">   </span>Compiling<span class="w"> </span>waytoodeep<span class="w"> </span>v0.1.0<span class="w"> </span><span class="o">(</span>/home/amos/ftl/waytoodeep<span class="o">)</span>
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.07s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:05:07.384<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Building<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:05:07.385<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>That<span class="w"> </span>fetch<span class="w"> </span>future<span class="w"> </span>has<span class="w"> </span>a<span class="w"> </span>type..<span class="w"> </span><span class="nv">type_name</span><span class="o">=</span><span class="s2">&quot;core::future::from_generator::GenFuture&lt;waytoodeep::fetch_thing::{{closure}}&gt;&quot;</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:05:07.385<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Awaiting<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:05:07.385<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::connect:<span class="w"> </span>starting<span class="w"> </span>new<span class="w"> </span>connection:<span class="w"> </span>https://fasterthanli.me/
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:05:07.503<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::async_impl::client:<span class="w"> </span>response<span class="w"> </span><span class="s1">&#39;200 OK&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>https://fasterthanli.me/articles/whats-in-the-box
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:05:07.503<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:05:07.503<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Done<span class="w"> </span>awaiting<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future
</code></pre></div>

<p>ç”šè‡³å¯¹äºæ¯ä¸€ä¸ªåŒ…ï¼ˆcrateï¼‰ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥é€šè¿‡ç›‘å¬ <a href="https://lib.rs/crates/hyper">hyper</a> å’Œ <a href="https://lib.rs/crates/h2">h2</a> æ¥è§‚å¯Ÿï¼š</p>
<div class="highlight"><pre><span></span><code><span class="o">$</span><span class="w"> </span><span class="n">RUST_LOG</span><span class="o">=</span><span class="n">debug</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.04</span><span class="n">s</span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">waytoodeep</span><span class="err">`</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">59.973</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">:</span><span class="w"> </span><span class="n">Building</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">future</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">59.973</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">:</span><span class="w"> </span><span class="n">That</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">type</span><span class="o">..</span><span class="w"> </span><span class="n">type_name</span><span class="o">=</span><span class="s2">&quot;core::future::from_generator::GenFuture&lt;waytoodeep::fetch_thing::{{closure}}&gt;&quot;</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">59.973</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">:</span><span class="w"> </span><span class="n">Awaiting</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">future</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">59.974</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">reqwest</span><span class="p">::</span><span class="n">connect</span><span class="p">:</span><span class="w"> </span><span class="n">starting</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">connection</span><span class="p">:</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">fasterthanli</span><span class="o">.</span><span class="n">me</span><span class="o">/</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">59.974</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">hyper</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">connect</span><span class="p">::</span><span class="n">dns</span><span class="p">:</span><span class="w"> </span><span class="n">resolving</span><span class="w"> </span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;fasterthanli.me&quot;</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">59.989</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">hyper</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">connect</span><span class="p">::</span><span class="n">http</span><span class="p">:</span><span class="w"> </span><span class="n">connecting</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">172.67</span><span class="o">.</span><span class="mf">196.144</span><span class="p">:</span><span class="mi">443</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.000</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">hyper</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">connect</span><span class="p">::</span><span class="n">http</span><span class="p">:</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">172.67</span><span class="o">.</span><span class="mf">196.144</span><span class="p">:</span><span class="mi">443</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.000</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustls</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">hs</span><span class="p">:</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">cached</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">DNSNameRef</span><span class="p">(</span><span class="s2">&quot;fasterthanli.me&quot;</span><span class="p">)</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.000</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustls</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">hs</span><span class="p">:</span><span class="w"> </span><span class="n">Not</span><span class="w"> </span><span class="n">resuming</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">session</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.016</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustls</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">hs</span><span class="p">:</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">ciphersuite</span><span class="w"> </span><span class="n">TLS13_CHACHA20_POLY1305_SHA256</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.016</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustls</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">tls13</span><span class="p">:</span><span class="w"> </span><span class="n">Not</span><span class="w"> </span><span class="n">resuming</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.017</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustls</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">tls13</span><span class="p">:</span><span class="w"> </span><span class="n">TLS1</span><span class="o">.</span><span class="mi">3</span><span class="w"> </span><span class="n">encrypted</span><span class="w"> </span><span class="n">extensions</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">ServerNameAck</span><span class="p">,</span><span class="w"> </span><span class="n">Protocols</span><span class="p">([</span><span class="n">PayloadU8</span><span class="p">([</span><span class="mi">104</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">])])]</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.017</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustls</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">hs</span><span class="p">:</span><span class="w"> </span><span class="n">ALPN</span><span class="w"> </span><span class="n">protocol</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">Some</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;h2&quot;</span><span class="p">)</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.018</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">client</span><span class="p">:</span><span class="w"> </span><span class="n">binding</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="n">connection</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.018</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">client</span><span class="p">:</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="n">bound</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.018</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_write</span><span class="p">:</span><span class="w"> </span><span class="n">send</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">Settings</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">flags</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="mh">0x0</span><span class="p">),</span><span class="w"> </span><span class="n">enable_push</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">initial_window_size</span><span class="p">:</span><span class="w"> </span><span class="mi">2097152</span><span class="p">,</span><span class="w"> </span><span class="n">max_frame_size</span><span class="p">:</span><span class="w"> </span><span class="mi">16384</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.019</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_write</span><span class="p">:</span><span class="w"> </span><span class="n">send</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">WindowUpdate</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">stream_id</span><span class="p">:</span><span class="w"> </span><span class="n">StreamId</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">size_increment</span><span class="p">:</span><span class="w"> </span><span class="mi">5177345</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.019</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">hyper</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">pool</span><span class="p">:</span><span class="w"> </span><span class="n">pooling</span><span class="w"> </span><span class="n">idle</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;https&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fasterthanli</span><span class="o">.</span><span class="n">me</span><span class="p">)</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.020</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_write</span><span class="p">:</span><span class="w"> </span><span class="n">send</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">Headers</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">stream_id</span><span class="p">:</span><span class="w"> </span><span class="n">StreamId</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">flags</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="mh">0x5</span><span class="p">:</span><span class="w"> </span><span class="n">END_HEADERS</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">END_STREAM</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.029</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">rustls</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">tls13</span><span class="p">:</span><span class="w"> </span><span class="n">Ticket</span><span class="w"> </span><span class="n">saved</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.029</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">rustls</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">tls13</span><span class="p">:</span><span class="w"> </span><span class="n">Ticket</span><span class="w"> </span><span class="n">saved</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.029</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_read</span><span class="p">:</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">Settings</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">flags</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="mh">0x0</span><span class="p">),</span><span class="w"> </span><span class="n">max_concurrent_streams</span><span class="p">:</span><span class="w"> </span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="n">initial_window_size</span><span class="p">:</span><span class="w"> </span><span class="mi">65536</span><span class="p">,</span><span class="w"> </span><span class="n">max_frame_size</span><span class="p">:</span><span class="w"> </span><span class="mi">16777215</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.030</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_write</span><span class="p">:</span><span class="w"> </span><span class="n">send</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">Settings</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">flags</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="mh">0x1</span><span class="p">:</span><span class="w"> </span><span class="n">ACK</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.030</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_read</span><span class="p">:</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">WindowUpdate</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">stream_id</span><span class="p">:</span><span class="w"> </span><span class="n">StreamId</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">size_increment</span><span class="p">:</span><span class="w"> </span><span class="mi">2147418112</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.041</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_read</span><span class="p">:</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">Settings</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">flags</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="mh">0x1</span><span class="p">:</span><span class="w"> </span><span class="n">ACK</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.041</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">proto</span><span class="p">::</span><span class="n">settings</span><span class="p">:</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="n">settings</span><span class="w"> </span><span class="n">ACK</span><span class="p">;</span><span class="w"> </span><span class="n">applying</span><span class="w"> </span><span class="n">Settings</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">flags</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="mh">0x0</span><span class="p">),</span><span class="w"> </span><span class="n">enable_push</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">initial_window_size</span><span class="p">:</span><span class="w"> </span><span class="mi">2097152</span><span class="p">,</span><span class="w"> </span><span class="n">max_frame_size</span><span class="p">:</span><span class="w"> </span><span class="mi">16384</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.120</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_read</span><span class="p">:</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">Headers</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">stream_id</span><span class="p">:</span><span class="w"> </span><span class="n">StreamId</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">flags</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="mh">0x4</span><span class="p">:</span><span class="w"> </span><span class="n">END_HEADERS</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.120</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_read</span><span class="p">:</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">Data</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">stream_id</span><span class="p">:</span><span class="w"> </span><span class="n">StreamId</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.121</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">reqwest</span><span class="p">::</span><span class="n">async_impl</span><span class="p">::</span><span class="n">client</span><span class="p">:</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="s1">&#39;200 OK&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">fasterthanli</span><span class="o">.</span><span class="n">me</span><span class="o">/</span><span class="n">articles</span><span class="o">/</span><span class="n">whats</span><span class="o">-</span><span class="ow">in</span><span class="o">-</span><span class="n">the</span><span class="o">-</span><span class="n">box</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.121</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">:</span><span class="w"> </span><span class="n">Got</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">response</span><span class="o">!</span><span class="w"> </span><span class="n">url</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">fasterthanli</span><span class="o">.</span><span class="n">me</span><span class="o">/</span><span class="n">articles</span><span class="o">/</span><span class="n">whats</span><span class="o">-</span><span class="ow">in</span><span class="o">-</span><span class="n">the</span><span class="o">-</span><span class="n">box</span><span class="w"> </span><span class="n">content_type</span><span class="o">=</span><span class="n">Some</span><span class="p">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="p">)</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.121</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">:</span><span class="w"> </span><span class="n">Done</span><span class="w"> </span><span class="n">awaiting</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">future</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.121</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_read</span><span class="p">:</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">Data</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">stream_id</span><span class="p">:</span><span class="w"> </span><span class="n">StreamId</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.122</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_write</span><span class="p">:</span><span class="w"> </span><span class="n">send</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">Reset</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">stream_id</span><span class="p">:</span><span class="w"> </span><span class="n">StreamId</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">error_code</span><span class="p">:</span><span class="w"> </span><span class="n">CANCEL</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.122</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_write</span><span class="p">:</span><span class="w"> </span><span class="n">send</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">GoAway</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">error_code</span><span class="p">:</span><span class="w"> </span><span class="n">NO_ERROR</span><span class="p">,</span><span class="w"> </span><span class="n">last_stream_id</span><span class="p">:</span><span class="w"> </span><span class="n">StreamId</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.122</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">proto</span><span class="p">::</span><span class="n">connection</span><span class="p">:</span><span class="w"> </span><span class="n">Connection</span><span class="p">::</span><span class="n">poll</span><span class="p">;</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">error</span><span class="o">=</span><span class="n">NO_ERROR</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.122</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">rustls</span><span class="p">::</span><span class="n">session</span><span class="p">:</span><span class="w"> </span><span class="n">Sending</span><span class="w"> </span><span class="n">warning</span><span class="w"> </span><span class="n">alert</span><span class="w"> </span><span class="n">CloseNotify</span>
</code></pre></div>

<blockquote>
<p>ä¸Šé¢å‡ºç°äº† rustlsï¼Œå¹¶ä¸”ä½¿ç”¨äº† TLS 1.3ï¼Œä½œè€…åšè¿‡<a href="https://www.youtube.com/watch?v=YHIiVsFybLA">ä¸€æœŸè§†é¢‘</a>ä»‹ç»è¿‡ TLS 1.3ã€‚</p>
</blockquote>
<p>è¿™äº›åº”è¯¥è¶³å¤Ÿè¯´æœä½ ï¼Œé™¤éä½ åªç›¸ä¿¡å†…æ ¸æ‰€è¯´çš„ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬çœ‹çœ‹è°ƒç”¨å †æ ˆåªä¸ºäº†æ›´åŠ ç¡®å®šã€‚</p>
<p>æˆ‘ä»¬åœ¨ <code>await</code> future å¯¹è±¡ä¹‹å‰å¢åŠ ä¸€ç§’é’Ÿçš„ä¼‘çœ ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">sleep</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">time</span>::<span class="n">Duration</span><span class="p">;</span>

<span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Building that fetch future...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Sleeping for a bit...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_secs</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Awaiting that fetch future...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">fut</span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Done awaiting that fetch future&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>build<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>strace<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;connect&#39;</span><span class="w"> </span>./target/debug/waytoodeep
<span class="w">   </span>Compiling<span class="w"> </span>waytoodeep<span class="w"> </span>v0.1.0<span class="w"> </span><span class="o">(</span>/home/amos/ftl/waytoodeep<span class="o">)</span>
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.13s
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:09:36.595<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Building<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:09:36.596<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Sleeping<span class="w"> </span><span class="k">for</span><span class="w"> </span>a<span class="w"> </span>bit...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:09:37.599<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Awaiting<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future...
connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">443</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;104.21.92.169&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>EINPROGRESS<span class="w"> </span><span class="o">(</span>Operation<span class="w"> </span>now<span class="w"> </span><span class="k">in</span><span class="w"> </span>progress<span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:09:37.720<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:09:37.721<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Done<span class="w"> </span>awaiting<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future
+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
</code></pre></div>

<p>å†æ¬¡å¼ºè°ƒï¼Œé™„ä¸Šä¼šè®©æ˜¾è‘—æé«˜ä¸Šé¢ä¿¡æ¯çš„å¯è¯»æ€§ï¼Œå¦‚æœä¸è®©æˆ‘é€‰æ‹©å®ƒä»¬çš„è¯æˆ‘æ˜¯éå¸¸å–œæ¬¢é«˜äº®çš„ã€‚æˆ‘æœ¬åœ°çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š
<img alt="" src="https://fasterthanli.me/content/articles/understanding-rust-futures-by-going-way-too-deep/assets/strace-colors.a4163f4bda179c2b.webp">
ç”±äº <code>tracing-subscriber</code> é»˜è®¤æ ¼å¼ä¼šè¾“å‡ºæ—¶é—´æˆ³ï¼Œå¯ä»¥çœ‹åˆ°ç¨‹åºä¼‘çœ äº†1åˆ†é’Ÿï¼ˆå¤–åŠ 3æ¯«ç§’ï¼‰ï¼Œè€Œä¸”åªæœ‰æˆ‘ä»¬çœŸæ­£è°ƒç”¨ <code>await</code> æ—¶æˆ‘ä»¬çš„ç¨‹åºæ‰ä¼šå¼€å§‹è¿æ¥åˆ°æ‰˜ç®¡æ–‡ç« çš„ CDN èŠ‚ç‚¹ã€‚</p>
<p>å¥½äº†ï¼è®©æˆ‘ä»¬å†æ¬¡å°è¯•æ‹‰å–ä¸¤ç¯‡æ–‡ç« ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_2</span><span class="p">);</span>

<span class="w">    </span><span class="n">fut1</span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">fut2</span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>å†æ¬¡æ£€æŸ¥æ—¥å¿—ï¼š</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info,reqwest<span class="o">=</span>debug<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:31:47.396<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::connect:<span class="w"> </span>starting<span class="w"> </span>new<span class="w"> </span>connection:<span class="w"> </span>https://fasterthanli.me/
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:31:47.536<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::async_impl::client:<span class="w"> </span>response<span class="w"> </span><span class="s1">&#39;200 OK&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>https://fasterthanli.me/articles/whats-in-the-box
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:31:47.537<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:31:47.627<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::async_impl::client:<span class="w"> </span>response<span class="w"> </span><span class="s1">&#39;200 OK&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>https://fasterthanli.me/series/advent-of-code-2020/part-13
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:31:47.627<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
</code></pre></div>

<p>éå¸¸æœ‰è¶£ã€‚ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œ <code>reqwest</code> ä¸ºä¸¤ä¸ªè¯·æ±‚å¤ç”¨äº†ç›¸åŒçš„è¿æ¥ã€‚æˆ‘ä¼šè¿™ä¹ˆè¯´æ˜¯å› æˆ‘åªçœ‹åˆ°äº†ä¸€è¡Œ <code>reqwest::connect</code> æ—¥å¿—ã€‚</p>
<p>è®©æˆ‘ä»¬å¿«é€Ÿé€šè¿‡ <code>strace</code> æ£€æŸ¥ä¸€ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>build<span class="w"> </span>--quiet<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>strace<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;connect&#39;</span><span class="w"> </span>./target/debug/waytoodeep<span class="w"> </span>&gt;<span class="w"> </span>/dev/null
connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">443</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;172.67.196.144&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>EINPROGRESS<span class="w"> </span><span class="o">(</span>Operation<span class="w"> </span>now<span class="w"> </span><span class="k">in</span><span class="w"> </span>progress<span class="o">)</span>
+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
</code></pre></div>

<p>ç°åœ¨å¯ä»¥ç¡®è®¤äº†ï¼Œåªæœ‰ä¸€æ¬¡è¿æ¥ã€‚</p>
<p>ä½†æ˜¯ï¼Œç¬¬ä¸€ä¸ªè¯·æ±‚å®Œæˆåæ‰å¼€å§‹äº†ç¬¬äºŒä¸ªè¯·æ±‚ã€‚ç¬¬ä¸€ä¸ªè€—è´¹äº† <code>536-396 = 140</code> æ¯«ç§’ï¼Œä½†æ˜¯ç¬¬äºŒä¸ªè€—è´¹äº† <code>627-537 = 90</code> æ¯«ç§’ï¼</p>
<blockquote>
<p>Emmmï¼Œç°åœ¨æˆ‘ä»¬è¿è¡Œæ„å»ºçš„æ˜¯ debug ç‰ˆæœ¬ä¸æ˜¯å—ï¼Ÿ</p>
</blockquote>
<p>è¿™æ˜¯çœŸçš„ã€‚æˆ‘ç¡®ä¿¡æˆ‘ä»¬é¢ä¸´çš„æ˜¯ IO å¯†é›†å‹ï¼Œè€Œä¸æ˜¯ CPU å¯†é›†å‹ã€‚</p>
<p>debug ç‰ˆæœ¬çš„æ„å»ºç»å¯¹æœ‰ä¸€äº›é¢å¤–çš„å¼€é”€ï¼Œä½†æ˜¯æˆ‘æ€€ç–‘è¿™é‡Œå®ƒä¸ä¼šå¤ªå½±å“å»¶è¿Ÿã€‚æ— è®ºå¦‚ä½•ï¼Œè®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹ï¼š
ï¼ˆæ³¨æ„ --releaseï¼‰</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info,reqwest<span class="o">=</span>debug<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:34:59.211<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::connect:<span class="w"> </span>starting<span class="w"> </span>new<span class="w"> </span>connection:<span class="w"> </span>https://fasterthanli.me/
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:34:59.343<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::async_impl::client:<span class="w"> </span>response<span class="w"> </span><span class="s1">&#39;200 OK&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>https://fasterthanli.me/articles/whats-in-the-box
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:34:59.343<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:34:59.427<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::async_impl::client:<span class="w"> </span>response<span class="w"> </span><span class="s1">&#39;200 OK&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>https://fasterthanli.me/series/advent-of-code-2020/part-13
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:34:59.427<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
</code></pre></div>

<p>æˆ‘ä»¬è®¡ç®—ä¸€ä¸‹å»¶è¿Ÿ <code>343-211 = 132ms</code> ï¼Œ <code>427-343 = 84ms</code> ã€‚</p>
<p>å‡ æ¯«ç§’çš„å·®å¼‚å¯èƒ½çš„è§£é‡Šæ˜¯é‚»å±…æ‰“å¼€äº†ä¸€ä¸ª YouTube è§†é¢‘å¯¼è‡´æ— çº¿ç”µæ³¢çˆ†å‘ï¼Œä»è€Œå¯¼è‡´å†²çªï¼ˆ802.11 æ²¡æœ‰ç©ºä¸­æµé‡æ§åˆ¶ï¼Œå…¨æ°‘è‡ªç”±ï¼ˆfree-for-allï¼‰ï¼‰å’Œé‡ä¼ ã€‚</p>
<p>æˆ–è€…å¦å¤–ä¸€ç™¾ä¸‡ä¸ªåŸå› ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸ç»§ç»­åˆ†æçš„åŸå› ã€‚</p>
<p>è®©æˆ‘ä»¬å›åˆ°æ–‡ç« çš„ä¸»é¢˜ã€‚</p>
<h3 id="ç­‰å¾…ç¬¬ä¸€ä¸ªå®Œæˆ">ç­‰å¾…ç¬¬ä¸€ä¸ªå®Œæˆ</h3>
<p>æ˜¯çš„ï¼ç­‰å¾…ç¬¬ä¸€ä¸ªå®Œæˆã€‚æ‰€ä»¥æˆ‘ä»¬å¦‚ä½•è®©ç¨‹åºåŒæ—¶è¯·æ±‚ä¸¤ä¸ªï¼Ÿ</p>
<p>å…¶å®æœ‰ä¸€å¤§å †æ–¹å¼ï¼</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªæ‰§è¡Œå™¨ä¸Šæ‰§è¡Œï¼ˆ <code>spawn</code> ï¼‰è¿™äº› future å¯¹è±¡ï¼Œç„¶åä¼‘çœ ä¸€ç§’é’Ÿã€‚1 ç§’é’Ÿè¶³å¤Ÿäº†å§ï¼Ÿ</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">    </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_2</span><span class="p">);</span>
<span class="w">    </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut2</span><span class="p">);</span>

<span class="w">    </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_secs</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">RUST_LOG</span><span class="o">=</span><span class="n">info</span><span class="p">,</span><span class="n">reqwest</span><span class="o">=</span><span class="n">debug</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">quiet</span><span class="w"> </span><span class="o">--</span><span class="k">release</span>
<span class="k">error</span><span class="err">[</span><span class="n">E0597</span><span class="err">]</span><span class="o">:</span><span class="w"> </span><span class="n n-Quoted">`client`</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">live</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">enough</span>
<span class="w">  </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span><span class="mi">28</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">let</span><span class="w"> </span><span class="n">fut1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="k">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">   </span><span class="o">|</span><span class="w">                </span><span class="o">------------^^^^^^^--------</span>
<span class="w">   </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">           </span><span class="o">|</span>
<span class="w">   </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">           </span><span class="n">borrowed</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">live</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">enough</span>
<span class="w">   </span><span class="o">|</span><span class="w">                </span><span class="n">argument</span><span class="w"> </span><span class="n">requires</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n n-Quoted">`client`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">borrowed</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n n-Quoted">`&#39;static`</span>
<span class="p">...</span>
<span class="mi">25</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="err">}</span>
<span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n n-Quoted">`client`</span><span class="w"> </span><span class="n">dropped</span><span class="w"> </span><span class="n">here</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">still</span><span class="w"> </span><span class="n">borrowed</span>

<span class="k">error</span><span class="o">:</span><span class="w"> </span><span class="n">aborting</span><span class="w"> </span><span class="n">due</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">previous</span><span class="w"> </span><span class="k">error</span>

<span class="k">For</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">information</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">error</span><span class="p">,</span><span class="w"> </span><span class="n">try</span><span class="w"> </span><span class="n n-Quoted">`rustc --explain E0597`</span><span class="p">.</span>
<span class="k">error</span><span class="o">:</span><span class="w"> </span><span class="n">could</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n n-Quoted">`waytoodeep`</span>

<span class="k">To</span><span class="w"> </span><span class="n">learn</span><span class="w"> </span><span class="n">more</span><span class="p">,</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">again</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="o">--</span><span class="n">verbose</span><span class="p">.</span>
</code></pre></div>

<p>é¢ï¼Œé™¤éæˆ‘ä»¬ä¸å¯ä»¥ã€‚ä¸å¯ä»¥æ˜¯å› ä¸ºã€‚ã€‚ã€‚</p>
<blockquote>
<p>æˆ‘ä»¬å°†ã€Œfuture å¯¹è±¡äº¤ç»™æ‰§è¡Œå™¨æ‰§è¡Œã€å¹¶å°† future å¯¹è±¡è½¬äº¤ç»™æ‰§è¡Œå™¨ï¼Œå¯¹å§ï¼Ÿæˆ‘ä»¬è½¬ç§»äº†å®ƒå’Œå®ƒçš„å†…å®¹çš„æ‰€æœ‰æƒã€‚</p>
<p>ç„¶åå³ä½¿æˆ‘ä»¬ä¸å¯¹å…¶è¿›è¡Œ <code>await</code> ï¼Œfuture å¯¹è±¡å› ä¸ºæ˜¯ã€Œæ‰§è¡Œå™¨éœ€è¦åšã€çš„ä¸€éƒ¨åˆ†ä¾ç„¶ä¼šè¢«æ‰§è¡Œï¼Œæ‰€ä»¥å³ä½¿æˆ‘ä»¬ä» <code>main</code> è¿”å› future å¯¹è±¡ä¹Ÿä¼šè¢«è½®è¯¢ï¼ˆpolledï¼‰ã€‚</p>
<p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬ä» <code>main</code> è¿”å›ï¼Œåˆ™æ•´ä¸ªç¨‹åºéƒ½ä¼šé€€å‡ºã€‚</p>
<p>è¿™é‡Œä¹Ÿå¯ä»¥æ˜¯ä»»ä½•å‡½æ•°ï¼ˆè¿™é‡Œæ˜¯ <code>main</code> ï¼‰ã€‚é‡è¦çš„æ˜¯å¦‚æœå‡½æ•°è¿”å›äº†ä½†æ˜¯ future å¯¹è±¡å€Ÿç”¨äº†éƒ¨åˆ†æ•°æ®å°†æ— æ³•é€šè¿‡å€Ÿç”¨æ£€æŸ¥å™¨ã€‚</p>
</blockquote>
<p>è¿™è®©æˆ‘å¾ˆé«˜å…´ï¼Œå› ä¸ºè¿™æ„å‘³ç€æˆ‘ä»¬ä¸ä¼šæ„å¤–è®¿é—®åˆ°ä¸€äº›è¢«é‡Šæ”¾çš„èµ„æºï¼š<a href="https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=use+after+free">UAF</a>ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬çš„ä¾‹å­æ²¡æœ‰å®Œæˆã€‚</p>
<p>æ‰€ä»¥ã€‚ã€‚ã€‚æˆ‘ä»¬éœ€è¦è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å¦‚æœ <code>fetch_thing</code> è¿”å›çš„ future å¯¹è±¡æ˜¯ <code>'static</code> çš„å‘¢ï¼Ÿæˆ–è€…å®ƒä¸å€Ÿç”¨ä»»ä½•ä¸œè¥¿ï¼Ÿ</p>
<p>ç¨‹åºç°åœ¨çœ‹èµ·æ¥å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">future</span>::<span class="n">Future</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">fetch_thing</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">client</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="nc">Client</span><span class="p">,</span>
<span class="w">    </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="kt">str</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="na">a</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">send</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">.</span><span class="n">error_for_status</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">content_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="n">res</span><span class="p">.</span><span class="n">headers</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;content-type&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Got a response!&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>å¥½å§ï¼Œä¹‹å‰æˆ‘ä»¬ç”¨äº† <code>async fn</code> ï¼Œä½†æ˜¯ä¸ºäº†æ›´åŠ æ·±å…¥çš„ç†è§£ï¼Œæˆ‘ä»¬ä¸å¾—ä¸æ”¾å¼ƒæ¼‚äº®çš„è¯­æ³•ã€‚</p>
<p>ä½†æ˜¯å¹¸è¿çš„æ˜¯ï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">fetch_thing</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">client</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="nc">Client</span><span class="p">,</span>
<span class="w">    </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="kt">str</span><span class="p">,</span>
<span class="c1">//                                                 ğŸ‘‡</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>

<p>ä½†æ˜¯æˆ‘ä»¬å€Ÿç”¨äº† <code>client</code> å’Œ <code>url</code> æˆ‘ä»¬å¿…é¡»é¿å…è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>å› ä¸º <code>url</code> æœ¬èº«å°±æ˜¯å¸¸é‡ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“è§£å†³ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">URL_1</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&quot;https://fasterthanli.me/articles/whats-in-the-box&quot;</span><span class="p">;</span>
<span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">URL_2</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&quot;https://fasterthanli.me/series/advent-of-code-2020/part-13&quot;</span><span class="p">;</span>
</code></pre></div>

<p>å®ƒä»¬æœ¬èº«å°±æ˜¯ <code>'static</code> ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è°ƒæ•´éœ€è¦ <code>'static</code> å°±è¡Œ:</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">fetch_thing</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">client</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="nc">Client</span><span class="p">,</span>
<span class="w">    </span><span class="c1">//       ğŸ‘‡</span>
<span class="w">    </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span> <span class="kt">str</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>

<p>éå¸¸å¥½ï¼è§£å†³äº†ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œè¿˜å‰©ä¸‹ä¸€ä¸ªã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥è¦æ±‚ <code>client</code> çš„ç”Ÿå‘½å‘¨æœŸä¸º <code>'static</code> ã€‚ç”±äºå®ƒæ˜¯ä¸€ä¸ª  <code>Client</code> çš„å¼•ç”¨ï¼Œæ„å‘³ç€ <code>Cleint</code> æœ¬èº«ä¹Ÿéœ€è¦æ˜¯ <code>'static</code> ç”Ÿå‘½å‘¨æœŸã€‚</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">fetch_thing</span><span class="p">(</span>
<span class="w">    </span><span class="c1">//         ğŸ‘‡</span>
<span class="w">    </span><span class="n">client</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span> <span class="nc">Client</span><span class="p">,</span>
<span class="w">    </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span> <span class="kt">str</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>

<p>ç”±äºå®ƒè¢« <code>main</code> æ‰€æœ‰ï¼Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥ï¼Œå¯ä»¥ã€‚ã€‚ã€‚å¯ä»¥æ³„æ¼å®ƒï¼š</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">leaked_client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">leak</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">leaked_client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">leaked_client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_2</span><span class="p">);</span>

<span class="w">    </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut1</span><span class="p">);</span>
<span class="w">    </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut2</span><span class="p">);</span>

<span class="w">    </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_secs</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>å®Œç¾ï¼æ²¡æœ‰ç”Ÿå‘½å‘¨æœŸçš„é—®é¢˜äº†ã€‚</p>
<p>ä»…ä»…å°†æ‰€æœ‰ä¸œè¥¿æ³„æ¼å°±è¡Œã€‚çœ‹åˆ°æ²¡ï¼Ÿä½ ä¸éœ€è¦ Cï¼</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info,reqwest<span class="o">=</span>debug<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:54:53.614<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::connect:<span class="w"> </span>starting<span class="w"> </span>new<span class="w"> </span>connection:<span class="w"> </span>https://fasterthanli.me/
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:54:53.614<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::connect:<span class="w"> </span>starting<span class="w"> </span>new<span class="w"> </span>connection:<span class="w"> </span>https://fasterthanli.me/
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:54:53.708<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::async_impl::client:<span class="w"> </span>response<span class="w"> </span><span class="s1">&#39;200 OK&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>https://fasterthanli.me/articles/whats-in-the-box
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:54:53.708<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:54:53.733<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::async_impl::client:<span class="w"> </span>response<span class="w"> </span><span class="s1">&#39;200 OK&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>https://fasterthanli.me/series/advent-of-code-2020/part-13
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:54:53.733<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
</code></pre></div>

<p>éï½ï½å¸¸æœ‰è¶£ï¼</p>
<p>æˆ‘ä»¬çš„ä¸¤ä¸ªè¯·æ±‚è‚¯å®šæ˜¯å¹¶å‘çš„å‘å‡ºå»äº†ï¼Œæˆ‘ä»¬ä¹‹æ‰€ä»¥çŸ¥é“æ˜¯å› ä¸ºä»æˆ‘çš„ç¬”è®°æœ¬ä¸Šè¯·æ±‚æˆ‘çš„ç½‘ç«™å¤§æ¦‚è€—æ—¶ 80ms åˆ° 140ms ä¹‹é—´ï¼Œä½†æ˜¯åœ¨æ—¥å¿—ä¸­æˆ‘ä»¬çœ‹åˆ°ä¸¤ä¸ªå“åº”ä¹‹é—´åªæœ‰ ~25ms çš„é—´éš”ã€‚</p>
<p>æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ° <code>reqwest</code> æœ‰è¿æ¥æ± æœºåˆ¶ï¼šåŒæ—¶åˆ›å»ºäº†ä¸¤ä¸ªè¿æ¥ã€‚å¯èƒ½æ˜¯å› ä¸ºæˆ‘ä»¬å¼€å§‹ç¬¬äºŒä¸ªè¿æ¥çš„æ—¶å€™ç¬¬ä¸€ä¸ªè¯·æ±‚çš„è¿æ¥è¿˜æ²¡æœ‰å»ºç«‹å®Œæˆã€‚</p>
<p>ä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬é€šè¿‡ <code>strace</code> å¯ä»¥çœ‹åˆ°ï¼š</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>build<span class="w"> </span>--quiet<span class="w"> </span>--release<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>strace<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;connect&#39;</span><span class="w"> </span>./target/release/waytoodeep
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:58:16.425<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:58:16.443<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
</code></pre></div>

<p>ã€‚ã€‚ã€‚ä¸¤ä¸ª <code>connect</code> è°ƒç”¨ï¼å¦‚æˆ‘æ‰€æ–™ï¼</p>
<blockquote>
<p>è°¬è®ºï¼šä¸€ä¸ª <code>connect</code> è°ƒç”¨éƒ½æ²¡çœ‹åˆ°ï¼Ÿå› ä¸º Rust æ„å»º HTTP/2 è¯·æ±‚çš„æ—¶å€™ç”šè‡³éƒ½éœ€è¦å»ºç«‹ TCP è¿æ¥ã€‚çœŸæ˜¯é©å‘½æ€§çš„ï¼</p>
</blockquote>
<p>è¿™å½“ç„¶ä¸æ˜¯çœŸçš„ã€‚å¯èƒ½åœ¨å…¶ä»–çº¿ç¨‹æ‰§è¡Œäº†ï¼Ÿä¹Ÿè®¸ <code>strace</code> é»˜è®¤ä»…è·Ÿè¸ªäº†ä¸»çº¿ç¨‹ï¼Ÿ</p>
<p>å•Šï¼Œå¯¹äº†ï¼Œ <code>-f</code> å¯ä»¥è·Ÿè¸ªæ‰€æœ‰ã€Œå­è¿›ç¨‹ã€ï¼Œå°±åƒå¤§å®¶çŸ¥é“çš„é‚£æ · Linux çº¿ç¨‹ä»…ä»…æ˜¯æŠ«äº†ä»¶é£è¡£çš„è¿›ç¨‹ï¼ˆæˆ–è€…å…¶ä»–æ–¹å¼ï¼‰ã€‚æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>build<span class="w"> </span>--quiet<span class="w"> </span>--release<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>strace<span class="w"> </span>-f<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;connect&#39;</span><span class="w"> </span>./target/release/waytoodeep
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154612</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154613</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154614</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154615</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154616</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154617</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154618</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154619</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154620</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154621</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154622</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154623</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154624</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154625</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154626</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154627</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154628</span><span class="w"> </span>attached
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_UNIX,<span class="w"> </span><span class="nv">sun_path</span><span class="o">=</span><span class="s2">&quot;/var/run/nscd/socket&quot;</span><span class="o">}</span>,<span class="w"> </span><span class="m">110</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>ENOENT<span class="w"> </span><span class="o">(</span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory<span class="o">)</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154628</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_UNIX,<span class="w"> </span><span class="nv">sun_path</span><span class="o">=</span><span class="s2">&quot;/var/run/nscd/socket&quot;</span><span class="o">}</span>,<span class="w"> </span><span class="m">110</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>ENOENT<span class="w"> </span><span class="o">(</span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory<span class="o">)</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_UNIX,<span class="w"> </span><span class="nv">sun_path</span><span class="o">=</span><span class="s2">&quot;/var/run/nscd/socket&quot;</span><span class="o">}</span>,<span class="w"> </span><span class="m">110</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>ENOENT<span class="w"> </span><span class="o">(</span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory<span class="o">)</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154628</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">53</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;127.0.0.53&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">53</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;127.0.0.53&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET6,<span class="w"> </span><span class="nv">sin6_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin6_flowinfo</span><span class="o">=</span>htonl<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span>inet_pton<span class="o">(</span>AF_INET6,<span class="w"> </span><span class="s2">&quot;2606:4700:3034::6815:5ca9&quot;</span>,<span class="w"> </span><span class="p">&amp;</span>sin6_addr<span class="o">)</span>,<span class="w"> </span><span class="nv">sin6_scope_id</span><span class="o">=</span><span class="m">0</span><span class="o">}</span>,<span class="w"> </span><span class="m">28</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>ENETUNREACH<span class="w"> </span><span class="o">(</span>Network<span class="w"> </span>is<span class="w"> </span>unreachable<span class="o">)</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_UNSPEC,<span class="w"> </span><span class="nv">sa_data</span><span class="o">=</span><span class="s2">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span><span class="o">}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET6,<span class="w"> </span><span class="nv">sin6_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin6_flowinfo</span><span class="o">=</span>htonl<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span>inet_pton<span class="o">(</span>AF_INET6,<span class="w"> </span><span class="s2">&quot;2606:4700:3031::ac43:c490&quot;</span>,<span class="w"> </span><span class="p">&amp;</span>sin6_addr<span class="o">)</span>,<span class="w"> </span><span class="nv">sin6_scope_id</span><span class="o">=</span><span class="m">0</span><span class="o">}</span>,<span class="w"> </span><span class="m">28</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>ENETUNREACH<span class="w"> </span><span class="o">(</span>Network<span class="w"> </span>is<span class="w"> </span>unreachable<span class="o">)</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_UNSPEC,<span class="w"> </span><span class="nv">sa_data</span><span class="o">=</span><span class="s2">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span><span class="o">}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;104.21.92.169&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_UNSPEC,<span class="w"> </span><span class="nv">sa_data</span><span class="o">=</span><span class="s2">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span><span class="o">}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;172.67.196.144&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154628</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET6,<span class="w"> </span><span class="nv">sin6_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin6_flowinfo</span><span class="o">=</span>htonl<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span>inet_pton<span class="o">(</span>AF_INET6,<span class="w"> </span><span class="s2">&quot;2606:4700:3034::6815:5ca9&quot;</span>,<span class="w"> </span><span class="p">&amp;</span>sin6_addr<span class="o">)</span>,<span class="w"> </span><span class="nv">sin6_scope_id</span><span class="o">=</span><span class="m">0</span><span class="o">}</span>,<span class="w"> </span><span class="m">28</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>ENETUNREACH<span class="w"> </span><span class="o">(</span>Network<span class="w"> </span>is<span class="w"> </span>unreachable<span class="o">)</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154628</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_UNSPEC,<span class="w"> </span><span class="nv">sa_data</span><span class="o">=</span><span class="s2">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span><span class="o">}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154628</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET6,<span class="w"> </span><span class="nv">sin6_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin6_flowinfo</span><span class="o">=</span>htonl<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span>inet_pton<span class="o">(</span>AF_INET6,<span class="w"> </span><span class="s2">&quot;2606:4700:3031::ac43:c490&quot;</span>,<span class="w"> </span><span class="p">&amp;</span>sin6_addr<span class="o">)</span>,<span class="w"> </span><span class="nv">sin6_scope_id</span><span class="o">=</span><span class="m">0</span><span class="o">}</span>,<span class="w"> </span><span class="m">28</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>ENETUNREACH<span class="w"> </span><span class="o">(</span>Network<span class="w"> </span>is<span class="w"> </span>unreachable<span class="o">)</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154628</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_UNSPEC,<span class="w"> </span><span class="nv">sa_data</span><span class="o">=</span><span class="s2">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span><span class="o">}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154628</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;104.21.92.169&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154628</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_UNSPEC,<span class="w"> </span><span class="nv">sa_data</span><span class="o">=</span><span class="s2">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span><span class="o">}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154628</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;172.67.196.144&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154625</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">443</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;104.21.92.169&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>EINPROGRESS<span class="w"> </span><span class="o">(</span>Operation<span class="w"> </span>now<span class="w"> </span><span class="k">in</span><span class="w"> </span>progress<span class="o">)</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154626</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">443</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;104.21.92.169&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>EINPROGRESS<span class="w"> </span><span class="o">(</span>Operation<span class="w"> </span>now<span class="w"> </span><span class="k">in</span><span class="w"> </span>progress<span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:00:53.862<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:00:53.880<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154628</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154618</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154614</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154612</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154619</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154617</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154613</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154615</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154623</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154616</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154624</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154621</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154622</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154626</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154620</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154625</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++shell
</code></pre></div>

<p>å“‡å“¦ï¼Œä¸€å¤§å † <code>connect</code> ã€‚</p>
<p>æ‰€ä»¥ç¨‹åºé¦–å…ˆå°è¯•è¿æ¥ <a href="https://jameshfisher.com/2018/02/05/dont-use-nscd/">nscd</a> å› ä¸ºæ˜¾ç„¶æˆ‘ä»¬ä¾ç„¶ç”Ÿæ´»åœ¨ 90 å¹´ä»£ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">pid</span><span class="w"> </span><span class="mi">154627</span><span class="p">]</span><span class="w"> </span><span class="n">connect</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">sa_family</span><span class="o">=</span><span class="n">AF_UNIX</span><span class="p">,</span><span class="w"> </span><span class="n">sun_path</span><span class="o">=</span><span class="s2">&quot;/var/run/nscd/socket&quot;</span><span class="p">},</span><span class="w"> </span><span class="mi">110</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="n">ENOENT</span><span class="w"> </span><span class="p">(</span><span class="n">No</span><span class="w"> </span><span class="n">such</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">directory</span><span class="p">)</span>
</code></pre></div>

<p>ã€‚ã€‚ã€‚å¹¸å¥½æˆ‘çš„ç³»ç»Ÿæ²¡æœ‰å®ƒï¼Œæ‰€ä»¥å®ƒç»§ç»­é€šè¿‡ <code>/etc/resolv.conf</code> æŸ¥è¯¢ DNSï¼š</p>
<div class="highlight"><pre><span></span><code>[<span class="nv">pid</span><span class="w"> </span><span class="mi">154628</span>]<span class="w"> </span><span class="k">connect</span><span class="ss">(</span><span class="mi">9</span>,<span class="w"> </span>{<span class="nv">sa_family</span><span class="o">=</span><span class="nv">AF_INET</span>,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span><span class="nv">htons</span><span class="ss">(</span><span class="mi">53</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span><span class="nv">inet_addr</span><span class="ss">(</span><span class="s2">&quot;127.0.0.53&quot;</span><span class="ss">)</span>},<span class="w"> </span><span class="mi">16</span><span class="ss">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div>

<p>ç„¶åæœ€ç»ˆè·å¾—ä¸€äº› <a href="https://www.cloudflare.com/ips/">Cloudflare çš„ IP åœ°å€</a>ï¼Œå¦‚ <code>172.67.196.144</code> å’Œ <code>104.21.92.169</code> ã€‚è¿˜æœ‰ä¸€äº› IPv6 ç›¸å…³çš„ï¼Œç”±äºæˆ‘ç¦ç”¨äº† IPv6 æ‰€ä»¥å¹¶æ²¡æœ‰å·¥ä½œï¼š</p>
<div class="highlight"><pre><span></span><code>[<span class="nv">pid</span><span class="w"> </span><span class="mi">154627</span>]<span class="w"> </span><span class="k">connect</span><span class="ss">(</span><span class="mi">9</span>,<span class="w"> </span>{<span class="nv">sa_family</span><span class="o">=</span><span class="nv">AF_INET6</span>,<span class="w"> </span><span class="nv">sin6_port</span><span class="o">=</span><span class="nv">htons</span><span class="ss">(</span><span class="mi">0</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">sin6_flowinfo</span><span class="o">=</span><span class="nv">htonl</span><span class="ss">(</span><span class="mi">0</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">inet_pton</span><span class="ss">(</span><span class="nv">AF_INET6</span>,<span class="w"> </span><span class="s2">&quot;2606:4700:3034::6815:5ca9&quot;</span>,<span class="w"> </span><span class="o">&amp;</span><span class="nv">sin6_addr</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">sin6_scope_id</span><span class="o">=</span><span class="mi">0</span>},<span class="w"> </span><span class="mi">28</span><span class="ss">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="nv">ENETUNREACH</span><span class="w"> </span><span class="ss">(</span><span class="nv">Network</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">unreachable</span><span class="ss">)</span>
</code></pre></div>

<p>ç„¶åç»ˆäºç¨‹åºå†³å®šä½¿ç”¨ IPv4 çš„åœ°å€ <code>104.21.92.169</code> å»æ„å»ºè¯·æ±‚ï¼ŒåŒæ—¶æˆ‘ä»¬èƒ½çœ‹åˆ°è¿™äº›éƒ½æ˜¯éé˜»å¡çš„ï¼ˆnon-blockingï¼‰è¿æ¥ï¼Œå› ä¸º <code>connect</code> è¿”å› <code>-1</code> è€Œä¸æ˜¯ <code>0</code> è¡¨ç¤ºã€Œæ­£åœ¨è¿æ¥ã€æ­£åœ¨è¿æ¥ã€ç¨åå›æ¥æ£€æŸ¥ã€ã€‚</p>
<div class="highlight"><pre><span></span><code>[<span class="nv">pid</span><span class="w"> </span><span class="mi">154625</span>]<span class="w"> </span><span class="k">connect</span><span class="ss">(</span><span class="mi">9</span>,<span class="w"> </span>{<span class="nv">sa_family</span><span class="o">=</span><span class="nv">AF_INET</span>,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span><span class="nv">htons</span><span class="ss">(</span><span class="mi">443</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span><span class="nv">inet_addr</span><span class="ss">(</span><span class="s2">&quot;104.21.92.169&quot;</span><span class="ss">)</span>},<span class="w"> </span><span class="mi">16</span><span class="ss">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="nv">EINPROGRESS</span><span class="w"> </span><span class="ss">(</span><span class="nv">Operation</span><span class="w"> </span><span class="nv">now</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">progress</span><span class="ss">)</span>
[<span class="nv">pid</span><span class="w"> </span><span class="mi">154626</span>]<span class="w"> </span><span class="k">connect</span><span class="ss">(</span><span class="mi">10</span>,<span class="w"> </span>{<span class="nv">sa_family</span><span class="o">=</span><span class="nv">AF_INET</span>,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span><span class="nv">htons</span><span class="ss">(</span><span class="mi">443</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span><span class="nv">inet_addr</span><span class="ss">(</span><span class="s2">&quot;104.21.92.169&quot;</span><span class="ss">)</span>},<span class="w"> </span><span class="mi">16</span><span class="ss">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="nv">EINPROGRESS</span><span class="w"> </span><span class="ss">(</span><span class="nv">Operation</span><span class="w"> </span><span class="nv">now</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">progress</span><span class="ss">)</span>
</code></pre></div>

<p>å¥½äº†ï¼æ‰€ä»¥å¿½ç•¥ <a href="https://isitdns.com/">DNS</a> çš„è¯æˆ‘ä»¬çœ‹åˆ°äº†ä¸¤ä¸ªè¿æ¥ã€‚</p>
<p>åŒæ—¶æˆ‘ä»¬çœ‹åˆ°äº†ä¸€äº›çº¿ç¨‹ã€‚</p>
<p>è¿™å°±æ˜¯ Rust å¼‚æ­¥çš„å·¥ä½œæ–¹å¼ï¼Ÿæˆ‘ä»¬åªæ˜¯ç”¨äº†ä¸€äº›çº¿ç¨‹ï¼Ÿè¿™ä¹Ÿå°±æ˜¯å®ƒèƒ½åœ¨ã€Œåå°è¿è¡Œã€çš„åŸå› ï¼Ÿ</p>
<p>åœ¨æˆ‘ä»¬å›ç­”è¿™äº›é—®é¢˜å‰ï¼Œè®©æˆ‘ä»¬å…ˆè°ƒæ•´æˆ‘ä»¬çš„ä»£ç çœŸæ­£çš„å»ç­‰å¾… future å®Œæˆï¼Œè€Œä¸æ˜¯éšæ„çš„ä¼‘çœ  1 ç§’é’Ÿã€‚</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">leaked_client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">leak</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">leaked_client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">leaked_client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_2</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">handle1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">handle2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut2</span><span class="p">);</span>

<span class="w">    </span><span class="n">handle1</span><span class="p">.</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">handle2</span><span class="p">.</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>ç­‰ç­‰ï¼Œæˆ‘ä»¬è¿™ä¸åˆå›åˆ°åŸç‚¹å—ï¼Ÿç­‰å¾…ç¬¬ä¸€ä¸ªè¯·æ±‚å®Œæˆï¼Œç„¶åæ‰å¼€å§‹ç¬¬äºŒä¸ªè¯·æ±‚ã€‚</p>
<p>å½“ç„¶ä¸æ˜¯ï¼æˆ‘ä»¬è¿è¡Œå‡ æ¬¡å°±å¯ä»¥çœ‹åˆ°ï¼š</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:11:07.934<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:11:07.958<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:11:08.676<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:11:08.680<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:11:09.325<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:11:09.338<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:11:10.134<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:11:10.144<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
</code></pre></div>

<p>ã€‚ã€‚ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹â€œwhats-in-the-boxâ€èƒœå‡ºäº†ï¼ˆå®ƒç¡®å®å…ˆå¼€å§‹ï¼‰ï¼Œä½†æ˜¯â€œadvent-of-code-2020â€ä¹Ÿé¦–å…ˆå®Œæˆäº†å‡ æ¬¡ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¬å¸Œæœ›çœ‹åˆ°çš„ã€‚</p>
<blockquote>
<p>è°¬è®ºï¼šä¹Ÿå°±æ˜¯è¯´å› ä¸ºæœ‰çº¿ç¨‹è¯·æ±‚è¢«å¹¶è¡Œï¼ˆparallelï¼‰çš„æ‰§è¡Œäº†ã€‚</p>
</blockquote>
<p>ä¸æ˜¯çš„ã€‚ä½†æ˜¯ä¸è¦ç›¸ä¿¡æˆ‘ï¼Œè®©æˆ‘ä»¬ç»§ç»­æ·±å…¥ã€‚</p>
<h3 id="ä¸æ˜¯å› ä¸ºçº¿ç¨‹">ä¸æ˜¯å› ä¸ºçº¿ç¨‹</h3>
<p>è®©æˆ‘ä»¬é€šè¿‡ GDB è¿è¡Œæˆ‘ä»¬çš„å°ç¨‹åºï¼Œå¤§éƒ¨åˆ†åŸå› æ˜¯æˆ‘è¿˜æ²¡æœ‰å¯¹ LLDB å½¢æˆè‚Œè‚‰è®°å¿†ï¼Œæˆ‘ç›¸ä¿¡è¿™æ˜¯æ°´åˆ°æ¸ æˆçš„äº‹ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="err">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">--</span><span class="n">quiet</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">gdb</span><span class="w"> </span><span class="o">--</span><span class="n">quiet</span><span class="w"> </span><span class="o">--</span><span class="n">args</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">waytoodeep</span>
<span class="n">Reading</span><span class="w"> </span><span class="n">symbols</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">waytoodeep</span><span class="p">...</span>
<span class="nl">warning</span><span class="p">:</span><span class="w"> </span><span class="n">Missing</span><span class="w"> </span><span class="n">auto</span><span class="o">-</span><span class="k">load</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">section</span><span class="w"> </span><span class="p">.</span><span class="n">debug_gdb_scripts</span>
<span class="k">of</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="n">ftl</span><span class="o">/</span><span class="n">waytoodeep</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">waytoodeep</span><span class="p">.</span>
<span class="k">Use</span><span class="w"> </span><span class="err">`</span><span class="n">info</span><span class="w"> </span><span class="n">auto</span><span class="o">-</span><span class="k">load</span><span class="w"> </span><span class="n">python</span><span class="o">-</span><span class="n">scripts</span><span class="w"> </span><span class="o">[</span><span class="n">REGEXP</span><span class="o">]</span><span class="err">&#39;</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">them</span><span class="p">.</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span>
</code></pre></div>

<p>ä¸€åˆ‡å°±ç»ªï¼</p>
<p>åœ¨æˆ‘ä»¬å¼€å§‹ä¹‹å‰å…ˆè®¾ç½®ä¸€ä¸‹æ–­ç‚¹ã€‚æˆ‘è¯´äº†æ–­ç‚¹ï¼Ÿåº”è¯¥æ˜¯æ•æ‰ç‚¹ï¼ˆcatchpointï¼‰ã€‚æˆ‘ä¸çŸ¥é“å‚ä¸æ„é€  HTTP/2 è¯·æ±‚çš„æ‰€æœ‰å‡½æ•°åï¼Œä½†æ˜¯æˆ‘çŸ¥é“ <code>connect</code> å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆsyscallï¼‰ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦æ‰“æ–­ç‚¹çš„åœ°æ–¹ï¼Œæˆ–è€…æ•æ‰ï¼ˆcatchï¼‰ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="ss">(</span><span class="nv">gdb</span><span class="ss">)</span><span class="w"> </span><span class="nv">catch</span><span class="w"> </span><span class="nv">syscall</span><span class="w"> </span><span class="k">connect</span>
<span class="nv">Catchpoint</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ss">(</span><span class="nv">syscall</span><span class="w"> </span><span class="s1">&#39;connect&#39;</span><span class="w"> </span>[<span class="mi">42</span>]<span class="ss">)</span>
</code></pre></div>

<p>ç°åœ¨æˆ‘ä»¬å¼€å§‹ï¼</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>Starting<span class="w"> </span>program:<span class="w"> </span>/home/amos/ftl/waytoodeep/target/debug/waytoodeep
<span class="o">[</span>Thread<span class="w"> </span>debugging<span class="w"> </span>using<span class="w"> </span>libthread_db<span class="w"> </span>enabled<span class="o">]</span>
Using<span class="w"> </span>host<span class="w"> </span>libthread_db<span class="w"> </span>library<span class="w"> </span><span class="s2">&quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;</span>.
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff7c28700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158945</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff7a27700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158946</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7fffef826700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158947</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff7826700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158948</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff7625700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158949</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff7424700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158950</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff7223700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158951</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff701f700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158952</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff6e1e700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158953</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff6c1a700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158954</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff6a16700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158955</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff680f700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158956</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff660e700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158957</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff640a700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158958</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff6206700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158959</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff5f4b700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158960</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff5d4a700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158961</span><span class="o">)]</span>
<span class="o">[</span>Switching<span class="w"> </span>to<span class="w"> </span>Thread<span class="w"> </span>0x7ffff5f4b700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158960</span><span class="o">)]</span>

Thread<span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="s2">&quot;tokio-runtime-w&quot;</span><span class="w"> </span>hit<span class="w"> </span>Catchpoint<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">(</span>call<span class="w"> </span>to<span class="w"> </span>syscall<span class="w"> </span>connect<span class="o">)</span>,<span class="w"> </span>0x00007ffff7d5033b<span class="w"> </span><span class="k">in</span><span class="w"> </span>__libc_connect<span class="w"> </span><span class="o">(</span><span class="nv">fd</span><span class="o">=</span>fd@entry<span class="o">=</span><span class="m">9</span>,<span class="w"> </span><span class="nv">addr</span><span class="o">=</span>...,<span class="w"> </span>addr@entry<span class="o">=</span>...,
<span class="w">    </span><span class="nv">len</span><span class="o">=</span>len@entry<span class="o">=</span><span class="m">110</span><span class="o">)</span><span class="w"> </span>at<span class="w"> </span>../sysdeps/unix/sysv/linux/connect.c:26
<span class="m">26</span><span class="w">      </span>../sysdeps/unix/sysv/linux/connect.c:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory.
<span class="o">(</span>gdb<span class="o">)</span>
</code></pre></div>

<p>ä¸é”™ä¸é”™ï¼ŒçœŸå¿«ï¼æˆ‘ä»¬åœåœ¨äº†åä¸º <code>tokio-runtime-w</code> çš„ <code>Thread 17</code> ä¸­ï¼Œå› ä¸ºæˆ‘çŒœå…¶ä»–æ‰€æœ‰å­—æ¯éƒ½è¢«ä½¿ç”¨äº†ã€‚</p>
<blockquote>
<p><code>w</code> æ„å‘³è¿™ <code>worker</code> ï¼Œå¦‚æœä½ ä¸æ˜¯ç¬¬ä¸€å¤©ç”¨ Unix å°±ä¼šçŸ¥é“ä»€ä¹ˆè¿™ä¹ˆç®€å†™ã€‚</p>
</blockquote>
<p>å¥½çš„ï¼Œ <code>Thread 17</code> ï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹åœ¨åšä»€ä¹ˆå‘¢ï¼Ÿ</p>
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="n">threads</span>
<span class="w">  </span><span class="n">Id</span><span class="w">   </span><span class="n">Target</span><span class="w"> </span><span class="n">Id</span><span class="w">                                            </span><span class="n">Frame</span>
<span class="w">  </span><span class="mi">1</span><span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7c2c6c0</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158941</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;waytoodeep&quot;</span><span class="w">      </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">2</span><span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7c28700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158945</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">3</span><span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7a27700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158946</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="mh">0x00007ffff7d4f5ce</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">epoll_wait</span><span class="w"> </span><span class="p">(</span><span class="n">epfd</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">events</span><span class="o">=</span><span class="mh">0x555556338b60</span><span class="p">,</span><span class="w"> </span><span class="n">maxevents</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="n">timeout</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">epoll_wait</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">30</span>
<span class="w">  </span><span class="mi">4</span><span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7fffef826700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158947</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">5</span><span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7826700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158948</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">6</span><span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7625700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158949</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">7</span><span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7424700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158950</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">8</span><span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7223700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158951</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">9</span><span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff701f700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158952</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">10</span><span class="w">   </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6e1e700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158953</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">11</span><span class="w">   </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6c1a700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158954</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">12</span><span class="w">   </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6a16700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158955</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">13</span><span class="w">   </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff680f700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158956</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">14</span><span class="w">   </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff660e700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158957</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">15</span><span class="w">   </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff640a700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158958</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">16</span><span class="w">   </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6206700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158959</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w"> </span><span class="o">*</span><span class="mi">17</span><span class="w">   </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff5f4b700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158960</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="mh">0x00007ffff7d5033b</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">__libc_connect</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="o">=</span><span class="n">fd</span><span class="nv">@entry</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="o">=</span><span class="p">...,</span><span class="w"> </span><span class="n">addr</span><span class="nv">@entry</span><span class="o">=</span><span class="p">...,</span><span class="w"> </span><span class="nf">len</span><span class="o">=</span><span class="nf">len</span><span class="nv">@entry</span><span class="o">=</span><span class="mi">110</span><span class="p">)</span>
<span class="w">    </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="k">connect</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">26</span>
<span class="w">  </span><span class="mi">18</span><span class="w">   </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff5d4a700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158961</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="mh">0x00007ffff7d48a46</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">__GI___mmap64</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="o">=</span><span class="mi">16418</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nf">len</span><span class="o">=</span><span class="mi">134217728</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="o">=</span><span class="mh">0x0</span><span class="p">)</span>
<span class="w">    </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">mmap64</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">59</span>
</code></pre></div>

<p>é¢ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥è·å¾—æ›´å¤šçš„æ ˆå¸§ï¼Ÿ</p>
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">apply</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">backtrace</span><span class="w"> </span><span class="mi">2</span>

<span class="n">Thread</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="p">(</span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff5d4a700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158961</span><span class="p">))</span><span class="err">:</span>
<span class="n">#0</span><span class="w">  </span><span class="mh">0x00007ffff7d48a46</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">__GI___mmap64</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="o">=</span><span class="mi">16418</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nf">len</span><span class="o">=</span><span class="mi">134217728</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="o">=</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">mmap64</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">59</span>
<span class="n">#1</span><span class="w">  </span><span class="n">__GI___mmap64</span><span class="w"> </span><span class="p">(</span><span class="n">addr</span><span class="o">=</span><span class="n">addr</span><span class="nv">@entry</span><span class="o">=</span><span class="mh">0x0</span><span class="p">,</span><span class="w"> </span><span class="nf">len</span><span class="o">=</span><span class="nf">len</span><span class="nv">@entry</span><span class="o">=</span><span class="mi">134217728</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="o">=</span><span class="n">prot</span><span class="nv">@entry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="nv">@entry</span><span class="o">=</span><span class="mi">16418</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="o">=</span><span class="n">fd</span><span class="nv">@entry</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="nv">@entry</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">mmap64</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">47</span>
<span class="p">(</span><span class="n">More</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">frames</span><span class="w"> </span><span class="n">follow</span><span class="p">...)</span>

<span class="n">Thread</span><span class="w"> </span><span class="mi">17</span><span class="w"> </span><span class="p">(</span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff5f4b700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158960</span><span class="p">))</span><span class="err">:</span>
<span class="n">#0</span><span class="w">  </span><span class="mh">0x00007ffff7d5033b</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">__libc_connect</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="o">=</span><span class="n">fd</span><span class="nv">@entry</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="o">=</span><span class="p">...,</span><span class="w"> </span><span class="n">addr</span><span class="nv">@entry</span><span class="o">=</span><span class="p">...,</span><span class="w"> </span><span class="nf">len</span><span class="o">=</span><span class="nf">len</span><span class="nv">@entry</span><span class="o">=</span><span class="mi">110</span><span class="p">)</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="k">connect</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">26</span>
<span class="n">#1</span><span class="w">  </span><span class="mh">0x00007ffff7d8b713</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">open_socket</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="o">=</span><span class="n">type</span><span class="nv">@entry</span><span class="o">=</span><span class="n">GETFDHST</span><span class="p">,</span><span class="w"> </span><span class="k">key</span><span class="o">=</span><span class="k">key</span><span class="nv">@entry</span><span class="o">=</span><span class="mh">0x7ffff7de5ccb</span><span class="w"> </span><span class="ss">&quot;hosts&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">keylen</span><span class="o">=</span><span class="n">keylen</span><span class="nv">@entry</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">nscd_helper</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">185</span>
<span class="p">(</span><span class="n">More</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">frames</span><span class="w"> </span><span class="n">follow</span><span class="p">...)</span>

<span class="n">Thread</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="p">(</span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6206700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158959</span><span class="p">))</span><span class="err">:</span>
<span class="n">#0</span><span class="w">  </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="n">#1</span><span class="w">  </span><span class="mh">0x0000555555b9f1d1</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">parking_lot_core</span><span class="p">:</span><span class="err">:</span><span class="nl">thread_parker</span><span class="p">:</span><span class="err">:</span><span class="nl">imp</span><span class="p">:</span><span class="err">:</span><span class="nl">ThreadParker</span><span class="p">:</span><span class="err">:</span><span class="n">futex_wait</span><span class="w"> </span><span class="p">(</span><span class="n">self</span><span class="o">=</span><span class="mh">0x7ffff6206498</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="o">=</span><span class="p">...)</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">parking_lot_core</span><span class="o">-</span><span class="mf">0.8.3</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">thread_parker</span><span class="o">/</span><span class="n">linux</span><span class="p">.</span><span class="nl">rs</span><span class="p">:</span><span class="mi">112</span>
<span class="p">(</span><span class="n">More</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">frames</span><span class="w"> </span><span class="n">follow</span><span class="p">...)</span>

<span class="n">Thread</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="p">(</span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff640a700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158958</span><span class="p">))</span><span class="err">:</span>
<span class="n">#0</span><span class="w">  </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="n">#1</span><span class="w">  </span><span class="mh">0x0000555555b9f1d1</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">parking_lot_core</span><span class="p">:</span><span class="err">:</span><span class="nl">thread_parker</span><span class="p">:</span><span class="err">:</span><span class="nl">imp</span><span class="p">:</span><span class="err">:</span><span class="nl">ThreadParker</span><span class="p">:</span><span class="err">:</span><span class="n">futex_wait</span><span class="w"> </span><span class="p">(</span><span class="n">self</span><span class="o">=</span><span class="mh">0x7ffff640a498</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="o">=</span><span class="p">...)</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">parking_lot_core</span><span class="o">-</span><span class="mf">0.8.3</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">thread_parker</span><span class="o">/</span><span class="n">linux</span><span class="p">.</span><span class="nl">rs</span><span class="p">:</span><span class="mi">112</span>
<span class="p">(</span><span class="n">More</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">frames</span><span class="w"> </span><span class="n">follow</span><span class="p">...)</span>

<span class="n">Thread</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="p">(</span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff660e700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158957</span><span class="p">))</span><span class="err">:</span>
<span class="n">#0</span><span class="w">  </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="n">#1</span><span class="w">  </span><span class="mh">0x0000555555b9f1d1</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">parking_lot_core</span><span class="p">:</span><span class="err">:</span><span class="nl">thread_parker</span><span class="p">:</span><span class="err">:</span><span class="nl">imp</span><span class="p">:</span><span class="err">:</span><span class="nl">ThreadParker</span><span class="p">:</span><span class="err">:</span><span class="n">futex_wait</span><span class="w"> </span><span class="p">(</span><span class="n">self</span><span class="o">=</span><span class="mh">0x7ffff660e498</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="o">=</span><span class="p">...)</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">parking_lot_core</span><span class="o">-</span><span class="mf">0.8.3</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">thread_parker</span><span class="o">/</span><span class="n">linux</span><span class="p">.</span><span class="nl">rs</span><span class="p">:</span><span class="mi">112</span>
<span class="p">(</span><span class="n">More</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">frames</span><span class="w"> </span><span class="n">follow</span><span class="p">...)</span>

<span class="n">Thread</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="p">(</span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff680f700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158956</span><span class="p">))</span><span class="err">:</span>
<span class="n">#0</span><span class="w">  </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="n">#1</span><span class="w">  </span><span class="mh">0x0000555555b9f1d1</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">parking_lot_core</span><span class="p">:</span><span class="err">:</span><span class="nl">thread_parker</span><span class="p">:</span><span class="err">:</span><span class="nl">imp</span><span class="p">:</span><span class="err">:</span><span class="nl">ThreadParker</span><span class="p">:</span><span class="err">:</span><span class="n">futex_wait</span><span class="w"> </span><span class="p">(</span><span class="n">self</span><span class="o">=</span><span class="mh">0x7ffff680f498</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="o">=</span><span class="p">...)</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">parking_lot_core</span><span class="o">-</span><span class="mf">0.8.3</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">thread_parker</span><span class="o">/</span><span class="n">linux</span><span class="p">.</span><span class="nl">rs</span><span class="p">:</span><span class="mi">112</span>
<span class="p">(</span><span class="n">More</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">frames</span><span class="w"> </span><span class="n">follow</span><span class="p">...)</span>
</code></pre></div>

<p>é¢ã€‚å¤§éƒ¨åˆ†éƒ½æ˜¯æŒ‚èµ·çš„ã€‚ä¹Ÿå°±æ˜¯ç©ºé—²çš„ã€‚æ›´å‡†ç¡®çš„æ˜¯å®ƒä»¬åœ¨ç­‰å¾…å·¥ä½œã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ htop æŸ¥çœ‹è¿™äº›æ‰€æœ‰çº¿ç¨‹ï¼Œæˆ‘çŸ¥é“æˆ‘ä»¬å·²ç»çœ‹åˆ°äº†ï¼Œä½†æ˜¯æˆ‘ä»…ä»…æ˜¯è§‰å¾— htop å¾ˆæ£’ã€‚æ„Ÿè°¢ <a href="https://twitter.com/hisham%5Fhm">Hisham</a>ï¼
<img alt="" src="https://fasterthanli.me/content/articles/understanding-rust-futures-by-going-way-too-deep/assets/htop-colors.571c5effbff8a0b3.webp">
æ‰€ä»¥ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°ä¸€äº›çº¿ç¨‹ï¼ŒåŒæ—¶ä¹Ÿæœ‰ä¸€äº› CPU æ ¸å¿ƒã€‚å¯èƒ½æ˜¯ä¸€ä¸ª CPU æ ¸å¿ƒä¸€ä¸ªçº¿ç¨‹ï¼Ÿ
<img alt="" src="https://fasterthanli.me/content/articles/understanding-rust-futures-by-going-way-too-deep/assets/worker-threads.64dbe39e33ccfc4f.webp">
æ˜¯çš„ã€‚ç„¶åè¿˜æœ‰ä¸€äº›é˜»å¡çš„çº¿ç¨‹ï¼Œæ­£å¦‚æˆ‘ä»¬ä»ä¸Šé¢ <code>strace</code> è¾“å‡ºçœ‹åˆ°çš„é‚£æ ·ï¼Œ å®ƒä¼šè¿›è¡Œä¸€äº›é˜»å¡çš„ <code>connect</code> è°ƒç”¨å»æŸ¥è¯¢ DNSï¼ˆå®é™…æ˜¯ glibc åœ¨æ‰§è¡Œï¼‰ï¼Œ
æ‰€ä»¥å®ƒé€šè¿‡è¿è¡Œåœ¨å·¥ä½œçº¿ç¨‹ä¹‹å¤–é¿å…é˜»å¡å…¶ä»–ä»»åŠ¡ã€‚</p>
<blockquote>
<p>æ‰€ä»¥å¤šä¸ªçº¿ç¨‹ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸€æ¬¡å¯ä»¥è¿è¡Œå¤šä¸ªè¯·æ±‚çš„åŸå› ï¼Ÿ</p>
</blockquote>
<p>å®é™…ä¸Šæ–‡æ¡£ä¸Šè¡¨æ˜è¿™æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„æ‰§è¡Œå™¨ï¼Œæˆ‘ä¹Ÿä¸èƒ½ç¡®å®šï¼Œæ‰€ä»¥è®©æˆ‘ä»¬è¯•ä¸€ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1">//                           ğŸ‘‡</span>
<span class="cp">#[tokio::main(flavor = </span><span class="s">&quot;current_thread&quot;</span><span class="cp">)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// (same as before)</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:50:15.977<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:50:15.994<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
</code></pre></div>

<p>ä¸¤ä¸ªå“åº”é—´éš” <code>17ms</code> ï¼Œè¿™ä¸ªæ—¶é—´ä¸å¤Ÿæ„é€ ä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚ï¼Œæ‰€ä»¥è¯·æ±‚å¹¶è¡Œï¼ˆparallelï¼‰çš„æ‰§è¡Œäº†ã€‚å¦‚æœä½ ä¾ç„¶åšæŒå®ƒå†…éƒ¨ä½¿ç”¨äº†çº¿ç¨‹ï¼Œè®©æˆ‘ä»¬è¿›ä¸€æ­¥ç¡®è®¤æˆ‘ä»¬åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼š
<img alt="" src="https://fasterthanli.me/content/articles/understanding-rust-futures-by-going-way-too-deep/assets/current-thread.cd7b619ed644899b.webp">
ç¡®å®æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯è¿™äº›éƒ½æ˜¯é˜»å¡çº¿ç¨‹ã€‚ä»…ä»…æ˜¯ DNS æŸ¥è¯¢ã€‚å¯ä»¥é€šè¿‡ htop çœ‹åˆ°å·²ç»æ²¡æœ‰æ— æ•°ï¼ˆ15ï¼‰çš„å·¥ä½œçº¿ç¨‹äº†ï¼š
<img alt="" src="https://fasterthanli.me/content/articles/understanding-rust-futures-by-going-way-too-deep/assets/htop-current-thread.fe28174abc5d15fa.webp">
ï¼ˆé¡ºä¾¿è¯´ä¸€ä¸‹ 15 ä¸ªå·¥ä½œçº¿ç¨‹çš„åŸå› ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘é¢„ç•™äº†ä¸€ä¸ª CPU æ ¸å¿ƒæ²¡æœ‰åˆ†é…ç»™è™šæ‹Ÿæœºï¼Œè¿™æ ·å³ä½¿è™šæ‹Ÿæœºå…¨é€Ÿè¿è¡Œä¹Ÿä¸ä¼šå¯¼è‡´å®¿ä¸»æœºåœæ­¢å“åº”ï¼‰ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬å°† DNS æŸ¥è¯¢æ’é™¤åœ¨å¤–ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°å®é™…ä¸Šä»…ä»…ä½¿ç”¨äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œæˆ‘ä»¬å°†ç»§ç»­ä¸‹å»ï¼Œä»¥é˜²ä½ ä¾ç„¶å­˜ç–‘ï¼</p>
<h3 id="æ’æ›²-è®©æˆ‘ä»¬é¿å…æ³„æ¼å†…å­˜">æ’æ›²ï¼šè®©æˆ‘ä»¬é¿å…æ³„æ¼å†…å­˜</h3>
<p>ä½†æ˜¯åœ¨é‚£ä¹‹å‰ï¼šæ­£åœ¨æ³„æ¼ reqwest çš„ <code>Client</code> è®©æˆ‘å¾ˆä¸çˆ½ã€‚</p>
<p>ä¸ºäº†é¿å…ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªåŸå­å¼•ç”¨è®¡æ•°ï¼ˆatomically-reference-countedï¼‰ï¼Œè¿™æ ·å®ƒå°±å¯ä»¥éšç€ä»»åŠ¡è¿è¡Œè€Œå­˜æ´»ã€‚</p>
<p>ä¿®æ”¹èµ·æ¥éå¸¸ç®€å•ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1">//             ğŸ‘‡ Atomically Reference Counted = Arc</span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="p">;</span>

<span class="cp">#[tokio::main(flavor = </span><span class="s">&quot;current_thread&quot;</span><span class="cp">)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//           ğŸ‘‡ there we go</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arc</span>::<span class="n">new</span><span class="p">(</span><span class="n">Client</span>::<span class="n">new</span><span class="p">());</span>

<span class="w">    </span><span class="c1">//                              ğŸ‘‡</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// (cloning it only increases the reference count)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">URL_2</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">handle1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">handle2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut2</span><span class="p">);</span>

<span class="w">    </span><span class="n">handle1</span><span class="p">.</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">handle2</span><span class="p">.</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="cp">#[allow(clippy::manual_async_fn)]</span>
<span class="k">fn</span> <span class="nf">fetch_thing</span><span class="p">(</span>
<span class="w">    </span><span class="c1">//       ğŸ‘‡ now taking this, we have shared ownership of it</span>
<span class="w">    </span><span class="n">client</span>: <span class="nc">Arc</span><span class="o">&lt;</span><span class="n">Client</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span> <span class="kt">str</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// luckily this  ğŸ‘‡ only requires `&amp;self`</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">send</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">.</span><span class="n">error_for_status</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">content_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="n">res</span><span class="p">.</span><span class="n">headers</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;content-type&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Got a response!&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>å¥½äº†ï¼Œç°åœ¨æˆ‘æ„Ÿè§‰å¥½å¤šäº†ã€‚æˆ‘ä»¬çš„ç¨‹åºä¸å†æ³„æ¼ä¸€äº›å­—èŠ‚å³ä½¿å®ƒæ°¸è¿œä¸ä¼šè¿è¡Œè¶…è¿‡å‡ ç§’é’Ÿã€‚ä¸€åˆ‡éƒ½è¿˜å¥½ã€‚</p>
<p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ <code>reqwest</code> çš„ <code>Client</code> å®šä¹‰:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[derive(Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Client</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">inner</span>: <span class="nc">Arc</span><span class="o">&lt;</span><span class="n">ClientRef</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>å®ƒå·²ç»æ˜¯å¼•ç”¨è®¡æ•°çš„äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥æ¥å—ä¸€ä¸ª <code>Client</code>:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main(flavor = </span><span class="s">&quot;current_thread&quot;</span><span class="cp">)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//             ğŸ‘‡</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="c1">//                              ğŸ‘‡</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// no need to clone a second time</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_2</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">handle1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">handle2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut2</span><span class="p">);</span>

<span class="w">    </span><span class="n">handle1</span><span class="p">.</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">handle2</span><span class="p">.</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="cp">#[allow(clippy::manual_async_fn)]</span>
<span class="k">fn</span> <span class="nf">fetch_thing</span><span class="p">(</span>
<span class="w">    </span><span class="c1">//        ğŸ‘‡</span>
<span class="w">    </span><span class="n">client</span>: <span class="nc">Client</span><span class="p">,</span>
<span class="w">    </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span> <span class="kt">str</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">send</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">.</span><span class="n">error_for_status</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">content_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="n">res</span><span class="p">.</span><span class="n">headers</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;content-type&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Got a response!&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>å¥½äº†ã€‚</p>
<p>å¯¹äº†ï¼Œä»…ä¾›å‚è€ƒï¼Œæ›´ç®€å•çš„ <code>async fn</code> ä¹Ÿå¯ä»¥å·¥ä½œäº†ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">fetch_thing</span><span class="p">(</span><span class="n">client</span>: <span class="nc">Client</span><span class="p">,</span><span class="w"> </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">send</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">.</span><span class="n">error_for_status</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">content_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="n">res</span><span class="p">.</span><span class="n">headers</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;content-type&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Got a response!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>æˆ‘ä»¬ç”šè‡³ä¸éœ€è¦è¦æ±‚ <code>url</code> çš„å€Ÿç”¨ç”Ÿå‘½å‘¨æœŸæ˜¯ <code>'static</code> ã€‚å¦‚æœ <code>url</code> æ˜¯ <code>'static</code> çš„åˆ™è¿”å›çš„ Future ä¹Ÿæ˜¯ï¼Œåä¹‹äº¦ç„¶ã€‚</p>
<p>ä½œä¸ºä¾‹å­ï¼Œä¸‹é¢ä»£ç æ— æ³•é€šè¿‡ç¼–è¯‘ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main(flavor = </span><span class="s">&quot;current_thread&quot;</span><span class="cp">)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// this is a `String`, owned by main</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">url1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="n">URL_1</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// we&#39;re borrowing from main           ğŸ‘‡</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">url1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_2</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">handle1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">handle2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut2</span><span class="p">);</span>

<span class="w">    </span><span class="n">handle1</span><span class="p">.</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">handle2</span><span class="p">.</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="k">check</span>
<span class="w">    </span><span class="n">Checking</span><span class="w"> </span><span class="n">waytoodeep</span><span class="w"> </span><span class="n">v0</span><span class="mf">.1.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="n">ftl</span><span class="o">/</span><span class="n">waytoodeep</span><span class="p">)</span>

<span class="k">error</span><span class="err">[</span><span class="n">E0597</span><span class="err">]</span><span class="o">:</span><span class="w"> </span><span class="n n-Quoted">`url1`</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">live</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">enough</span>
<span class="w">  </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">18</span><span class="o">:</span><span class="mi">44</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">18</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">let</span><span class="w"> </span><span class="n">fut1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="k">client</span><span class="p">.</span><span class="k">clone</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">url1</span><span class="p">);</span>
<span class="w">   </span><span class="o">|</span><span class="w">                </span><span class="o">----------------------------^^^^^-</span>
<span class="w">   </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">                           </span><span class="o">|</span>
<span class="w">   </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">                           </span><span class="n">borrowed</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">live</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">enough</span>
<span class="w">   </span><span class="o">|</span><span class="w">                </span><span class="n">argument</span><span class="w"> </span><span class="n">requires</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n n-Quoted">`url1`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">borrowed</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n n-Quoted">`&#39;static`</span>
<span class="p">...</span>
<span class="mi">28</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="err">}</span>
<span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n n-Quoted">`url1`</span><span class="w"> </span><span class="n">dropped</span><span class="w"> </span><span class="n">here</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">still</span><span class="w"> </span><span class="n">borrowed</span>
</code></pre></div>

<blockquote>
<p>ä½ é¢å¯¹çš„è€ƒéªŒå°±æ˜¯ï¼šä¿®æ”¹äº†ä¸€äº›ä»£ç ï¼Œç„¶åçªç„¶é—´æ•´ä¸ª <code>Future</code> ä¸å†å®ç° <code>Send</code> ï¼Œä½†æ˜¯ä½ éœ€è¦å®ƒå®ç° <code>Send</code> ã€‚å‚è€ƒ<a href="https://fasterthanli.me/articles/getting-in-and-out-of-trouble-with-rust-futures">Getting in and out of trouble with Rust futures</a>ã€‚</p>
</blockquote>
<p>åœ¨æˆ‘ä»¬è¿›ä¸€æ­¥æ·±å…¥ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æƒ³æä¸€ä¸‹ï¼Œé™¤äº†é€šè¿‡ <code>tokio::spawn</code> å¯ä»¥åŒæ—¶è¿è¡Œä¸¤ä¸ª future å¹¶ä¸”ç«‹å³ç­‰å¾…ä¸¤ä¸ª future å®Œæˆï¼Œè¿˜æ˜¯ä½¿ç”¨ <code>FuturesUnordered</code> å®ç°ç›¸åŒç›®çš„ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">futures</span><span class="mf">@0.3.16</span>
<span class="w">    </span><span class="n">Updating</span><span class="w"> </span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//github.com/rust-lang/crates.io-index&#39; index</span>
<span class="w">      </span><span class="n">Adding</span><span class="w"> </span><span class="n">futures</span><span class="w"> </span><span class="n">v0</span><span class="mf">.3.16</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dependencies</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">futures</span>::<span class="p">{</span><span class="n">stream</span>::<span class="n">FuturesUnordered</span><span class="p">,</span><span class="w"> </span><span class="n">StreamExt</span><span class="p">};</span>


<span class="cp">#[tokio::main(flavor = </span><span class="s">&quot;current_thread&quot;</span><span class="cp">)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span>
<span class="w">        </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">URL_1</span><span class="p">),</span>
<span class="w">        </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_2</span><span class="p">),</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">    </span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">collect</span>::<span class="o">&lt;</span><span class="n">FuturesUnordered</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">group</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="k">await</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// propagate errors</span>
<span class="w">        </span><span class="n">item</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>é€šè¿‡è¿™ä¸ªè§£å†³åŠå•ƒå•Šï¼Œæˆ‘ä»¬å¯ä»¥ await ä»»æ„æ•°é‡çš„ future å¯¹è±¡ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å¹¶å‘çš„è¢«è½®è¯¢ï¼ˆpolledï¼‰ã€‚</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:12:37.208<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:12:37.227<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
</code></pre></div>

<p>ä»…ä»…ã€‚ã€‚ã€‚19 æ¯«ç§’çš„é—´éš” -- å¯ä»¥ç¡®å®šæ˜¯å¹¶å‘çš„ã€‚</p>
<h3 id="å½»åº•æ‘†è„±-dns">å½»åº•æ‘†è„± DNS</h3>
<p>ç°åœ¨è®©æˆ‘ä»¬æš‚æ—¶å¿˜æ‰ <code>reqwest</code> ã€‚</p>
<p>HTTP <a href="https://fasterthanli.me/articles/aiming-for-correctness-with-types">å¹¶ä¸éš¾</a> ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±æ„å»ºã€‚åªè¦ TCP å°±è¡Œï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">net</span>::<span class="n">SocketAddr</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">tokio</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">io</span>::<span class="p">{</span><span class="n">AsyncReadExt</span><span class="p">,</span><span class="w"> </span><span class="n">AsyncWriteExt</span><span class="p">},</span>
<span class="w">    </span><span class="n">net</span>::<span class="n">TcpStream</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">fetch_thing</span><span class="p">(</span><span class="n">name</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// look mom, no DNS!</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">addr</span>: <span class="nc">SocketAddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">80</span><span class="p">).</span><span class="n">into</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TcpStream</span>::<span class="n">connect</span><span class="p">(</span><span class="n">addr</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// we&#39;re writing straight to the socket, there&#39;s no buffering</span>
<span class="w">    </span><span class="c1">// so no need to flush</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;GET / HTTP/1.1</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;Host: 1.1.1.1</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;User-Agent: cool-bear</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;Connection: close</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">with_capacity</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">read_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">response</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">lines</span><span class="p">().</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap_or_default</span><span class="p">();</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Got response!&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// dropping the socket will close the connection</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>å¯ä»¥æ­£å¸¸è¿è¡Œï¼š</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:24:05.158<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">301</span><span class="w"> </span>Moved<span class="w"> </span>Permanently<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:24:05.159<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">301</span><span class="w"> </span>Moved<span class="w"> </span>Permanently<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
</code></pre></div>

<p>ï¼ˆçœ‹ï¼Œç¬¬äºŒä¸ªèµ¢å¾—äº†èƒœåˆ©ï¼‰ã€‚</p>
<p>åŒæ—¶å†ä¹Ÿæ²¡æœ‰ DNS æŸ¥è¯¢äº†ã€‚</p>
<p>å½“ç„¶ <code>http://1.1.1.1</code> å°†æˆ‘ä»¬é‡å®šå‘åˆ° HTTPS çš„é¡µé¢ï¼ŒæŠ€æœ¯ä¸Šå®ç° TLS å¹¶ä¸å›°éš¾ï¼Œä½†æ˜¯æˆ‘ä»¬çš„ç¯‡å¹…å·²ç»å¾ˆé•¿äº†ï¼Œæ‰€ä»¥ã€‚ã€‚ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">tokio</span><span class="o">-</span><span class="n">rustls</span><span class="mf">@0.22.0</span>
<span class="w">    </span><span class="n">Updating</span><span class="w"> </span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//github.com/rust-lang/crates.io-index&#39; index</span>
<span class="w">      </span><span class="n">Adding</span><span class="w"> </span><span class="n">tokio</span><span class="o">-</span><span class="n">rustls</span><span class="w"> </span><span class="n">v0</span><span class="mf">.22.0</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dependencies</span>
<span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">webpki</span><span class="mf">@0.21.4</span>
<span class="w">    </span><span class="n">Updating</span><span class="w"> </span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//github.com/rust-lang/crates.io-index&#39; index</span>
<span class="w">      </span><span class="n">Adding</span><span class="w"> </span><span class="n">webpki</span><span class="w"> </span><span class="n">v0</span><span class="mf">.21.4</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dependencies</span>
<span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">webpki</span><span class="o">-</span><span class="n">roots</span><span class="mf">@0.21.1</span>
<span class="w">    </span><span class="n">Updating</span><span class="w"> </span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//github.com/rust-lang/crates.io-index&#39; index</span>
<span class="w">      </span><span class="n">Adding</span><span class="w"> </span><span class="n">webpki</span><span class="o">-</span><span class="n">roots</span><span class="w"> </span><span class="n">v0</span><span class="mf">.21.1</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dependencies</span>
</code></pre></div>

<p>ç„¶åã€‚ã€‚ã€‚</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>rm<span class="w"> </span>reqwest
<span class="w">    </span>Removing<span class="w"> </span>reqwest<span class="w"> </span>from<span class="w"> </span>dependencies
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">webpki</span>::<span class="n">DNSNameRef</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">tokio_rustls</span>::<span class="p">{</span><span class="n">rustls</span>::<span class="n">ClientConfig</span><span class="p">,</span><span class="w"> </span><span class="n">TlsConnector</span><span class="p">};</span>

<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">fetch_thing</span><span class="p">(</span><span class="n">name</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// look out it&#39;s port 443 now</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">addr</span>: <span class="nc">SocketAddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">443</span><span class="p">).</span><span class="n">into</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TcpStream</span>::<span class="n">connect</span><span class="p">(</span><span class="n">addr</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// establish a TLS session...</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">connector</span>: <span class="nc">TlsConnector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClientConfig</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">config</span>
<span class="w">            </span><span class="p">.</span><span class="n">root_store</span>
<span class="w">            </span><span class="p">.</span><span class="n">add_server_trust_anchors</span><span class="p">(</span><span class="o">&amp;</span><span class="n">webpki_roots</span>::<span class="n">TLS_SERVER_ROOTS</span><span class="p">);</span>
<span class="w">        </span><span class="n">Arc</span>::<span class="n">new</span><span class="p">(</span><span class="n">config</span><span class="p">).</span><span class="n">into</span><span class="p">()</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="c1">// we have to use the proper DNS name now      ğŸ‘‡</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">dnsname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DNSNameRef</span>::<span class="n">try_from_ascii_str</span><span class="p">(</span><span class="s">&quot;one.one.one.one&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connector</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dnsname</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// we&#39;re writing straight to the socket, there&#39;s no buffering</span>
<span class="w">    </span><span class="c1">// so no need to flush</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;GET / HTTP/1.1</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//                        ğŸ‘‡</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;Host: one.one.one.one</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;User-Agent: cool-bear</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;Connection: close</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">with_capacity</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">read_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">response</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">lines</span><span class="p">().</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap_or_default</span><span class="p">();</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Got response!&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// dropping the socket will close the connection</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:31:32.627<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:31:32.658<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
</code></pre></div>

<p>å¥½äº†ï¼Œç°åœ¨è¿”å›çŠ¶æ€ç  200ï¼</p>
<p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯äº†è§£ Rust çš„ futureï¼Œæˆ‘ä»¬å·²ç»è·å¾—äº†ä¸é”™çš„è¿›å±•ã€‚</p>
<p>ä½†æ˜¯è®©æˆ‘ä»¬è€ƒè™‘ä»¥ä¸‹åœºæ™¯ï¼šæˆ‘ä»¬æƒ³å¹¶å‘çš„æ‰§è¡Œä¸¤ä¸ªè¯·æ±‚ï¼Œä¸€æ—¦å…¶ä¸­ä¸€ä¸ªå¤±è´¥ï¼Œå¦å¤–ä¸€ä¸ªä¹Ÿåº”è¯¥ç«‹å³è¯·æ±‚å¤±è´¥ï¼Œæˆ–è€…ä¸¤ä¸ªä¸€èµ·æˆåŠŸã€‚</p>
<h3 id="tokio-çš„-try-join-å®">tokio çš„ try_join å®</h3>
<p>å®é™…ä¸Šï¼Œåˆä¸€ä¸ªå®å¯ä»¥åšè¿™ä¸ªï¼</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main(flavor = </span><span class="s">&quot;current_thread&quot;</span><span class="cp">)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">try_join</span><span class="o">!</span><span class="p">(</span><span class="n">fetch_thing</span><span class="p">(</span><span class="s">&quot;first&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="s">&quot;second&quot;</span><span class="p">),)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">?</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;All done!&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>è¿™å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:44:52.150<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:44:52.165<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:44:52.165<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(()</span>,<span class="w"> </span><span class="o">())</span>
</code></pre></div>

<p>å†æ¬¡å¿«é€Ÿæ£€æŸ¥ä»¥ä¸‹ï¼šå“åº”é—´éš”åœ¨ 15ms -- ä¹Ÿå°±æ˜¯ç¡®å®šæ˜¯å¹¶å‘çš„å‘é€ã€‚</p>
<p><code>try_join!</code> å¸®æˆ‘ä»¬è¿›è¡Œäº† <code>await</code> ï¼ŒåŒæ—¶å¸®æˆ‘ä»¬å¤„ç†äº†ç»“æœã€‚å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œæˆ‘ä»¬å¾—åˆ°æ‰€æœ‰ future å¯¹è±¡çš„ç»“æœï¼šå†…å®¹ä¸º <code>Ok</code> çš„ç©ºå…ƒç»„ï¼ˆæœ‰åºçš„ï¼‰ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å–åˆ°æˆ‘ä»¬ future è¿”å›çš„å¯¹è±¡ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1">//                                          ğŸ‘‡</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">fetch_thing</span><span class="p">(</span><span class="n">name</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// (omitted)</span>

<span class="w">    </span><span class="c1">//  ğŸ‘‡</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<p>ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬è‡ªå·±ï¼Œå®ƒä»¬æŒ‰ç…§é¡ºåºè¿”å›ï¼Œæ— è®ºå“ªä¸ªå…ˆè¢«æ‰§è¡Œï¼š</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:47:56.967<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:47:56.967<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:47:56.967<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:47:57.933<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:47:57.935<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:47:57.935<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:47:58.942<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:47:58.946<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:47:58.946<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
</code></pre></div>

<p>å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬æ²¡æœ‰ DNS æŸ¥è¯¢ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¶ˆé™¤â€œåŒæ—¶â€è¯·æ±‚æ˜¯ç”±äºå¤šçº¿ç¨‹å®ç°çš„ã€‚</p>
<p>å› ä¸ºï¼Œå¦‚æœæˆ‘ä»¬åœ¨ <code>strace</code> ä¸‹è¿è¡Œç¨‹åºï¼Œå¹¶é€šè¿‡ <code>-f</code> è¯·æ±‚è·Ÿè¸ªå­çº¿ç¨‹ï¼ˆ BTW <code>f</code> æ„æ€æ˜¯è·Ÿè¸ªï¼ˆ <code>follow</code> ï¼‰å­çº¿ç¨‹ï¼‰ï¼š</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>build<span class="w"> </span>--quiet<span class="w"> </span>--release<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>strace<span class="w"> </span>-f<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;connect&#39;</span><span class="w"> </span>./target/release/waytoodeep
connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">443</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;1.1.1.1&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>EINPROGRESS<span class="w"> </span><span class="o">(</span>Operation<span class="w"> </span>now<span class="w"> </span><span class="k">in</span><span class="w"> </span>progress<span class="o">)</span>
connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">443</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;1.1.1.1&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>EINPROGRESS<span class="w"> </span><span class="o">(</span>Operation<span class="w"> </span>now<span class="w"> </span><span class="k">in</span><span class="w"> </span>progress<span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:51:54.004<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:51:54.013<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:51:54.015<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
</code></pre></div>

<p>ã€‚ã€‚ã€‚ç°åœ¨æˆ‘ä»¬çœ‹åˆ°äº†é¢„æœŸçš„ä¸¤æ¬¡ <code>connect</code> è°ƒç”¨ï¼Œä½†æ˜¯æ²¡æœ‰ä»»ä½•å­çº¿ç¨‹ã€‚è€Œä¸”åœ¨è¿™ä¸ªè¿è¡Œä¸­ï¼Œå“åº”ä¹‹é—´çš„é—´éš”æ—¶é—´æ˜¯ 9 æ¯«ç§’ï¼å°‘äºæˆ‘ç›´æ¥ ping 1.1.1.1:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ping<span class="w"> </span>-c<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span>.1.1.1
PING<span class="w"> </span><span class="m">1</span>.1.1.1<span class="w"> </span><span class="o">(</span><span class="m">1</span>.1.1.1<span class="o">)</span><span class="w"> </span><span class="m">56</span><span class="o">(</span><span class="m">84</span><span class="o">)</span><span class="w"> </span>bytes<span class="w"> </span>of<span class="w"> </span>data.
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">1</span>.1.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">57</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">13</span>.7<span class="w"> </span>ms

---<span class="w"> </span><span class="m">1</span>.1.1.1<span class="w"> </span>ping<span class="w"> </span>statistics<span class="w"> </span>---
<span class="m">1</span><span class="w"> </span>packets<span class="w"> </span>transmitted,<span class="w"> </span><span class="m">1</span><span class="w"> </span>received,<span class="w"> </span><span class="m">0</span>%<span class="w"> </span>packet<span class="w"> </span>loss,<span class="w"> </span><span class="nb">time</span><span class="w"> </span>0ms
rtt<span class="w"> </span>min/avg/max/mdev<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">13</span>.748/13.748/13.748/0.000<span class="w"> </span>ms
</code></pre></div>

<p>è¿™æ˜¯å› ä¸ºæ‰§è¡Œå™¨é€šè¿‡ Event Loop æ„å»ºéé˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ï¼Œç„¶åè®¢é˜… Event Loop ç®¡ç†çš„èµ„æºç›¸å…³çš„äº‹ä»¶ï¼Œ
ç„¶åå°±å¯ä»¥çŸ¥é“ä¸€ä¸ª socket ä»€ä¹ˆæ—¶é—´å¯ä»¥è¿›è¡Œè¯»å†™ã€‚</p>
<p>æ‰€ä»¥ï¼Œfuture å¯¹è±¡åªæ˜¯ä¸€äº›çŠ¶æ€ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥è¿›è¡Œ awaitï¼Œé‚£ä¹ˆåœ¨å“ªè®¢é˜…çš„äº‹ä»¶å‘¢ï¼Ÿ</p>
<p>è®©æˆ‘ä»¬å°è¯•åˆ›å»ºä¸€ä¸ªæˆ‘ä»¬è‡ªå·±çš„ <code>try_join</code> -- ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”åªæ¥å—ä¸¤ä¸ª futureã€‚ç„¶åæˆ‘ä»¬å°±èƒ½çœ‹åˆ°å‘ç”Ÿäº†ä»€ä¹ˆã€‚</p>
<p>æˆ‘ä»¬å·²ç»å®ç°äº†è‡ªå·±çš„ futureï¼Œå®ç°ä¸€ä¸ª <code>try_join</code> å‡½æ•°ä¼šæœ‰å¤šéº»çƒ¦ï¼Ÿ</p>
<h3 id="äº‹å®è¯æ˜å¾ˆéº»çƒ¦">äº‹å®è¯æ˜å¾ˆéº»çƒ¦</h3>
<p>æˆ‘ä»¬å…ˆä»ç®€å•çš„å¼€å§‹ï¼æˆ‘ä»¬æƒ³å®ç°ä¸€ä¸ªå‡½æ•°æ¥å—ä¸¤ä¸ª future å¯¹è±¡ç„¶åè¿”å›ä¸€ä¸ª future å¯¹è±¡ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in `src/main.rs`</span>
<span class="k">mod</span> <span class="nn">tj</span><span class="p">;</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1">// in `src/tj.rs`</span>

<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">future</span>::<span class="n">Future</span><span class="p">;</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">try_join</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">B</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="fm">todo!</span><span class="p">(</span><span class="s">&quot;implement me!&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>é¢ã€‚å‡½æ•°ä¸åº”è¯¥åªè¿”å›ä¸€ä¸ªç©ºå…ƒç»„ï¼Œå®ƒéœ€è¦è¿”å›ä¸€ä¸ªåŒ…å«æˆåŠŸç»“æœçš„å…ƒç»„ã€‚æˆ–è€…é‡åˆ°çš„ç¬¬ä¸€ä¸ªé”™è¯¯ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€äº›æ›´å¤šçš„èŒƒå‹å‚æ•°ï¼šä¸€ä¸ªé”™è¯¯ç±»å‹ï¼ˆæˆ‘ä»¬å‡è®¾ä¸¤ä¸ª future å¯¹è±¡è¿”å›åŒæ ·çš„é”™è¯¯ç±»å‹ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯ future å¯¹è±¡è¿”å›çš„ <code>Ok</code> çš„ç±»å‹ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">try_join</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">B</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">),</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="fm">todo!</span><span class="p">(</span><span class="s">&quot;implement me!&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>å¥½äº†ï¼è¿™éå¸¸ç»•å£ï¼Œä½†æ˜¯æˆ‘ç›¸ä¿¡æˆ‘ä»¬å·²ç»å®ç°äº†éœ€æ±‚ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬ä½¿ç”¨äº† <code>impl Trait</code> è¯­æ³•ï¼Œè®©æˆ‘ä»¬ä¸ç”¨æš´éœ²æˆ‘ä»¬è‡ªå·±çš„ <code>try join future</code> ã€‚è¿™ä¸é‡è¦ï¼Œä½†æ˜¯å¯ä»¥è®©æˆ‘ä»¬ç”¨æ›´å°‘çš„ <code>pub</code> å…³é”®å­—ï¼ŒåŒæ—¶æˆ‘ä»¬çš„æ‰‹æŒ‡å·²ç»ç ç´¯äº†ã€‚éå¸¸ç´¯ã€‚</p>
<p>æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬æ¥åˆ›å»ºè¿™ä¸ªç±»å‹ï¼</p>
<p>ç±»å‹éœ€è¦æŒç»­ <code>A</code> å’Œ <code>B</code> ï¼Œå¹¶æ³¨æ„ <code>AR</code> ã€ <code>BR</code> å’Œ <code>E</code> ç±»å‹ã€‚æ‰€ä»¥ï¼Œå¸Œæœ›æ‚¨å¯¹è¿™äº›èŒƒå‹å‚æ•°æ²™æ‹‰æœ‰ä¸ªå¥½èƒƒå£ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="nc">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span>
<span class="w">    </span><span class="n">b</span>: <span class="nc">B</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>ç„¶åå¯ä»¥åœ¨æˆ‘ä»¬çš„ <code>try_join</code> å‡½æ•°ä¸­è¿”å›å®ƒï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">try_join</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">B</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">),</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// so simple!</span>
<span class="w">    </span><span class="n">TryJoin</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>æˆ‘è®¤ä¸ºè¿™å¾ˆå¥½çš„è¯´æ˜ä¸€ä¸ªäº‹å®ï¼šåˆ›å»º future å¯¹è±¡ä»…ä»…æ˜¯æ„å»ºçŠ¶æ€ã€‚ä¸éœ€è¦ä»»ä½•é¢å¤–çš„å·¥ä½œã€‚</p>
<p>å½“ç„¶ï¼Œè¿™ä¸ªä¸ä¼šé€šè¿‡ç¼–è¯‘ï¼Œå› ä¸º <code>TryJoin</code> è¿˜æ²¡æœ‰å®ç° <code>Future</code> ã€‚</p>
<p>ä½†æ˜¯ä¸è¦æ‹…å¿ƒï¼ <code>rust-analyzer</code> å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç”Ÿæˆç¼ºå¤±çš„éƒ¨åˆ†ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">future</span>::<span class="n">Future</span><span class="p">,</span>
<span class="w">    </span><span class="n">pin</span>::<span class="n">Pin</span><span class="p">,</span>
<span class="w">    </span><span class="n">task</span>::<span class="p">{</span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">Poll</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">),</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">todo!</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>å¦‚æœæˆ‘ä»¬çœŸæ­£çš„å®ç°äº†ï¼Œæˆ‘ä»¬å°†æŒ‰ç…§ä¸‹é¢æ–¹å¼ä½¿ç”¨ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main(flavor = </span><span class="s">&quot;current_thread&quot;</span><span class="cp">)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tj</span>::<span class="n">try_join</span><span class="p">(</span><span class="n">fetch_thing</span><span class="p">(</span><span class="s">&quot;first&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="s">&quot;second&quot;</span><span class="p">)).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">?</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;All done!&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>å½“ç„¶ï¼Œç°åœ¨åªæ˜¯ä¼šå´©æºƒï¼š</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release

The<span class="w"> </span>application<span class="w"> </span>panicked<span class="w"> </span><span class="o">(</span>crashed<span class="o">)</span>.
Message:<span class="w">  </span>not<span class="w"> </span>yet<span class="w"> </span>implemented
Location:<span class="w"> </span>src/tj.rs:32

Backtrace<span class="w"> </span>omitted.
Run<span class="w"> </span>with<span class="w"> </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>environment<span class="w"> </span>variable<span class="w"> </span>to<span class="w"> </span>display<span class="w"> </span>it.
Run<span class="w"> </span>with<span class="w"> </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span>full<span class="w"> </span>to<span class="w"> </span>include<span class="w"> </span><span class="nb">source</span><span class="w"> </span>snippets.
</code></pre></div>

<p>æ‰€ä»¥ï¼Œæˆ‘çŒœæˆ‘ä»¬éœ€è¦å®ç°å®ƒï¼</p>
<p>å¥½å§ï¼Œè®©æˆ‘ä»¬å…ˆå°è¯•è‡³å°‘è½®è¯¢ï¼ˆpollingï¼‰ä¸€ä¸ª future å¯¹è±¡ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">);</span>

<span class="w">    </span><span class="fm">todo!</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">RUST_LOG</span><span class="o">=</span><span class="n">info</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">quiet</span><span class="w"> </span><span class="o">--</span><span class="k">release</span>
<span class="k">error</span><span class="err">[</span><span class="n">E0599</span><span class="err">]</span><span class="o">:</span><span class="w"> </span><span class="k">no</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="n">named</span><span class="w"> </span><span class="n n-Quoted">`poll`</span><span class="w"> </span><span class="k">found</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="n n-Quoted">`A`</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">current</span><span class="w"> </span><span class="n">scope</span>
<span class="w">   </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">tj</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">32</span><span class="o">:</span><span class="mi">24</span>
<span class="w">    </span><span class="o">|</span>
<span class="mi">32</span><span class="w">  </span><span class="o">|</span><span class="w">         </span><span class="n">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">);</span>
<span class="w">    </span><span class="o">|</span><span class="w">                        </span><span class="o">^^^^</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">found</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n n-Quoted">`A`</span>
<span class="w">    </span><span class="o">|</span>
<span class="w">   </span><span class="o">:::</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">stable</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="no">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">future</span><span class="o">/</span><span class="n">future</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">100</span><span class="o">:</span><span class="mi">8</span>
<span class="w">    </span><span class="o">|</span>
<span class="mi">100</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">fn</span><span class="w"> </span><span class="n">poll</span><span class="p">(</span><span class="n">self</span><span class="o">:</span><span class="w"> </span><span class="n">Pin</span><span class="o">&lt;&amp;</span><span class="n">mut</span><span class="w"> </span><span class="n">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mut</span><span class="w"> </span><span class="k">Context</span><span class="o">&lt;</span><span class="s1">&#39;_&gt;) -&gt; Poll&lt;Self::Output&gt;;</span>
<span class="s1">    |        ---- the method is available for `Pin&lt;&amp;mut A&gt;` here</span>
<span class="s1">    |</span>
<span class="s1">help: consider wrapping the receiver expression with the appropriate type</span>
<span class="s1">    |</span>
<span class="s1">32  |         let a = Pin::new(&amp;mut self.a).poll(cx);</span>
<span class="s1">    |                 ^^^^^^^^^^^^^       ^</span>
</code></pre></div>

<p>é¢ï¼ä¸€ä¸ªå¥½çš„å¼€å§‹ï¼Œå¥½çš„å¼€å§‹ã€‚</p>
<p>æˆ‘å·²ç»åœ¨è¿™é‡Œ<a href="https://fasterthanli.me/articles/pin-and-suffering">è¯¦ç»†çš„è§£é‡Šäº†</a> Pinï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±ç®€å•çš„ä»‹ç»ä¸€ä¸‹ã€‚</p>
<p>æ–¹æ³•é€šå¸¸é€šè¿‡å¦‚ä¸‹æ–¹å¼å®šä¹‰æ¥æ”¶è€…ï¼ˆreceiverï¼‰ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="nc">MyType</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">do_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;my value is {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>ä¹Ÿå°±æ˜¯ä¸‹é¢çš„ç®€å†™ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="nc">MyType</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">do_thing</span><span class="p">(</span><span class="bp">self</span>: <span class="kp">&amp;</span><span class="nc">Self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;my value is {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>å› ä¸ºæˆ‘ä»¬åœ¨ <code>impl MyType</code> ä»£ç å—ä¸­ <code>Self</code> å°±æ˜¯ <code>MyType</code> ã€‚</p>
<p>å¾ˆæ¸…æ™°å§ï¼Ÿå¥½äº†ï¼Œè¿˜å¯ä»¥å®šä¹‰å…¶ä»–å¾ˆå¤šç±»å‹ä½œä¸ºæ¥æ”¶è€…ï¼Œ <code>Pin&lt;&amp;mut Self&gt;</code> å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="nc">MyType</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">do_thing</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// good luck!1</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>é‚£ä¹ˆ <code>MyType</code> å¿…é¡»æ˜¯å›ºå®šçš„ï¼ˆpinnedï¼‰æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæ¯”å¦‚ï¼Œå®ƒä¿è¯ä¸è¿›è¡Œè½¬ç§»ï¼ˆmoveï¼‰ã€‚é™¤éå®ƒå®ç°äº† <code>Unpin</code> ï¼Œ
ç„¶åå®ƒå°±å¯ä»¥æ˜¯éå›ºå®šçš„ï¼ˆunpinnedï¼‰ï¼Œå¯ç§»åŠ¨ï¼Œç„¶åè¢«å†ä¸€æ¬¡å›ºå®šã€‚</p>
<p>å¯¹äºå‰©ä¸‹çš„æ–‡ç« ï¼Œæˆ‘ä»¬ä¸ä¼šå‡è®¾æˆ‘ä»¬çš„ future <code>A</code> å’Œ <code>B</code> éƒ½æ˜¯ <code>Unpin</code> ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è‡ªå·±ä¸ä¼šç§»åŠ¨ï¼ˆmoveï¼‰å®ƒä»¬ï¼ˆåªé”€æ¯ï¼ˆdropï¼‰å®ƒä»¬ï¼‰ã€‚</p>
<p>ä½ å¯ä»¥è¯´æˆ‘ä»¬ä¸éœ€è¦ <code>A</code> å’Œ <code>B</code> æ˜¯ <code>Unpin</code> çš„ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰æ·»åŠ æŒ‡å®šçš„ where clause æ¥æ ‡è®°éœ€è¦å®ƒä»¬æ˜¯ <code>Unpin</code> ã€‚
å› ä¸ºå¦‚æœæˆ‘ä»¬éœ€è¦ï¼Œæˆ‘ä»¬å°±è¦åƒä¸‹é¢è¿™æ ·æ·»åŠ é¢å¤–çš„ <code>trait bound</code> ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="nc">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="c1">//                                    ğŸ‘‡</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Unpin</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Unpin</span><span class="p">,</span>
<span class="p">{}</span>
</code></pre></div>

<p>ä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½å‡è®¾ <code>A</code> æˆ– <code>B</code> æ˜¯ <code>Unpin</code> çš„ã€‚</p>
<p>æ‰€ä»¥ï¼æˆ‘ä»¬ç°åœ¨çœŸçš„åªæ˜¯é¢ä¸´å›ºå®šï¼ˆpinï¼‰ä¿æŠ¤çš„é—®é¢˜ã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨åªæŒæœ‰ä¸€ä¸ª <code>Pin&lt;&amp;mut TryJoin&lt;A, B, ...&gt;&gt;</code> ä½†æ˜¯æˆ‘å¸Œæœ›æŒç»­ä¸€ä¸ª <code>Pin&lt;&amp;mut A&gt;</code> ï¼ˆå› ä¸ºè¿™å°±æ˜¯æˆ‘ä»¬å› ä¸ºéœ€è¦è½®è¯¢ <code>A</code> ï¼‰ã€‚</p>
<p>å¦å¤–ä¸€ä¸ªè§£å†³æ–¹æ³•ï¼Œæˆ‘å€¾å‘äºé€šè¿‡ä¸€äº›ç±»ä¼¼ <a href="https://lib.rs/crates/pin-project">pin-project</a> åŒ…ï¼Œæˆ–è€…ç±»ä¼¼ <a href="https://lib.rs/crates/pin-project-lite">pin-project-lite</a>ï¼Œä½†æ˜¯åœ¨æˆ‘ä»¬å‰è¿›çš„æ–¹å‘ç›´æ¥ä½¿ç”¨ <code>pin-project</code> çœŸçš„å¾ˆå°´å°¬ï¼Œ
æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä½¿ç”¨ <code>unsafe</code> ä½œä¸ºæ›¿ä»£ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">map_unchecked_mut</span><span class="p">(</span><span class="o">|</span><span class="n">this</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">);</span>

<span class="w">    </span><span class="fm">todo!</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<p>å¯ä»¥é€šè¿‡ç¼–è¯‘ã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨ <code>unsafe</code> ï¼Œä¹Ÿå°±æ„å‘³ç€ç¼–è¯‘å™¨æ­£å¼åœæ­¢ ~~ç…§é¡¾~~ æ£€æŸ¥æˆ‘ä»¬çš„ä»£ç ã€‚
æˆ‘ä»¬è‡ªå·±å¿…é¡»å¼ºåˆ¶æ‰§è¡Œä¸€äº›ä¸å˜é‡ï¼ˆinvariantsï¼‰ï¼Œå¹¶ä¸”éå¸¸éå¸¸å°å¿ƒï¼ŒåŒæ—¶è®©å…¶ä»–äººå®¡æŸ¥ï¼ˆreviewï¼‰æˆ‘ä»¬çš„å·¥ä½œï¼Œ
ä½†æ˜¯ä¾ç„¶å¯èƒ½ä¼šå‡ºé”™ï¼Œå› ä¸ºä»–ä»¬ä¹Ÿä¼šä¼‘æ¯ã€‚</p>
<p>ç°åœ¨ï¼Œéå¸¸æ£’çš„æ˜¯æˆ‘ä»¬å¯ä»¥è½®è¯¢ <code>a</code> ã€‚å®ƒå¦‚æœå®Œæˆä¼šè¿”å› <code>Poll::Ready(Result&lt;AR, E&gt;)</code> ï¼Œ
å¦åˆ™å°±æ˜¯ç­‰ä¼šä¼šå®Œæˆåˆ™è¿”å› <code>Poll::Pending</code> ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">map_unchecked_mut</span><span class="p">(</span><span class="o">|</span><span class="n">this</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;A is pending...&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;A is ready!&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="fm">todo!</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<p>æˆ‘ä»¬é€šè¿‡æ‰“å°æ—¥å¿—â€œA is pendingâ€çŸ¥é“å‡†å¤‡å®Œæˆã€‚è¿™å¯èƒ½éœ€è¦å‡ ä¸ªå›åˆï¼šæ¯•ç«Ÿï¼Œæˆ‘ä»¬æ­£åœ¨åšä¸€äº›é‡è¦çš„äº‹æƒ…ã€‚
æˆ‘ä»¬å»ºç«‹ä¸€ä¸ª TCP è¿æ¥ï¼Œæ¥ç€åœ¨ä¸Šé¢è¿›è¡Œ TLS ä¼šè¯ï¼Œæ¥ç€æ˜¯ä¸€äº›åˆ†å¼€çš„å†™ï¼Œæœ€åè¯»åˆ° EOFï¼ˆend of fileï¼‰ã€‚</p>
<p>å½“ç„¶ï¼Œå¦‚æœæˆ‘ä»¬è¿è¡Œå®ƒçš„è¯ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">aytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.495</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.495</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.495</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.495</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.495</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.495</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.495</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.513</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.513</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.513</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.513</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.513</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.514</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.522</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.522</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.522</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.522</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.522</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.523</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.523</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.530</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.530</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.530</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">:</span><span class="w"> </span><span class="n">Got</span><span class="w"> </span><span class="n">response</span><span class="o">!</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="n">OK</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">first</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.530</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">ready</span><span class="o">!</span>
<span class="n">The</span><span class="w"> </span><span class="n">application</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="p">(</span><span class="n">crashed</span><span class="p">)</span><span class="o">.</span>
<span class="n">Message</span><span class="p">:</span><span class="w">  </span><span class="ow">not</span><span class="w"> </span><span class="n">yet</span><span class="w"> </span><span class="n">implemented</span>
<span class="n">Location</span><span class="p">:</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">tj</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">46</span>

<span class="n">Backtrace</span><span class="w"> </span><span class="n">omitted</span><span class="o">.</span>
<span class="n">Run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">it</span><span class="o">.</span>
<span class="n">Run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="n">full</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">include</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="n">snippets</span><span class="o">.</span>
</code></pre></div>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒç¡®å®èŠ±è´¹äº†å‡ ä¸ªå›åˆã€‚</p>
<p>æ³¨æ„å¦‚æœ <code>A</code> è¿”å›é”™è¯¯æˆ‘ä»¬çš„ä»£ç ä¹Ÿä¼šè¿”å› <code>Poll:Ready</code> ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³æ”¶é›† A å’Œ B çš„ç»“æœã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯¹ B åšç›¸åŒçš„äº‹æƒ…ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">map_unchecked_mut</span><span class="p">(</span><span class="o">|</span><span class="n">this</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;A is pending...&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;A is ready!&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">map_unchecked_mut</span><span class="p">(</span><span class="o">|</span><span class="n">this</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;B is pending...&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;B is ready!&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="fm">todo!</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<p>ç„¶åã€‚ã€‚whoopsï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">RUST_LOG</span><span class="o">=</span><span class="n">info</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">quiet</span><span class="w"> </span><span class="o">--</span><span class="k">release</span>
<span class="k">error</span><span class="err">[</span><span class="n">E0382</span><span class="err">]</span><span class="o">:</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">moved</span><span class="w"> </span><span class="k">value</span><span class="o">:</span><span class="w"> </span><span class="n n-Quoted">`self`</span>
<span class="w">   </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">tj</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">46</span><span class="o">:</span><span class="mi">26</span>
<span class="w">    </span><span class="o">|</span>
<span class="mi">33</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="n">fn</span><span class="w"> </span><span class="n">poll</span><span class="p">(</span><span class="n">self</span><span class="o">:</span><span class="w"> </span><span class="n">Pin</span><span class="o">&lt;&amp;</span><span class="n">mut</span><span class="w"> </span><span class="n">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mut</span><span class="w"> </span><span class="k">Context</span><span class="o">&lt;</span><span class="s1">&#39;_&gt;) -&gt; Poll&lt;Self::Output&gt; {</span>
<span class="s1">    |             ---- move occurs because `self` has type `Pin&lt;&amp;mut TryJoin&lt;A, B, AR, BR, E&gt;&gt;`, which does not implement the `Copy` trait</span>
<span class="s1">34  |         let a = unsafe { self.map_unchecked_mut(|this| &amp;mut this.a) };</span>
<span class="s1">    |                               ------------------------------------- `self` moved due to this method call</span>
<span class="s1">...</span>
<span class="s1">46  |         let b = unsafe { self.map_unchecked_mut(|this| &amp;mut this.a) };</span>
<span class="s1">    |                          ^^^^ value used here after move</span>
<span class="s1">    |</span>
<span class="s1">note: this function takes ownership of the receiver `self`, which moves `self`</span>
<span class="s1">   --&gt; /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/pin.rs:776:43</span>
<span class="s1">    |</span>
<span class="s1">776 |     pub unsafe fn map_unchecked_mut&lt;U, F&gt;(self, func: F) -&gt; Pin&lt;&amp;&#39;</span><span class="n">a</span><span class="w"> </span><span class="n">mut</span><span class="w"> </span><span class="n">U</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">|</span><span class="w">                                           </span><span class="o">^^^^</span>
</code></pre></div>

<p>æ˜¯çš„ã€‚ <code>map_unchecked_mut</code> å æœ‰äº† <code>self</code> ã€‚</p>
<p>ä¸ç”¨æ‹…å¿ƒï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>.as_mut()</code> ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1">//       ğŸ‘‡</span>
<span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">//                      ğŸ‘‡</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">as_mut</span><span class="p">().</span><span class="n">map_unchecked_mut</span><span class="p">(</span><span class="o">|</span><span class="n">this</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;A is pending...&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;A is ready!&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">//                      ğŸ‘‡</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">as_mut</span><span class="p">().</span><span class="n">map_unchecked_mut</span><span class="p">(</span><span class="o">|</span><span class="n">this</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;B is pending...&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;B is ready!&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="fm">todo!</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<p>ä½†æ˜¯ä¾ç„¶æ— æ³•é€šè¿‡ç¼–è¯‘ï¼š</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
<span class="o">(</span>cut<span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">22</span>:57:07.913<span class="w">  </span>INFO<span class="w"> </span>waytoodeep::tj:<span class="w"> </span>A<span class="w"> </span>is<span class="w"> </span>pending...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">22</span>:57:07.913<span class="w">  </span>INFO<span class="w"> </span>waytoodeep::tj:<span class="w"> </span>A<span class="w"> </span>is<span class="w"> </span>pending...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">22</span>:57:07.913<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">22</span>:57:07.913<span class="w">  </span>INFO<span class="w"> </span>waytoodeep::tj:<span class="w"> </span>A<span class="w"> </span>is<span class="w"> </span>ready!
The<span class="w"> </span>application<span class="w"> </span>panicked<span class="w"> </span><span class="o">(</span>crashed<span class="o">)</span>.
Message:<span class="w">  </span><span class="sb">`</span>async<span class="w"> </span>fn<span class="sb">`</span><span class="w"> </span>resumed<span class="w"> </span>after<span class="w"> </span>completion
Location:<span class="w"> </span>src/main.rs:24

Backtrace<span class="w"> </span>omitted.
Run<span class="w"> </span>with<span class="w"> </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>environment<span class="w"> </span>variable<span class="w"> </span>to<span class="w"> </span>display<span class="w"> </span>it.
Run<span class="w"> </span>with<span class="w"> </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span>full<span class="w"> </span>to<span class="w"> </span>include<span class="w"> </span><span class="nb">source</span><span class="w"> </span>snippets.
</code></pre></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸€æ—¦ <code>Future</code> è¿”å› <code>Poll::Ready</code> æˆ‘ä»¬å°±ä¸èƒ½å†æ¬¡è½®è¯¢å®ƒäº†ã€‚æˆ‘ä»¬ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿå› ä¸º <code>Future</code> å·²ç»è¿”å›äº†ç»“æœã€‚å¦‚æœç»“æœæ˜¯é <code>Copy</code> çš„ï¼Œå®ƒå¯èƒ½åªèƒ½è¿”å›ä¸€æ¬¡ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦ 1ï¼‰è·Ÿè¸ª <code>A</code> æ˜¯å¦å®Œæˆï¼Œç„¶å 2ï¼‰åœ¨æŸä¸ªåœ°æ–¹å­˜å‚¨å®ƒçš„è¿”å›ç»“æœã€‚</p>
<p>æˆ‘ä»¬åªéœ€è¦åœ¨æˆ‘ä»¬çš„ç»“æ„ä½“ä¸­æ·»åŠ ä¸€äº›å­—æ®µï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="nc">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span>
<span class="w">    </span><span class="n">b</span>: <span class="nc">B</span><span class="p">,</span>
<span class="w">    </span><span class="c1">// ğŸ‘‡</span>
<span class="w">    </span><span class="n">a_res</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">AR</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">b_res</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">BR</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>ä¸è¦å¿˜è®°åˆå§‹åŒ–å®ƒä»¬ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">try_join</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">B</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">),</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">TryJoin</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">a</span><span class="p">,</span>
<span class="w">        </span><span class="n">b</span><span class="p">,</span>
<span class="w">        </span><span class="c1">// ğŸ‘‡</span>
<span class="w">        </span><span class="n">a_res</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">        </span><span class="n">b_res</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>ç°åœ¨è®¡åˆ’æ˜¯ï¼š</p>
<ul>
<li>å¦‚æœ <code>a_res</code> æ˜¯ <code>Some</code> ï¼Œç„¶åæˆ‘ä»¬å°±ä¸éœ€è¦è½®è¯¢ <code>a</code> ,å› ä¸ºå®ƒå·²ç»å®Œæˆäº†</li>
<li>åŒæ ·çš„é€»è¾‘å¤„ç† <code>b_res</code> å’Œ <code>b</code></li>
</ul>
<p>è®©æˆ‘ä»¬å®ç°å®ƒã€‚åŒæ—¶ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»åœ¨ä½¿ç”¨äº† <code>unsafe</code> ï¼Œæ‰€ä»¥æˆ‘ä»¬å·²ç»è´Ÿè´£ç»´æŠ¤ä¸å˜é‡ï¼ˆinvariantsï¼‰ï¼Œ
æ‰€ä»¥æˆ‘å†³å®šåŒæ—¶å›ºå®š <code>a</code> å’Œ <code>b</code> ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_unchecked_mut</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">(</span>
<span class="w">            </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">),</span>
<span class="w">            </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">b</span><span class="p">),</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a_res</span><span class="p">.</span><span class="n">is_none</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">,</span>
<span class="w">            </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nb">Ok</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
<span class="w">                </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">b_res</span><span class="p">.</span><span class="n">is_none</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">,</span>
<span class="w">            </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nb">Ok</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">b_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
<span class="w">                </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="fm">todo!</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<p>å¥½äº†ï¼Œè¿™ä¸ªåº”è¯¥èƒ½è®© <code>a</code> å’Œ <code>b</code> æœ‰æœºä¼šåœ¨æˆ‘ä»¬å´©æºƒä¹‹å‰å®Œæˆï¼š</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:11:03.851<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:11:04.380<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
The<span class="w"> </span>application<span class="w"> </span>panicked<span class="w"> </span><span class="o">(</span>crashed<span class="o">)</span>.
Message:<span class="w">  </span>not<span class="w"> </span>yet<span class="w"> </span>implemented
Location:<span class="w"> </span>src/tj.rs:69

Backtrace<span class="w"> </span>omitted.
Run<span class="w"> </span>with<span class="w"> </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>environment<span class="w"> </span>variable<span class="w"> </span>to<span class="w"> </span>display<span class="w"> </span>it.
Run<span class="w"> </span>with<span class="w"> </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span>full<span class="w"> </span>to<span class="w"> </span>include<span class="w"> </span><span class="nb">source</span><span class="w"> </span>snippets.
</code></pre></div>

<p>å¾ˆå¥½ï¼ç°åœ¨æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯è§£å‡ºä¸¤ä¸ªç»“æœå¹¶è¿”å›å®ƒä»¬ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1">// instead of the `todo!()`:</span>

<span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="n">_</span><span class="p">),</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="p">.</span><span class="n">a_res</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">this</span><span class="p">.</span><span class="n">b_res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a_res</span><span class="p">.</span><span class="n">take</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">b_res</span><span class="p">.</span><span class="n">take</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="nb">Ok</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Poll</span>::<span class="n">Pending</span>
<span class="p">}</span>
</code></pre></div>

<p>å¯ä»¥å·¥ä½œï¼š</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:13:32.497<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:13:32.829<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:13:32.829<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
</code></pre></div>

<p>ã€‚ã€‚ã€‚ä½†æ˜¯è¿™ä¸æ˜¯ <code>try_join</code> çš„å®ç°ã€‚æˆ‘ä»¬æ­£åœ¨åšçš„å’Œè¿™ä¸ªå®Œå…¨ä¸€æ ·ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1">// (pseudo-code, buncha things are missing)</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">try_join</span><span class="p">(</span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">B</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>

<p>æ˜¯é¡ºåºçš„æ‰§è¡Œçš„ã€‚è¯·è®°ä½ï¼Œä»…ä»…æ˜¯å› ä¸º tokio çš„æ‰§è¡Œå™¨å¯èƒ½ç”¨äº†ä¸€å †çº¿ç¨‹å¹¶æ„å‘³ç€åŒæ—¶è¿è¡Œæ˜¯è‡ªåŠ¨çš„ã€‚
å‰é¢æˆ‘ä»¬ä¸å¾—ä¸ä½¿ç”¨ <code>tokio::spwan</code> æˆ– <code>UnorderedFutures</code> æˆ– <code>try_join!</code> è®©å…¶åŒæ—¶è¿è¡Œã€‚</p>
<p>æ‰€ä»¥è®©æˆ‘ä»¬é‡æ–°çœ‹ä¸€ä¸‹ã€‚ã€‚ã€‚å½“æˆ‘ä»¬è½®è¯¢ <code>a</code> çš„æ˜¯åå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a_res</span><span class="p">.</span><span class="n">is_none</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">,</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>é¢ï¼Œå½“è½®è¯¢ <code>a</code> çš„æ—¶å€™è¿”å› <code>Poll::Pending</code> æ—¶æˆ‘ä»¬ä¹Ÿä¼šè¿”å› <code>Poll::Pending</code>  ã€‚æ‰€ä»¥è¿™å°±æ˜¯é—®é¢˜ã€‚
å¦‚æœ <code>a</code> æ­£åœ¨ç­‰å¾…ï¼ˆpendingï¼‰æˆ‘ä»¬ä¸åº”è¯¥è¿”å›ã€‚å› ä¸ºå¦‚æœè¿™æ—¶å€™ <code>b</code> å·²ç»å‡†å¤‡å¥½æˆ–è€…æœ‰é”™è¯¯å‘¢ï¼Ÿ</p>
<p>æˆ–è€…å¦‚æœï¼Œæˆ‘ä»¬åƒè¿™æ ·è°ƒç”¨ <code>try_join</code> å‘¢ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Joining...&quot;</span><span class="p">);</span>
<span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tj</span>::<span class="n">try_join</span><span class="p">(</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">2000</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">10</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span>
<span class="w">        </span><span class="nb">Err</span>::<span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="p">(</span><span class="n">color_eyre</span>::<span class="n">eyre</span>::<span class="n">eyre</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;uh oh&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">)</span>
<span class="p">.</span><span class="k">await</span><span class="p">;</span>
</code></pre></div>

<p>ã€‚ã€‚ã€‚ç„¶å <code>a</code> èŠ±è´¹äº† 2 ç§’é’Ÿæ‰å‡†å¤‡å¥½ï¼ŒåŒæ—¶ <code>b</code> ä¼šåœ¨ 10æ¯«ç§’ä¹‹åè¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œå¦‚æœæˆ‘ä»¬è½®è¯¢å®ƒï¼</p>
<p>å—ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ï¼š</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:19:26.972<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Joining...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:19:28.990<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=</span>Err<span class="o">(</span>
<span class="w">   </span><span class="m">0</span>:<span class="w"> </span>uh<span class="w"> </span>oh

Location:
<span class="w">   </span>src/main.rs:28
<span class="o">(</span>cut<span class="o">)</span>
</code></pre></div>

<p>ï¼ˆæ³¨æ„æ—¶é—´æˆ³ï¼‰</p>
<p>é‡ç‚¹æ˜¯ <code>try_join</code> ä¼šæå‰å¤±è´¥ï¼šä¸€æ—¦ Future è¿”å› <code>Result::Err~</code> ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¿…é¡»åŒæ—¶è½®è¯¢ <code>a</code> å’Œ <code>b</code> ã€‚å¥½å§ã€‚ã€‚ã€‚ä¸æ˜¯ä¸¥æ ¼æ„ä¹‰çš„åŒæ—¶ã€‚æˆ‘ä»¬å¿…é¡»æ¯æ¬¡æˆ‘ä»¬çš„ <code>TryJoin</code> future å¯¹è±¡è¢«è½®è¯¢æ—¶å¹¶å‘ï¼ˆconcurrentlyï¼‰çš„è½®è¯¢å®ƒä»¬ï¼Œ
ç›´åˆ°å®ƒä»¬è¿”å›ç»“æœã€‚</p>
<p>æœ‰ä¸€ä¸ªç®€å•è§£å†³åŠæ³• -- åœ¨ä»»ä¸€ future å¯¹è±¡è¿”å› <code>Poll::Pending</code> æ—¶ä¸è¿”å› <code>Poll::Pending</code> ã€‚</p>
<p>åŒæ—¶ï¼Œæˆ‘åŒå€¦äº†è¾“å…¥ <code>Poll::Ready</code> å¹¶ä¸” <code>Poll&lt;T&gt;</code> å®ç°äº† <code>From&lt;T&gt;</code> ,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>.into()</code> äº†ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_unchecked_mut</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">(</span>
<span class="w">            </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">),</span>
<span class="w">            </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">b</span><span class="p">),</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a_res</span><span class="p">.</span><span class="n">is_none</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nb">Ok</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
<span class="w">                </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">into</span><span class="p">(),</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">b_res</span><span class="p">.</span><span class="n">is_none</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nb">Ok</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">b_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
<span class="w">                </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">into</span><span class="p">(),</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="n">_</span><span class="p">),</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="p">.</span><span class="n">a_res</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">this</span><span class="p">.</span><span class="n">b_res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a_res</span><span class="p">.</span><span class="n">take</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">b_res</span><span class="p">.</span><span class="n">take</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)).</span><span class="n">into</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Pending</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>è®©æˆ‘ä»¬å†æ¬¡è¿è¡Œ</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:22:40.238<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Joining...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:22:40.253<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=</span>Err<span class="o">(</span>
<span class="w">   </span><span class="m">0</span>:<span class="w"> </span>uh<span class="w"> </span>oh

Location:
<span class="w">   </span>src/main.rs:28

<span class="o">(</span>cut<span class="o">)</span>
</code></pre></div>

<p>ã€‚ã€‚ã€‚å¯ä»¥äº†ï¼æˆ‘æ˜¯è¯´å®ƒæŒ‰ç…§é¢„æœŸçš„å¤±è´¥äº†ã€‚é¢„æœŸçš„å¤±è´¥å°±æ˜¯æˆåŠŸã€‚</p>
<p>ç„¶åæˆ‘ä»¬å°†è¿™ä¸ªæ–¹æ³•åº”ç”¨åˆ°è°ƒç”¨ <code>try_join</code> :</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main(flavor = </span><span class="s">&quot;current_thread&quot;</span><span class="cp">)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Joining...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tj</span>::<span class="n">try_join</span><span class="p">(</span><span class="n">fetch_thing</span><span class="p">(</span><span class="s">&quot;first&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="s">&quot;second&quot;</span><span class="p">)).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">?</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;All done!&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç«äº‰åˆå›æ¥äº†ï¼šæœ‰æ—¶ <code>first</code> å…ˆå®Œæˆï¼Œæœ‰æ—¶åˆ™ä¸æ˜¯ï¼š</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:25.925<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Joining...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:26.224<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:26.236<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:26.236<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:26.937<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Joining...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:27.237<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:27.242<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:27.242<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:27.865<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Joining...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:28.164<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:28.818<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:28.818<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:30.153<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Joining...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:31.477<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:31.496<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:31.496<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
</code></pre></div>

<p>ã€‚ã€‚ã€‚åŒæ—¶ç»“æœçš„é¡ºåºæ˜¯æ­£ç¡®çš„ã€‚</p>
<p>éå¸¸å¥½ï¼Œæˆ‘ä»¬å®ç°äº†å®ƒï¼</p>
<p>ä½†æ˜¯ï¼</p>
<h3 id="æˆ‘ä»¬å¯ä»¥åšçš„æ›´å¥½">æˆ‘ä»¬å¯ä»¥åšçš„æ›´å¥½</h3>
<p>å¹¸è¿çš„æ˜¯ï¼Œåå°±æ˜¯å¥½ã€‚</p>
<p>ä¸‹é¢è¿™ä¸ªç±»å‹å›°æ‰°ç€æˆ‘ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="nc">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span>
<span class="w">    </span><span class="n">b</span>: <span class="nc">B</span><span class="p">,</span>
<span class="w">    </span><span class="n">a_res</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">AR</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">b_res</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">BR</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>æˆ‘å…¶å®åªæœ‰åœ¨ <code>a</code> å®Œæˆåæ‰éœ€è¦ <code>a_res</code> ã€‚ä¸€æ—¦ <code>a</code> å®Œæˆç„¶åå°†ç»“æœå­˜å‚¨åˆ° <code>a_res</code> ï¼Œæˆ‘ä»¬å°±ä¸å†éœ€è¦ <code>a</code> äº†ã€‚</p>
<p>å®é™…ä¸Šï¼Œç”šè‡³æˆ‘ä»¬ä¸åº”è¯¥å†ç¢° <code>a</code>  ã€‚</p>
<p>è¿™å¬èµ·æ¥æ›´åƒæˆ‘ä»¬è¦ä¹ˆæŒæœ‰ <code>A</code> è¦ä¹ˆæŒæœ‰ <code>AR</code> ï¼Œä½†æ˜¯æ°¸è¿œä¸ä¼šåŒæ—¶æŒæœ‰ã€‚</p>
<blockquote>
<p><code>SUM TYPES</code> : Rust çš„æšä¸¾å°±æ˜¯ä¸€ä¸ªæ±‡æ€»ç±»å‹ã€‚</p>
</blockquote>
<p>æ‰€ä»¥ï¼æ±‡æ€»ç±»å‹ã€‚Rust æšä¸¾ã€‚è¿™å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå«åš <code>State</code> çš„ç±»å‹ï¼Œç„¶åå®ƒæœ‰ä¸¤ä¸ªå˜ä½“ï¼š
ä¸€ä¸ªç”¨äºå®ƒè¿˜æ˜¯ future å¯¹è±¡ï¼Œä¸€ä¸ªç”¨äºå®ƒæ˜¯ä¸€ä¸ªç»“æœã€‚éå¸¸ç®€å•ï¼</p>
<div class="highlight"><pre><span></span><code><span class="k">enum</span> <span class="nc">State</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">F</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Future</span><span class="p">(</span><span class="n">F</span><span class="p">),</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">T</span><span class="p">),</span>
<span class="p">}</span>
</code></pre></div>

<p>è¿™å°†ä¼šéå¸¸æ£’ï¼</p>
<p>è®©æˆ‘ä»¬èµ‹ç»™æˆ‘ä»¬çš„ <code>TryJoin</code> ç»“æ„ä½“ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="nc">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">a</span>: <span class="nc">State</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">b</span>: <span class="nc">State</span><span class="o">&lt;</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>ï¼ˆæ˜¯ä¸æ˜¯éå¸¸æ¼‚äº®ï¼‰</p>
<p>ç„¶ååˆå§‹åŒ–å®ƒä»¬ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">try_join</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">B</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">),</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">TryJoin</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">a</span>: <span class="nc">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>
<span class="w">        </span><span class="n">b</span>: <span class="nc">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">b</span><span class="p">),</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>éå¸¸é…·ã€‚ç„¶åæˆ‘ä»¬åªéœ€è¦ç¨å¾®è°ƒæ•´ä¸€ä¸‹æˆ‘ä»¬çš„ <code>poll</code> æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦å°† <code>Pin&lt;&amp;mut Self&gt;</code> è½¬æ¢ä¸º <code>&amp;mut Self</code> ã€‚ã€‚ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_unchecked_mut</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
</code></pre></div>

<p>è¿™æ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºæˆ‘ä»¬æ‰¿è¯ºç»´æŠ¤ä¸å˜é‡ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¸ä¼šè½¬ç§»ï¼ˆmoveï¼‰ <code>State::Future</code> å†…éƒ¨ã€‚</p>
<p>ç„¶åå¦‚æœ <code>a</code> æ˜¯ <code>State::Future</code> æˆ‘ä»¬å°±è½®è¯¢å®ƒï¼Œç„¶åæˆ‘ä»¬å†ä¼ æ’­é”™è¯¯æˆ–è€…ä¿å­˜å®ƒçš„ç»“æœï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">into</span><span class="p">(),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>ç„¶ååŒæ ·çš„ä¿®æ”¹ <code>b</code> ã€‚ã€‚ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1">// you can figure that one out, I believe in you</span>
</code></pre></div>

<p>ç„¶åæˆ‘ä»¬å°±å®Œæˆäº†å¦‚æœå®ƒä»¬éƒ½æ˜¯ <code>State::Ok</code> ï¼å¦åˆ™æˆ‘ä»¬å°±è¿”å› <code>Poll::Pending</code> :</p>
<div class="highlight"><pre><span></span><code><span class="k">match</span><span class="w"> </span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="w"> </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)).</span><span class="n">into</span><span class="p">(),</span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>éå¸¸å¥½ã€‚</p>
<p>é™¤äº†å®ƒæ— æ³•é€šè¿‡ç¼–è¯‘ï¼š</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
error<span class="o">[</span>E0507<span class="o">]</span>:<span class="w"> </span>cannot<span class="w"> </span>move<span class="w"> </span>out<span class="w"> </span>of<span class="w"> </span><span class="sb">`</span>this.a<span class="sb">`</span><span class="w"> </span>which<span class="w"> </span>is<span class="w"> </span>behind<span class="w"> </span>a<span class="w"> </span>mutable<span class="w"> </span>reference
<span class="w">  </span>--&gt;<span class="w"> </span>src/tj.rs:65:16
<span class="w">   </span><span class="p">|</span>
<span class="m">65</span><span class="w"> </span><span class="p">|</span><span class="w">         </span>match<span class="w"> </span><span class="o">(</span>this.a,<span class="w"> </span>this.b<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">   </span><span class="p">|</span><span class="w">                </span>^^^^^^<span class="w"> </span>move<span class="w"> </span>occurs<span class="w"> </span>because<span class="w"> </span><span class="sb">`</span>this.a<span class="sb">`</span><span class="w"> </span>has<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="sb">`</span>State&lt;A,<span class="w"> </span>AR,<span class="w"> </span>E&gt;<span class="sb">`</span>,<span class="w"> </span>which<span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>implement<span class="w"> </span>the<span class="w"> </span><span class="sb">`</span>Copy<span class="sb">`</span><span class="w"> </span>trait

error<span class="o">[</span>E0507<span class="o">]</span>:<span class="w"> </span>cannot<span class="w"> </span>move<span class="w"> </span>out<span class="w"> </span>of<span class="w"> </span><span class="sb">`</span>this.b<span class="sb">`</span><span class="w"> </span>which<span class="w"> </span>is<span class="w"> </span>behind<span class="w"> </span>a<span class="w"> </span>mutable<span class="w"> </span>reference
<span class="w">  </span>--&gt;<span class="w"> </span>src/tj.rs:65:24
<span class="w">   </span><span class="p">|</span>
<span class="m">65</span><span class="w"> </span><span class="p">|</span><span class="w">         </span>match<span class="w"> </span><span class="o">(</span>this.a,<span class="w"> </span>this.b<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">   </span><span class="p">|</span><span class="w">                        </span>^^^^^^<span class="w"> </span>move<span class="w"> </span>occurs<span class="w"> </span>because<span class="w"> </span><span class="sb">`</span>this.b<span class="sb">`</span><span class="w"> </span>has<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="sb">`</span>State&lt;B,<span class="w"> </span>BR,<span class="w"> </span>E&gt;<span class="sb">`</span>,<span class="w"> </span>which<span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>implement<span class="w"> </span>the<span class="w"> </span><span class="sb">`</span>Copy<span class="sb">`</span><span class="w"> </span>trait

error:<span class="w"> </span>aborting<span class="w"> </span>due<span class="w"> </span>to<span class="w"> </span><span class="m">2</span><span class="w"> </span>previous<span class="w"> </span>errors

For<span class="w"> </span>more<span class="w"> </span>information<span class="w"> </span>about<span class="w"> </span>this<span class="w"> </span>error,<span class="w"> </span>try<span class="w"> </span><span class="sb">`</span>rustc<span class="w"> </span>--explain<span class="w"> </span>E0507<span class="sb">`</span>.
error:<span class="w"> </span>could<span class="w"> </span>not<span class="w"> </span>compile<span class="w"> </span><span class="sb">`</span>waytoodeep<span class="sb">`</span>

To<span class="w"> </span>learn<span class="w"> </span>more,<span class="w"> </span>run<span class="w"> </span>the<span class="w"> </span><span class="nb">command</span><span class="w"> </span>again<span class="w"> </span>with<span class="w"> </span>--verbose.
</code></pre></div>

<p>å› ä¸ºã€‚ã€‚ã€‚æˆ‘ä»¬åªæœ‰ <code>&amp;mut Self</code> è€Œä¸æ˜¯ <code>Self</code> ã€‚</p>
<p>æˆ‘ä»¬æ²¡æœ‰è‡ªå·±çš„æ‰€æœ‰æƒï¼Œä»…ä»…æ˜¯å€Ÿç”¨æˆ‘ä»¬è‡ªå·±ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¸èƒ½å°†å°†æˆ‘ä»¬çš„æˆå‘˜è½¬ç§»ï¼ˆmoveï¼‰å‡ºå»ï¼Œå› ä¸ºæˆ‘ä»¬ä¸èƒ½é˜»æ­¢å…¶ä»–äººå†æ¬¡è½®è¯¢ <code>TryJoin</code> ã€‚
æ‰€ä»¥è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦å´©æºƒï¼ˆpanicï¼‰ã€‚</p>
<p>å½“ç„¶ï¼Œå¦‚æœæˆ‘ä»¬åƒ <code>Option&lt;T&gt;</code> é‚£æ ·æœ‰ä¸€ä¸ª <code>.take()</code> æ–¹æ³•äº‹æƒ…å°±ä¼šå¤§å¤§ç®€åŒ–ã€‚
å®ƒè¿”å› Option æ‹¥æœ‰çš„ä»»ä½•å†…å®¹ï¼Œæˆ–è€… <code>None</code> ã€‚</p>
<p>ä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰ <code>None</code> ã€‚æˆ‘ä»¬åªæœ‰ <code>State::Future</code> å’Œ <code>State::OK</code> ï¼Œæ²¡æœ‰â€œä¸­ç«‹â€ï¼ˆneutralï¼‰çŠ¶æ€ã€‚</p>
<p>è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">enum</span> <span class="nc">State</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">F</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Future</span><span class="p">(</span><span class="n">F</span><span class="p">),</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">T</span><span class="p">),</span>
<span class="w">    </span><span class="n">Gone</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å°† <code>this.a</code> å’Œ <code>this.b</code> æ›¿æ¢ä¸º <code>State::Gone</code> ã€‚ã€‚ã€‚æˆ–è€…å®ƒçš„è¿”å›ç»“æœï¼ˆæˆ‘ä»¬æ‹¥æœ‰æ‰€æœ‰æƒï¼‰ã€‚
ç„¶åæˆ‘ä»¬å°±å¯ä»¥å°†å®ƒä»¬è½¬ç§»ï¼ˆmoveï¼‰å‡ºå»ã€‚</p>
<p>ä½†æ˜¯åŒæ—¶ã€‚ã€‚ã€‚æˆ‘ä»¬éœ€è¦å†æ¬¡å¯¹å…¶è¿›è¡Œæ¨¡å¼åŒ¹é…ï¼ˆpattern matchï¼‰ã€‚</p>
<p>å°±åƒï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">match</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">this</span><span class="p">.</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">),</span><span class="w"> </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">replace</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">State</span>::<span class="n">Gone</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">t</span><span class="p">,</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">unreachable!</span><span class="p">(),</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">replace</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">State</span>::<span class="n">Gone</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">t</span><span class="p">,</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">unreachable!</span><span class="p">(),</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)).</span><span class="n">into</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>å®è¯è¯´ã€‚ã€‚ã€‚æˆ‘çœ‹è¿‡æ›´ç³Ÿçš„ä»£ç ã€‚å®ƒåªæ˜¯æ²¡é‚£ä¹ˆ<a href="https://en.wikipedia.org/wiki/Don%27t%5Frepeat%5Fyourself">DRY</a>ã€‚</p>
<p>éå¸¸å¥½çš„å®ç°ï¼</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:52:24.097<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Joining...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:52:25.050<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:52:25.061<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:52:25.061<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
</code></pre></div>

<p>çœ‹ï¼Œåªæœ‰ 11ms çš„é—´éš”ã€‚</p>
<h3 id="æ›´è¿›ä¸€æ­¥">æ›´è¿›ä¸€æ­¥ï¼Ÿ</h3>
<p>è¿™æ®µä»£ç å†æ¬¡å›°æ‰°äº†æˆ‘ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="nc">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">a</span>: <span class="nc">State</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">b</span>: <span class="nc">State</span><span class="o">&lt;</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>å› ä¸ºç°åœ¨ <code>a</code> å’Œ <code>b</code> æ˜¯ä¸‰æ€çš„ï¼ˆtri-stateï¼‰ï¼š <code>Future</code> ã€ <code>Ok</code> æˆ–è€… <code>Gone</code> ã€‚</p>
<p>å¦‚æœ <code>a</code> å’Œ <code>b</code> éƒ½æ˜¯ <code>Gone</code> å‘¢ï¼Ÿè¿™ä¸ªçŠ¶æ€ä¸åˆç†ï¼</p>
<p>å¦‚æœå‘ç”Ÿäº†è¿™ä¸ªçŠ¶æ€ï¼Œæˆ‘ä»¬ç°åœ¨å°†ä¼šæ°¸è¿œè¿”å› <code>Poll::Pending</code> -- è¿™ä¸å¤ªå¥½ -- ä¸€ä¸ªæ­»é”ã€‚</p>
<p>æˆ‘ä»¬çœŸæ­£æƒ³è¦çš„æ˜¯ã€‚ã€‚ã€‚ä¸¤ä¸ªæšä¸¾ã€‚å®é™…ä¸Šæˆ‘ä»¬æƒ³è¦æ•´ä¸ª <code>TryJoin</code> ç±»å‹æ˜¯ä¸€ä¸ª <code>enum</code> ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="k">enum</span> <span class="nc">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Polling</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">a</span>: <span class="nc">State</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">b</span>: <span class="nc">State</span><span class="o">&lt;</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">Done</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>åƒè¿™æ ·åˆå§‹åŒ–ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">try_join</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">B</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">),</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">TryJoin</span>::<span class="n">Polling</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">a</span>: <span class="nc">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>
<span class="w">        </span><span class="n">b</span>: <span class="nc">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">b</span><span class="p">),</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>ç„¶åï¼Œsurpriceï¼ <code>Poll&lt;T&gt;</code> å®ç°äº† <a href="https://doc.rust-lang.org/stable/std/ops/trait.Try.html">Try</a> traitã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>?</code> ã€‚
æ‰€ä»¥æœ€ç»ˆæˆ‘ä»¬çš„ä»£ç å®é™…ä¸Šéå¸¸çŸ­å°ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">),</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_unchecked_mut</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">Self</span>::<span class="n">Polling</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">),</span>
<span class="w">            </span><span class="bp">Self</span>::<span class="n">Done</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">panic!</span><span class="p">(</span><span class="s">&quot;TryJoin future polled after completion&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">fut</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="n">fut</span><span class="p">)</span><span class="w"> </span><span class="p">}.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">res</span><span class="o">?</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">fut</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="n">fut</span><span class="p">)</span><span class="w"> </span><span class="p">}.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">*</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">res</span><span class="o">?</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">(</span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">),</span><span class="w"> </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">replace</span><span class="p">(</span><span class="n">this</span><span class="p">,</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Done</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">Self</span>::<span class="n">Polling</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">a</span>: <span class="nc">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>
<span class="w">                    </span><span class="n">b</span>: <span class="nc">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">b</span><span class="p">),</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)).</span><span class="n">into</span><span class="p">(),</span>
<span class="w">                </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">unreachable!</span><span class="p">(),</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>ç°åœ¨ï¼Œæˆ‘çŸ¥é“ä½ åœ¨æƒ³ä»€ä¹ˆã€‚ <code>Pin&lt;&amp;mut T&gt;</code> ä¸æ˜¯æ°æ°ç”¨æ¥é¿å…åƒ <code>std::mem::swap</code> å’Œ <code>std::mem::replace</code> å—ï¼Ÿ
è¿™äº›æ‰€æœ‰çš„è½¬ç§»ï¼ˆmoveï¼‰éƒ½æ˜¯å›´ç»•ç€å†…å­˜ï¼è¿™æ˜¯è¢«ç¦æ­¢çš„ï¼æ˜¯çš„ï¼Œæˆ‘ä»¬æ‰¿è¯ºäº†ä¸å»è½¬ç§»ï¼ˆmoveï¼‰å®ƒã€‚
ä½†æ˜¯åœ¨è¿™ä¸ªæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªæ˜¯åœ¨å®Œæˆè½®è¯¢ä¸¤ä¸ª future å¯¹è±¡åè½¬ç§»äº† <code>self</code> / <code>this</code> ã€‚</p>
<p>ç„¶åæˆ‘ä»¬å°±å†ä¹Ÿæ²¡æœ‰ä½¿ç”¨è¿‡ä¸¤ä¸ª future å¯¹è±¡ï¼Œæ— è®ºå›ºå®šè¿˜æ˜¯éå›ºå®šã€‚åŒæ—¶æˆ‘ä»¬ä»æ¥ä¹Ÿæ²¡ä¿è¯è¿‡ç»“æœè‡ªèº«æ˜¯å¦å°†è¦è¢«å›ºå®šï¼ˆpinnedï¼‰ï¼</p>
<p>æˆ‘ä»¬åªéœ€è¦å†³å®šæŸäº›ä¸œè¥¿æ˜¯â€œæ°¸è¿œå›ºå®šâ€è¿˜æ˜¯â€œæ°¸ä¸å›ºå®šâ€ï¼Œç„¶åæˆ‘ä»¬å¯èƒ½ä¼šç¼–å†™ç»“æœæ­£ç¡®çš„ä»£ç ã€‚</p>
<p>åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸‹ï¼Œåªæœ‰ <code>TryJoin::Polling(State::Future(_))</code> å°±æ˜¯â€œæ°¸è¿œå›ºå®šâ€ çš„ï¼Œå…¶ä»–éƒ½ä¸æ˜¯ã€‚</p>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬å¿«é€Ÿçš„ä» <code>Pin&lt;&amp;mut Self&gt;</code> åˆ‡æ¢åˆ° <code>&amp;mut Self</code> ï¼Œç„¶ååˆå›åˆ° <code>Pin&lt;&amp;mut A&gt;</code> ï¼Œ
ä½†åªè¦æˆ‘ä»¬ä¸è¦åœ¨ä¸­é—´ç§»åŠ¨å°±æ²¡æœ‰é—®é¢˜ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬åœ¨æŒæœ‰ future å¯¹è±¡çš„æƒ…å†µä¸‹ä½¿ç”¨ <code>std::mem:replace</code> æˆ– <code>std::mem::swap</code> å°±ä¼šä¸å¦™ã€‚
æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜å¥½ï¼Œæˆ‘æƒ³ï¼Œæˆ‘ä¸å¤ªç¡®å®šã€‚å¦‚æœä¸æ˜¯ï¼Œæœ‰äººåº”è¯¥ä¼šç•™è¨€ã€‚</p>
<h3 id="å°±è¿™æ ·">å°±è¿™æ ·</h3>
<p>è®©æˆ‘ä»¬å›é¡¾æˆ‘ä»¬çš„å·¥ä½œï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in `src/tj.rs`</span>

<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">future</span>::<span class="n">Future</span><span class="p">,</span>
<span class="w">    </span><span class="n">pin</span>::<span class="n">Pin</span><span class="p">,</span>
<span class="w">    </span><span class="n">task</span>::<span class="p">{</span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">Poll</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">try_join</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">B</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">),</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">TryJoin</span>::<span class="n">Polling</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">a</span>: <span class="nc">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>
<span class="w">        </span><span class="n">b</span>: <span class="nc">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">b</span><span class="p">),</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="nc">State</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">F</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Future</span><span class="p">(</span><span class="n">F</span><span class="p">),</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">T</span><span class="p">),</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="nc">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Polling</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">a</span>: <span class="nc">State</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">b</span>: <span class="nc">State</span><span class="o">&lt;</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">Done</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">),</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_unchecked_mut</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">Self</span>::<span class="n">Polling</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">),</span>
<span class="w">            </span><span class="bp">Self</span>::<span class="n">Done</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">panic!</span><span class="p">(</span><span class="s">&quot;TryJoin future polled after completion&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">fut</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="n">fut</span><span class="p">)</span><span class="w"> </span><span class="p">}.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">res</span><span class="o">?</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">fut</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="n">fut</span><span class="p">)</span><span class="w"> </span><span class="p">}.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">*</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">res</span><span class="o">?</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">(</span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">),</span><span class="w"> </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">replace</span><span class="p">(</span><span class="n">this</span><span class="p">,</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Done</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">Self</span>::<span class="n">Polling</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">a</span>: <span class="nc">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>
<span class="w">                    </span><span class="n">b</span>: <span class="nc">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">b</span><span class="p">),</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)).</span><span class="n">into</span><span class="p">(),</span>
<span class="w">                </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">unreachable!</span><span class="p">(),</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>è¿˜æœ‰æˆ‘ä»¬å°å°çš„ HTTPS å®¢æˆ·ç«¯ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in `src/main.rs`</span>

<span class="k">use</span><span class="w"> </span><span class="n">color_eyre</span>::<span class="n">Report</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="p">{</span><span class="n">net</span>::<span class="n">SocketAddr</span><span class="p">,</span><span class="w"> </span><span class="n">sync</span>::<span class="n">Arc</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">tokio</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">io</span>::<span class="p">{</span><span class="n">AsyncReadExt</span><span class="p">,</span><span class="w"> </span><span class="n">AsyncWriteExt</span><span class="p">},</span>
<span class="w">    </span><span class="n">net</span>::<span class="n">TcpStream</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">tokio_rustls</span>::<span class="p">{</span><span class="n">rustls</span>::<span class="n">ClientConfig</span><span class="p">,</span><span class="w"> </span><span class="n">TlsConnector</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">tracing</span>::<span class="n">info</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">tracing_subscriber</span>::<span class="n">EnvFilter</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">webpki</span>::<span class="n">DNSNameRef</span><span class="p">;</span>

<span class="k">mod</span> <span class="nn">tj</span><span class="p">;</span>

<span class="cp">#[tokio::main(flavor = </span><span class="s">&quot;current_thread&quot;</span><span class="cp">)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Joining...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tj</span>::<span class="n">try_join</span><span class="p">(</span><span class="n">fetch_thing</span><span class="p">(</span><span class="s">&quot;first&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="s">&quot;second&quot;</span><span class="p">)).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">?</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;All done!&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="cp">#[allow(dead_code)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">fetch_thing</span><span class="p">(</span><span class="n">name</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// look out it&#39;s port 443 now</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">addr</span>: <span class="nc">SocketAddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">443</span><span class="p">).</span><span class="n">into</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TcpStream</span>::<span class="n">connect</span><span class="p">(</span><span class="n">addr</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// establish a TLS session...</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">connector</span>: <span class="nc">TlsConnector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClientConfig</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">config</span>
<span class="w">            </span><span class="p">.</span><span class="n">root_store</span>
<span class="w">            </span><span class="p">.</span><span class="n">add_server_trust_anchors</span><span class="p">(</span><span class="o">&amp;</span><span class="n">webpki_roots</span>::<span class="n">TLS_SERVER_ROOTS</span><span class="p">);</span>
<span class="w">        </span><span class="n">Arc</span>::<span class="n">new</span><span class="p">(</span><span class="n">config</span><span class="p">).</span><span class="n">into</span><span class="p">()</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">dnsname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DNSNameRef</span>::<span class="n">try_from_ascii_str</span><span class="p">(</span><span class="s">&quot;one.one.one.one&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connector</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dnsname</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// we&#39;re writing straight to the socket, there&#39;s no buffering</span>
<span class="w">    </span><span class="c1">// so no need to flush</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;GET / HTTP/1.1</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;Host: one.one.one.one</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;User-Agent: cool-bear</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;Connection: close</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">with_capacity</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">read_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">response</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">lines</span><span class="p">().</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap_or_default</span><span class="p">();</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Got response!&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// dropping the socket will close the connection</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">setup</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">var</span><span class="p">(</span><span class="s">&quot;RUST_LIB_BACKTRACE&quot;</span><span class="p">).</span><span class="n">is_err</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="s">&quot;RUST_LIB_BACKTRACE&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">color_eyre</span>::<span class="n">install</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">var</span><span class="p">(</span><span class="s">&quot;RUST_LOG&quot;</span><span class="p">).</span><span class="n">is_err</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="s">&quot;RUST_LOG&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;info&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">tracing_subscriber</span>::<span class="n">fmt</span>::<span class="n">fmt</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">with_env_filter</span><span class="p">(</span><span class="n">EnvFilter</span>::<span class="n">from_default_env</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">init</span><span class="p">();</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>And it works.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="m">00</span>:08:13.399<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Joining...
Jul<span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="m">00</span>:08:13.707<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="m">00</span>:08:13.709<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="m">00</span>:08:13.710<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
</code></pre></div>

<p>2ms é—´éš”ï¼è¿™æ˜¯ä¸€ä¸ªæ–°çš„è®°å½•ã€‚</p>
            </section>

            <section class="post-info">
                <div class="post-share">
                    <a class="twitter" href="https://twitter.com/share?text=ã€è¯‘ã€‘æ·±å…¥ç†è§£ Rust future&amp;url=https://www.linuxzen.com/understanding-rust-futures-by-going-way-too-deep.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <i class="ic ic-twitter"></i><span class="hidden">Twitter</span>
                    </a>
                    <a class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.linuxzen.com/understanding-rust-futures-by-going-way-too-deep.html" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <i class="ic ic-facebook"></i><span class="hidden">Facebook</span>
                    </a>
                    <a class="googleplus" href="https://plus.google.com/share?url=https://www.linuxzen.com/understanding-rust-futures-by-going-way-too-deep.html" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <i class="ic ic-googleplus"></i><span class="hidden">Google+</span>
                    </a>
                    <div class="clear"></div>
                </div>

                <aside class="post-tags">
<a href="https://www.linuxzen.com/tag/rust.html">Rust</a><a href="https://www.linuxzen.com/tag/future.html">future</a><a href="https://www.linuxzen.com/tag/tokio.html">tokio</a>                </aside>

                <div class="clear"></div>

                <aside class="post-author">


                        <figure class="post-author-avatar">
                            <img src="https://s.gravatar.com/avatar/4d0bc04ed0e44ab750ba32b5224101d7?s=200" alt="Gray King" />
                        </figure>
                    <div class="post-author-bio">
                        <h4 class="post-author-name"><a href="https://www.linuxzen.com/author/cold.html">Gray King</a></h4>
                            <p class="post-author-about">çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œç»çŸ¥æ­¤äº‹è¦èº¬è¡Œ</p>
                            <span class="post-author-location"><i class="ic ic-location"></i> Beijing</span>
                            <span class="post-author-website"><a href="https://github.com/coldnight"><i class="ic ic-link"></i> Website</a></span>
                        <!-- Social linkes in alphabet order. -->
                    </div>
                    <div class="clear"></div>
                </aside>

                </section>

                <script type="text/javascript">
                    var disqus = 'linuxzen';
                    var disqus_shortname = 'linuxzen';
                    var disqus_identifier = '/understanding-rust-futures-by-going-way-too-deep.html';
                    var disqus_url = 'https://www.linuxzen.com/understanding-rust-futures-by-going-way-too-deep.html';
                </script>
                <noscript>Please enable JavaScript to view the comments.</noscript>
                <section class="post-comments">
                        <a id="show-disqus" class="post-comments-activate" data-disqus-identifier="/understanding-rust-futures-by-going-way-too-deep.html" >Show Comments</a>
                    <div id="disqus_thread"></div>
                </section>

                <aside class="post-nav">
                    <div class="clear"></div>
                </aside>

            </div>
        </article>
    </main>
      <!-- TODO : Body class -->
    <div id="body-class" style="display: none;" class=""></div>

    <footer id="footer">
      <div class="inner">
        <section class="credits">


          <span class="credits-theme">Theme <a href="https://github.com/arulrajnet/attila" rel="nofollow">Attila</a></span>
          <span class="credits-software">Published with <a href="https://github.com/getpelican/pelican" rel="nofollow">Pelican</a></span>
        </section>
      </div>
    </footer>
  </section>

  <script src="https://ajax.googleapis.cnpmjs.org/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.2/build/highlight.min.js"></script>
  <script type="text/javascript" src="https://www.linuxzen.com/theme/js/script.js"></script>

    <script type="text/javascript">
        var pkBaseURL = "piwik.linuxzen.com";
    var _paq = _paq || [];
    _paq.push(["trackPageView"]);
    _paq.push(["enableLinkTracking"]);
    (function() {
        var u=(("https:" == document.location.protocol) ? "https" : "http")+"://"+pkBaseURL+"/";
        _paq.push(["setTrackerUrl", u+"piwik.php"]);
        _paq.push(["setSiteId", "2"]);
        var d=document, g=d.createElement("script"), s=d.getElementsByTagName("script")[0]; g.type="text/javascript";
        g.defer=true; g.async=true; g.src=u+"piwik.js"; s.parentNode.insertBefore(g,s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'linuxzen';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>