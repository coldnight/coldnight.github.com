<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />


  <title>【译】深入理解 Rust future</title>

  <meta name="description" content="博主一个爱好开源技术的人，对 Python 比较熟悉，也喜欢用 Python 捣腾一些东西，本博主要分享一些开源技术，其中包括但不限于 Linux/Python/Vim。" />

  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="origin" />
  <meta name="generator" content="Pelican" />

  <link rel="shortcut icon" href="/favicon.ico" type="image/vnd.microsoft.icon" />
  <link rel="icon" href="/favicon.ico" type="image/vnd.microsoft.icon" />

<link href="https://www.linuxzen.com/understanding-rust-futures-by-going-way-too-deep.html" rel="canonical" />
  <!-- Feed -->
      <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="cold's world Full Atom Feed" />

  <link href="https://www.linuxzen.com/theme/css/style.css" type="text/css" rel="stylesheet" />

  <!-- Code highlight color scheme -->
      <link href="https://www.linuxzen.com/theme/css/code_blocks/tomorrow.css" rel="stylesheet">

    <!-- CSS specified by the user -->


    <link href="https://www.linuxzen.com/static/css/wide.css" type="text/css" rel="stylesheet" />

  <!-- Custom fonts -->
  <link href='https://fonts.googleapis.cnpmjs.org/css?family=Montserrat:400,300' rel='stylesheet' type='text/css' />
  <link href="https://fonts.googleapis.cnpmjs.org/css?family=Lato" rel="stylesheet" type="text/css" />

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->



    <meta name="description" content="原文链接：Understanding Rust futures by going way too deep。 译者注：原文大量的引入了有趣的对话，迫于排版问题这里不进行翻译，必要的对话通过引用 …">

    <meta name="author" content="cold">

    <meta name="tags" content="Rust">
    <meta name="tags" content="future">
    <meta name="tags" content="tokio">




<!-- Open Graph -->
<meta property="og:site_name" content="cold's world"/>
<meta property="og:title" content="【译】深入理解 Rust future"/>
<meta property="og:description" content="原文链接：Understanding Rust futures by going way too deep。 译者注：原文大量的引入了有趣的对话，迫于排版问题这里不进行翻译，必要的对话通过引用 …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://www.linuxzen.com/understanding-rust-futures-by-going-way-too-deep.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2021-07-29 00:00:00+08:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://www.linuxzen.com/author/cold.html">
<meta property="article:section" content="Rust"/>
<meta property="article:tag" content="Rust"/>
<meta property="article:tag" content="future"/>
<meta property="article:tag" content="tokio"/>
<meta property="og:image" content="https://www.linuxzen.com/theme/images/post-bg.jpg">

<!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@grayking_w">
    <meta name="twitter:title" content="【译】深入理解 Rust future">
    <meta name="twitter:url" content="https://www.linuxzen.com/understanding-rust-futures-by-going-way-too-deep.html">

        <meta name="twitter:image:src" content="https://www.linuxzen.com/theme/images/post-bg.jpg">

      <meta name="twitter:description" content="原文链接：Understanding Rust futures by going way too deep。 译者注：原文大量的引入了有趣的对话，迫于排版问题这里不进行翻译，必要的对话通过引用 …">

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "【译】深入理解 Rust future",
  "headline": "【译】深入理解 Rust future",
  "datePublished": "2021-07-29 00:00:00+08:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "cold",
    "url": "https://www.linuxzen.com/author/cold.html"
  },
  "image": "https://www.linuxzen.com/theme/images/post-bg.jpg",
  "url": "https://www.linuxzen.com/understanding-rust-futures-by-going-way-too-deep.html",
  "description": "原文链接：Understanding Rust futures by going way too deep。 译者注：原文大量的引入了有趣的对话，迫于排版问题这里不进行翻译，必要的对话通过引用 …"
}
</script>
</head>
<!-- TODO : Body class -->
<body class="home-template">

<nav id="menu">
  <a class="close-button">Close</a>
  <div class="nav-wrapper">
    <p class="nav-label">Menu</p>
    <ul>
          <li><a href="/notes/" role="presentation">Zettelkasten</a></li>

                  <li role="presentation"><a href="https://www.linuxzen.com/category/git.html">Git</a></li>
                  <li role="presentation"><a href="https://www.linuxzen.com/category/go.html">Go</a></li>
                  <li role="presentation"><a href="https://www.linuxzen.com/category/linux.html">Linux</a></li>
                  <li role="presentation"><a href="https://www.linuxzen.com/category/other.html">Other</a></li>
                  <li role="presentation"><a href="https://www.linuxzen.com/category/pyqt.html">PyQt</a></li>
                  <li role="presentation"><a href="https://www.linuxzen.com/category/python.html">Python</a></li>
                  <li class="nav-rust active" role="presentation"><a href="https://www.linuxzen.com/category/rust.html">Rust</a></li>
                  <li role="presentation"><a href="https://www.linuxzen.com/category/tech.html">Tech</a></li>
                  <li role="presentation"><a href="https://www.linuxzen.com/category/vim.html">Vim</a></li>

        <li class="nav-rss"><a href="/feeds/all.atom.xml"><i class="ic ic-rss"></i> Subscribe</a></li>
    </ul>
  </div>
</nav>
    <!-- Progressbar -->
    <div class="progress-container">
        <span class="progress-bar"></span>
    </div>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header id="post-header" >
      <div class="inner">
        <nav id="navigation">
            <span id="home-button" class="nav-button">
                <a class="home-button" href="https://www.linuxzen.com/" title="Home"><i class="ic ic-arrow-left"></i> Home</a>
            </span>
          <span id="menu-button" class="nav-button">
            <a class="menu-button"><i class="ic ic-menu"></i> Menu</a>
          </span>
        </nav>
        <h1 class="post-title">【译】深入理解 Rust future</h1>
        <!-- TODO : Proper class for headline -->
        <span class="post-meta">
                <a href="https://www.linuxzen.com/author/cold.html">Gray King</a>
            | <time datetime="Thu 29 July 2021">Thu 29 July 2021</time>
        </span>
        <!-- TODO : Modified check -->
      </div>
    </header>

  <section id="wrapper">
    <a class="hidden-close"></a>

    <!-- Post content -->
    <main class="content" role="main">
        <article class="post">
        <div class="inner">
            <section class="post-content">
                <p>原文链接：<a href="https://fasterthanli.me/articles/understanding-rust-futures-by-going-way-too-deep">Understanding Rust futures by going way too deep</a>。</p>
<p>译者注：原文大量的引入了有趣的对话，迫于排版问题这里不进行翻译，必要的对话通过引用块来解释。</p>
<h2 id="深入理解-rust-future">深入理解 Rust future</h2>
<p>用 Rust future！就是这么简单！直到我们发现并非如此。所以我们先探索简单的部分，然后继续探索困难部分而不是等它慢慢靠近我们。</p>
<h2 id="起步">起步</h2>
<blockquote>
<p>Choo choo here comes the easy part 🚂💨</p>
</blockquote>
<p>我们创建一个新的项目：</p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">waytoodeep</span>
<span class="w">     </span><span class="n">Created</span><span class="w"> </span><span class="kt">binary</span><span class="w"> </span><span class="p">(</span><span class="n">application</span><span class="p">)</span><span class="w"> </span><span class="n n-Quoted">`waytoodeep`</span><span class="w"> </span><span class="n">package</span>
</code></pre></div>

<p>我们需要安装 <code>cargo-edit</code> 如果之前没有安装过的话，接下来就可以直接 <code>cargo add</code> ：</p>
<div class="highlight"><pre><span></span><code><span class="o">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">cargo</span><span class="o">-</span><span class="n">edit</span>
<span class="w">    </span><span class="n">Updating</span><span class="w"> </span><span class="n">crates</span><span class="o">.</span><span class="n">io</span><span class="w"> </span><span class="n">index</span>
<span class="w">  </span><span class="n">Downloaded</span><span class="w"> </span><span class="n">cargo</span><span class="o">-</span><span class="n">edit</span><span class="w"> </span><span class="n">v0</span><span class="o">.</span><span class="mf">7.0</span>
<span class="w">  </span><span class="n">Downloaded</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">crate</span><span class="w"> </span><span class="p">(</span><span class="mf">57.6</span><span class="w"> </span><span class="n">KB</span><span class="p">)</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.47</span><span class="n">s</span>
<span class="w">     </span><span class="n">Ignored</span><span class="w"> </span><span class="n">package</span><span class="w"> </span><span class="err">`</span><span class="n">cargo</span><span class="o">-</span><span class="n">edit</span><span class="w"> </span><span class="n">v0</span><span class="o">.</span><span class="mf">7.0</span><span class="err">`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">already</span><span class="w"> </span><span class="n">installed</span><span class="p">,</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="o">--</span><span class="n">force</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">override</span>
</code></pre></div>

<blockquote>
<p>因为 <code>cargo-edit</code> 很方便，所以你可能已经安装过它。部分读者会感到困惑是因为像
<code>cargo new</code>, <code>cargo build</code>, <code>cargo test</code>, <code>cargo run</code> 等子命令都内置在 cargo 中，
但是 <code>cargo add</code> 没有。</p>
<p>实际上，有一大堆像这样的包，如 <a href="https://lib.rs/crates/cargo-hack">cargo-hack</a>,<a href="https://lib.rs/crates/cargo-udeps">cargo-udeps</a>,<a href="https://lib.rs/crates/cargo-expand">cargo-expand</a>...<a href="https://lib.rs/keywords/cargo">等等</a>。</p>
</blockquote>
<p>然后我们需要选择一个「异步运行时」（async runtime），因为这些 future 对象不会轮询（poll）自己。。。
我们毫无理由的选择 tokio，唯一的原因是：过去几个月我一直在用它。</p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">tokio</span><span class="mf">@1.9.0</span><span class="w"> </span><span class="o">--</span><span class="n">features</span><span class="w"> </span><span class="n">full</span>
<span class="w">    </span><span class="n">Updating</span><span class="w"> </span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//github.com/rust-lang/crates.io-index&#39; index</span>
<span class="w">      </span><span class="n">Adding</span><span class="w"> </span><span class="n">tokio</span><span class="w"> </span><span class="n">v1</span><span class="mf">.9.0</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dependencies</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">features</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;full&quot;</span><span class="p">]</span>
</code></pre></div>

<p>然后我们修改 <code>main</code> 函数使用 tokio 默认执行器（executor）（ <code>cargo new</code> 为我们生成了一个 <code>main</code> 函数，但是这里并不能满足我们的需求）：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in `src/main.rs`</span>

<span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello from a (so far completely unnecessary) async runtime&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>run<span class="w">                                                                                                                                                                                          </span>3s<span class="w"> </span>209ms
<span class="w">   </span>Compiling<span class="w"> </span>waytoodeep<span class="w"> </span>v0.1.0<span class="w"> </span><span class="o">(</span>/Users/wh/codes/rust/waytoodeep<span class="o">)</span>
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.47s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
Hello<span class="w"> </span>from<span class="w"> </span>a<span class="w"> </span><span class="o">(</span>so<span class="w"> </span>far<span class="w"> </span>completely<span class="w"> </span>unnecessary<span class="o">)</span><span class="w"> </span>async<span class="w"> </span>runtime
</code></pre></div>

<p>酷！</p>
<p>接下来让我们添加其他一些我喜欢在我的项目中使用的好东西。</p>
<p>首先，对于错误处理 - 我们编写程序就需要处理一堆不同库里不同的错误类型，如果能通过一个类型统一它们就会非常整洁。</p>
<p><a href="https://lib.rs/crates/eyre">eyre</a> 可以赋予我们这些（就像 <code>anyhow</code> ）！</p>
<p>并且因为我喜欢漂亮的颜色我将使用 <a href="https://lib.rs/crates/color-eyre">color-eyre</a>。</p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">color</span><span class="o">-</span><span class="n">eyre</span><span class="mf">@0.5.11</span>
<span class="w">    </span><span class="n">Updating</span><span class="w"> </span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//github.com/rust-lang/crates.io-index&#39; index</span>
<span class="w">      </span><span class="n">Adding</span><span class="w"> </span><span class="n">color</span><span class="o">-</span><span class="n">eyre</span><span class="w"> </span><span class="n">v0</span><span class="mf">.5.11</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dependencies</span>
</code></pre></div>

<p>现在我们需要安装 <code>color-eyre</code> 作为默认的崩溃（panic）处理器，我悄悄修改了一些环境变量来默认输出调用堆栈（backtracks）。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">color_eyre</span>::<span class="n">Report</span><span class="p">;</span>

<span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Hello from a (so far completely unnecessary) async runtime&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">setup</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">var</span><span class="p">(</span><span class="s">&quot;RUST_LIB_BACKTRACE&quot;</span><span class="p">).</span><span class="n">is_err</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="s">&quot;RUST_LIB_BACKTRACE&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">color_eyre</span>::<span class="n">install</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>run
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.02s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
Hello<span class="w"> </span>from<span class="w"> </span>a<span class="w"> </span><span class="o">(</span>so<span class="w"> </span>far<span class="w"> </span>completely<span class="w"> </span>unnecessary<span class="o">)</span><span class="w"> </span>async<span class="w"> </span>runtime
</code></pre></div>

<p>很好！现在如果我们某处出现了一个错误，我们将看到完整的堆栈跟踪，就像下面这样：
<img alt="" src="https://fasterthanli.me/content/articles/understanding-rust-futures-by-going-way-too-deep/assets/color-eyre.78931d5fc80841f6.webp"></p>
<p>最后，因为我喜欢结构化日志，让我们添加 <a href="https://lib.rs/crates/tracing">tracing</a> 然后通过漂亮的颜色打印它们，让我们添加 <a href="https://lib.rs/crates/tracing-subscriber">tracing-subscriber</a>.</p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">tracing</span><span class="mf">@0.1.26</span><span class="w"> </span><span class="n">tracing</span><span class="o">-</span><span class="n">subscriber</span><span class="mf">@0.2.19</span>
<span class="w">    </span><span class="n">Updating</span><span class="w"> </span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//github.com/rust-lang/crates.io-index&#39; index</span>
<span class="w">      </span><span class="n">Adding</span><span class="w"> </span><span class="n">tracing</span><span class="w"> </span><span class="n">v0</span><span class="mf">.1.26</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dependencies</span>
<span class="w">      </span><span class="n">Adding</span><span class="w"> </span><span class="n">tracing</span><span class="o">-</span><span class="n">subscriber</span><span class="w"> </span><span class="n">v0</span><span class="mf">.2.19</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dependencies</span>
</code></pre></div>

<p>我们已经有一个 <code>setup</code> 函数，所以直接在那里安装 <code>tracing-subscriber</code>.. 然后我们将 <code>println!</code> 改成 <code>info!</code> ！
然后，为了演示如何设置让我们再次修改一些环境变量：对所有包（crates）默认 <code>info</code> 日志级别。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">color_eyre</span>::<span class="n">Report</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">tracing</span>::<span class="n">info</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">tracing_subscriber</span>::<span class="n">EnvFilter</span><span class="p">;</span>

<span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Hello from a comfy nest we&#39;ve made for ourselves&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">setup</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">var</span><span class="p">(</span><span class="s">&quot;RUST_LIB_BACKTRACE&quot;</span><span class="p">).</span><span class="n">is_err</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="s">&quot;RUST_LIB_BACKTRACE&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">color_eyre</span>::<span class="n">install</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">var</span><span class="p">(</span><span class="s">&quot;RUST_LOG&quot;</span><span class="p">).</span><span class="n">is_err</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="s">&quot;RUST_LOG&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;info&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">tracing_subscriber</span>::<span class="n">fmt</span>::<span class="n">fmt</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">with_env_filter</span><span class="p">(</span><span class="n">EnvFilter</span>::<span class="n">from_default_env</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">init</span><span class="p">();</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>run
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.02s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:03:46.993<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Hello<span class="w"> </span>from<span class="w"> </span>a<span class="w"> </span>comfy<span class="w"> </span>nest<span class="w"> </span>we<span class="err">&#39;</span>ve<span class="w"> </span>made<span class="w"> </span><span class="k">for</span><span class="w"> </span>ourselves
</code></pre></div>

<p>好了，我们准备好做一些有用的事情了。</p>
<h3 id="做一些有用的事情">做一些有用的事情</h3>
<p>当决定在咖啡间隙阅读哪一篇文章的时候，人们通常同时打开几个网站，然后读最先加载出来的那一篇。</p>
<p>事实如此。你可以引用我的话，谁会去验证呢？毕竟这听起来需要很多工作。</p>
<p>所以让我们来编写一个程序做相同的事情。</p>
<p>让我们引入 <a href="https://lib.rs/crates/reqwest">reqwest</a> -- 尽管我不喜欢它的 API，但它会很好的完成接下来的工作。</p>
<p>同时，因为 <a href="https://www.openssl.org/news/vulnerabilities.html">screw OpenSSL</a> 我们将标记 reqwest 使用 <a href="https://lib.rs/crates/rustls">rustls</a>：</p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">reqwest</span><span class="mf">@0.11.4</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="k">default</span><span class="o">-</span><span class="n">features</span><span class="w"> </span><span class="o">--</span><span class="n">features</span><span class="w"> </span><span class="n">rustls</span><span class="o">-</span><span class="n">tls</span>
<span class="w">    </span><span class="n">Updating</span><span class="w"> </span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//github.com/rust-lang/crates.io-index&#39; index</span>
<span class="w">      </span><span class="n">Adding</span><span class="w"> </span><span class="n">reqwest</span><span class="w"> </span><span class="n">v0</span><span class="mf">.11.4</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dependencies</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">features</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;rustls-tls&quot;</span><span class="p">]</span>
</code></pre></div>

<p>我们准备好发送一个请求了！</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">color_eyre</span>::<span class="n">Report</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">tracing</span>::<span class="n">info</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">tracing_subscriber</span>::<span class="n">EnvFilter</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">reqwest</span>::<span class="n">Client</span><span class="p">;</span>

<span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Hello from a comfy nest we&#39;ve made for ourselves&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;https://fasterthanli.me&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// this will turn non-200 HTTP status codes into rust errors,</span>
<span class="w">    </span><span class="c1">// so the first `?` propagates &quot;we had a connection problem&quot; and</span>
<span class="w">    </span><span class="c1">// the second `?` propagates &quot;we had a chat with the server and they</span>
<span class="w">    </span><span class="c1">// were not pleased&quot;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">send</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">.</span><span class="n">error_for_status</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">content_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="n">res</span><span class="p">.</span><span class="n">headers</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;content-type&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Got a response!&quot;</span><span class="p">);</span>


<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">setup</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">var</span><span class="p">(</span><span class="s">&quot;RUST_LIB_BACKTRACE&quot;</span><span class="p">).</span><span class="n">is_err</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="s">&quot;RUST_LIB_BACKTRACE&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">color_eyre</span>::<span class="n">install</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">var</span><span class="p">(</span><span class="s">&quot;RUST_LOG&quot;</span><span class="p">).</span><span class="n">is_err</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="s">&quot;RUST_LOG&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;info&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">tracing_subscriber</span>::<span class="n">fmt</span>::<span class="n">fmt</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">with_env_filter</span><span class="p">(</span><span class="n">EnvFilter</span>::<span class="n">from_default_env</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">init</span><span class="p">();</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>出发了！</p>
<div class="highlight"><pre><span></span><code><span class="nt">cargo</span><span class="w"> </span><span class="nt">run</span>
<span class="w">   </span><span class="nt">Compiling</span><span class="w"> </span><span class="nt">waytoodeep</span><span class="w"> </span><span class="nt">v0</span><span class="p">.</span><span class="nc">1</span><span class="p">.</span><span class="nc">0</span><span class="w"> </span><span class="o">(/</span><span class="nt">Users</span><span class="o">/</span><span class="nt">wh</span><span class="o">/</span><span class="nt">codes</span><span class="o">/</span><span class="nt">rust</span><span class="o">/</span><span class="nt">waytoodeep</span><span class="o">)</span>
<span class="w">    </span><span class="nt">Finished</span><span class="w"> </span><span class="nt">dev</span><span class="w"> </span><span class="cp">[</span><span class="nx">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">debuginfo</span><span class="cp">]</span><span class="w"> </span><span class="nt">target</span><span class="o">(</span><span class="nt">s</span><span class="o">)</span><span class="w"> </span><span class="nt">in</span><span class="w"> </span><span class="nt">7</span><span class="p">.</span><span class="nc">16s</span>
<span class="w">     </span><span class="nt">Running</span><span class="w"> </span><span class="err">`</span><span class="nt">target</span><span class="o">/</span><span class="nt">debug</span><span class="o">/</span><span class="nt">waytoodeep</span><span class="err">`</span>
<span class="nt">Jul</span><span class="w"> </span><span class="nt">26</span><span class="w"> </span><span class="nt">16</span><span class="p">:</span><span class="nd">50</span><span class="p">:</span><span class="nd">57</span><span class="p">.</span><span class="nc">778</span><span class="w">  </span><span class="nt">INFO</span><span class="w"> </span><span class="nt">waytoodeep</span><span class="o">:</span><span class="w"> </span><span class="nt">Hello</span><span class="w"> </span><span class="nt">from</span><span class="w"> </span><span class="nt">a</span><span class="w"> </span><span class="nt">comfy</span><span class="w"> </span><span class="nt">nest</span><span class="w"> </span><span class="nt">we</span><span class="err">&#39;</span><span class="nt">ve</span><span class="w"> </span><span class="nt">made</span><span class="w"> </span><span class="nt">for</span><span class="w"> </span><span class="nt">ourselves</span>
<span class="nt">Jul</span><span class="w"> </span><span class="nt">26</span><span class="w"> </span><span class="nt">16</span><span class="p">:</span><span class="nd">50</span><span class="p">:</span><span class="nd">59</span><span class="p">.</span><span class="nc">090</span><span class="w">  </span><span class="nt">INFO</span><span class="w"> </span><span class="nt">waytoodeep</span><span class="o">:</span><span class="w"> </span><span class="nt">Got</span><span class="w"> </span><span class="nt">a</span><span class="w"> </span><span class="nt">response</span><span class="o">!</span><span class="w"> </span><span class="nt">url</span><span class="o">=</span><span class="nt">https</span><span class="o">://</span><span class="nt">fasterthanli</span><span class="p">.</span><span class="nc">me</span><span class="w"> </span><span class="nt">content_type</span><span class="o">=</span><span class="nt">Some</span><span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
</code></pre></div>

<p>这就是我所说的「结构化日志」。嗯，其中的一部分。让我们看下这行代码：</p>
<div class="highlight"><pre><span></span><code><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">content_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="n">res</span><span class="p">.</span><span class="n">headers</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;content-type&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Got a response!&quot;</span><span class="p">);</span>
</code></pre></div>

<p>我们输出来一个消息： <code>Got a response!</code> ，一个名为 <code>url</code> 的标签：值为变量 <code>url</code> 的 <a href="https://doc.rust-lang.org/stable/std/fmt/trait.Display.html">Display</a> 格式，
一个名为 <code>content_type</code> 的标签：值为表达式的 <a href="https://doc.rust-lang.org/stable/std/fmt/trait.Debug.html">Debug</a> 格式。</p>
<p>就是这么简单！ <code>name = %value</code> 输出 <code>Display</code> ， <code>name = ?value</code> 输出 <code>Debug</code> 。</p>
<p>当然，还有非常棒的跨度（spans），重点是你可以将它们发送到 APM（Appliation Performance Monitoring），比如 Datadog 或者 Honeycomb 等，但是这不是一篇关于跟踪的文章。</p>
<p>为了举例说明，如果我们安装一个 JSON 的 tracing subscriber，我们将获得如下内容：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>run
<span class="w">   </span>Compiling<span class="w"> </span>waytoodeep<span class="w"> </span>v0.1.0<span class="w"> </span><span class="o">(</span>/home/amos/ftl/waytoodeep<span class="o">)</span>
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.09s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
<span class="o">{</span><span class="s2">&quot;timestamp&quot;</span>:<span class="s2">&quot;Jul 25 17:17:21.531&quot;</span>,<span class="s2">&quot;level&quot;</span>:<span class="s2">&quot;INFO&quot;</span>,<span class="s2">&quot;fields&quot;</span>:<span class="o">{</span><span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;Hello from a comfy nest we&#39;ve made for ourselves&quot;</span><span class="o">}</span>,<span class="s2">&quot;target&quot;</span>:<span class="s2">&quot;waytoodeep&quot;</span><span class="o">}</span>
<span class="o">{</span><span class="s2">&quot;timestamp&quot;</span>:<span class="s2">&quot;Jul 25 17:17:21.709&quot;</span>,<span class="s2">&quot;level&quot;</span>:<span class="s2">&quot;INFO&quot;</span>,<span class="s2">&quot;fields&quot;</span>:<span class="o">{</span><span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;Got a response!&quot;</span>,<span class="s2">&quot;url&quot;</span>:<span class="s2">&quot;https://fasterthanli.me&quot;</span>,<span class="s2">&quot;content_type&quot;</span>:<span class="s2">&quot;Some(\&quot;text/html; charset=utf-8\&quot;)&quot;</span><span class="o">}</span>,<span class="s2">&quot;target&quot;</span>:<span class="s2">&quot;waytoodeep&quot;</span><span class="o">}</span>
</code></pre></div>

<p>这应该足以激起你的兴趣。</p>
<h3 id="同时获取两个地址">同时获取两个地址</h3>
<p>现在让我们获取两个地址：</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">URL_1</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&quot;https://fasterthanli.me/articles/whats-in-the-box&quot;</span><span class="p">;</span>
<span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">URL_2</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&quot;https://fasterthanli.me/series/advent-of-code-2020/part-13&quot;</span><span class="p">;</span>
</code></pre></div>

<p>。。。这是一个公平的比较。 这两篇文章都托管在我自己的网站上，绝对不是为了推广，而是为了使获取时间具有可比性，并且任一都有可能先加载完成（并且会随着时间的推移随机变化）。</p>
<p>我们将创建一个函数来获取内容：</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">fetch_thing</span><span class="p">(</span><span class="n">client</span>: <span class="kp">&amp;</span><span class="nc">Client</span><span class="p">,</span><span class="w"> </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">send</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">.</span><span class="n">error_for_status</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">content_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="n">res</span><span class="p">.</span><span class="n">headers</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;content-type&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Got a response!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>并使用它：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Hello from a comfy nest we&#39;ve made for ourselves&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">    </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_2</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>然后运行它:</p>
<div class="highlight"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">waytoodeep</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">1.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="n">ftl</span><span class="o">/</span><span class="n">waytoodeep</span><span class="p">)</span>
<span class="n">warning</span>: <span class="nc">unused</span><span class="w"> </span><span class="n">implementer</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="err">`</span><span class="n">Future</span><span class="err">`</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">used</span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">15</span>:<span class="mi">5</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">15</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="w">   </span><span class="o">|</span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="err">`</span><span class="cp">#[warn(unused_must_use)]</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">default</span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">futures</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">nothing</span><span class="w"> </span><span class="n">unless</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="err">`</span><span class="p">.</span><span class="k">await</span><span class="err">`</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">poll</span><span class="w"> </span><span class="n">them</span>

<span class="n">warning</span>: <span class="nc">unused</span><span class="w"> </span><span class="n">implementer</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="err">`</span><span class="n">Future</span><span class="err">`</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">used</span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">16</span>:<span class="mi">5</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">16</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_2</span><span class="p">);</span>
<span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="o">^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="w">   </span><span class="o">|</span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">futures</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">nothing</span><span class="w"> </span><span class="n">unless</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="err">`</span><span class="p">.</span><span class="k">await</span><span class="err">`</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">poll</span><span class="w"> </span><span class="n">them</span>

<span class="n">warning</span>: <span class="mi">2</span><span class="w"> </span><span class="n">warnings</span><span class="w"> </span><span class="n">emitted</span>

<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">3.01</span><span class="n">s</span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">waytoodeep</span><span class="err">`</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">17</span>:<span class="mi">26</span>:<span class="mf">31.571</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span>: <span class="nc">Hello</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">comfy</span><span class="w"> </span><span class="n">nest</span><span class="w"> </span><span class="n">we</span><span class="o">&#39;</span><span class="na">ve</span><span class="w"> </span><span class="n">made</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">ourselves</span>
</code></pre></div>

<p>奇怪的是，没有任何事情发生。</p>
<blockquote>
<p>黄色的波浪线和恼人的 Rust 警告已经给出了提示。</p>
</blockquote>
<p>让我们来修复它：</p>
<div class="highlight"><pre><span></span><code><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_2</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>run
<span class="w">   </span>Compiling<span class="w"> </span>waytoodeep<span class="w"> </span>v0.1.0<span class="w"> </span><span class="o">(</span>/home/amos/ftl/waytoodeep<span class="o">)</span>
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.17s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:27:29.768<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Hello<span class="w"> </span>from<span class="w"> </span>a<span class="w"> </span>comfy<span class="w"> </span>nest<span class="w"> </span>we<span class="err">&#39;</span>ve<span class="w"> </span>made<span class="w"> </span><span class="k">for</span><span class="w"> </span>ourselves
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:27:29.891<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:27:29.974<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
</code></pre></div>

<p>所以，第零课：future 对象不做任何事情直到它们被轮询（polled）。</p>
<p>这是因为 future 对象几乎就是状态。让我们来创建一个：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in `src/main.rs`</span>

<span class="k">mod</span> <span class="nn">dumb</span><span class="p">;</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1">// in `src/dumb.rs`</span>

<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">future</span>::<span class="n">Future</span><span class="p">,</span>
<span class="w">    </span><span class="n">pin</span>::<span class="n">Pin</span><span class="p">,</span>
<span class="w">    </span><span class="n">task</span>::<span class="p">{</span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">Poll</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">use</span><span class="w"> </span><span class="n">tracing</span>::<span class="n">info</span><span class="p">;</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">DumbFuture</span><span class="w"> </span><span class="p">{}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">DumbFuture</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">();</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">_cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Hello from a dumb future!&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1">// back in `src/main.rs`</span>

<span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dumb</span>::<span class="n">DumbFuture</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>以上！我们几乎就完成了，除了我们没有进行 <code>.await</code> 。</p>
<p>运行它除了打印警告不会有任何效果：</p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">waytoodeep</span><span class="w"> </span><span class="n">v0</span><span class="mf">.1.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="n">ftl</span><span class="o">/</span><span class="n">waytoodeep</span><span class="p">)</span>
<span class="n">warning</span><span class="o">:</span><span class="w"> </span><span class="n">unused</span><span class="w"> </span><span class="n">variable</span><span class="o">:</span><span class="w"> </span><span class="n n-Quoted">`fut`</span>
<span class="w">  </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mi">9</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">14</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">let</span><span class="w"> </span><span class="n">fut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dumb</span><span class="o">::</span><span class="n">DumbFuture</span><span class="w"> </span><span class="err">{}</span><span class="p">;</span>
<span class="w">   </span><span class="o">|</span><span class="w">         </span><span class="o">^^^</span><span class="w"> </span><span class="k">help</span><span class="o">:</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">intentional</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">underscore</span><span class="o">:</span><span class="w"> </span><span class="n n-Quoted">`_fut`</span>
<span class="w">   </span><span class="o">|</span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span><span class="o">:</span><span class="w"> </span><span class="n n-Quoted">`#[warn(unused_variables)]`</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">default</span>

<span class="n">warning</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">warning</span><span class="w"> </span><span class="n">emitted</span>

<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="err">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="err">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">2.11</span><span class="n">s</span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="n n-Quoted">`target/debug/waytoodeep`</span>
</code></pre></div>

<p>因为怎么可能？我们字面上仅仅构建了一个结构体。一个零大小的结构体。</p>
<p>如果我们调用它的 <code>.await</code> 。。 然后当我们要求运行时运行它的事件循环直到 future 对象被轮询（polled）并且最终返回 <code>Poll::Ready</code> （我们的代码立即返回）：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Building that dumb future...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dumb</span>::<span class="n">DumbFuture</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Awaiting that dumb future...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">fut</span><span class="p">.</span><span class="k">await</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Done awaiting that dumb future&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>run
<span class="w">   </span>Compiling<span class="w"> </span>waytoodeep<span class="w"> </span>v0.1.0<span class="w"> </span><span class="o">(</span>/home/amos/ftl/waytoodeep<span class="o">)</span>
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span>.34s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:37:09.261<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Building<span class="w"> </span>that<span class="w"> </span>dumb<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:37:09.261<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Awaiting<span class="w"> </span>that<span class="w"> </span>dumb<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:37:09.261<span class="w">  </span>INFO<span class="w"> </span>waytoodeep::dumb:<span class="w"> </span>Hello<span class="w"> </span>from<span class="w"> </span>a<span class="w"> </span>dumb<span class="w"> </span>future!
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:37:09.262<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Done<span class="w"> </span>awaiting<span class="w"> </span>that<span class="w"> </span>dumb<span class="w"> </span>future
</code></pre></div>

<p>这里与 ECMAScript 的 <code>promise</code> 有一些略微的区别：即使它们压根没有被 await 其中包含的工作依然会被执行。</p>
<p>但是 Rust 的 future 对象仅仅是无聊的状态机，如果你故意制造麻烦就可以理解这个机制：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in `src/dumb.rs`</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">DumbFuture</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">();</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">_cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">panic!</span><span class="p">(</span><span class="s">&quot;Oh heck no&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>cargo<span class="w"> </span>run
<span class="w">   </span>Compiling<span class="w"> </span>waytoodeep<span class="w"> </span>v0.1.0<span class="w"> </span><span class="o">(</span>/home/amos/ftl/waytoodeep<span class="o">)</span>
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span>.28s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:41:18.956<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Building<span class="w"> </span>that<span class="w"> </span>dumb<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:41:18.956<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Awaiting<span class="w"> </span>that<span class="w"> </span>dumb<span class="w"> </span>future...
The<span class="w"> </span>application<span class="w"> </span>panicked<span class="w"> </span><span class="o">(</span>crashed<span class="o">)</span>.
Message:<span class="w">  </span>Oh<span class="w"> </span>heck<span class="w"> </span>no
Location:<span class="w"> </span>src/dumb.rs:14

<span class="w">  </span>━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━<span class="w"> </span>BACKTRACE<span class="w"> </span>━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
<span class="w">                                </span>⋮<span class="w"> </span><span class="m">6</span><span class="w"> </span>frames<span class="w"> </span>hidden<span class="w"> </span>⋮
<span class="w">   </span><span class="m">7</span>:<span class="w"> </span>&lt;waytoodeep::dumb::DumbFuture<span class="w"> </span>as<span class="w"> </span>core::future::future::Future&gt;::poll::h4a44780628f4c5f0
<span class="w">      </span>at<span class="w"> </span>/home/amos/ftl/waytoodeep/src/dumb.rs:14
<span class="w">   </span><span class="m">8</span>:<span class="w"> </span>waytoodeep::main::<span class="o">{{</span>closure<span class="o">}}</span>::h36de5a1f1f2a5c5b
<span class="w">      </span>at<span class="w"> </span>/home/amos/ftl/waytoodeep/src/main.rs:17
<span class="w">   </span><span class="m">9</span>:<span class="w"> </span>&lt;core::future::from_generator::GenFuture&lt;T&gt;<span class="w"> </span>as<span class="w"> </span>core::future::future::Future&gt;::poll::h20a96e082c7a581e
<span class="w">      </span>at<span class="w"> </span>/home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/mod.rs:80
<span class="w">  </span><span class="m">10</span>:<span class="w"> </span>tokio::park::thread::CachedParkThread::block_on::<span class="o">{{</span>closure<span class="o">}}</span>::hdf98cb3c7fdf3de4
<span class="w">      </span>at<span class="w"> </span>/home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/park/thread.rs:263
<span class="w">  </span><span class="m">11</span>:<span class="w"> </span>tokio::coop::with_budget::<span class="o">{{</span>closure<span class="o">}}</span>::h6a86a24a246e220f
<span class="w">      </span>at<span class="w"> </span>/home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/coop.rs:106
<span class="w">  </span><span class="m">12</span>:<span class="w"> </span>std::thread::local::LocalKey&lt;T&gt;::try_with::h2ce0ac27c85965b6
<span class="w">      </span>at<span class="w"> </span>/home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/local.rs:376
<span class="w">  </span><span class="m">13</span>:<span class="w"> </span>std::thread::local::LocalKey&lt;T&gt;::with::hc449f38c9f65fb53
<span class="w">      </span>at<span class="w"> </span>/home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/local.rs:352
<span class="w">  </span><span class="m">14</span>:<span class="w"> </span>tokio::coop::with_budget::h5db157bd1e95e0e8
<span class="w">      </span>at<span class="w"> </span>/home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/coop.rs:99
<span class="w">  </span><span class="m">15</span>:<span class="w"> </span>tokio::coop::budget::h7b57383f1255ac24
<span class="w">      </span>at<span class="w"> </span>/home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/coop.rs:76
<span class="w">  </span><span class="m">16</span>:<span class="w"> </span>tokio::park::thread::CachedParkThread::block_on::hece399485213b91c
<span class="w">      </span>at<span class="w"> </span>/home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/park/thread.rs:263
<span class="w">  </span><span class="m">17</span>:<span class="w"> </span>tokio::runtime::enter::Enter::block_on::h89e9882e539e82d3
<span class="w">      </span>at<span class="w"> </span>/home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/runtime/enter.rs:151
<span class="w">  </span><span class="m">18</span>:<span class="w"> </span>tokio::runtime::thread_pool::ThreadPool::block_on::h1a0186470c00ba70
<span class="w">      </span>at<span class="w"> </span>/home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/runtime/thread_pool/mod.rs:71
<span class="w">  </span><span class="m">19</span>:<span class="w"> </span>tokio::runtime::Runtime::block_on::h7c21d6989b86d606
<span class="w">      </span>at<span class="w"> </span>/home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/runtime/mod.rs:452
<span class="w">  </span><span class="m">20</span>:<span class="w"> </span>waytoodeep::main::hb4dd5ffd46a5c032
<span class="w">      </span>at<span class="w"> </span>/home/amos/ftl/waytoodeep/src/main.rs:20
<span class="w">  </span><span class="m">21</span>:<span class="w"> </span>core::ops::function::FnOnce::call_once::hc1fcc87431f77d25
<span class="w">      </span>at<span class="w"> </span>/home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/function.rs:227
<span class="w">                                </span>⋮<span class="w"> </span><span class="m">11</span><span class="w"> </span>frames<span class="w"> </span>hidden<span class="w"> </span>⋮

Run<span class="w"> </span>with<span class="w"> </span><span class="nv">COLORBT_SHOW_HIDDEN</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>environment<span class="w"> </span>variable<span class="w"> </span>to<span class="w"> </span>disable<span class="w"> </span>frame<span class="w"> </span>filtering.
Run<span class="w"> </span>with<span class="w"> </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span>full<span class="w"> </span>to<span class="w"> </span>include<span class="w"> </span><span class="nb">source</span><span class="w"> </span>snippets.
</code></pre></div>

<p>上面堆栈跟踪如果加上颜色效果会更好，所以我希望你在本地做了相同的尝试，即使如此我们依然可以看到我们真正的 main 函数在 20 帧，然后往上，我们可以看到 <code>Runtime::block_on</code>  、一个线程池的东西、一些挂起（parked）的线程、thread-local（其他 TLS）、一个 <strong><em>*生成的</em></strong>* future（帧 9 和 8，也就是我们的 <code>async fn main</code> 的最终结果），最后是我们的 <code>DumbFuture</code> poll 方法（帧 7）。</p>
<p>帧 6 到 1 就是 <a href="https://doc.rust-lang.org/stable/std/panic/index.html">panic</a> 机制，再次完全超出本文讨论的范围。</p>
<p>但是请站起来，亲爱的观众，用你的手臂绕过这个装置，以确保没有障眼法，没有隐藏的线，没有。。。</p>
<p>。。。我要说的是对于异步堆栈跟踪没有“特殊处理”（special handling）。当然，这里我们崩溃了，但是仅仅是 Rust，操作系统甚至不知道我几乎避免了一场灾难。</p>
<p>但是我们可以制造更大的混乱，如果我们愿意使用 <code>unsafe</code> ：</p>
<div class="highlight"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">DumbFuture</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">();</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">_cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">*</span><span class="p">(</span><span class="mh">0xF00D</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u64</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="fm">unreachable!</span><span class="p">();</span><span class="w"> </span><span class="c1">// pinky promise</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>然后就不会有一些列的崩溃处理来拯救我们：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>cargo<span class="w"> </span>run
<span class="w">   </span>Compiling<span class="w"> </span>waytoodeep<span class="w"> </span>v0.1.0<span class="w"> </span><span class="o">(</span>/home/amos/ftl/waytoodeep<span class="o">)</span>
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span>.18s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:46:53.926<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Building<span class="w"> </span>that<span class="w"> </span>dumb<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:46:53.926<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Awaiting<span class="w"> </span>that<span class="w"> </span>dumb<span class="w"> </span>future...
zsh:<span class="w"> </span>segmentation<span class="w"> </span>fault<span class="w"> </span><span class="o">(</span>core<span class="w"> </span>dumped<span class="o">)</span><span class="w">  </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>cargo<span class="w"> </span>run
</code></pre></div>

<p>但是 GDB 可以：</p>
<div class="highlight"><pre><span></span><code><span class="o">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">gdb</span><span class="w"> </span><span class="o">--</span><span class="n">quiet</span><span class="w"> </span><span class="o">--</span><span class="n">args</span><span class="w"> </span><span class="o">./</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">waytoodeep</span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.04</span><span class="n">s</span>
<span class="n">Reading</span><span class="w"> </span><span class="n">symbols</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="o">./</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">waytoodeep</span><span class="o">...</span>
<span class="n">warning</span><span class="p">:</span><span class="w"> </span><span class="n">Missing</span><span class="w"> </span><span class="n">auto</span><span class="o">-</span><span class="nb">load</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="o">.</span><span class="n">debug_gdb_scripts</span>
<span class="n">of</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="n">ftl</span><span class="o">/</span><span class="n">waytoodeep</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">waytoodeep</span><span class="o">.</span>
<span class="n">Use</span><span class="w"> </span><span class="err">`</span><span class="n">info</span><span class="w"> </span><span class="n">auto</span><span class="o">-</span><span class="nb">load</span><span class="w"> </span><span class="n">python</span><span class="o">-</span><span class="n">scripts</span><span class="w"> </span><span class="p">[</span><span class="n">REGEXP</span><span class="p">]</span><span class="s1">&#39; to list them.</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">r</span>
<span class="n">Starting</span><span class="w"> </span><span class="n">program</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="n">ftl</span><span class="o">/</span><span class="n">waytoodeep</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">waytoodeep</span>
<span class="p">[</span><span class="n">Thread</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">libthread_db</span><span class="w"> </span><span class="n">enabled</span><span class="p">]</span>
<span class="n">Using</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="n">libthread_db</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="s2">&quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;</span><span class="o">.</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7c28700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129418</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7a27700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129419</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7826700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129420</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7625700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129421</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7424700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129422</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7223700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129423</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7022700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129424</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6e1e700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129425</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6c1a700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129426</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6a16700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129427</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6812700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129428</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff660e700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129429</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff640a700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129430</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6206700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129431</span><span class="p">)]</span>
<span class="p">[</span><span class="n">New</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6002700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">129432</span><span class="p">)]</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">17</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mf">13.278</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">:</span><span class="w"> </span><span class="n">Building</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">dumb</span><span class="w"> </span><span class="n">future</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">17</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mf">13.279</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">:</span><span class="w"> </span><span class="n">Awaiting</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">dumb</span><span class="w"> </span><span class="n">future</span><span class="o">...</span>

<span class="n">Thread</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="s2">&quot;waytoodeep&quot;</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="k">signal</span><span class="w"> </span><span class="n">SIGSEGV</span><span class="p">,</span><span class="w"> </span><span class="n">Segmentation</span><span class="w"> </span><span class="n">fault</span><span class="o">.</span>
<span class="o">&lt;</span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">dumb</span><span class="p">::</span><span class="n">DumbFuture</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">future</span><span class="p">::</span><span class="n">future</span><span class="p">::</span><span class="n">Future</span><span class="o">&gt;</span><span class="p">::</span><span class="n">poll</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">=...</span><span class="p">,</span><span class="w"> </span><span class="n">_cx</span><span class="o">=</span><span class="mh">0x7fffffffd690</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">dumb</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">15</span>
<span class="mi">15</span><span class="w">                  </span><span class="o">*</span><span class="p">(</span><span class="mh">0xF00D</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="n">mut</span><span class="w"> </span><span class="n">u64</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0</span><span class="p">;</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">bt</span>
<span class="c1">#0  &lt;waytoodeep::dumb::DumbFuture as core::future::future::Future&gt;::poll (self=..., _cx=0x7fffffffd690) at src/dumb.rs:15</span>
<span class="c1">#1  0x00005555555ab3a3 in waytoodeep::main::{{closure}} () at src/main.rs:17</span>
<span class="c1">#2  0x00005555555adb29 in &lt;core::future::from_generator::GenFuture&lt;T&gt; as core::future::future::Future&gt;::poll (self=..., cx=0x7fffffffd690)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">stable</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">future</span><span class="o">/</span><span class="n">mod</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">80</span>
<span class="c1">#3  0x00005555555adaa0 in tokio::park::thread::CachedParkThread::block_on::{{closure}} ()</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">park</span><span class="o">/</span><span class="n">thread</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">263</span>
<span class="c1">#4  0x00005555555b1742 in tokio::coop::with_budget::{{closure}} (cell=0x7ffff7c2c412)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">coop</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">106</span>
<span class="c1">#5  0x00005555555a9f58 in std::thread::local::LocalKey&lt;T&gt;::try_with (self=0x555555925fc0, f=...)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">stable</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">thread</span><span class="o">/</span><span class="n">local</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">376</span>
<span class="c1">#6  0x00005555555a9e3d in std::thread::local::LocalKey&lt;T&gt;::with (self=0x555555925fc0, f=...)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">stable</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">thread</span><span class="o">/</span><span class="n">local</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">352</span>
<span class="c1">#7  0x00005555555ad7c8 in tokio::coop::with_budget (budget=..., f=...)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">coop</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">99</span>
<span class="c1">#8  tokio::coop::budget (f=...) at /home/amos/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.9.0/src/coop.rs:76</span>
<span class="c1">#9  tokio::park::thread::CachedParkThread::block_on (self=0x7fffffffd7a0, f=...)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">park</span><span class="o">/</span><span class="n">thread</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">263</span>
<span class="c1">#10 0x00005555555abcc9 in tokio::runtime::enter::Enter::block_on (self=0x7fffffffd7f0, f=...)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">enter</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">151</span>
<span class="c1">#11 0x00005555555acf2e in tokio::runtime::thread_pool::ThreadPool::block_on (self=0x7fffffffd908, future=...)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">thread_pool</span><span class="o">/</span><span class="n">mod</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">71</span>
<span class="c1">#12 0x00005555555b0dfd in tokio::runtime::Runtime::block_on (self=0x7fffffffd900, future=...)</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">tokio</span><span class="o">-</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">mod</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">452</span>
<span class="c1">#13 0x00005555555aa807 in waytoodeep::main () at src/main.rs:20</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span>
</code></pre></div>

<p>我们再次丢失了高亮颜色，这里可以看一下：
<img alt="" src="https://fasterthanli.me/content/articles/understanding-rust-futures-by-going-way-too-deep/assets/gdb-colors.b45af429c46a37d9.webp"></p>
<blockquote>
<p>译注：我在本地环境并没有通过 GDB 复现带高亮的堆栈跟踪，反而是通过 LLDB 可以看到高亮的堆栈跟踪。</p>
</blockquote>
<p>是不是很漂亮？</p>
<p>现在让我们回到正常有用的代码，移除所有关于自己实现的 future 代码： <code>src/dumb.rs</code> 和 <code>mod dumb</code> 。并使用一个获取 future 替代：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Building that fetch future...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Awaiting that fetch future...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">fut</span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Done awaiting that fetch future&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>cargo<span class="w"> </span>run
<span class="w">   </span>Compiling<span class="w"> </span>waytoodeep<span class="w"> </span>v0.1.0<span class="w"> </span><span class="o">(</span>/home/amos/ftl/waytoodeep<span class="o">)</span>
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span>.99s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:51:49.281<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Building<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:51:49.282<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Awaiting<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:51:49.437<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">17</span>:51:49.438<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Done<span class="w"> </span>awaiting<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future
</code></pre></div>

<p>有两种方式考虑我们的函数，一个是语法糖层：也就是 <code>async fn</code> ：</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">fetch_thing</span><span class="p">(</span><span class="n">client</span>: <span class="kp">&amp;</span><span class="nc">Client</span><span class="p">,</span><span class="w"> </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">send</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">.</span><span class="n">error_for_status</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">content_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="n">res</span><span class="p">.</span><span class="n">headers</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;content-type&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Got a response!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>然后是核心实现层：一个普通的 <code>fn</code> 仅用来返回一个 future 对象：</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">future</span>::<span class="n">Future</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">fetch_thing</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">client</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="nc">Client</span><span class="p">,</span>
<span class="w">    </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="kt">str</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="na">a</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">send</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">.</span><span class="n">error_for_status</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">content_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="n">res</span><span class="p">.</span><span class="n">headers</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;content-type&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Got a response!&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>由于借用 <code>client</code> 和 <code>url</code> ，所以 <code>Future</code> 对象的存活时间不能超过两者，这也是为什么我会将上面两个生命周期命名为 <code>'a</code> ，
并且返回的值也是任意实现了 <code>Future</code> （通过 <code>Output</code> ）同时生命周期也是 <code>'a</code> 。</p>
<p>整个 <code>async move {}</code> 快也仅仅是“构建状态” -- 等于一个实现了 <code>Future</code> 的类型。</p>
<p>我们只是无法命名它。</p>
<p>我们只能尽量获取它的描述：</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">type_name_of</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span>: <span class="kp">&amp;</span><span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span> <span class="kt">str</span> <span class="p">{</span>
<span class="w">    </span><span class="n">std</span>::<span class="n">any</span>::<span class="n">type_name</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// in main</span>

<span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Building that fetch future...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span>
<span class="w">        </span><span class="n">type_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type_name_of</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fut</span><span class="p">),</span>
<span class="w">        </span><span class="s">&quot;That fetch future has a type..&quot;</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Awaiting that fetch future...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">fut</span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Done awaiting that fetch future&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>run
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.05s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:00:39.774<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Building<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:00:39.775<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>That<span class="w"> </span>fetch<span class="w"> </span>future<span class="w"> </span>has<span class="w"> </span>a<span class="w"> </span>type..<span class="w"> </span><span class="nv">type_name</span><span class="o">=</span><span class="s2">&quot;core::future::from_generator::GenFuture&lt;waytoodeep::fetch_thing::{{closure}}&gt;&quot;</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:00:39.775<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Awaiting<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:00:39.882<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:00:39.882<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Done<span class="w"> </span>awaiting<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future
</code></pre></div>

<p>。。。但是等等，由于我们使用了 <code>async</code> 语法所以它是一个编译器生成的类型。某种意义上我们无法命名它也就意味这我们无法绑定这个对象，或者编写一个函数仅仅接受该类型。</p>
<p>为了让我们自己相信 future 对象在我们真正轮询它之前它不会做任何工作，我们可以打开 <code>reqwest</code> 的调试日志：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info,reqwest<span class="o">=</span>debug<span class="w"> </span>cargo<span class="w"> </span>run
<span class="w">   </span>Compiling<span class="w"> </span>waytoodeep<span class="w"> </span>v0.1.0<span class="w"> </span><span class="o">(</span>/home/amos/ftl/waytoodeep<span class="o">)</span>
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.07s
<span class="w">     </span>Running<span class="w"> </span><span class="sb">`</span>target/debug/waytoodeep<span class="sb">`</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:05:07.384<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Building<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:05:07.385<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>That<span class="w"> </span>fetch<span class="w"> </span>future<span class="w"> </span>has<span class="w"> </span>a<span class="w"> </span>type..<span class="w"> </span><span class="nv">type_name</span><span class="o">=</span><span class="s2">&quot;core::future::from_generator::GenFuture&lt;waytoodeep::fetch_thing::{{closure}}&gt;&quot;</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:05:07.385<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Awaiting<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:05:07.385<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::connect:<span class="w"> </span>starting<span class="w"> </span>new<span class="w"> </span>connection:<span class="w"> </span>https://fasterthanli.me/
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:05:07.503<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::async_impl::client:<span class="w"> </span>response<span class="w"> </span><span class="s1">&#39;200 OK&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>https://fasterthanli.me/articles/whats-in-the-box
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:05:07.503<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:05:07.503<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Done<span class="w"> </span>awaiting<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future
</code></pre></div>

<p>甚至对于每一个包（crate），我们都可以通过监听 <a href="https://lib.rs/crates/hyper">hyper</a> 和 <a href="https://lib.rs/crates/h2">h2</a> 来观察：</p>
<div class="highlight"><pre><span></span><code><span class="o">$</span><span class="w"> </span><span class="n">RUST_LOG</span><span class="o">=</span><span class="n">debug</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.04</span><span class="n">s</span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">waytoodeep</span><span class="err">`</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">59.973</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">:</span><span class="w"> </span><span class="n">Building</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">future</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">59.973</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">:</span><span class="w"> </span><span class="n">That</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">type</span><span class="o">..</span><span class="w"> </span><span class="n">type_name</span><span class="o">=</span><span class="s2">&quot;core::future::from_generator::GenFuture&lt;waytoodeep::fetch_thing::{{closure}}&gt;&quot;</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">59.973</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">:</span><span class="w"> </span><span class="n">Awaiting</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">future</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">59.974</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">reqwest</span><span class="p">::</span><span class="n">connect</span><span class="p">:</span><span class="w"> </span><span class="n">starting</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">connection</span><span class="p">:</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">fasterthanli</span><span class="o">.</span><span class="n">me</span><span class="o">/</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">59.974</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">hyper</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">connect</span><span class="p">::</span><span class="n">dns</span><span class="p">:</span><span class="w"> </span><span class="n">resolving</span><span class="w"> </span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;fasterthanli.me&quot;</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">59.989</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">hyper</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">connect</span><span class="p">::</span><span class="n">http</span><span class="p">:</span><span class="w"> </span><span class="n">connecting</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">172.67</span><span class="o">.</span><span class="mf">196.144</span><span class="p">:</span><span class="mi">443</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.000</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">hyper</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">connect</span><span class="p">::</span><span class="n">http</span><span class="p">:</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">172.67</span><span class="o">.</span><span class="mf">196.144</span><span class="p">:</span><span class="mi">443</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.000</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustls</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">hs</span><span class="p">:</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">cached</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">DNSNameRef</span><span class="p">(</span><span class="s2">&quot;fasterthanli.me&quot;</span><span class="p">)</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.000</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustls</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">hs</span><span class="p">:</span><span class="w"> </span><span class="n">Not</span><span class="w"> </span><span class="n">resuming</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">session</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.016</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustls</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">hs</span><span class="p">:</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">ciphersuite</span><span class="w"> </span><span class="n">TLS13_CHACHA20_POLY1305_SHA256</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.016</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustls</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">tls13</span><span class="p">:</span><span class="w"> </span><span class="n">Not</span><span class="w"> </span><span class="n">resuming</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.017</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustls</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">tls13</span><span class="p">:</span><span class="w"> </span><span class="n">TLS1</span><span class="o">.</span><span class="mi">3</span><span class="w"> </span><span class="n">encrypted</span><span class="w"> </span><span class="n">extensions</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">ServerNameAck</span><span class="p">,</span><span class="w"> </span><span class="n">Protocols</span><span class="p">([</span><span class="n">PayloadU8</span><span class="p">([</span><span class="mi">104</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">])])]</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.017</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustls</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">hs</span><span class="p">:</span><span class="w"> </span><span class="n">ALPN</span><span class="w"> </span><span class="n">protocol</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">Some</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;h2&quot;</span><span class="p">)</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.018</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">client</span><span class="p">:</span><span class="w"> </span><span class="n">binding</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="n">connection</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.018</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">client</span><span class="p">:</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="n">bound</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.018</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_write</span><span class="p">:</span><span class="w"> </span><span class="n">send</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">Settings</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">flags</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="mh">0x0</span><span class="p">),</span><span class="w"> </span><span class="n">enable_push</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">initial_window_size</span><span class="p">:</span><span class="w"> </span><span class="mi">2097152</span><span class="p">,</span><span class="w"> </span><span class="n">max_frame_size</span><span class="p">:</span><span class="w"> </span><span class="mi">16384</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.019</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_write</span><span class="p">:</span><span class="w"> </span><span class="n">send</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">WindowUpdate</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">stream_id</span><span class="p">:</span><span class="w"> </span><span class="n">StreamId</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">size_increment</span><span class="p">:</span><span class="w"> </span><span class="mi">5177345</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.019</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">hyper</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">pool</span><span class="p">:</span><span class="w"> </span><span class="n">pooling</span><span class="w"> </span><span class="n">idle</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;https&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fasterthanli</span><span class="o">.</span><span class="n">me</span><span class="p">)</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.020</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_write</span><span class="p">:</span><span class="w"> </span><span class="n">send</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">Headers</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">stream_id</span><span class="p">:</span><span class="w"> </span><span class="n">StreamId</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">flags</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="mh">0x5</span><span class="p">:</span><span class="w"> </span><span class="n">END_HEADERS</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">END_STREAM</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.029</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">rustls</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">tls13</span><span class="p">:</span><span class="w"> </span><span class="n">Ticket</span><span class="w"> </span><span class="n">saved</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.029</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">rustls</span><span class="p">::</span><span class="n">client</span><span class="p">::</span><span class="n">tls13</span><span class="p">:</span><span class="w"> </span><span class="n">Ticket</span><span class="w"> </span><span class="n">saved</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.029</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_read</span><span class="p">:</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">Settings</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">flags</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="mh">0x0</span><span class="p">),</span><span class="w"> </span><span class="n">max_concurrent_streams</span><span class="p">:</span><span class="w"> </span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="n">initial_window_size</span><span class="p">:</span><span class="w"> </span><span class="mi">65536</span><span class="p">,</span><span class="w"> </span><span class="n">max_frame_size</span><span class="p">:</span><span class="w"> </span><span class="mi">16777215</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.030</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_write</span><span class="p">:</span><span class="w"> </span><span class="n">send</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">Settings</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">flags</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="mh">0x1</span><span class="p">:</span><span class="w"> </span><span class="n">ACK</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.030</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_read</span><span class="p">:</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">WindowUpdate</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">stream_id</span><span class="p">:</span><span class="w"> </span><span class="n">StreamId</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">size_increment</span><span class="p">:</span><span class="w"> </span><span class="mi">2147418112</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.041</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_read</span><span class="p">:</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">Settings</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">flags</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="mh">0x1</span><span class="p">:</span><span class="w"> </span><span class="n">ACK</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.041</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">proto</span><span class="p">::</span><span class="n">settings</span><span class="p">:</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="n">settings</span><span class="w"> </span><span class="n">ACK</span><span class="p">;</span><span class="w"> </span><span class="n">applying</span><span class="w"> </span><span class="n">Settings</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">flags</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="mh">0x0</span><span class="p">),</span><span class="w"> </span><span class="n">enable_push</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">initial_window_size</span><span class="p">:</span><span class="w"> </span><span class="mi">2097152</span><span class="p">,</span><span class="w"> </span><span class="n">max_frame_size</span><span class="p">:</span><span class="w"> </span><span class="mi">16384</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.120</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_read</span><span class="p">:</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">Headers</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">stream_id</span><span class="p">:</span><span class="w"> </span><span class="n">StreamId</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">flags</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="mh">0x4</span><span class="p">:</span><span class="w"> </span><span class="n">END_HEADERS</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.120</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_read</span><span class="p">:</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">Data</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">stream_id</span><span class="p">:</span><span class="w"> </span><span class="n">StreamId</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.121</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">reqwest</span><span class="p">::</span><span class="n">async_impl</span><span class="p">::</span><span class="n">client</span><span class="p">:</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="s1">&#39;200 OK&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">fasterthanli</span><span class="o">.</span><span class="n">me</span><span class="o">/</span><span class="n">articles</span><span class="o">/</span><span class="n">whats</span><span class="o">-</span><span class="ow">in</span><span class="o">-</span><span class="n">the</span><span class="o">-</span><span class="n">box</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.121</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">:</span><span class="w"> </span><span class="n">Got</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">response</span><span class="o">!</span><span class="w"> </span><span class="n">url</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">fasterthanli</span><span class="o">.</span><span class="n">me</span><span class="o">/</span><span class="n">articles</span><span class="o">/</span><span class="n">whats</span><span class="o">-</span><span class="ow">in</span><span class="o">-</span><span class="n">the</span><span class="o">-</span><span class="n">box</span><span class="w"> </span><span class="n">content_type</span><span class="o">=</span><span class="n">Some</span><span class="p">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="p">)</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.121</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">:</span><span class="w"> </span><span class="n">Done</span><span class="w"> </span><span class="n">awaiting</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">future</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.121</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_read</span><span class="p">:</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">Data</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">stream_id</span><span class="p">:</span><span class="w"> </span><span class="n">StreamId</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.122</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_write</span><span class="p">:</span><span class="w"> </span><span class="n">send</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">Reset</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">stream_id</span><span class="p">:</span><span class="w"> </span><span class="n">StreamId</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">error_code</span><span class="p">:</span><span class="w"> </span><span class="n">CANCEL</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.122</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">codec</span><span class="p">::</span><span class="n">framed_write</span><span class="p">:</span><span class="w"> </span><span class="n">send</span><span class="w"> </span><span class="n">frame</span><span class="o">=</span><span class="n">GoAway</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">error_code</span><span class="p">:</span><span class="w"> </span><span class="n">NO_ERROR</span><span class="p">,</span><span class="w"> </span><span class="n">last_stream_id</span><span class="p">:</span><span class="w"> </span><span class="n">StreamId</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.122</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">h2</span><span class="p">::</span><span class="n">proto</span><span class="p">::</span><span class="n">connection</span><span class="p">:</span><span class="w"> </span><span class="n">Connection</span><span class="p">::</span><span class="n">poll</span><span class="p">;</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">error</span><span class="o">=</span><span class="n">NO_ERROR</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">00.122</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="n">Connection</span><span class="p">{</span><span class="n">peer</span><span class="o">=</span><span class="n">Client</span><span class="p">}:</span><span class="w"> </span><span class="n">rustls</span><span class="p">::</span><span class="n">session</span><span class="p">:</span><span class="w"> </span><span class="n">Sending</span><span class="w"> </span><span class="n">warning</span><span class="w"> </span><span class="n">alert</span><span class="w"> </span><span class="n">CloseNotify</span>
</code></pre></div>

<blockquote>
<p>上面出现了 rustls，并且使用了 TLS 1.3，作者做过<a href="https://www.youtube.com/watch?v=YHIiVsFybLA">一期视频</a>介绍过 TLS 1.3。</p>
</blockquote>
<p>这些应该足够说服你，除非你只相信内核所说的，所以让我们看看调用堆栈只为了更加确定。</p>
<p>我们在 <code>await</code> future 对象之前增加一秒钟的休眠：</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">sleep</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">time</span>::<span class="n">Duration</span><span class="p">;</span>

<span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Building that fetch future...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Sleeping for a bit...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_secs</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Awaiting that fetch future...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">fut</span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Done awaiting that fetch future&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>build<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>strace<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;connect&#39;</span><span class="w"> </span>./target/debug/waytoodeep
<span class="w">   </span>Compiling<span class="w"> </span>waytoodeep<span class="w"> </span>v0.1.0<span class="w"> </span><span class="o">(</span>/home/amos/ftl/waytoodeep<span class="o">)</span>
<span class="w">    </span>Finished<span class="w"> </span>dev<span class="w"> </span><span class="o">[</span>unoptimized<span class="w"> </span>+<span class="w"> </span>debuginfo<span class="o">]</span><span class="w"> </span>target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">3</span>.13s
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:09:36.595<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Building<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:09:36.596<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Sleeping<span class="w"> </span><span class="k">for</span><span class="w"> </span>a<span class="w"> </span>bit...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:09:37.599<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Awaiting<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future...
connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">443</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;104.21.92.169&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>EINPROGRESS<span class="w"> </span><span class="o">(</span>Operation<span class="w"> </span>now<span class="w"> </span><span class="k">in</span><span class="w"> </span>progress<span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:09:37.720<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:09:37.721<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Done<span class="w"> </span>awaiting<span class="w"> </span>that<span class="w"> </span>fetch<span class="w"> </span>future
+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
</code></pre></div>

<p>再次强调，附上会让显著提高上面信息的可读性，如果不让我选择它们的话我是非常喜欢高亮的。我本地看起来是这样的：
<img alt="" src="https://fasterthanli.me/content/articles/understanding-rust-futures-by-going-way-too-deep/assets/strace-colors.a4163f4bda179c2b.webp">
由于 <code>tracing-subscriber</code> 默认格式会输出时间戳，可以看到程序休眠了1分钟（外加3毫秒），而且只有我们真正调用 <code>await</code> 时我们的程序才会开始连接到托管文章的 CDN 节点。</p>
<p>好了！让我们再次尝试拉取两篇文章：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_2</span><span class="p">);</span>

<span class="w">    </span><span class="n">fut1</span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">fut2</span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>再次检查日志：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info,reqwest<span class="o">=</span>debug<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:31:47.396<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::connect:<span class="w"> </span>starting<span class="w"> </span>new<span class="w"> </span>connection:<span class="w"> </span>https://fasterthanli.me/
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:31:47.536<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::async_impl::client:<span class="w"> </span>response<span class="w"> </span><span class="s1">&#39;200 OK&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>https://fasterthanli.me/articles/whats-in-the-box
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:31:47.537<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:31:47.627<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::async_impl::client:<span class="w"> </span>response<span class="w"> </span><span class="s1">&#39;200 OK&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>https://fasterthanli.me/series/advent-of-code-2020/part-13
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:31:47.627<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
</code></pre></div>

<p>非常有趣。从这里可以看到， <code>reqwest</code> 为两个请求复用了相同的连接。我会这么说是因我只看到了一行 <code>reqwest::connect</code> 日志。</p>
<p>让我们快速通过 <code>strace</code> 检查一下：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>build<span class="w"> </span>--quiet<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>strace<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;connect&#39;</span><span class="w"> </span>./target/debug/waytoodeep<span class="w"> </span>&gt;<span class="w"> </span>/dev/null
connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">443</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;172.67.196.144&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>EINPROGRESS<span class="w"> </span><span class="o">(</span>Operation<span class="w"> </span>now<span class="w"> </span><span class="k">in</span><span class="w"> </span>progress<span class="o">)</span>
+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
</code></pre></div>

<p>现在可以确认了，只有一次连接。</p>
<p>但是，第一个请求完成后才开始了第二个请求。第一个耗费了 <code>536-396 = 140</code> 毫秒，但是第二个耗费了 <code>627-537 = 90</code> 毫秒！</p>
<blockquote>
<p>Emmm，现在我们运行构建的是 debug 版本不是吗？</p>
</blockquote>
<p>这是真的。我确信我们面临的是 IO 密集型，而不是 CPU 密集型。</p>
<p>debug 版本的构建绝对有一些额外的开销，但是我怀疑这里它不会太影响延迟。无论如何，让我们检查一下：
（注意 --release）</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info,reqwest<span class="o">=</span>debug<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:34:59.211<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::connect:<span class="w"> </span>starting<span class="w"> </span>new<span class="w"> </span>connection:<span class="w"> </span>https://fasterthanli.me/
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:34:59.343<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::async_impl::client:<span class="w"> </span>response<span class="w"> </span><span class="s1">&#39;200 OK&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>https://fasterthanli.me/articles/whats-in-the-box
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:34:59.343<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:34:59.427<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::async_impl::client:<span class="w"> </span>response<span class="w"> </span><span class="s1">&#39;200 OK&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>https://fasterthanli.me/series/advent-of-code-2020/part-13
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:34:59.427<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
</code></pre></div>

<p>我们计算一下延迟 <code>343-211 = 132ms</code> ， <code>427-343 = 84ms</code> 。</p>
<p>几毫秒的差异可能的解释是邻居打开了一个 YouTube 视频导致无线电波爆发，从而导致冲突（802.11 没有空中流量控制，全民自由（free-for-all））和重传。</p>
<p>或者另外一百万个原因。这也是我们不继续分析的原因。</p>
<p>让我们回到文章的主题。</p>
<h3 id="等待第一个完成">等待第一个完成</h3>
<p>是的！等待第一个完成。所以我们如何让程序同时请求两个？</p>
<p>其实有一大堆方式！</p>
<p>例如，我们可以在一个执行器上执行（ <code>spawn</code> ）这些 future 对象，然后休眠一秒钟。1 秒钟足够了吧？</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">    </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_2</span><span class="p">);</span>
<span class="w">    </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut2</span><span class="p">);</span>

<span class="w">    </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_secs</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">RUST_LOG</span><span class="o">=</span><span class="n">info</span><span class="p">,</span><span class="n">reqwest</span><span class="o">=</span><span class="n">debug</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">quiet</span><span class="w"> </span><span class="o">--</span><span class="k">release</span>
<span class="k">error</span><span class="err">[</span><span class="n">E0597</span><span class="err">]</span><span class="o">:</span><span class="w"> </span><span class="n n-Quoted">`client`</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">live</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">enough</span>
<span class="w">  </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span><span class="mi">28</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">let</span><span class="w"> </span><span class="n">fut1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="k">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">   </span><span class="o">|</span><span class="w">                </span><span class="o">------------^^^^^^^--------</span>
<span class="w">   </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">           </span><span class="o">|</span>
<span class="w">   </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">           </span><span class="n">borrowed</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">live</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">enough</span>
<span class="w">   </span><span class="o">|</span><span class="w">                </span><span class="n">argument</span><span class="w"> </span><span class="n">requires</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n n-Quoted">`client`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">borrowed</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n n-Quoted">`&#39;static`</span>
<span class="p">...</span>
<span class="mi">25</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="err">}</span>
<span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n n-Quoted">`client`</span><span class="w"> </span><span class="n">dropped</span><span class="w"> </span><span class="n">here</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">still</span><span class="w"> </span><span class="n">borrowed</span>

<span class="k">error</span><span class="o">:</span><span class="w"> </span><span class="n">aborting</span><span class="w"> </span><span class="n">due</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">previous</span><span class="w"> </span><span class="k">error</span>

<span class="k">For</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">information</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">error</span><span class="p">,</span><span class="w"> </span><span class="n">try</span><span class="w"> </span><span class="n n-Quoted">`rustc --explain E0597`</span><span class="p">.</span>
<span class="k">error</span><span class="o">:</span><span class="w"> </span><span class="n">could</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n n-Quoted">`waytoodeep`</span>

<span class="k">To</span><span class="w"> </span><span class="n">learn</span><span class="w"> </span><span class="n">more</span><span class="p">,</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">again</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="o">--</span><span class="n">verbose</span><span class="p">.</span>
</code></pre></div>

<p>额，除非我们不可以。不可以是因为。。。</p>
<blockquote>
<p>我们将「future 对象交给执行器执行」并将 future 对象转交给执行器，对吧？我们转移了它和它的内容的所有权。</p>
<p>然后即使我们不对其进行 <code>await</code> ，future 对象因为是「执行器需要做」的一部分依然会被执行，所以即使我们从 <code>main</code> 返回 future 对象也会被轮询（polled）。</p>
<p>但是如果我们从 <code>main</code> 返回，则整个程序都会退出。</p>
<p>这里也可以是任何函数（这里是 <code>main</code> ）。重要的是如果函数返回了但是 future 对象借用了部分数据将无法通过借用检查器。</p>
</blockquote>
<p>这让我很高兴，因为这意味着我们不会意外访问到一些被释放的资源：<a href="https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=use+after+free">UAF</a>。</p>
<p>这里我们的例子没有完成。</p>
<p>所以。。。我们需要解决这个问题。如果 <code>fetch_thing</code> 返回的 future 对象是 <code>'static</code> 的呢？或者它不借用任何东西？</p>
<p>程序现在看起来如下：</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">future</span>::<span class="n">Future</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">fetch_thing</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">client</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="nc">Client</span><span class="p">,</span>
<span class="w">    </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="kt">str</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="na">a</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">send</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">.</span><span class="n">error_for_status</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">content_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="n">res</span><span class="p">.</span><span class="n">headers</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;content-type&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Got a response!&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>好吧，之前我们用了 <code>async fn</code> ，但是为了更加深入的理解，我们不得不放弃漂亮的语法。</p>
<p>但是幸运的是，这正是我们想要的：</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">fetch_thing</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">client</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="nc">Client</span><span class="p">,</span>
<span class="w">    </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="kt">str</span><span class="p">,</span>
<span class="c1">//                                                 👇</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>

<p>但是我们借用了 <code>client</code> 和 <code>url</code> 我们必须避免这个问题。</p>
<p>因为 <code>url</code> 本身就是常量，所以很容易解决：</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">URL_1</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&quot;https://fasterthanli.me/articles/whats-in-the-box&quot;</span><span class="p">;</span>
<span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">URL_2</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&quot;https://fasterthanli.me/series/advent-of-code-2020/part-13&quot;</span><span class="p">;</span>
</code></pre></div>

<p>它们本身就是 <code>'static</code> 。所以我们只需要调整需要 <code>'static</code> 就行:</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">fetch_thing</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">client</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="nc">Client</span><span class="p">,</span>
<span class="w">    </span><span class="c1">//       👇</span>
<span class="w">    </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span> <span class="kt">str</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>

<p>非常好！解决了一个生命周期，还剩下一个。</p>
<p>我们可以要求 <code>client</code> 的生命周期为 <code>'static</code> 。由于它是一个  <code>Client</code> 的引用，意味着 <code>Cleint</code> 本身也需要是 <code>'static</code> 生命周期。</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">fetch_thing</span><span class="p">(</span>
<span class="w">    </span><span class="c1">//         👇</span>
<span class="w">    </span><span class="n">client</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span> <span class="nc">Client</span><span class="p">,</span>
<span class="w">    </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span> <span class="kt">str</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>

<p>由于它被 <code>main</code> 所有，额，我们可以，可以。。。可以泄漏它：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">leaked_client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">leak</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">leaked_client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">leaked_client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_2</span><span class="p">);</span>

<span class="w">    </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut1</span><span class="p">);</span>
<span class="w">    </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut2</span><span class="p">);</span>

<span class="w">    </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_secs</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>完美！没有生命周期的问题了。</p>
<p>仅仅将所有东西泄漏就行。看到没？你不需要 C！</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info,reqwest<span class="o">=</span>debug<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:54:53.614<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::connect:<span class="w"> </span>starting<span class="w"> </span>new<span class="w"> </span>connection:<span class="w"> </span>https://fasterthanli.me/
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:54:53.614<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::connect:<span class="w"> </span>starting<span class="w"> </span>new<span class="w"> </span>connection:<span class="w"> </span>https://fasterthanli.me/
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:54:53.708<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::async_impl::client:<span class="w"> </span>response<span class="w"> </span><span class="s1">&#39;200 OK&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>https://fasterthanli.me/articles/whats-in-the-box
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:54:53.708<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:54:53.733<span class="w"> </span>DEBUG<span class="w"> </span>reqwest::async_impl::client:<span class="w"> </span>response<span class="w"> </span><span class="s1">&#39;200 OK&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>https://fasterthanli.me/series/advent-of-code-2020/part-13
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:54:53.733<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
</code></pre></div>

<p>非～～常有趣！</p>
<p>我们的两个请求肯定是并发的发出去了，我们之所以知道是因为从我的笔记本上请求我的网站大概耗时 80ms 到 140ms 之间，但是在日志中我们看到两个响应之间只有 ~25ms 的间隔。</p>
<p>我们还可以看到 <code>reqwest</code> 有连接池机制：同时创建了两个连接。可能是因为我们开始第二个连接的时候第一个请求的连接还没有建立完成。</p>
<p>也就意味着我们通过 <code>strace</code> 可以看到：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>build<span class="w"> </span>--quiet<span class="w"> </span>--release<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>strace<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;connect&#39;</span><span class="w"> </span>./target/release/waytoodeep
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:58:16.425<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">18</span>:58:16.443<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
</code></pre></div>

<p>。。。两个 <code>connect</code> 调用！如我所料！</p>
<blockquote>
<p>谬论：一个 <code>connect</code> 调用都没看到？因为 Rust 构建 HTTP/2 请求的时候甚至都需要建立 TCP 连接。真是革命性的！</p>
</blockquote>
<p>这当然不是真的。可能在其他线程执行了？也许 <code>strace</code> 默认仅跟踪了主线程？</p>
<p>啊，对了， <code>-f</code> 可以跟踪所有「子进程」，就像大家知道的那样 Linux 线程仅仅是披了件风衣的进程（或者其他方式）。所以，让我们看一下：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>build<span class="w"> </span>--quiet<span class="w"> </span>--release<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>strace<span class="w"> </span>-f<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;connect&#39;</span><span class="w"> </span>./target/release/waytoodeep
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154612</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154613</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154614</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154615</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154616</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154617</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154618</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154619</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154620</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154621</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154622</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154623</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154624</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154625</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154626</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154627</span><span class="w"> </span>attached
strace:<span class="w"> </span>Process<span class="w"> </span><span class="m">154628</span><span class="w"> </span>attached
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_UNIX,<span class="w"> </span><span class="nv">sun_path</span><span class="o">=</span><span class="s2">&quot;/var/run/nscd/socket&quot;</span><span class="o">}</span>,<span class="w"> </span><span class="m">110</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>ENOENT<span class="w"> </span><span class="o">(</span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory<span class="o">)</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154628</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_UNIX,<span class="w"> </span><span class="nv">sun_path</span><span class="o">=</span><span class="s2">&quot;/var/run/nscd/socket&quot;</span><span class="o">}</span>,<span class="w"> </span><span class="m">110</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>ENOENT<span class="w"> </span><span class="o">(</span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory<span class="o">)</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_UNIX,<span class="w"> </span><span class="nv">sun_path</span><span class="o">=</span><span class="s2">&quot;/var/run/nscd/socket&quot;</span><span class="o">}</span>,<span class="w"> </span><span class="m">110</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>ENOENT<span class="w"> </span><span class="o">(</span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory<span class="o">)</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154628</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">53</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;127.0.0.53&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">53</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;127.0.0.53&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET6,<span class="w"> </span><span class="nv">sin6_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin6_flowinfo</span><span class="o">=</span>htonl<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span>inet_pton<span class="o">(</span>AF_INET6,<span class="w"> </span><span class="s2">&quot;2606:4700:3034::6815:5ca9&quot;</span>,<span class="w"> </span><span class="p">&amp;</span>sin6_addr<span class="o">)</span>,<span class="w"> </span><span class="nv">sin6_scope_id</span><span class="o">=</span><span class="m">0</span><span class="o">}</span>,<span class="w"> </span><span class="m">28</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>ENETUNREACH<span class="w"> </span><span class="o">(</span>Network<span class="w"> </span>is<span class="w"> </span>unreachable<span class="o">)</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_UNSPEC,<span class="w"> </span><span class="nv">sa_data</span><span class="o">=</span><span class="s2">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span><span class="o">}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET6,<span class="w"> </span><span class="nv">sin6_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin6_flowinfo</span><span class="o">=</span>htonl<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span>inet_pton<span class="o">(</span>AF_INET6,<span class="w"> </span><span class="s2">&quot;2606:4700:3031::ac43:c490&quot;</span>,<span class="w"> </span><span class="p">&amp;</span>sin6_addr<span class="o">)</span>,<span class="w"> </span><span class="nv">sin6_scope_id</span><span class="o">=</span><span class="m">0</span><span class="o">}</span>,<span class="w"> </span><span class="m">28</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>ENETUNREACH<span class="w"> </span><span class="o">(</span>Network<span class="w"> </span>is<span class="w"> </span>unreachable<span class="o">)</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_UNSPEC,<span class="w"> </span><span class="nv">sa_data</span><span class="o">=</span><span class="s2">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span><span class="o">}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;104.21.92.169&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_UNSPEC,<span class="w"> </span><span class="nv">sa_data</span><span class="o">=</span><span class="s2">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span><span class="o">}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;172.67.196.144&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154628</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET6,<span class="w"> </span><span class="nv">sin6_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin6_flowinfo</span><span class="o">=</span>htonl<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span>inet_pton<span class="o">(</span>AF_INET6,<span class="w"> </span><span class="s2">&quot;2606:4700:3034::6815:5ca9&quot;</span>,<span class="w"> </span><span class="p">&amp;</span>sin6_addr<span class="o">)</span>,<span class="w"> </span><span class="nv">sin6_scope_id</span><span class="o">=</span><span class="m">0</span><span class="o">}</span>,<span class="w"> </span><span class="m">28</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>ENETUNREACH<span class="w"> </span><span class="o">(</span>Network<span class="w"> </span>is<span class="w"> </span>unreachable<span class="o">)</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154628</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_UNSPEC,<span class="w"> </span><span class="nv">sa_data</span><span class="o">=</span><span class="s2">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span><span class="o">}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154628</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET6,<span class="w"> </span><span class="nv">sin6_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin6_flowinfo</span><span class="o">=</span>htonl<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span>inet_pton<span class="o">(</span>AF_INET6,<span class="w"> </span><span class="s2">&quot;2606:4700:3031::ac43:c490&quot;</span>,<span class="w"> </span><span class="p">&amp;</span>sin6_addr<span class="o">)</span>,<span class="w"> </span><span class="nv">sin6_scope_id</span><span class="o">=</span><span class="m">0</span><span class="o">}</span>,<span class="w"> </span><span class="m">28</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>ENETUNREACH<span class="w"> </span><span class="o">(</span>Network<span class="w"> </span>is<span class="w"> </span>unreachable<span class="o">)</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154628</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_UNSPEC,<span class="w"> </span><span class="nv">sa_data</span><span class="o">=</span><span class="s2">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span><span class="o">}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154628</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;104.21.92.169&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154628</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_UNSPEC,<span class="w"> </span><span class="nv">sa_data</span><span class="o">=</span><span class="s2">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span><span class="o">}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154628</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;172.67.196.144&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154625</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">443</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;104.21.92.169&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>EINPROGRESS<span class="w"> </span><span class="o">(</span>Operation<span class="w"> </span>now<span class="w"> </span><span class="k">in</span><span class="w"> </span>progress<span class="o">)</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154626</span><span class="o">]</span><span class="w"> </span>connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">443</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;104.21.92.169&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>EINPROGRESS<span class="w"> </span><span class="o">(</span>Operation<span class="w"> </span>now<span class="w"> </span><span class="k">in</span><span class="w"> </span>progress<span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:00:53.862<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:00:53.880<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
<span class="o">[</span>pid<span class="w"> </span><span class="m">154628</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154627</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154618</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154614</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154612</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154619</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154617</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154613</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154615</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154623</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154616</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154624</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154621</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154622</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154626</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154620</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
<span class="o">[</span>pid<span class="w"> </span><span class="m">154625</span><span class="o">]</span><span class="w"> </span>+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++shell
</code></pre></div>

<p>哇哦，一大堆 <code>connect</code> 。</p>
<p>所以程序首先尝试连接 <a href="https://jameshfisher.com/2018/02/05/dont-use-nscd/">nscd</a> 因为显然我们依然生活在 90 年代：</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">pid</span><span class="w"> </span><span class="mi">154627</span><span class="p">]</span><span class="w"> </span><span class="n">connect</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">sa_family</span><span class="o">=</span><span class="n">AF_UNIX</span><span class="p">,</span><span class="w"> </span><span class="n">sun_path</span><span class="o">=</span><span class="s2">&quot;/var/run/nscd/socket&quot;</span><span class="p">},</span><span class="w"> </span><span class="mi">110</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="n">ENOENT</span><span class="w"> </span><span class="p">(</span><span class="n">No</span><span class="w"> </span><span class="n">such</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">directory</span><span class="p">)</span>
</code></pre></div>

<p>。。。幸好我的系统没有它，所以它继续通过 <code>/etc/resolv.conf</code> 查询 DNS：</p>
<div class="highlight"><pre><span></span><code>[<span class="nv">pid</span><span class="w"> </span><span class="mi">154628</span>]<span class="w"> </span><span class="k">connect</span><span class="ss">(</span><span class="mi">9</span>,<span class="w"> </span>{<span class="nv">sa_family</span><span class="o">=</span><span class="nv">AF_INET</span>,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span><span class="nv">htons</span><span class="ss">(</span><span class="mi">53</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span><span class="nv">inet_addr</span><span class="ss">(</span><span class="s2">&quot;127.0.0.53&quot;</span><span class="ss">)</span>},<span class="w"> </span><span class="mi">16</span><span class="ss">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div>

<p>然后最终获得一些 <a href="https://www.cloudflare.com/ips/">Cloudflare 的 IP 地址</a>，如 <code>172.67.196.144</code> 和 <code>104.21.92.169</code> 。还有一些 IPv6 相关的，由于我禁用了 IPv6 所以并没有工作：</p>
<div class="highlight"><pre><span></span><code>[<span class="nv">pid</span><span class="w"> </span><span class="mi">154627</span>]<span class="w"> </span><span class="k">connect</span><span class="ss">(</span><span class="mi">9</span>,<span class="w"> </span>{<span class="nv">sa_family</span><span class="o">=</span><span class="nv">AF_INET6</span>,<span class="w"> </span><span class="nv">sin6_port</span><span class="o">=</span><span class="nv">htons</span><span class="ss">(</span><span class="mi">0</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">sin6_flowinfo</span><span class="o">=</span><span class="nv">htonl</span><span class="ss">(</span><span class="mi">0</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">inet_pton</span><span class="ss">(</span><span class="nv">AF_INET6</span>,<span class="w"> </span><span class="s2">&quot;2606:4700:3034::6815:5ca9&quot;</span>,<span class="w"> </span><span class="o">&amp;</span><span class="nv">sin6_addr</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">sin6_scope_id</span><span class="o">=</span><span class="mi">0</span>},<span class="w"> </span><span class="mi">28</span><span class="ss">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="nv">ENETUNREACH</span><span class="w"> </span><span class="ss">(</span><span class="nv">Network</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">unreachable</span><span class="ss">)</span>
</code></pre></div>

<p>然后终于程序决定使用 IPv4 的地址 <code>104.21.92.169</code> 去构建请求，同时我们能看到这些都是非阻塞的（non-blocking）连接，因为 <code>connect</code> 返回 <code>-1</code> 而不是 <code>0</code> 表示「正在连接、正在连接、稍后回来检查」。</p>
<div class="highlight"><pre><span></span><code>[<span class="nv">pid</span><span class="w"> </span><span class="mi">154625</span>]<span class="w"> </span><span class="k">connect</span><span class="ss">(</span><span class="mi">9</span>,<span class="w"> </span>{<span class="nv">sa_family</span><span class="o">=</span><span class="nv">AF_INET</span>,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span><span class="nv">htons</span><span class="ss">(</span><span class="mi">443</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span><span class="nv">inet_addr</span><span class="ss">(</span><span class="s2">&quot;104.21.92.169&quot;</span><span class="ss">)</span>},<span class="w"> </span><span class="mi">16</span><span class="ss">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="nv">EINPROGRESS</span><span class="w"> </span><span class="ss">(</span><span class="nv">Operation</span><span class="w"> </span><span class="nv">now</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">progress</span><span class="ss">)</span>
[<span class="nv">pid</span><span class="w"> </span><span class="mi">154626</span>]<span class="w"> </span><span class="k">connect</span><span class="ss">(</span><span class="mi">10</span>,<span class="w"> </span>{<span class="nv">sa_family</span><span class="o">=</span><span class="nv">AF_INET</span>,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span><span class="nv">htons</span><span class="ss">(</span><span class="mi">443</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span><span class="nv">inet_addr</span><span class="ss">(</span><span class="s2">&quot;104.21.92.169&quot;</span><span class="ss">)</span>},<span class="w"> </span><span class="mi">16</span><span class="ss">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="nv">EINPROGRESS</span><span class="w"> </span><span class="ss">(</span><span class="nv">Operation</span><span class="w"> </span><span class="nv">now</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">progress</span><span class="ss">)</span>
</code></pre></div>

<p>好了！所以忽略 <a href="https://isitdns.com/">DNS</a> 的话我们看到了两个连接。</p>
<p>同时我们看到了一些线程。</p>
<p>这就是 Rust 异步的工作方式？我们只是用了一些线程？这也就是它能在「后台运行」的原因？</p>
<p>在我们回答这些问题前，让我们先调整我们的代码真正的去等待 future 完成，而不是随意的休眠 1 秒钟。</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">leaked_client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">leak</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">leaked_client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">leaked_client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_2</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">handle1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">handle2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut2</span><span class="p">);</span>

<span class="w">    </span><span class="n">handle1</span><span class="p">.</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">handle2</span><span class="p">.</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>等等，我们这不又回到原点吗？等待第一个请求完成，然后才开始第二个请求。</p>
<p>当然不是！我们运行几次就可以看到：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:11:07.934<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:11:07.958<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:11:08.676<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:11:08.680<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:11:09.325<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:11:09.338<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:11:10.134<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:11:10.144<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
</code></pre></div>

<p>。。。大部分情况下“whats-in-the-box”胜出了（它确实先开始），但是“advent-of-code-2020”也首先完成了几次。这也是我们希望看到的。</p>
<blockquote>
<p>谬论：也就是说因为有线程请求被并行（parallel）的执行了。</p>
</blockquote>
<p>不是的。但是不要相信我，让我们继续深入。</p>
<h3 id="不是因为线程">不是因为线程</h3>
<p>让我们通过 GDB 运行我们的小程序，大部分原因是我还没有对 LLDB 形成肌肉记忆，我相信这是水到渠成的事。</p>
<div class="highlight"><pre><span></span><code><span class="err">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">--</span><span class="n">quiet</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">gdb</span><span class="w"> </span><span class="o">--</span><span class="n">quiet</span><span class="w"> </span><span class="o">--</span><span class="n">args</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">waytoodeep</span>
<span class="n">Reading</span><span class="w"> </span><span class="n">symbols</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">waytoodeep</span><span class="p">...</span>
<span class="nl">warning</span><span class="p">:</span><span class="w"> </span><span class="n">Missing</span><span class="w"> </span><span class="n">auto</span><span class="o">-</span><span class="k">load</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">section</span><span class="w"> </span><span class="p">.</span><span class="n">debug_gdb_scripts</span>
<span class="k">of</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="n">ftl</span><span class="o">/</span><span class="n">waytoodeep</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">waytoodeep</span><span class="p">.</span>
<span class="k">Use</span><span class="w"> </span><span class="err">`</span><span class="n">info</span><span class="w"> </span><span class="n">auto</span><span class="o">-</span><span class="k">load</span><span class="w"> </span><span class="n">python</span><span class="o">-</span><span class="n">scripts</span><span class="w"> </span><span class="o">[</span><span class="n">REGEXP</span><span class="o">]</span><span class="err">&#39;</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">them</span><span class="p">.</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span>
</code></pre></div>

<p>一切就绪！</p>
<p>在我们开始之前先设置一下断点。我说了断点？应该是捕捉点（catchpoint）。我不知道参与构造 HTTP/2 请求的所有函数名，但是我知道 <code>connect</code> 对应的系统调用（syscall），这也是我们需要打断点的地方，或者捕捉（catch）。</p>
<div class="highlight"><pre><span></span><code><span class="ss">(</span><span class="nv">gdb</span><span class="ss">)</span><span class="w"> </span><span class="nv">catch</span><span class="w"> </span><span class="nv">syscall</span><span class="w"> </span><span class="k">connect</span>
<span class="nv">Catchpoint</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ss">(</span><span class="nv">syscall</span><span class="w"> </span><span class="s1">&#39;connect&#39;</span><span class="w"> </span>[<span class="mi">42</span>]<span class="ss">)</span>
</code></pre></div>

<p>现在我们开始！</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>Starting<span class="w"> </span>program:<span class="w"> </span>/home/amos/ftl/waytoodeep/target/debug/waytoodeep
<span class="o">[</span>Thread<span class="w"> </span>debugging<span class="w"> </span>using<span class="w"> </span>libthread_db<span class="w"> </span>enabled<span class="o">]</span>
Using<span class="w"> </span>host<span class="w"> </span>libthread_db<span class="w"> </span>library<span class="w"> </span><span class="s2">&quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;</span>.
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff7c28700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158945</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff7a27700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158946</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7fffef826700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158947</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff7826700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158948</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff7625700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158949</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff7424700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158950</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff7223700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158951</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff701f700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158952</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff6e1e700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158953</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff6c1a700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158954</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff6a16700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158955</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff680f700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158956</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff660e700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158957</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff640a700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158958</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff6206700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158959</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff5f4b700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158960</span><span class="o">)]</span>
<span class="o">[</span>New<span class="w"> </span>Thread<span class="w"> </span>0x7ffff5d4a700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158961</span><span class="o">)]</span>
<span class="o">[</span>Switching<span class="w"> </span>to<span class="w"> </span>Thread<span class="w"> </span>0x7ffff5f4b700<span class="w"> </span><span class="o">(</span>LWP<span class="w"> </span><span class="m">158960</span><span class="o">)]</span>

Thread<span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="s2">&quot;tokio-runtime-w&quot;</span><span class="w"> </span>hit<span class="w"> </span>Catchpoint<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">(</span>call<span class="w"> </span>to<span class="w"> </span>syscall<span class="w"> </span>connect<span class="o">)</span>,<span class="w"> </span>0x00007ffff7d5033b<span class="w"> </span><span class="k">in</span><span class="w"> </span>__libc_connect<span class="w"> </span><span class="o">(</span><span class="nv">fd</span><span class="o">=</span>fd@entry<span class="o">=</span><span class="m">9</span>,<span class="w"> </span><span class="nv">addr</span><span class="o">=</span>...,<span class="w"> </span>addr@entry<span class="o">=</span>...,
<span class="w">    </span><span class="nv">len</span><span class="o">=</span>len@entry<span class="o">=</span><span class="m">110</span><span class="o">)</span><span class="w"> </span>at<span class="w"> </span>../sysdeps/unix/sysv/linux/connect.c:26
<span class="m">26</span><span class="w">      </span>../sysdeps/unix/sysv/linux/connect.c:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory.
<span class="o">(</span>gdb<span class="o">)</span>
</code></pre></div>

<p>不错不错，真快！我们停在了名为 <code>tokio-runtime-w</code> 的 <code>Thread 17</code> 中，因为我猜其他所有字母都被使用了。</p>
<blockquote>
<p><code>w</code> 意味这 <code>worker</code> ，如果你不是第一天用 Unix 就会知道什么这么简写。</p>
</blockquote>
<p>好的， <code>Thread 17</code> ，那么其他线程在做什么呢？</p>
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="n">threads</span>
<span class="w">  </span><span class="n">Id</span><span class="w">   </span><span class="n">Target</span><span class="w"> </span><span class="n">Id</span><span class="w">                                            </span><span class="n">Frame</span>
<span class="w">  </span><span class="mi">1</span><span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7c2c6c0</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158941</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;waytoodeep&quot;</span><span class="w">      </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">2</span><span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7c28700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158945</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">3</span><span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7a27700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158946</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="mh">0x00007ffff7d4f5ce</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">epoll_wait</span><span class="w"> </span><span class="p">(</span><span class="n">epfd</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">events</span><span class="o">=</span><span class="mh">0x555556338b60</span><span class="p">,</span><span class="w"> </span><span class="n">maxevents</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="n">timeout</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">epoll_wait</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">30</span>
<span class="w">  </span><span class="mi">4</span><span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7fffef826700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158947</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">5</span><span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7826700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158948</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">6</span><span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7625700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158949</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">7</span><span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7424700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158950</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">8</span><span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff7223700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158951</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">9</span><span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff701f700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158952</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">10</span><span class="w">   </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6e1e700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158953</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">11</span><span class="w">   </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6c1a700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158954</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">12</span><span class="w">   </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6a16700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158955</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">13</span><span class="w">   </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff680f700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158956</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">14</span><span class="w">   </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff660e700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158957</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">15</span><span class="w">   </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff640a700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158958</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w">  </span><span class="mi">16</span><span class="w">   </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6206700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158959</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="w"> </span><span class="o">*</span><span class="mi">17</span><span class="w">   </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff5f4b700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158960</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="mh">0x00007ffff7d5033b</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">__libc_connect</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="o">=</span><span class="n">fd</span><span class="nv">@entry</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="o">=</span><span class="p">...,</span><span class="w"> </span><span class="n">addr</span><span class="nv">@entry</span><span class="o">=</span><span class="p">...,</span><span class="w"> </span><span class="nf">len</span><span class="o">=</span><span class="nf">len</span><span class="nv">@entry</span><span class="o">=</span><span class="mi">110</span><span class="p">)</span>
<span class="w">    </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="k">connect</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">26</span>
<span class="w">  </span><span class="mi">18</span><span class="w">   </span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff5d4a700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158961</span><span class="p">)</span><span class="w"> </span><span class="ss">&quot;tokio-runtime-w&quot;</span><span class="w"> </span><span class="mh">0x00007ffff7d48a46</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">__GI___mmap64</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="o">=</span><span class="mi">16418</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nf">len</span><span class="o">=</span><span class="mi">134217728</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="o">=</span><span class="mh">0x0</span><span class="p">)</span>
<span class="w">    </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">mmap64</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">59</span>
</code></pre></div>

<p>额。</p>
<p>我们可以获得更多的栈帧？</p>
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">apply</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">backtrace</span><span class="w"> </span><span class="mi">2</span>

<span class="n">Thread</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="p">(</span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff5d4a700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158961</span><span class="p">))</span><span class="err">:</span>
<span class="n">#0</span><span class="w">  </span><span class="mh">0x00007ffff7d48a46</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">__GI___mmap64</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="o">=</span><span class="mi">16418</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nf">len</span><span class="o">=</span><span class="mi">134217728</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="o">=</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">mmap64</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">59</span>
<span class="n">#1</span><span class="w">  </span><span class="n">__GI___mmap64</span><span class="w"> </span><span class="p">(</span><span class="n">addr</span><span class="o">=</span><span class="n">addr</span><span class="nv">@entry</span><span class="o">=</span><span class="mh">0x0</span><span class="p">,</span><span class="w"> </span><span class="nf">len</span><span class="o">=</span><span class="nf">len</span><span class="nv">@entry</span><span class="o">=</span><span class="mi">134217728</span><span class="p">,</span><span class="w"> </span><span class="n">prot</span><span class="o">=</span><span class="n">prot</span><span class="nv">@entry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="nv">@entry</span><span class="o">=</span><span class="mi">16418</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="o">=</span><span class="n">fd</span><span class="nv">@entry</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="nv">@entry</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">mmap64</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">47</span>
<span class="p">(</span><span class="n">More</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">frames</span><span class="w"> </span><span class="n">follow</span><span class="p">...)</span>

<span class="n">Thread</span><span class="w"> </span><span class="mi">17</span><span class="w"> </span><span class="p">(</span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff5f4b700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158960</span><span class="p">))</span><span class="err">:</span>
<span class="n">#0</span><span class="w">  </span><span class="mh">0x00007ffff7d5033b</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">__libc_connect</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="o">=</span><span class="n">fd</span><span class="nv">@entry</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="o">=</span><span class="p">...,</span><span class="w"> </span><span class="n">addr</span><span class="nv">@entry</span><span class="o">=</span><span class="p">...,</span><span class="w"> </span><span class="nf">len</span><span class="o">=</span><span class="nf">len</span><span class="nv">@entry</span><span class="o">=</span><span class="mi">110</span><span class="p">)</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="k">connect</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">26</span>
<span class="n">#1</span><span class="w">  </span><span class="mh">0x00007ffff7d8b713</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">open_socket</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="o">=</span><span class="n">type</span><span class="nv">@entry</span><span class="o">=</span><span class="n">GETFDHST</span><span class="p">,</span><span class="w"> </span><span class="k">key</span><span class="o">=</span><span class="k">key</span><span class="nv">@entry</span><span class="o">=</span><span class="mh">0x7ffff7de5ccb</span><span class="w"> </span><span class="ss">&quot;hosts&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">keylen</span><span class="o">=</span><span class="n">keylen</span><span class="nv">@entry</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">nscd_helper</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">185</span>
<span class="p">(</span><span class="n">More</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">frames</span><span class="w"> </span><span class="n">follow</span><span class="p">...)</span>

<span class="n">Thread</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="p">(</span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff6206700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158959</span><span class="p">))</span><span class="err">:</span>
<span class="n">#0</span><span class="w">  </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="n">#1</span><span class="w">  </span><span class="mh">0x0000555555b9f1d1</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">parking_lot_core</span><span class="p">:</span><span class="err">:</span><span class="nl">thread_parker</span><span class="p">:</span><span class="err">:</span><span class="nl">imp</span><span class="p">:</span><span class="err">:</span><span class="nl">ThreadParker</span><span class="p">:</span><span class="err">:</span><span class="n">futex_wait</span><span class="w"> </span><span class="p">(</span><span class="n">self</span><span class="o">=</span><span class="mh">0x7ffff6206498</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="o">=</span><span class="p">...)</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">parking_lot_core</span><span class="o">-</span><span class="mf">0.8.3</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">thread_parker</span><span class="o">/</span><span class="n">linux</span><span class="p">.</span><span class="nl">rs</span><span class="p">:</span><span class="mi">112</span>
<span class="p">(</span><span class="n">More</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">frames</span><span class="w"> </span><span class="n">follow</span><span class="p">...)</span>

<span class="n">Thread</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="p">(</span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff640a700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158958</span><span class="p">))</span><span class="err">:</span>
<span class="n">#0</span><span class="w">  </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="n">#1</span><span class="w">  </span><span class="mh">0x0000555555b9f1d1</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">parking_lot_core</span><span class="p">:</span><span class="err">:</span><span class="nl">thread_parker</span><span class="p">:</span><span class="err">:</span><span class="nl">imp</span><span class="p">:</span><span class="err">:</span><span class="nl">ThreadParker</span><span class="p">:</span><span class="err">:</span><span class="n">futex_wait</span><span class="w"> </span><span class="p">(</span><span class="n">self</span><span class="o">=</span><span class="mh">0x7ffff640a498</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="o">=</span><span class="p">...)</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">parking_lot_core</span><span class="o">-</span><span class="mf">0.8.3</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">thread_parker</span><span class="o">/</span><span class="n">linux</span><span class="p">.</span><span class="nl">rs</span><span class="p">:</span><span class="mi">112</span>
<span class="p">(</span><span class="n">More</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">frames</span><span class="w"> </span><span class="n">follow</span><span class="p">...)</span>

<span class="n">Thread</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="p">(</span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff660e700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158957</span><span class="p">))</span><span class="err">:</span>
<span class="n">#0</span><span class="w">  </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="n">#1</span><span class="w">  </span><span class="mh">0x0000555555b9f1d1</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">parking_lot_core</span><span class="p">:</span><span class="err">:</span><span class="nl">thread_parker</span><span class="p">:</span><span class="err">:</span><span class="nl">imp</span><span class="p">:</span><span class="err">:</span><span class="nl">ThreadParker</span><span class="p">:</span><span class="err">:</span><span class="n">futex_wait</span><span class="w"> </span><span class="p">(</span><span class="n">self</span><span class="o">=</span><span class="mh">0x7ffff660e498</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="o">=</span><span class="p">...)</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">parking_lot_core</span><span class="o">-</span><span class="mf">0.8.3</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">thread_parker</span><span class="o">/</span><span class="n">linux</span><span class="p">.</span><span class="nl">rs</span><span class="p">:</span><span class="mi">112</span>
<span class="p">(</span><span class="n">More</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">frames</span><span class="w"> </span><span class="n">follow</span><span class="p">...)</span>

<span class="n">Thread</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="p">(</span><span class="n">Thread</span><span class="w"> </span><span class="mh">0x7ffff680f700</span><span class="w"> </span><span class="p">(</span><span class="n">LWP</span><span class="w"> </span><span class="mi">158956</span><span class="p">))</span><span class="err">:</span>
<span class="n">#0</span><span class="w">  </span><span class="n">syscall</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">sysdeps</span><span class="o">/</span><span class="n">unix</span><span class="o">/</span><span class="n">sysv</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="nl">S</span><span class="p">:</span><span class="mi">38</span>
<span class="n">#1</span><span class="w">  </span><span class="mh">0x0000555555b9f1d1</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">parking_lot_core</span><span class="p">:</span><span class="err">:</span><span class="nl">thread_parker</span><span class="p">:</span><span class="err">:</span><span class="nl">imp</span><span class="p">:</span><span class="err">:</span><span class="nl">ThreadParker</span><span class="p">:</span><span class="err">:</span><span class="n">futex_wait</span><span class="w"> </span><span class="p">(</span><span class="n">self</span><span class="o">=</span><span class="mh">0x7ffff680f498</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="o">=</span><span class="p">...)</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="p">.</span><span class="n">cargo</span><span class="o">/</span><span class="n">registry</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">-</span><span class="mi">1</span><span class="n">ecc6299db9ec823</span><span class="o">/</span><span class="n">parking_lot_core</span><span class="o">-</span><span class="mf">0.8.3</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">thread_parker</span><span class="o">/</span><span class="n">linux</span><span class="p">.</span><span class="nl">rs</span><span class="p">:</span><span class="mi">112</span>
<span class="p">(</span><span class="n">More</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">frames</span><span class="w"> </span><span class="n">follow</span><span class="p">...)</span>
</code></pre></div>

<p>额。大部分都是挂起的。也就是空闲的。更准确的是它们在等待工作。</p>
<p>我们也可以通过 htop 查看这些所有线程，我知道我们已经看到了，但是我仅仅是觉得 htop 很棒。感谢 <a href="https://twitter.com/hisham%5Fhm">Hisham</a>！
<img alt="" src="https://fasterthanli.me/content/articles/understanding-rust-futures-by-going-way-too-deep/assets/htop-colors.571c5effbff8a0b3.webp">
所以，我们注意到一些线程，同时也有一些 CPU 核心。可能是一个 CPU 核心一个线程？
<img alt="" src="https://fasterthanli.me/content/articles/understanding-rust-futures-by-going-way-too-deep/assets/worker-threads.64dbe39e33ccfc4f.webp">
是的。然后还有一些阻塞的线程，正如我们从上面 <code>strace</code> 输出看到的那样， 它会进行一些阻塞的 <code>connect</code> 调用去查询 DNS（实际是 glibc 在执行），
所以它通过运行在工作线程之外避免阻塞其他任务。</p>
<blockquote>
<p>所以多个线程，这就是为什么一次可以运行多个请求的原因？</p>
</blockquote>
<p>实际上文档上表明这是一个单线程的执行器，我也不能确定，所以让我们试一下：</p>
<div class="highlight"><pre><span></span><code><span class="c1">//                           👇</span>
<span class="cp">#[tokio::main(flavor = </span><span class="s">&quot;current_thread&quot;</span><span class="cp">)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// (same as before)</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:50:15.977<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">19</span>:50:15.994<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
</code></pre></div>

<p>两个响应间隔 <code>17ms</code> ，这个时间不够构造一个完整的请求，所以请求并行（parallel）的执行了。如果你依然坚持它内部使用了线程，让我们进一步确认我们只有一个线程：
<img alt="" src="https://fasterthanli.me/content/articles/understanding-rust-futures-by-going-way-too-deep/assets/current-thread.cd7b619ed644899b.webp">
确实有多个线程，但是这些都是阻塞线程。仅仅是 DNS 查询。可以通过 htop 看到已经没有无数（15）的工作线程了：
<img alt="" src="https://fasterthanli.me/content/articles/understanding-rust-futures-by-going-way-too-deep/assets/htop-current-thread.fe28174abc5d15fa.webp">
（顺便说一下 15 个工作线程的原因，这是因为我预留了一个 CPU 核心没有分配给虚拟机，这样即使虚拟机全速运行也不会导致宿主机停止响应）。</p>
<p>如果我们将 DNS 查询排除在外，我们就可以看到实际上仅仅使用了一个线程，我们将继续下去，以防你依然存疑！</p>
<h3 id="插曲-让我们避免泄漏内存">插曲：让我们避免泄漏内存</h3>
<p>但是在那之前：正在泄漏 reqwest 的 <code>Client</code> 让我很不爽。</p>
<p>为了避免，我们可以创建一个原子引用计数（atomically-reference-counted），这样它就可以随着任务运行而存活。</p>
<p>修改起来非常简单：</p>
<div class="highlight"><pre><span></span><code><span class="c1">//             👇 Atomically Reference Counted = Arc</span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="p">;</span>

<span class="cp">#[tokio::main(flavor = </span><span class="s">&quot;current_thread&quot;</span><span class="cp">)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//           👇 there we go</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arc</span>::<span class="n">new</span><span class="p">(</span><span class="n">Client</span>::<span class="n">new</span><span class="p">());</span>

<span class="w">    </span><span class="c1">//                              👇</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// (cloning it only increases the reference count)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">URL_2</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">handle1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">handle2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut2</span><span class="p">);</span>

<span class="w">    </span><span class="n">handle1</span><span class="p">.</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">handle2</span><span class="p">.</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="cp">#[allow(clippy::manual_async_fn)]</span>
<span class="k">fn</span> <span class="nf">fetch_thing</span><span class="p">(</span>
<span class="w">    </span><span class="c1">//       👇 now taking this, we have shared ownership of it</span>
<span class="w">    </span><span class="n">client</span>: <span class="nc">Arc</span><span class="o">&lt;</span><span class="n">Client</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span> <span class="kt">str</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// luckily this  👇 only requires `&amp;self`</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">send</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">.</span><span class="n">error_for_status</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">content_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="n">res</span><span class="p">.</span><span class="n">headers</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;content-type&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Got a response!&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>好了，现在我感觉好多了。我们的程序不再泄漏一些字节即使它永远不会运行超过几秒钟。一切都还好。</p>
<p>让我们看一下 <code>reqwest</code> 的 <code>Client</code> 定义:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[derive(Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Client</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">inner</span>: <span class="nc">Arc</span><span class="o">&lt;</span><span class="n">ClientRef</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>它已经是引用计数的了，所以我们可以直接接受一个 <code>Client</code>:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main(flavor = </span><span class="s">&quot;current_thread&quot;</span><span class="cp">)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//             👇</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="c1">//                              👇</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">URL_1</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// no need to clone a second time</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_2</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">handle1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">handle2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut2</span><span class="p">);</span>

<span class="w">    </span><span class="n">handle1</span><span class="p">.</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">handle2</span><span class="p">.</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="cp">#[allow(clippy::manual_async_fn)]</span>
<span class="k">fn</span> <span class="nf">fetch_thing</span><span class="p">(</span>
<span class="w">    </span><span class="c1">//        👇</span>
<span class="w">    </span><span class="n">client</span>: <span class="nc">Client</span><span class="p">,</span>
<span class="w">    </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span> <span class="kt">str</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">send</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">.</span><span class="n">error_for_status</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">content_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="n">res</span><span class="p">.</span><span class="n">headers</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;content-type&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Got a response!&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>好了。</p>
<p>对了，仅供参考，更简单的 <code>async fn</code> 也可以工作了：</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">fetch_thing</span><span class="p">(</span><span class="n">client</span>: <span class="nc">Client</span><span class="p">,</span><span class="w"> </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">send</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">.</span><span class="n">error_for_status</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">content_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="n">res</span><span class="p">.</span><span class="n">headers</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;content-type&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Got a response!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>我们甚至不需要要求 <code>url</code> 的借用生命周期是 <code>'static</code> 。如果 <code>url</code> 是 <code>'static</code> 的则返回的 Future 也是，反之亦然。</p>
<p>作为例子，下面代码无法通过编译：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main(flavor = </span><span class="s">&quot;current_thread&quot;</span><span class="cp">)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// this is a `String`, owned by main</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">url1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="n">URL_1</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// we&#39;re borrowing from main           👇</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">url1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fut2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_2</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">handle1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">handle2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="n">fut2</span><span class="p">);</span>

<span class="w">    </span><span class="n">handle1</span><span class="p">.</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">handle2</span><span class="p">.</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="k">check</span>
<span class="w">    </span><span class="n">Checking</span><span class="w"> </span><span class="n">waytoodeep</span><span class="w"> </span><span class="n">v0</span><span class="mf">.1.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="n">ftl</span><span class="o">/</span><span class="n">waytoodeep</span><span class="p">)</span>

<span class="k">error</span><span class="err">[</span><span class="n">E0597</span><span class="err">]</span><span class="o">:</span><span class="w"> </span><span class="n n-Quoted">`url1`</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">live</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">enough</span>
<span class="w">  </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">18</span><span class="o">:</span><span class="mi">44</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">18</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">let</span><span class="w"> </span><span class="n">fut1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="k">client</span><span class="p">.</span><span class="k">clone</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">url1</span><span class="p">);</span>
<span class="w">   </span><span class="o">|</span><span class="w">                </span><span class="o">----------------------------^^^^^-</span>
<span class="w">   </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">                           </span><span class="o">|</span>
<span class="w">   </span><span class="o">|</span><span class="w">                </span><span class="o">|</span><span class="w">                           </span><span class="n">borrowed</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">live</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">enough</span>
<span class="w">   </span><span class="o">|</span><span class="w">                </span><span class="n">argument</span><span class="w"> </span><span class="n">requires</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n n-Quoted">`url1`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">borrowed</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n n-Quoted">`&#39;static`</span>
<span class="p">...</span>
<span class="mi">28</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="err">}</span>
<span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n n-Quoted">`url1`</span><span class="w"> </span><span class="n">dropped</span><span class="w"> </span><span class="n">here</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">still</span><span class="w"> </span><span class="n">borrowed</span>
</code></pre></div>

<blockquote>
<p>你面对的考验就是：修改了一些代码，然后突然间整个 <code>Future</code> 不再实现 <code>Send</code> ，但是你需要它实现 <code>Send</code> 。参考<a href="https://fasterthanli.me/articles/getting-in-and-out-of-trouble-with-rust-futures">Getting in and out of trouble with Rust futures</a>。</p>
</blockquote>
<p>在我们进一步深入之前，我们还想提一下，除了通过 <code>tokio::spawn</code> 可以同时运行两个 future 并且立即等待两个 future 完成，还是使用 <code>FuturesUnordered</code> 实现相同目的。</p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">futures</span><span class="mf">@0.3.16</span>
<span class="w">    </span><span class="n">Updating</span><span class="w"> </span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//github.com/rust-lang/crates.io-index&#39; index</span>
<span class="w">      </span><span class="n">Adding</span><span class="w"> </span><span class="n">futures</span><span class="w"> </span><span class="n">v0</span><span class="mf">.3.16</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dependencies</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">futures</span>::<span class="p">{</span><span class="n">stream</span>::<span class="n">FuturesUnordered</span><span class="p">,</span><span class="w"> </span><span class="n">StreamExt</span><span class="p">};</span>


<span class="cp">#[tokio::main(flavor = </span><span class="s">&quot;current_thread&quot;</span><span class="cp">)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span>
<span class="w">        </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">URL_1</span><span class="p">),</span>
<span class="w">        </span><span class="n">fetch_thing</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">URL_2</span><span class="p">),</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">    </span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">collect</span>::<span class="o">&lt;</span><span class="n">FuturesUnordered</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">group</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="k">await</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// propagate errors</span>
<span class="w">        </span><span class="n">item</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>通过这个解决半啃啊，我们可以 await 任意数量的 future 对象，同时也是并发的被轮询（polled）。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:12:37.208<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/articles/whats-in-the-box<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:12:37.227<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>a<span class="w"> </span>response!<span class="w"> </span><span class="nv">url</span><span class="o">=</span>https://fasterthanli.me/series/advent-of-code-2020/part-13<span class="w"> </span><span class="nv">content_type</span><span class="o">=</span>Some<span class="o">(</span><span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="o">)</span>
</code></pre></div>

<p>仅仅。。。19 毫秒的间隔 -- 可以确定是并发的。</p>
<h3 id="彻底摆脱-dns">彻底摆脱 DNS</h3>
<p>现在让我们暂时忘掉 <code>reqwest</code> 。</p>
<p>HTTP <a href="https://fasterthanli.me/articles/aiming-for-correctness-with-types">并不难</a> ，我们可以自己构建。只要 TCP 就行：</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">net</span>::<span class="n">SocketAddr</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">tokio</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">io</span>::<span class="p">{</span><span class="n">AsyncReadExt</span><span class="p">,</span><span class="w"> </span><span class="n">AsyncWriteExt</span><span class="p">},</span>
<span class="w">    </span><span class="n">net</span>::<span class="n">TcpStream</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">fetch_thing</span><span class="p">(</span><span class="n">name</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// look mom, no DNS!</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">addr</span>: <span class="nc">SocketAddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">80</span><span class="p">).</span><span class="n">into</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TcpStream</span>::<span class="n">connect</span><span class="p">(</span><span class="n">addr</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// we&#39;re writing straight to the socket, there&#39;s no buffering</span>
<span class="w">    </span><span class="c1">// so no need to flush</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;GET / HTTP/1.1</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;Host: 1.1.1.1</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;User-Agent: cool-bear</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;Connection: close</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">with_capacity</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">read_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">response</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">lines</span><span class="p">().</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap_or_default</span><span class="p">();</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Got response!&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// dropping the socket will close the connection</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>可以正常运行：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:24:05.158<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">301</span><span class="w"> </span>Moved<span class="w"> </span>Permanently<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:24:05.159<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">301</span><span class="w"> </span>Moved<span class="w"> </span>Permanently<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
</code></pre></div>

<p>（看，第二个赢得了胜利）。</p>
<p>同时再也没有 DNS 查询了。</p>
<p>当然 <code>http://1.1.1.1</code> 将我们重定向到 HTTPS 的页面，技术上实现 TLS 并不困难，但是我们的篇幅已经很长了，所以。。。</p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">tokio</span><span class="o">-</span><span class="n">rustls</span><span class="mf">@0.22.0</span>
<span class="w">    </span><span class="n">Updating</span><span class="w"> </span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//github.com/rust-lang/crates.io-index&#39; index</span>
<span class="w">      </span><span class="n">Adding</span><span class="w"> </span><span class="n">tokio</span><span class="o">-</span><span class="n">rustls</span><span class="w"> </span><span class="n">v0</span><span class="mf">.22.0</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dependencies</span>
<span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">webpki</span><span class="mf">@0.21.4</span>
<span class="w">    </span><span class="n">Updating</span><span class="w"> </span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//github.com/rust-lang/crates.io-index&#39; index</span>
<span class="w">      </span><span class="n">Adding</span><span class="w"> </span><span class="n">webpki</span><span class="w"> </span><span class="n">v0</span><span class="mf">.21.4</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dependencies</span>
<span class="n">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">webpki</span><span class="o">-</span><span class="n">roots</span><span class="mf">@0.21.1</span>
<span class="w">    </span><span class="n">Updating</span><span class="w"> </span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//github.com/rust-lang/crates.io-index&#39; index</span>
<span class="w">      </span><span class="n">Adding</span><span class="w"> </span><span class="n">webpki</span><span class="o">-</span><span class="n">roots</span><span class="w"> </span><span class="n">v0</span><span class="mf">.21.1</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">dependencies</span>
</code></pre></div>

<p>然后。。。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>rm<span class="w"> </span>reqwest
<span class="w">    </span>Removing<span class="w"> </span>reqwest<span class="w"> </span>from<span class="w"> </span>dependencies
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">sync</span>::<span class="n">Arc</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">webpki</span>::<span class="n">DNSNameRef</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">tokio_rustls</span>::<span class="p">{</span><span class="n">rustls</span>::<span class="n">ClientConfig</span><span class="p">,</span><span class="w"> </span><span class="n">TlsConnector</span><span class="p">};</span>

<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">fetch_thing</span><span class="p">(</span><span class="n">name</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// look out it&#39;s port 443 now</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">addr</span>: <span class="nc">SocketAddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">443</span><span class="p">).</span><span class="n">into</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TcpStream</span>::<span class="n">connect</span><span class="p">(</span><span class="n">addr</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// establish a TLS session...</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">connector</span>: <span class="nc">TlsConnector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClientConfig</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">config</span>
<span class="w">            </span><span class="p">.</span><span class="n">root_store</span>
<span class="w">            </span><span class="p">.</span><span class="n">add_server_trust_anchors</span><span class="p">(</span><span class="o">&amp;</span><span class="n">webpki_roots</span>::<span class="n">TLS_SERVER_ROOTS</span><span class="p">);</span>
<span class="w">        </span><span class="n">Arc</span>::<span class="n">new</span><span class="p">(</span><span class="n">config</span><span class="p">).</span><span class="n">into</span><span class="p">()</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="c1">// we have to use the proper DNS name now      👇</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">dnsname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DNSNameRef</span>::<span class="n">try_from_ascii_str</span><span class="p">(</span><span class="s">&quot;one.one.one.one&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connector</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dnsname</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// we&#39;re writing straight to the socket, there&#39;s no buffering</span>
<span class="w">    </span><span class="c1">// so no need to flush</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;GET / HTTP/1.1</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//                        👇</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;Host: one.one.one.one</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;User-Agent: cool-bear</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;Connection: close</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">with_capacity</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">read_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">response</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">lines</span><span class="p">().</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap_or_default</span><span class="p">();</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Got response!&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// dropping the socket will close the connection</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:31:32.627<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:31:32.658<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
</code></pre></div>

<p>好了，现在返回状态码 200！</p>
<p>我们的目标是了解 Rust 的 future，我们已经获得了不错的进展。</p>
<p>但是让我们考虑以下场景：我们想并发的执行两个请求，一旦其中一个失败，另外一个也应该立即请求失败，或者两个一起成功。</p>
<h3 id="tokio-的-try-join-宏">tokio 的 try_join 宏</h3>
<p>实际上，又一个宏可以做这个！</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main(flavor = </span><span class="s">&quot;current_thread&quot;</span><span class="cp">)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">try_join</span><span class="o">!</span><span class="p">(</span><span class="n">fetch_thing</span><span class="p">(</span><span class="s">&quot;first&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="s">&quot;second&quot;</span><span class="p">),)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">?</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;All done!&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>这就是我们想要的！</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:44:52.150<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:44:52.165<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:44:52.165<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(()</span>,<span class="w"> </span><span class="o">())</span>
</code></pre></div>

<p>再次快速检查以下：响应间隔在 15ms -- 也就是确定是并发的发送。</p>
<p><code>try_join!</code> 帮我们进行了 <code>await</code> ，同时帮我们处理了结果。如果一切正常，我们得到所有 future 对象的结果：内容为 <code>Ok</code> 的空元组（有序的）。</p>
<p>所以我们可以取到我们 future 返回的对象：</p>
<div class="highlight"><pre><span></span><code><span class="c1">//                                          👇</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">fetch_thing</span><span class="p">(</span><span class="n">name</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// (omitted)</span>

<span class="w">    </span><span class="c1">//  👇</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<p>为了方便我们自己，它们按照顺序返回，无论哪个先被执行：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:47:56.967<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:47:56.967<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:47:56.967<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:47:57.933<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:47:57.935<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:47:57.935<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:47:58.942<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:47:58.946<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:47:58.946<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
</code></pre></div>

<p>好了，现在我们没有 DNS 查询，我们就可以消除“同时”请求是由于多线程实现的。</p>
<p>因为，如果我们在 <code>strace</code> 下运行程序，并通过 <code>-f</code> 请求跟踪子线程（ BTW <code>f</code> 意思是跟踪（ <code>follow</code> ）子线程）：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cargo<span class="w"> </span>build<span class="w"> </span>--quiet<span class="w"> </span>--release<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>strace<span class="w"> </span>-f<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;connect&#39;</span><span class="w"> </span>./target/release/waytoodeep
connect<span class="o">(</span><span class="m">9</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">443</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;1.1.1.1&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>EINPROGRESS<span class="w"> </span><span class="o">(</span>Operation<span class="w"> </span>now<span class="w"> </span><span class="k">in</span><span class="w"> </span>progress<span class="o">)</span>
connect<span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET,<span class="w"> </span><span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span><span class="m">443</span><span class="o">)</span>,<span class="w"> </span><span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">&quot;1.1.1.1&quot;</span><span class="o">)}</span>,<span class="w"> </span><span class="m">16</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>EINPROGRESS<span class="w"> </span><span class="o">(</span>Operation<span class="w"> </span>now<span class="w"> </span><span class="k">in</span><span class="w"> </span>progress<span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:51:54.004<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:51:54.013<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">20</span>:51:54.015<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
+++<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">0</span><span class="w"> </span>+++
</code></pre></div>

<p>。。。现在我们看到了预期的两次 <code>connect</code> 调用，但是没有任何子线程。而且在这个运行中，响应之间的间隔时间是 9 毫秒！少于我直接 ping 1.1.1.1:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ping<span class="w"> </span>-c<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1</span>.1.1.1
PING<span class="w"> </span><span class="m">1</span>.1.1.1<span class="w"> </span><span class="o">(</span><span class="m">1</span>.1.1.1<span class="o">)</span><span class="w"> </span><span class="m">56</span><span class="o">(</span><span class="m">84</span><span class="o">)</span><span class="w"> </span>bytes<span class="w"> </span>of<span class="w"> </span>data.
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">1</span>.1.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">57</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">13</span>.7<span class="w"> </span>ms

---<span class="w"> </span><span class="m">1</span>.1.1.1<span class="w"> </span>ping<span class="w"> </span>statistics<span class="w"> </span>---
<span class="m">1</span><span class="w"> </span>packets<span class="w"> </span>transmitted,<span class="w"> </span><span class="m">1</span><span class="w"> </span>received,<span class="w"> </span><span class="m">0</span>%<span class="w"> </span>packet<span class="w"> </span>loss,<span class="w"> </span><span class="nb">time</span><span class="w"> </span>0ms
rtt<span class="w"> </span>min/avg/max/mdev<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">13</span>.748/13.748/13.748/0.000<span class="w"> </span>ms
</code></pre></div>

<p>这是因为执行器通过 Event Loop 构建非阻塞的系统调用，然后订阅 Event Loop 管理的资源相关的事件，
然后就可以知道一个 socket 什么时间可以进行读写。</p>
<p>所以，future 对象只是一些状态，接下来就可以进行 await，那么在哪订阅的事件呢？</p>
<p>让我们尝试创建一个我们自己的 <code>try_join</code> -- 一个函数，并且只接受两个 future。然后我们就能看到发生了什么。</p>
<p>我们已经实现了自己的 future，实现一个 <code>try_join</code> 函数会有多麻烦？</p>
<h3 id="事实证明很麻烦">事实证明很麻烦</h3>
<p>我们先从简单的开始！我们想实现一个函数接受两个 future 对象然后返回一个 future 对象。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in `src/main.rs`</span>
<span class="k">mod</span> <span class="nn">tj</span><span class="p">;</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1">// in `src/tj.rs`</span>

<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">future</span>::<span class="n">Future</span><span class="p">;</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">try_join</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">B</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="fm">todo!</span><span class="p">(</span><span class="s">&quot;implement me!&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>额。函数不应该只返回一个空元组，它需要返回一个包含成功结果的元组。或者遇到的第一个错误。</p>
<p>所以我们需要添加一些更多的范型参数：一个错误类型（我们假设两个 future 对象返回同样的错误类型），另一个是 future 对象返回的 <code>Ok</code> 的类型。</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">try_join</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">B</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">),</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="fm">todo!</span><span class="p">(</span><span class="s">&quot;implement me!&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>好了！这非常绕口，但是我相信我们已经实现了需求。</p>
<p>需要注意的是我们使用了 <code>impl Trait</code> 语法，让我们不用暴露我们自己的 <code>try join future</code> 。这不重要，但是可以让我们用更少的 <code>pub</code> 关键字，同时我们的手指已经码累了。非常累。</p>
<p>所以，让我们来创建这个类型！</p>
<p>类型需要持续 <code>A</code> 和 <code>B</code> ，并注意 <code>AR</code> 、 <code>BR</code> 和 <code>E</code> 类型。所以，希望您对这些范型参数沙拉有个好胃口。</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="nc">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span>
<span class="w">    </span><span class="n">b</span>: <span class="nc">B</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>然后可以在我们的 <code>try_join</code> 函数中返回它：</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">try_join</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">B</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">),</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// so simple!</span>
<span class="w">    </span><span class="n">TryJoin</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>我认为这很好的说明一个事实：创建 future 对象仅仅是构建状态。不需要任何额外的工作。</p>
<p>当然，这个不会通过编译，因为 <code>TryJoin</code> 还没有实现 <code>Future</code> 。</p>
<p>但是不要担心！ <code>rust-analyzer</code> 可以帮助我们生成缺失的部分：</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">future</span>::<span class="n">Future</span><span class="p">,</span>
<span class="w">    </span><span class="n">pin</span>::<span class="n">Pin</span><span class="p">,</span>
<span class="w">    </span><span class="n">task</span>::<span class="p">{</span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">Poll</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">),</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">todo!</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>如果我们真正的实现了，我们将按照下面方式使用：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main(flavor = </span><span class="s">&quot;current_thread&quot;</span><span class="cp">)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tj</span>::<span class="n">try_join</span><span class="p">(</span><span class="n">fetch_thing</span><span class="p">(</span><span class="s">&quot;first&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="s">&quot;second&quot;</span><span class="p">)).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">?</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;All done!&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>当然，现在只是会崩溃：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release

The<span class="w"> </span>application<span class="w"> </span>panicked<span class="w"> </span><span class="o">(</span>crashed<span class="o">)</span>.
Message:<span class="w">  </span>not<span class="w"> </span>yet<span class="w"> </span>implemented
Location:<span class="w"> </span>src/tj.rs:32

Backtrace<span class="w"> </span>omitted.
Run<span class="w"> </span>with<span class="w"> </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>environment<span class="w"> </span>variable<span class="w"> </span>to<span class="w"> </span>display<span class="w"> </span>it.
Run<span class="w"> </span>with<span class="w"> </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span>full<span class="w"> </span>to<span class="w"> </span>include<span class="w"> </span><span class="nb">source</span><span class="w"> </span>snippets.
</code></pre></div>

<p>所以，我猜我们需要实现它！</p>
<p>好吧，让我们先尝试至少轮询（polling）一个 future 对象。</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">);</span>

<span class="w">    </span><span class="fm">todo!</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">RUST_LOG</span><span class="o">=</span><span class="n">info</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">quiet</span><span class="w"> </span><span class="o">--</span><span class="k">release</span>
<span class="k">error</span><span class="err">[</span><span class="n">E0599</span><span class="err">]</span><span class="o">:</span><span class="w"> </span><span class="k">no</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="n">named</span><span class="w"> </span><span class="n n-Quoted">`poll`</span><span class="w"> </span><span class="k">found</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="n n-Quoted">`A`</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">current</span><span class="w"> </span><span class="n">scope</span>
<span class="w">   </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">tj</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">32</span><span class="o">:</span><span class="mi">24</span>
<span class="w">    </span><span class="o">|</span>
<span class="mi">32</span><span class="w">  </span><span class="o">|</span><span class="w">         </span><span class="n">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">);</span>
<span class="w">    </span><span class="o">|</span><span class="w">                        </span><span class="o">^^^^</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">found</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n n-Quoted">`A`</span>
<span class="w">    </span><span class="o">|</span>
<span class="w">   </span><span class="o">:::</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">amos</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">stable</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="no">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">future</span><span class="o">/</span><span class="n">future</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">100</span><span class="o">:</span><span class="mi">8</span>
<span class="w">    </span><span class="o">|</span>
<span class="mi">100</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">fn</span><span class="w"> </span><span class="n">poll</span><span class="p">(</span><span class="n">self</span><span class="o">:</span><span class="w"> </span><span class="n">Pin</span><span class="o">&lt;&amp;</span><span class="n">mut</span><span class="w"> </span><span class="n">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mut</span><span class="w"> </span><span class="k">Context</span><span class="o">&lt;</span><span class="s1">&#39;_&gt;) -&gt; Poll&lt;Self::Output&gt;;</span>
<span class="s1">    |        ---- the method is available for `Pin&lt;&amp;mut A&gt;` here</span>
<span class="s1">    |</span>
<span class="s1">help: consider wrapping the receiver expression with the appropriate type</span>
<span class="s1">    |</span>
<span class="s1">32  |         let a = Pin::new(&amp;mut self.a).poll(cx);</span>
<span class="s1">    |                 ^^^^^^^^^^^^^       ^</span>
</code></pre></div>

<p>额！一个好的开始，好的开始。</p>
<p>我已经在这里<a href="https://fasterthanli.me/articles/pin-and-suffering">详细的解释了</a> Pin，所以这里我们就简单的介绍一下。</p>
<p>方法通常通过如下方式定义接收者（receiver）：</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="nc">MyType</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">do_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;my value is {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>也就是下面的简写：</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="nc">MyType</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">do_thing</span><span class="p">(</span><span class="bp">self</span>: <span class="kp">&amp;</span><span class="nc">Self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;my value is {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>因为我们在 <code>impl MyType</code> 代码块中 <code>Self</code> 就是 <code>MyType</code> 。</p>
<p>很清晰吧？好了，还可以定义其他很多类型作为接收者， <code>Pin&lt;&amp;mut Self&gt;</code> 就是其中之一：</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="nc">MyType</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">do_thing</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// good luck!1</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>那么 <code>MyType</code> 必须是固定的（pinned）是什么意思呢？比如，它保证不进行转移（move）。除非它实现了 <code>Unpin</code> ，
然后它就可以是非固定的（unpinned），可移动，然后被再一次固定。</p>
<p>对于剩下的文章，我们不会假设我们的 future <code>A</code> 和 <code>B</code> 都是 <code>Unpin</code> ，也就是说我们自己不会移动（move）它们（只销毁（drop）它们）。</p>
<p>你可以说我们不需要 <code>A</code> 和 <code>B</code> 是 <code>Unpin</code> 的，因为我们没有添加指定的 where clause 来标记需要它们是 <code>Unpin</code> 。
因为如果我们需要，我们就要像下面这样添加额外的 <code>trait bound</code> ：</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="nc">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="c1">//                                    👇</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Unpin</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Unpin</span><span class="p">,</span>
<span class="p">{}</span>
</code></pre></div>

<p>但是我们没有，所以我们不能假设 <code>A</code> 或 <code>B</code> 是 <code>Unpin</code> 的。</p>
<p>所以！我们现在真的只是面临固定（pin）保护的问题。</p>
<p>我们现在只持有一个 <code>Pin&lt;&amp;mut TryJoin&lt;A, B, ...&gt;&gt;</code> 但是我希望持续一个 <code>Pin&lt;&amp;mut A&gt;</code> （因为这就是我们因为需要轮询 <code>A</code> ）。</p>
<p>另外一个解决方法，我倾向于通过一些类似 <a href="https://lib.rs/crates/pin-project">pin-project</a> 包，或者类似 <a href="https://lib.rs/crates/pin-project-lite">pin-project-lite</a>，但是在我们前进的方向直接使用 <code>pin-project</code> 真的很尴尬，
所以我们这里使用 <code>unsafe</code> 作为替代：</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">map_unchecked_mut</span><span class="p">(</span><span class="o">|</span><span class="n">this</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">);</span>

<span class="w">    </span><span class="fm">todo!</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<p>可以通过编译。但是我们在使用 <code>unsafe</code> ，也就意味着编译器正式停止 ~~照顾~~ 检查我们的代码。
我们自己必须强制执行一些不变量（invariants），并且非常非常小心，同时让其他人审查（review）我们的工作，
但是依然可能会出错，因为他们也会休息。</p>
<p>现在，非常棒的是我们可以轮询 <code>a</code> 。它如果完成会返回 <code>Poll::Ready(Result&lt;AR, E&gt;)</code> ，
否则就是等会会完成则返回 <code>Poll::Pending</code> 。</p>
<p>我们可以观察到：</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">map_unchecked_mut</span><span class="p">(</span><span class="o">|</span><span class="n">this</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;A is pending...&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;A is ready!&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="fm">todo!</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<p>我们通过打印日志“A is pending”知道准备完成。这可能需要几个回合：毕竟，我们正在做一些重要的事情。
我们建立一个 TCP 连接，接着在上面进行 TLS 会话，接着是一些分开的写，最后读到 EOF（end of file）。</p>
<p>当然，如果我们运行它的话：</p>
<div class="highlight"><pre><span></span><code><span class="n">aytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.495</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.495</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.495</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.495</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.495</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.495</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.495</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.513</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.513</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.513</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.513</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.513</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.514</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.522</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.522</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.522</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.522</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.522</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.523</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.523</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.530</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.530</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pending</span><span class="o">...</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.530</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">:</span><span class="w"> </span><span class="n">Got</span><span class="w"> </span><span class="n">response</span><span class="o">!</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="n">OK</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">first</span>
<span class="n">Jul</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">14.530</span><span class="w">  </span><span class="n">INFO</span><span class="w"> </span><span class="n">waytoodeep</span><span class="p">::</span><span class="n">tj</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">ready</span><span class="o">!</span>
<span class="n">The</span><span class="w"> </span><span class="n">application</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="p">(</span><span class="n">crashed</span><span class="p">)</span><span class="o">.</span>
<span class="n">Message</span><span class="p">:</span><span class="w">  </span><span class="ow">not</span><span class="w"> </span><span class="n">yet</span><span class="w"> </span><span class="n">implemented</span>
<span class="n">Location</span><span class="p">:</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">tj</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">46</span>

<span class="n">Backtrace</span><span class="w"> </span><span class="n">omitted</span><span class="o">.</span>
<span class="n">Run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">it</span><span class="o">.</span>
<span class="n">Run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="n">full</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">include</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="n">snippets</span><span class="o">.</span>
</code></pre></div>

<p>我们可以看到它确实花费了几个回合。</p>
<p>注意如果 <code>A</code> 返回错误我们的代码也会返回 <code>Poll:Ready</code> ，因为我们想收集 A 和 B 的结果。</p>
<p>所以我们对 B 做相同的事情：</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">map_unchecked_mut</span><span class="p">(</span><span class="o">|</span><span class="n">this</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;A is pending...&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;A is ready!&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">map_unchecked_mut</span><span class="p">(</span><span class="o">|</span><span class="n">this</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;B is pending...&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;B is ready!&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="fm">todo!</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<p>然后。。whoops：</p>
<div class="highlight"><pre><span></span><code><span class="n">RUST_LOG</span><span class="o">=</span><span class="n">info</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">quiet</span><span class="w"> </span><span class="o">--</span><span class="k">release</span>
<span class="k">error</span><span class="err">[</span><span class="n">E0382</span><span class="err">]</span><span class="o">:</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">moved</span><span class="w"> </span><span class="k">value</span><span class="o">:</span><span class="w"> </span><span class="n n-Quoted">`self`</span>
<span class="w">   </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">src</span><span class="o">/</span><span class="n">tj</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">46</span><span class="o">:</span><span class="mi">26</span>
<span class="w">    </span><span class="o">|</span>
<span class="mi">33</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="n">fn</span><span class="w"> </span><span class="n">poll</span><span class="p">(</span><span class="n">self</span><span class="o">:</span><span class="w"> </span><span class="n">Pin</span><span class="o">&lt;&amp;</span><span class="n">mut</span><span class="w"> </span><span class="n">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mut</span><span class="w"> </span><span class="k">Context</span><span class="o">&lt;</span><span class="s1">&#39;_&gt;) -&gt; Poll&lt;Self::Output&gt; {</span>
<span class="s1">    |             ---- move occurs because `self` has type `Pin&lt;&amp;mut TryJoin&lt;A, B, AR, BR, E&gt;&gt;`, which does not implement the `Copy` trait</span>
<span class="s1">34  |         let a = unsafe { self.map_unchecked_mut(|this| &amp;mut this.a) };</span>
<span class="s1">    |                               ------------------------------------- `self` moved due to this method call</span>
<span class="s1">...</span>
<span class="s1">46  |         let b = unsafe { self.map_unchecked_mut(|this| &amp;mut this.a) };</span>
<span class="s1">    |                          ^^^^ value used here after move</span>
<span class="s1">    |</span>
<span class="s1">note: this function takes ownership of the receiver `self`, which moves `self`</span>
<span class="s1">   --&gt; /home/amos/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/pin.rs:776:43</span>
<span class="s1">    |</span>
<span class="s1">776 |     pub unsafe fn map_unchecked_mut&lt;U, F&gt;(self, func: F) -&gt; Pin&lt;&amp;&#39;</span><span class="n">a</span><span class="w"> </span><span class="n">mut</span><span class="w"> </span><span class="n">U</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">|</span><span class="w">                                           </span><span class="o">^^^^</span>
</code></pre></div>

<p>是的。 <code>map_unchecked_mut</code> 占有了 <code>self</code> 。</p>
<p>不用担心，我们可以使用 <code>.as_mut()</code> ：</p>
<div class="highlight"><pre><span></span><code><span class="c1">//       👇</span>
<span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">//                      👇</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">as_mut</span><span class="p">().</span><span class="n">map_unchecked_mut</span><span class="p">(</span><span class="o">|</span><span class="n">this</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;A is pending...&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;A is ready!&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">//                      👇</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">as_mut</span><span class="p">().</span><span class="n">map_unchecked_mut</span><span class="p">(</span><span class="o">|</span><span class="n">this</span><span class="o">|</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;B is pending...&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;B is ready!&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="fm">todo!</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<p>但是依然无法通过编译：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
<span class="o">(</span>cut<span class="o">)</span>
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">22</span>:57:07.913<span class="w">  </span>INFO<span class="w"> </span>waytoodeep::tj:<span class="w"> </span>A<span class="w"> </span>is<span class="w"> </span>pending...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">22</span>:57:07.913<span class="w">  </span>INFO<span class="w"> </span>waytoodeep::tj:<span class="w"> </span>A<span class="w"> </span>is<span class="w"> </span>pending...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">22</span>:57:07.913<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">22</span>:57:07.913<span class="w">  </span>INFO<span class="w"> </span>waytoodeep::tj:<span class="w"> </span>A<span class="w"> </span>is<span class="w"> </span>ready!
The<span class="w"> </span>application<span class="w"> </span>panicked<span class="w"> </span><span class="o">(</span>crashed<span class="o">)</span>.
Message:<span class="w">  </span><span class="sb">`</span>async<span class="w"> </span>fn<span class="sb">`</span><span class="w"> </span>resumed<span class="w"> </span>after<span class="w"> </span>completion
Location:<span class="w"> </span>src/main.rs:24

Backtrace<span class="w"> </span>omitted.
Run<span class="w"> </span>with<span class="w"> </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>environment<span class="w"> </span>variable<span class="w"> </span>to<span class="w"> </span>display<span class="w"> </span>it.
Run<span class="w"> </span>with<span class="w"> </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span>full<span class="w"> </span>to<span class="w"> </span>include<span class="w"> </span><span class="nb">source</span><span class="w"> </span>snippets.
</code></pre></div>

<p>可以看到，一旦 <code>Future</code> 返回 <code>Poll::Ready</code> 我们就不能再次轮询它了。我们为什么会这样？因为 <code>Future</code> 已经返回了结果。如果结果是非 <code>Copy</code> 的，它可能只能返回一次。</p>
<p>所以，我们需要 1）跟踪 <code>A</code> 是否完成，然后 2）在某个地方存储它的返回结果。</p>
<p>我们只需要在我们的结构体中添加一些字段：</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="nc">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span>
<span class="w">    </span><span class="n">b</span>: <span class="nc">B</span><span class="p">,</span>
<span class="w">    </span><span class="c1">// 👇</span>
<span class="w">    </span><span class="n">a_res</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">AR</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">b_res</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">BR</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>不要忘记初始化它们：</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">try_join</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">B</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">),</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">TryJoin</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">a</span><span class="p">,</span>
<span class="w">        </span><span class="n">b</span><span class="p">,</span>
<span class="w">        </span><span class="c1">// 👇</span>
<span class="w">        </span><span class="n">a_res</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">        </span><span class="n">b_res</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>现在计划是：</p>
<ul>
<li>如果 <code>a_res</code> 是 <code>Some</code> ，然后我们就不需要轮询 <code>a</code> ,因为它已经完成了</li>
<li>同样的逻辑处理 <code>b_res</code> 和 <code>b</code></li>
</ul>
<p>让我们实现它。同时，因为我们已经在使用了 <code>unsafe</code> ，所以我们已经负责维护不变量（invariants），
所以我决定同时固定 <code>a</code> 和 <code>b</code> ，如下：</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_unchecked_mut</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">(</span>
<span class="w">            </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">),</span>
<span class="w">            </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">b</span><span class="p">),</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a_res</span><span class="p">.</span><span class="n">is_none</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">,</span>
<span class="w">            </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nb">Ok</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
<span class="w">                </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">b_res</span><span class="p">.</span><span class="n">is_none</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">,</span>
<span class="w">            </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nb">Ok</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">b_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
<span class="w">                </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="fm">todo!</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<p>好了，这个应该能让 <code>a</code> 和 <code>b</code> 有机会在我们崩溃之前完成：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:11:03.851<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:11:04.380<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
The<span class="w"> </span>application<span class="w"> </span>panicked<span class="w"> </span><span class="o">(</span>crashed<span class="o">)</span>.
Message:<span class="w">  </span>not<span class="w"> </span>yet<span class="w"> </span>implemented
Location:<span class="w"> </span>src/tj.rs:69

Backtrace<span class="w"> </span>omitted.
Run<span class="w"> </span>with<span class="w"> </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>environment<span class="w"> </span>variable<span class="w"> </span>to<span class="w"> </span>display<span class="w"> </span>it.
Run<span class="w"> </span>with<span class="w"> </span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span>full<span class="w"> </span>to<span class="w"> </span>include<span class="w"> </span><span class="nb">source</span><span class="w"> </span>snippets.
</code></pre></div>

<p>很好！现在我们需要做的就是解出两个结果并返回它们：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// instead of the `todo!()`:</span>

<span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="n">_</span><span class="p">),</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="p">.</span><span class="n">a_res</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">this</span><span class="p">.</span><span class="n">b_res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a_res</span><span class="p">.</span><span class="n">take</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">b_res</span><span class="p">.</span><span class="n">take</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="nb">Ok</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Poll</span>::<span class="n">Pending</span>
<span class="p">}</span>
</code></pre></div>

<p>可以工作：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:13:32.497<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:13:32.829<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:13:32.829<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
</code></pre></div>

<p>。。。但是这不是 <code>try_join</code> 的实现。我们正在做的和这个完全一样：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// (pseudo-code, buncha things are missing)</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">try_join</span><span class="p">(</span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">B</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>

<p>是顺序的执行的。请记住，仅仅是因为 tokio 的执行器可能用了一堆线程并意味着同时运行是自动的。
前面我们不得不使用 <code>tokio::spwan</code> 或 <code>UnorderedFutures</code> 或 <code>try_join!</code> 让其同时运行。</p>
<p>所以让我们重新看一下。。。当我们轮询 <code>a</code> 的是后发生了什么？</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a_res</span><span class="p">.</span><span class="n">is_none</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">,</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>额，当轮询 <code>a</code> 的时候返回 <code>Poll::Pending</code> 时我们也会返回 <code>Poll::Pending</code>  。所以这就是问题。
如果 <code>a</code> 正在等待（pending）我们不应该返回。因为如果这时候 <code>b</code> 已经准备好或者有错误呢？</p>
<p>或者如果，我们像这样调用 <code>try_join</code> 呢：</p>
<div class="highlight"><pre><span></span><code><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Joining...&quot;</span><span class="p">);</span>
<span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tj</span>::<span class="n">try_join</span><span class="p">(</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">2000</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_millis</span><span class="p">(</span><span class="mi">10</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span>
<span class="w">        </span><span class="nb">Err</span>::<span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="p">(</span><span class="n">color_eyre</span>::<span class="n">eyre</span>::<span class="n">eyre</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;uh oh&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">)</span>
<span class="p">.</span><span class="k">await</span><span class="p">;</span>
</code></pre></div>

<p>。。。然后 <code>a</code> 花费了 2 秒钟才准备好，同时 <code>b</code> 会在 10毫秒之后返回一个错误，如果我们轮询它！</p>
<p>嗐，我们并没有：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:19:26.972<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Joining...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:19:28.990<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=</span>Err<span class="o">(</span>
<span class="w">   </span><span class="m">0</span>:<span class="w"> </span>uh<span class="w"> </span>oh

Location:
<span class="w">   </span>src/main.rs:28
<span class="o">(</span>cut<span class="o">)</span>
</code></pre></div>

<p>（注意时间戳）</p>
<p>重点是 <code>try_join</code> 会提前失败：一旦 Future 返回 <code>Result::Err~</code> 。</p>
<p>所以我们必须同时轮询 <code>a</code> 和 <code>b</code> 。好吧。。。不是严格意义的同时。我们必须每次我们的 <code>TryJoin</code> future 对象被轮询时并发（concurrently）的轮询它们，
直到它们返回结果。</p>
<p>有一个简单解决办法 -- 在任一 future 对象返回 <code>Poll::Pending</code> 时不返回 <code>Poll::Pending</code> 。</p>
<p>同时，我厌倦了输入 <code>Poll::Ready</code> 并且 <code>Poll&lt;T&gt;</code> 实现了 <code>From&lt;T&gt;</code> ,所以我们可以使用 <code>.into()</code> 了：</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_unchecked_mut</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">(</span>
<span class="w">            </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">),</span>
<span class="w">            </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">b</span><span class="p">),</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a_res</span><span class="p">.</span><span class="n">is_none</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nb">Ok</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
<span class="w">                </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">into</span><span class="p">(),</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">b_res</span><span class="p">.</span><span class="n">is_none</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nb">Ok</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">b_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
<span class="w">                </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">into</span><span class="p">(),</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="n">_</span><span class="p">),</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="p">.</span><span class="n">a_res</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">this</span><span class="p">.</span><span class="n">b_res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a_res</span><span class="p">.</span><span class="n">take</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">b_res</span><span class="p">.</span><span class="n">take</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)).</span><span class="n">into</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Poll</span>::<span class="n">Pending</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>让我们再次运行</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:22:40.238<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Joining...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:22:40.253<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=</span>Err<span class="o">(</span>
<span class="w">   </span><span class="m">0</span>:<span class="w"> </span>uh<span class="w"> </span>oh

Location:
<span class="w">   </span>src/main.rs:28

<span class="o">(</span>cut<span class="o">)</span>
</code></pre></div>

<p>。。。可以了！我是说它按照预期的失败了。预期的失败就是成功。</p>
<p>然后我们将这个方法应用到调用 <code>try_join</code> :</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[tokio::main(flavor = </span><span class="s">&quot;current_thread&quot;</span><span class="cp">)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Joining...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tj</span>::<span class="n">try_join</span><span class="p">(</span><span class="n">fetch_thing</span><span class="p">(</span><span class="s">&quot;first&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="s">&quot;second&quot;</span><span class="p">)).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">?</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;All done!&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>我们可以看到竞争又回来了：有时 <code>first</code> 先完成，有时则不是：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:25.925<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Joining...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:26.224<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:26.236<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:26.236<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:26.937<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Joining...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:27.237<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:27.242<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:27.242<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:27.865<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Joining...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:28.164<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:28.818<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:28.818<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:30.153<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Joining...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:31.477<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:31.496<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:25:31.496<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
</code></pre></div>

<p>。。。同时结果的顺序是正确的。</p>
<p>非常好，我们实现了它！</p>
<p>但是！</p>
<h3 id="我们可以做的更好">我们可以做的更好</h3>
<p>幸运的是，坏就是好。</p>
<p>下面这个类型困扰着我：</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="nc">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span>
<span class="w">    </span><span class="n">b</span>: <span class="nc">B</span><span class="p">,</span>
<span class="w">    </span><span class="n">a_res</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">AR</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">b_res</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">BR</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>我其实只有在 <code>a</code> 完成后才需要 <code>a_res</code> 。一旦 <code>a</code> 完成然后将结果存储到 <code>a_res</code> ，我们就不再需要 <code>a</code> 了。</p>
<p>实际上，甚至我们不应该再碰 <code>a</code>  。</p>
<p>这听起来更像我们要么持有 <code>A</code> 要么持有 <code>AR</code> ，但是永远不会同时持有。</p>
<blockquote>
<p><code>SUM TYPES</code> : Rust 的枚举就是一个汇总类型。</p>
</blockquote>
<p>所以！汇总类型。Rust 枚举。这就是我们想要的。让我们创建一个叫做 <code>State</code> 的类型，然后它有两个变体：
一个用于它还是 future 对象，一个用于它是一个结果。非常简单！</p>
<div class="highlight"><pre><span></span><code><span class="k">enum</span> <span class="nc">State</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">F</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Future</span><span class="p">(</span><span class="n">F</span><span class="p">),</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">T</span><span class="p">),</span>
<span class="p">}</span>
</code></pre></div>

<p>这将会非常棒！</p>
<p>让我们赋给我们的 <code>TryJoin</code> 结构体：</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="nc">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">a</span>: <span class="nc">State</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">b</span>: <span class="nc">State</span><span class="o">&lt;</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>（是不是非常漂亮）</p>
<p>然后初始化它们：</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">try_join</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">B</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">),</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">TryJoin</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">a</span>: <span class="nc">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>
<span class="w">        </span><span class="n">b</span>: <span class="nc">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">b</span><span class="p">),</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>非常酷。然后我们只需要稍微调整一下我们的 <code>poll</code> 方法，我们需要将 <code>Pin&lt;&amp;mut Self&gt;</code> 转换为 <code>&amp;mut Self</code> 。。。</p>
<div class="highlight"><pre><span></span><code><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_unchecked_mut</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
</code></pre></div>

<p>这是可以的，因为我们承诺维护不变量，也就是说我们不会转移（move） <code>State::Future</code> 内部。</p>
<p>然后如果 <code>a</code> 是 <code>State::Future</code> 我们就轮询它，然后我们再传播错误或者保存它的结果：</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">into</span><span class="p">(),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>然后同样的修改 <code>b</code> 。。。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// you can figure that one out, I believe in you</span>
</code></pre></div>

<p>然后我们就完成了如果它们都是 <code>State::Ok</code> ！否则我们就返回 <code>Poll::Pending</code> :</p>
<div class="highlight"><pre><span></span><code><span class="k">match</span><span class="w"> </span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="w"> </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)).</span><span class="n">into</span><span class="p">(),</span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>非常好。</p>
<p>除了它无法通过编译：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
error<span class="o">[</span>E0507<span class="o">]</span>:<span class="w"> </span>cannot<span class="w"> </span>move<span class="w"> </span>out<span class="w"> </span>of<span class="w"> </span><span class="sb">`</span>this.a<span class="sb">`</span><span class="w"> </span>which<span class="w"> </span>is<span class="w"> </span>behind<span class="w"> </span>a<span class="w"> </span>mutable<span class="w"> </span>reference
<span class="w">  </span>--&gt;<span class="w"> </span>src/tj.rs:65:16
<span class="w">   </span><span class="p">|</span>
<span class="m">65</span><span class="w"> </span><span class="p">|</span><span class="w">         </span>match<span class="w"> </span><span class="o">(</span>this.a,<span class="w"> </span>this.b<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">   </span><span class="p">|</span><span class="w">                </span>^^^^^^<span class="w"> </span>move<span class="w"> </span>occurs<span class="w"> </span>because<span class="w"> </span><span class="sb">`</span>this.a<span class="sb">`</span><span class="w"> </span>has<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="sb">`</span>State&lt;A,<span class="w"> </span>AR,<span class="w"> </span>E&gt;<span class="sb">`</span>,<span class="w"> </span>which<span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>implement<span class="w"> </span>the<span class="w"> </span><span class="sb">`</span>Copy<span class="sb">`</span><span class="w"> </span>trait

error<span class="o">[</span>E0507<span class="o">]</span>:<span class="w"> </span>cannot<span class="w"> </span>move<span class="w"> </span>out<span class="w"> </span>of<span class="w"> </span><span class="sb">`</span>this.b<span class="sb">`</span><span class="w"> </span>which<span class="w"> </span>is<span class="w"> </span>behind<span class="w"> </span>a<span class="w"> </span>mutable<span class="w"> </span>reference
<span class="w">  </span>--&gt;<span class="w"> </span>src/tj.rs:65:24
<span class="w">   </span><span class="p">|</span>
<span class="m">65</span><span class="w"> </span><span class="p">|</span><span class="w">         </span>match<span class="w"> </span><span class="o">(</span>this.a,<span class="w"> </span>this.b<span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="w">   </span><span class="p">|</span><span class="w">                        </span>^^^^^^<span class="w"> </span>move<span class="w"> </span>occurs<span class="w"> </span>because<span class="w"> </span><span class="sb">`</span>this.b<span class="sb">`</span><span class="w"> </span>has<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="sb">`</span>State&lt;B,<span class="w"> </span>BR,<span class="w"> </span>E&gt;<span class="sb">`</span>,<span class="w"> </span>which<span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>implement<span class="w"> </span>the<span class="w"> </span><span class="sb">`</span>Copy<span class="sb">`</span><span class="w"> </span>trait

error:<span class="w"> </span>aborting<span class="w"> </span>due<span class="w"> </span>to<span class="w"> </span><span class="m">2</span><span class="w"> </span>previous<span class="w"> </span>errors

For<span class="w"> </span>more<span class="w"> </span>information<span class="w"> </span>about<span class="w"> </span>this<span class="w"> </span>error,<span class="w"> </span>try<span class="w"> </span><span class="sb">`</span>rustc<span class="w"> </span>--explain<span class="w"> </span>E0507<span class="sb">`</span>.
error:<span class="w"> </span>could<span class="w"> </span>not<span class="w"> </span>compile<span class="w"> </span><span class="sb">`</span>waytoodeep<span class="sb">`</span>

To<span class="w"> </span>learn<span class="w"> </span>more,<span class="w"> </span>run<span class="w"> </span>the<span class="w"> </span><span class="nb">command</span><span class="w"> </span>again<span class="w"> </span>with<span class="w"> </span>--verbose.
</code></pre></div>

<p>因为。。。我们只有 <code>&amp;mut Self</code> 而不是 <code>Self</code> 。</p>
<p>我们没有自己的所有权，仅仅是借用我们自己。</p>
<p>所以，我们不能将将我们的成员转移（move）出去，因为我们不能阻止其他人再次轮询 <code>TryJoin</code> 。
所以这种情况，我们需要崩溃（panic）。</p>
<p>当然，如果我们像 <code>Option&lt;T&gt;</code> 那样有一个 <code>.take()</code> 方法事情就会大大简化。
它返回 Option 拥有的任何内容，或者 <code>None</code> 。</p>
<p>但是我们没有 <code>None</code> 。我们只有 <code>State::Future</code> 和 <code>State::OK</code> ，没有“中立”（neutral）状态。</p>
<p>让我们创建一个：</p>
<div class="highlight"><pre><span></span><code><span class="k">enum</span> <span class="nc">State</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">F</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Future</span><span class="p">(</span><span class="n">F</span><span class="p">),</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">T</span><span class="p">),</span>
<span class="w">    </span><span class="n">Gone</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>现在，我们可以将 <code>this.a</code> 和 <code>this.b</code> 替换为 <code>State::Gone</code> 。。。或者它的返回结果（我们拥有所有权）。
然后我们就可以将它们转移（move）出去。</p>
<p>但是同时。。。我们需要再次对其进行模式匹配（pattern match）。</p>
<p>就像：</p>
<div class="highlight"><pre><span></span><code><span class="k">match</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">this</span><span class="p">.</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">),</span><span class="w"> </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">replace</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">State</span>::<span class="n">Gone</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">t</span><span class="p">,</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">unreachable!</span><span class="p">(),</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">replace</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">State</span>::<span class="n">Gone</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">t</span><span class="p">,</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">unreachable!</span><span class="p">(),</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)).</span><span class="n">into</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>实话说。。。我看过更糟的代码。它只是没那么<a href="https://en.wikipedia.org/wiki/Don%27t%5Frepeat%5Fyourself">DRY</a>。</p>
<p>非常好的实现！</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:52:24.097<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Joining...
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:52:25.050<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:52:25.061<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="m">23</span>:52:25.061<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
</code></pre></div>

<p>看，只有 11ms 的间隔。</p>
<h3 id="更进一步">更进一步？</h3>
<p>这段代码再次困扰了我：</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="nc">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">a</span>: <span class="nc">State</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">b</span>: <span class="nc">State</span><span class="o">&lt;</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>因为现在 <code>a</code> 和 <code>b</code> 是三态的（tri-state）： <code>Future</code> 、 <code>Ok</code> 或者 <code>Gone</code> 。</p>
<p>如果 <code>a</code> 和 <code>b</code> 都是 <code>Gone</code> 呢？这个状态不合理！</p>
<p>如果发生了这个状态，我们现在将会永远返回 <code>Poll::Pending</code> -- 这不太好 -- 一个死锁。</p>
<p>我们真正想要的是。。。两个枚举。实际上我们想要整个 <code>TryJoin</code> 类型是一个 <code>enum</code> 。</p>
<div class="highlight"><pre><span></span><code><span class="k">enum</span> <span class="nc">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Polling</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">a</span>: <span class="nc">State</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">b</span>: <span class="nc">State</span><span class="o">&lt;</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">Done</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>像这样初始化：</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">try_join</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">B</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">),</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">TryJoin</span>::<span class="n">Polling</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">a</span>: <span class="nc">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>
<span class="w">        </span><span class="n">b</span>: <span class="nc">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">b</span><span class="p">),</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>然后，surprice！ <code>Poll&lt;T&gt;</code> 实现了 <a href="https://doc.rust-lang.org/stable/std/ops/trait.Try.html">Try</a> trait。所以我们可以使用 <code>?</code> 。
所以最终我们的代码实际上非常短小：</p>
<div class="highlight"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">),</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_unchecked_mut</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">Self</span>::<span class="n">Polling</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">),</span>
<span class="w">            </span><span class="bp">Self</span>::<span class="n">Done</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">panic!</span><span class="p">(</span><span class="s">&quot;TryJoin future polled after completion&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">fut</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="n">fut</span><span class="p">)</span><span class="w"> </span><span class="p">}.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">res</span><span class="o">?</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">fut</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="n">fut</span><span class="p">)</span><span class="w"> </span><span class="p">}.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">*</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">res</span><span class="o">?</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">(</span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">),</span><span class="w"> </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">replace</span><span class="p">(</span><span class="n">this</span><span class="p">,</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Done</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">Self</span>::<span class="n">Polling</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">a</span>: <span class="nc">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>
<span class="w">                    </span><span class="n">b</span>: <span class="nc">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">b</span><span class="p">),</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)).</span><span class="n">into</span><span class="p">(),</span>
<span class="w">                </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">unreachable!</span><span class="p">(),</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>现在，我知道你在想什么。 <code>Pin&lt;&amp;mut T&gt;</code> 不是恰恰用来避免像 <code>std::mem::swap</code> 和 <code>std::mem::replace</code> 吗？
这些所有的转移（move）都是围绕着内存！这是被禁止的！是的，我们承诺了不去转移（move）它。
但是在这个情况下，我们只是在完成轮询两个 future 对象后转移了 <code>self</code> / <code>this</code> 。</p>
<p>然后我们就再也没有使用过两个 future 对象，无论固定还是非固定。同时我们从来也没保证过结果自身是否将要被固定（pinned）！</p>
<p>我们只需要决定某些东西是“永远固定”还是“永不固定”，然后我们可能会编写结果正确的代码。</p>
<p>在我们的场景下，只有 <code>TryJoin::Polling(State::Future(_))</code> 就是“永远固定” 的，其他都不是。</p>
<p>当然，我们快速的从 <code>Pin&lt;&amp;mut Self&gt;</code> 切换到 <code>&amp;mut Self</code> ，然后又回到 <code>Pin&lt;&amp;mut A&gt;</code> ，
但只要我们不要在中间移动就没有问题。</p>
<p>如果我们在持有 future 对象的情况下使用 <code>std::mem:replace</code> 或 <code>std::mem::swap</code> 就会不妙。
所以，我们还好，我想，我不太确定。如果不是，有人应该会留言。</p>
<h3 id="就这样">就这样</h3>
<p>让我们回顾我们的工作：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in `src/tj.rs`</span>

<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">future</span>::<span class="n">Future</span><span class="p">,</span>
<span class="w">    </span><span class="n">pin</span>::<span class="n">Pin</span><span class="p">,</span>
<span class="w">    </span><span class="n">task</span>::<span class="p">{</span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">Poll</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">try_join</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span>: <span class="nc">A</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">B</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">),</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">TryJoin</span>::<span class="n">Polling</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">a</span>: <span class="nc">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>
<span class="w">        </span><span class="n">b</span>: <span class="nc">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">b</span><span class="p">),</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="nc">State</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">F</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Future</span><span class="p">(</span><span class="n">F</span><span class="p">),</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">T</span><span class="p">),</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="nc">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Polling</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">a</span>: <span class="nc">State</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">b</span>: <span class="nc">State</span><span class="o">&lt;</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">Done</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">TryJoin</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">A</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">B</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">BR</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">AR</span><span class="p">,</span><span class="w"> </span><span class="n">BR</span><span class="p">),</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Poll</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_unchecked_mut</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">Self</span>::<span class="n">Polling</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">),</span>
<span class="w">            </span><span class="bp">Self</span>::<span class="n">Done</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">panic!</span><span class="p">(</span><span class="s">&quot;TryJoin future polled after completion&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">fut</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="n">fut</span><span class="p">)</span><span class="w"> </span><span class="p">}.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">res</span><span class="o">?</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">State</span>::<span class="n">Future</span><span class="p">(</span><span class="n">fut</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Ready</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="n">fut</span><span class="p">)</span><span class="w"> </span><span class="p">}.</span><span class="n">poll</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">*</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">res</span><span class="o">?</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">(</span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">),</span><span class="w"> </span><span class="n">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">replace</span><span class="p">(</span><span class="n">this</span><span class="p">,</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Done</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">Self</span>::<span class="n">Polling</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">a</span>: <span class="nc">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>
<span class="w">                    </span><span class="n">b</span>: <span class="nc">State</span>::<span class="nb">Ok</span><span class="p">(</span><span class="n">b</span><span class="p">),</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)).</span><span class="n">into</span><span class="p">(),</span>
<span class="w">                </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">unreachable!</span><span class="p">(),</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Poll</span>::<span class="n">Pending</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>还有我们小小的 HTTPS 客户端：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in `src/main.rs`</span>

<span class="k">use</span><span class="w"> </span><span class="n">color_eyre</span>::<span class="n">Report</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="p">{</span><span class="n">net</span>::<span class="n">SocketAddr</span><span class="p">,</span><span class="w"> </span><span class="n">sync</span>::<span class="n">Arc</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">tokio</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">io</span>::<span class="p">{</span><span class="n">AsyncReadExt</span><span class="p">,</span><span class="w"> </span><span class="n">AsyncWriteExt</span><span class="p">},</span>
<span class="w">    </span><span class="n">net</span>::<span class="n">TcpStream</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">tokio_rustls</span>::<span class="p">{</span><span class="n">rustls</span>::<span class="n">ClientConfig</span><span class="p">,</span><span class="w"> </span><span class="n">TlsConnector</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">tracing</span>::<span class="n">info</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">tracing_subscriber</span>::<span class="n">EnvFilter</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">webpki</span>::<span class="n">DNSNameRef</span><span class="p">;</span>

<span class="k">mod</span> <span class="nn">tj</span><span class="p">;</span>

<span class="cp">#[tokio::main(flavor = </span><span class="s">&quot;current_thread&quot;</span><span class="cp">)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setup</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Joining...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tj</span>::<span class="n">try_join</span><span class="p">(</span><span class="n">fetch_thing</span><span class="p">(</span><span class="s">&quot;first&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">fetch_thing</span><span class="p">(</span><span class="s">&quot;second&quot;</span><span class="p">)).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">?</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;All done!&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="cp">#[allow(dead_code)]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">fetch_thing</span><span class="p">(</span><span class="n">name</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// look out it&#39;s port 443 now</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">addr</span>: <span class="nc">SocketAddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">443</span><span class="p">).</span><span class="n">into</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TcpStream</span>::<span class="n">connect</span><span class="p">(</span><span class="n">addr</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// establish a TLS session...</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">connector</span>: <span class="nc">TlsConnector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClientConfig</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">config</span>
<span class="w">            </span><span class="p">.</span><span class="n">root_store</span>
<span class="w">            </span><span class="p">.</span><span class="n">add_server_trust_anchors</span><span class="p">(</span><span class="o">&amp;</span><span class="n">webpki_roots</span>::<span class="n">TLS_SERVER_ROOTS</span><span class="p">);</span>
<span class="w">        </span><span class="n">Arc</span>::<span class="n">new</span><span class="p">(</span><span class="n">config</span><span class="p">).</span><span class="n">into</span><span class="p">()</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">dnsname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DNSNameRef</span>::<span class="n">try_from_ascii_str</span><span class="p">(</span><span class="s">&quot;one.one.one.one&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connector</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dnsname</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// we&#39;re writing straight to the socket, there&#39;s no buffering</span>
<span class="w">    </span><span class="c1">// so no need to flush</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;GET / HTTP/1.1</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;Host: one.one.one.one</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;User-Agent: cool-bear</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;Connection: close</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="s">b&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">with_capacity</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>
<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">read_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">response</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">lines</span><span class="p">().</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap_or_default</span><span class="p">();</span>
<span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="o">%</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Got response!&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// dropping the socket will close the connection</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">setup</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Report</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">var</span><span class="p">(</span><span class="s">&quot;RUST_LIB_BACKTRACE&quot;</span><span class="p">).</span><span class="n">is_err</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="s">&quot;RUST_LIB_BACKTRACE&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">color_eyre</span>::<span class="n">install</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">var</span><span class="p">(</span><span class="s">&quot;RUST_LOG&quot;</span><span class="p">).</span><span class="n">is_err</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="s">&quot;RUST_LOG&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;info&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">tracing_subscriber</span>::<span class="n">fmt</span>::<span class="n">fmt</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">with_env_filter</span><span class="p">(</span><span class="n">EnvFilter</span>::<span class="n">from_default_env</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">init</span><span class="p">();</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>

<p>And it works.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">RUST_LOG</span><span class="o">=</span>info<span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--quiet<span class="w"> </span>--release
Jul<span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="m">00</span>:08:13.399<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Joining...
Jul<span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="m">00</span>:08:13.707<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>first
Jul<span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="m">00</span>:08:13.709<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>Got<span class="w"> </span>response!<span class="w"> </span><span class="nv">status</span><span class="o">=</span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK<span class="w"> </span><span class="nv">name</span><span class="o">=</span>second
Jul<span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="m">00</span>:08:13.710<span class="w">  </span>INFO<span class="w"> </span>waytoodeep:<span class="w"> </span>All<span class="w"> </span><span class="k">done</span>!<span class="w"> </span><span class="nv">res</span><span class="o">=(</span><span class="s2">&quot;first&quot;</span>,<span class="w"> </span><span class="s2">&quot;second&quot;</span><span class="o">)</span>
</code></pre></div>

<p>2ms 间隔！这是一个新的记录。</p>
            </section>

            <section class="post-info">
                <div class="post-share">
                    <a class="twitter" href="https://twitter.com/share?text=【译】深入理解 Rust future&amp;url=https://www.linuxzen.com/understanding-rust-futures-by-going-way-too-deep.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <i class="ic ic-twitter"></i><span class="hidden">Twitter</span>
                    </a>
                    <a class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.linuxzen.com/understanding-rust-futures-by-going-way-too-deep.html" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <i class="ic ic-facebook"></i><span class="hidden">Facebook</span>
                    </a>
                    <a class="googleplus" href="https://plus.google.com/share?url=https://www.linuxzen.com/understanding-rust-futures-by-going-way-too-deep.html" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <i class="ic ic-googleplus"></i><span class="hidden">Google+</span>
                    </a>
                    <div class="clear"></div>
                </div>

                <aside class="post-tags">
<a href="https://www.linuxzen.com/tag/rust.html">Rust</a><a href="https://www.linuxzen.com/tag/future.html">future</a><a href="https://www.linuxzen.com/tag/tokio.html">tokio</a>                </aside>

                <div class="clear"></div>

                <aside class="post-author">


                        <figure class="post-author-avatar">
                            <img src="https://s.gravatar.com/avatar/4d0bc04ed0e44ab750ba32b5224101d7?s=200" alt="Gray King" />
                        </figure>
                    <div class="post-author-bio">
                        <h4 class="post-author-name"><a href="https://www.linuxzen.com/author/cold.html">Gray King</a></h4>
                            <p class="post-author-about">纸上得来终觉浅，绝知此事要躬行</p>
                            <span class="post-author-location"><i class="ic ic-location"></i> Beijing</span>
                            <span class="post-author-website"><a href="https://github.com/coldnight"><i class="ic ic-link"></i> Website</a></span>
                        <!-- Social linkes in alphabet order. -->
                    </div>
                    <div class="clear"></div>
                </aside>

                </section>

                <script type="text/javascript">
                    var disqus = 'linuxzen';
                    var disqus_shortname = 'linuxzen';
                    var disqus_identifier = '/understanding-rust-futures-by-going-way-too-deep.html';
                    var disqus_url = 'https://www.linuxzen.com/understanding-rust-futures-by-going-way-too-deep.html';
                </script>
                <noscript>Please enable JavaScript to view the comments.</noscript>
                <section class="post-comments">
                        <a id="show-disqus" class="post-comments-activate" data-disqus-identifier="/understanding-rust-futures-by-going-way-too-deep.html" >Show Comments</a>
                    <div id="disqus_thread"></div>
                </section>

                <aside class="post-nav">
                    <div class="clear"></div>
                </aside>

            </div>
        </article>
    </main>
      <!-- TODO : Body class -->
    <div id="body-class" style="display: none;" class=""></div>

    <footer id="footer">
      <div class="inner">
        <section class="credits">


          <span class="credits-theme">Theme <a href="https://github.com/arulrajnet/attila" rel="nofollow">Attila</a></span>
          <span class="credits-software">Published with <a href="https://github.com/getpelican/pelican" rel="nofollow">Pelican</a></span>
        </section>
      </div>
    </footer>
  </section>

  <script src="https://ajax.googleapis.cnpmjs.org/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.2/build/highlight.min.js"></script>
  <script type="text/javascript" src="https://www.linuxzen.com/theme/js/script.js"></script>

    <script type="text/javascript">
        var pkBaseURL = "piwik.linuxzen.com";
    var _paq = _paq || [];
    _paq.push(["trackPageView"]);
    _paq.push(["enableLinkTracking"]);
    (function() {
        var u=(("https:" == document.location.protocol) ? "https" : "http")+"://"+pkBaseURL+"/";
        _paq.push(["setTrackerUrl", u+"piwik.php"]);
        _paq.push(["setSiteId", "2"]);
        var d=document, g=d.createElement("script"), s=d.getElementsByTagName("script")[0]; g.type="text/javascript";
        g.defer=true; g.async=true; g.src=u+"piwik.js"; s.parentNode.insertBefore(g,s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'linuxzen';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>